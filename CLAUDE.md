# Claude Code Instructions for namsbokasafn-efni

## âš ï¸ MANDATORY: Read Documentation Before Pipeline Operations

**Before performing ANY pipeline operation** (processing, publishing, assembling, syncing content), you MUST:

1. **Read** [docs/workflow/simplified-workflow.md](docs/workflow/simplified-workflow.md) first
2. **Identify** which step(s) of the 5-step workflow apply
3. **Use the documented tools** - never bypass with manual file operations
4. **Follow the documented order** - source fixes go in source directories, not publication directories

**Pipeline operations include:**
- Processing content through any pipeline stage
- Publishing or preparing content for publication
- Splitting or assembling chapter files
- Syncing content between repositories
- Fixing content rendering issues

**DO NOT:**
- Edit files directly in `05-publication/` without using pipeline tools
- Copy files manually between repositories (use sync scripts)
- Edit `toc.json` in -vefur directly (source of truth is in content repo)
- "Quick fix" content issues without understanding the proper workflow

**If documentation is unclear or tools don't work as expected:**
- Report the issue to the user
- Do not work around the tooling with manual operations

---

## Notes for Code Reviewers

This project was built iteratively with AI assistance. Known areas of concern:
- Pipeline tools evolved organically â€” may have inconsistent patterns
- Error handling may be incomplete in some tools
- Server authentication needs security review
- Documentation may be ahead of or behind actual implementation in places
- No automated test suite yet

## Purpose

Translation workflow for Icelandic OpenStax textbooks. Produces three assets:
1. **Faithful translations** (03-faithful-translation/) - human-verified, academically citable
2. **Translation memory** (tm/) - human-verified ENâ†”IS parallel corpus
3. **Localized content** (04-localized-content/, 05-publication/) - adapted for Icelandic students

## Project Context

- **Developer profile:** Chemistry teacher with basic Linux skills, not a professional developer
- **Development method:** Built primarily with Claude Code assistance
- **Server:** Linode Ubuntu, nginx, Node.js
- **Sister repo:** namsbokasafn-vefur (web publishing service)
- **Domain:** namsbokasafn.is (migrated from efnafraedi.app)
- **Authentication:** GitHub OAuth for the workflow server
- **Scale:** Small educational project â€” 1-2 developers, ~5 editors

## Tech Stack

- **Runtime:** Node.js
- **Pipeline tools:** Custom CLI scripts in `tools/`
- **Server:** Express-based workflow interface in `server/`
- **Content format:** CNXML â†’ Markdown (intermediate) â†’ HTML
- **Dependencies:** See package.json

## Directory Structure

```
books/{book}/
â”œâ”€â”€ 01-source/          # ğŸ”’ READ ONLY - OpenStax CNXML originals
â”œâ”€â”€ 02-for-mt/          # EN segments for machine translation
â”‚   â””â”€â”€ ch{NN}/         #   m{NNNNN}-segments.en.md
â”œâ”€â”€ 02-structure/       # Document structure from extraction
â”‚   â””â”€â”€ ch{NN}/         #   m{NNNNN}-structure.json, -equations.json
â”œâ”€â”€ 02-mt-output/       # ğŸ”’ READ ONLY - Raw IS segments from MT
â”œâ”€â”€ 02-machine-translated/ # Merged MT segments (ready for injection)
â”œâ”€â”€ 03-faithful-translation/ # âœï¸ Reviewed IS segments (per-module, written by applyApprovedEdits)
â”œâ”€â”€ 03-translated/      # Translated CNXML from injection
â”‚   â””â”€â”€ {track}/ch{NN}/ #   m{NNNNN}.cnxml (track = mt-preview, faithful, localized)
â”œâ”€â”€ 04-localization/    # âœï¸ Localization in progress
â”œâ”€â”€ 04-localized-content/ # âœï¸ Pass 2 output (localized version)
â”œâ”€â”€ 05-publication/     # âœï¸ Web-ready HTML
â”‚   â”œâ”€â”€ mt-preview/     #    MT versions for immediate use
â”‚   â””â”€â”€ faithful/       #    Human-reviewed versions
â”œâ”€â”€ for-align/          # Staging for Matecat Align
â”œâ”€â”€ tm/                 # ğŸ”’ READ ONLY - TMX from Matecat Align
â”œâ”€â”€ glossary/           # Terminology files
â””â”€â”€ chapters/ch{NN}/    # Status tracking (status.json)

tools/                  # CLI tools for pipeline processing
server/                 # Web workflow interface
docs/                   # Documentation (see below)
```

## File Permissions

| Permission | Folders | Rule |
|------------|---------|------|
| ğŸ”’ READ ONLY | `01-source/`, `02-mt-output/`, `tm/` | Never modify |
| âœï¸ WRITE | `03-faithful-translation/`, `04-localized-content/`, `05-publication/` | Backup before editing |
| GENERATED | `02-for-mt/`, `02-structure/`, `03-translated/`, `for-align/` | Generated by tools |

**Before modifying files:** Create backup `{filename}.{YYYY-MM-DD-HHMM}.bak`

## Extract-Inject-Render Pipeline

```
CNXML â†’ Extract â†’ EN Segments â†’ MT â†’ Initialize â†’ Review â†’ Inject â†’ Render â†’ HTML
```

| Step | What | Tool/Service | Output |
|------|------|--------------|--------|
| 1a | CNXML â†’ EN segments | `cnxml-extract.js` | `02-for-mt/`, `02-structure/` |
| 1b | Protect for MT | `protect-segments-for-mt.js` | MT-ready segments |
| 2a | Machine translation | malstadur.is | `02-mt-output/` |
| 2b | Unprotect MT output | `unprotect-segments.js` | Ready for review/injection |
| 3a | Linguistic review | Segment editor (web) or manual editing | `03-faithful-translation/` â˜… |
| 3b | Apply approved edits | `applyApprovedEdits()` (per-module) | `03-faithful-translation/` |
| 4 | TM creation | `prepare-for-align.js` + Matecat Align | `tm/` â˜… |
| 5a | Inject translations | `cnxml-inject.js` | `03-translated/` |
| 5b | Render to HTML | `cnxml-render.js` | `05-publication/` |

â˜… = Human-verified asset

**Key insight:** Review BEFORE TM creation, so TM is human-verified quality. Markdown is only an intermediary for MT; final output is semantic HTML.

See [docs/workflow/simplified-workflow.md](docs/workflow/simplified-workflow.md) for full instructions.

## Commands

| Command | Purpose |
|---------|---------|
| `/pipeline-status` | Overview of all chapters |
| `/chapter-status <book> <ch>` | Specific chapter progress |
| `/review-chapter <book> <ch>` | Pass 1 linguistic review |
| `/localize-chapter <book> <ch>` | Pass 2 localization |
| `/check-terminology <book> <ch>` | Verify terminology |

## Skills (Auto-loaded)

| Skill | Triggers When |
|-------|---------------|
| `editorial-pass1` | Working on `03-faithful-translation/`, grammar review |
| `localization` | Working on `04-localized-content/`, unit conversions |
| `chemistry-reader-tags` | Working on `05-publication/`, tagging content |
| `workflow-status` | Discussing chapter progress |
| `repo-structure` | Creating or moving files |
| `review-protocol` | Discussing reviews or approvals |
| `activity-logging` | File operations requiring logging |

Skills are in `.claude/skills/` and provide domain-specific guidance.

## Status Updates

```bash
npm run update-status <book> <chapter> <stage> <status>
npm run validate
```

**Stages (Extract-Inject-Render pipeline):**
- `extraction` - Step 1: Segments + structure extracted
- `mtReady` - Step 1b: Segments protected for MT
- `mtOutput` - Step 2: MT output received
- `linguisticReview` - Step 3: Faithful translation reviewed
- `tmCreated` - Step 4: TM created via Matecat Align
- `injection` - Step 5a: Translated CNXML produced
- `rendering` - Step 5b: HTML produced
- `publication` - Step 5c: Published to web

**Statuses:** `complete`, `not-started` (binary in status.json; `pending` used in section-level display)

## Human Review Required

All AI suggestions require human approval before:
- Advancing workflow stages
- Committing terminology changes
- Publishing content

## Two-Repository Workflow

| Problem Type | Fix In |
|--------------|--------|
| Content issues | **HERE** (namsbokasafn-efni) |
| Rendering bugs | namsbokasafn-vefur |

**Cross-repo CSS contract:** Rendered HTML from `cnxml-render.js` produces semantic HTML that relies on `/styles/content.css` served by namsbokasafn-vefur (located at `static/styles/content.css`). Changes to CNXML class names or structure must be coordinated with that stylesheet.

**Sync command** (run in namsbokasafn-vefur):
```bash
node scripts/sync-content.js --source ../namsbokasafn-efni
```

## Documentation

| Document | Purpose |
|----------|---------|
| [docs/workflow/simplified-workflow.md](docs/workflow/simplified-workflow.md) | **Extract-Inject-Render workflow** |
| [docs/workflow/editor-improvements-jan2026.md](docs/workflow/editor-improvements-jan2026.md) | **Editor rebuild plan for CNXMLâ†’HTML pipeline** |
| [docs/editorial/pass1-linguistic.md](docs/editorial/pass1-linguistic.md) | Pass 1 instructions |
| [docs/editorial/pass2-localization.md](docs/editorial/pass2-localization.md) | Pass 2 instructions |
| [docs/editorial/terminology.md](docs/editorial/terminology.md) | Terminology standards |
| [docs/technical/architecture.md](docs/technical/architecture.md) | System architecture |
| [docs/pipeline/html-pipeline-issues.md](docs/pipeline/html-pipeline-issues.md) | cnxml-render bug tracking |
| [ROADMAP.md](ROADMAP.md) | Development status |

## Current Priority

**Operational use** â€” Phases 8-13 complete. Pipeline verified with 49 automated tests.

See [ROADMAP.md](ROADMAP.md) and [docs/workflow/development-plan-phases-9-13.md](docs/workflow/development-plan-phases-9-13.md) for completed work and future ideas.

**Phase 13 Status:** COMPLETE (2026-02-16) â€” Dead code removed, 22 pipeline integration tests added.
**Phase 12 Status:** COMPLETE (2026-02-16) â€” All 8 pipeline issues verified as resolved on live site.
**Phase 11 Status:** COMPLETE (2026-02-16) â€” 8-stage schema migration, canonical stage names, auto-advance hooks.
**Phase 10 Status:** COMPLETE (2026-02-16) â€” Publication service migrated; faithful track grows per-module.
**Phase 9 Status:** COMPLETE (2026-02-16) â€” `applyApprovedEdits()` writes reviewed segments per-module.
**Phase 8 Status:** COMPLETE (2026-02-05) â€” Editor rebuild for CNXMLâ†’HTML pipeline delivered.
