<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stjórnborð - Námsbókasafn</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    /* Attention panel - full width on top */
    .attention-panel {
      grid-column: span 12;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .attention-panel.has-issues {
      border-left: 4px solid var(--warning);
    }

    .attention-panel.all-clear {
      border-left: 4px solid var(--success);
    }

    .attention-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .attention-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .attention-stats {
      display: flex;
      gap: 1.5rem;
    }

    .attention-stat {
      text-align: center;
    }

    .attention-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .attention-stat-value.zero { color: var(--success); }
    .attention-stat-value.warning { color: var(--warning); }
    .attention-stat-value.danger { color: var(--danger); }

    .attention-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .attention-items {
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .attention-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
    }

    .attention-item:last-child {
      margin-bottom: 0;
    }

    .attention-item-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }

    .attention-item-icon.overdue { background: var(--danger-light); color: var(--danger); }
    .attention-item-icon.blocked { background: var(--danger-light); color: var(--danger); }
    .attention-item-icon.unassigned { background: var(--warning-light); color: var(--warning); }
    .attention-item-icon.review { background: var(--info-light); color: var(--info); }

    .attention-item-content {
      flex: 1;
    }

    .attention-item-title {
      font-weight: 500;
      color: var(--text-primary);
    }

    .attention-item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .attention-item-action {
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
    }

    /* Workload panel - left 8 cols */
    .workload-panel {
      grid-column: span 8;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .workload-table {
      width: 100%;
      border-collapse: collapse;
    }

    .workload-table th {
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .workload-table td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .workload-table tr:last-child td {
      border-bottom: none;
    }

    .workload-user {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .workload-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-light);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .workload-bar {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }

    .workload-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .workload-bar-fill.low { background: var(--success); }
    .workload-bar-fill.medium { background: var(--warning); }
    .workload-bar-fill.high { background: var(--danger); }

    /* Ready for assignment panel - right 4 cols */
    .ready-panel {
      grid-column: span 4;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .ready-item {
      padding: 0.75rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .ready-item:hover {
      background: var(--primary-light);
    }

    .ready-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ready-item-title {
      font-weight: 500;
      color: var(--text-primary);
    }

    .ready-item-stage {
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      background: var(--success-light);
      color: var(--success);
      border-radius: var(--radius-sm);
    }

    .ready-item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    /* Activity panel - bottom */
    .activity-panel {
      grid-column: span 12;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.5rem;
    }

    .activity-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      background: var(--gray-200);
      color: var(--gray-600);
    }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .activity-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .panel-header h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-header h2 i {
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .workload-panel, .ready-panel {
        grid-column: span 12;
      }
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .attention-panel, .workload-panel, .ready-panel, .activity-panel {
        grid-column: span 1;
      }

      .attention-stats {
        flex-wrap: wrap;
        gap: 1rem;
      }
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .page-header h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-subtitle {
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .refresh-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .last-updated {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Stage labels */
    .stage-label {
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: var(--radius-sm);
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .stage-label.enMarkdown { background: #dbeafe; color: #1e40af; }
    .stage-label.mtOutput { background: #fef3c7; color: #92400e; }
    .stage-label.linguisticReview { background: #d1fae5; color: #065f46; }
    .stage-label.tmCreated { background: #ede9fe; color: #5b21b6; }
    .stage-label.publication { background: #fce7f3; color: #9d174d; }
  </style>
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/my-work">Mín verkefni</a>
      <a href="/workflow">Verkflæði</a>
      <a href="/status">Staða</a>
      <a href="/segment-editor">Ritstjóri</a>
      <a href="/terminology">Orðasafn</a>
      <a href="/review-queue">Yfirferðarröð</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stjórnborð</a>
      <a href="/admin" class="admin-only admin-link">Stjórnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um þema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <nav class="breadcrumb">
      <a href="/admin">Stjórnandi</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current">Stjórnborð</span>
    </nav>

    <div class="page-header">
      <div>
        <h1><i class="fas fa-tachometer-alt"></i> Stjórnborð</h1>
        <p class="page-subtitle">Yfirlit fyrir aðalritstjóra</p>
      </div>
      <div>
        <button class="btn btn-secondary refresh-btn" onclick="loadDashboard()">
          <i class="fas fa-sync-alt"></i> Uppfæra
        </button>
        <span class="last-updated" id="last-updated"></span>
      </div>
    </div>

    <div class="dashboard-grid">
      <!-- Needs Attention Panel -->
      <div class="attention-panel" id="attention-panel">
        <div class="attention-header">
          <h2><i class="fas fa-exclamation-triangle"></i> Þarfnast athygli</h2>
          <div class="attention-stats" id="attention-stats">
            <!-- Filled by JS -->
          </div>
        </div>
        <div class="attention-items" id="attention-items">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Hleður...</p>
          </div>
        </div>
      </div>

      <!-- Editor Workload Panel -->
      <div class="workload-panel">
        <div class="panel-header">
          <h2><i class="fas fa-users"></i> Vinnuálag ritstjóra</h2>
        </div>
        <table class="workload-table" id="workload-table">
          <thead>
            <tr>
              <th>Ritstjóri</th>
              <th>Virk</th>
              <th>Tímafrestur</th>
              <th>Álag</th>
            </tr>
          </thead>
          <tbody id="workload-body">
            <tr>
              <td colspan="4" class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Hleður...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Ready for Assignment Panel -->
      <div class="ready-panel">
        <div class="panel-header">
          <h2><i class="fas fa-clipboard-check"></i> Tilbúið til úthlutunar</h2>
        </div>
        <div id="ready-list">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Hleður...</p>
          </div>
        </div>
      </div>

      <!-- Recent Activity Panel -->
      <div class="activity-panel">
        <div class="panel-header">
          <h2><i class="fas fa-history"></i> Nýleg virkni</h2>
          <a href="/status" class="btn btn-sm btn-secondary">Sjá allt</a>
        </div>
        <div class="activity-list" id="activity-list">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Hleður...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/theme.js"></script>
  <script src="/js/nav.js"></script>
  <script src="/js/htmlUtils.js"></script>
  <script>
    // Stage label translations
    const STAGE_LABELS = {
      'enMarkdown': 'EN Markdown',
      'mtOutput': 'Vélþýðing',
      'linguisticReview': 'Yfirferð 1',
      'tmCreated': 'Þýðingaminni',
      'publication': 'Útgáfa'
    };

    // Load dashboard data
    async function loadDashboard() {
      try {
        const response = await fetch('/api/status/dashboard');
        if (!response.ok) throw new Error('Failed to load dashboard');
        const data = await response.json();

        renderAttentionPanel(data.needsAttention, data.overdueItems);
        renderWorkload(data.workload);
        renderReadyList(data.readyForAssignment);
        renderActivity(data.teamActivity);

        document.getElementById('last-updated').textContent =
          `Uppfært: ${new Date().toLocaleTimeString('is-IS')}`;
      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }

    // Render attention panel
    function renderAttentionPanel(attention, overdueItems) {
      const panel = document.getElementById('attention-panel');
      const statsEl = document.getElementById('attention-stats');
      const itemsEl = document.getElementById('attention-items');

      const totalIssues = attention.overdueCount + attention.blockedIssues +
                         attention.unassignedWork + attention.pendingReviews;

      // Update panel class
      panel.className = totalIssues > 0 ? 'attention-panel has-issues' : 'attention-panel all-clear';

      // Render stats
      statsEl.innerHTML = `
        <div class="attention-stat">
          <div class="attention-stat-value ${attention.overdueCount > 0 ? 'danger' : 'zero'}">
            ${attention.overdueCount}
          </div>
          <div class="attention-stat-label">Tímafrestur</div>
        </div>
        <div class="attention-stat">
          <div class="attention-stat-value ${attention.blockedIssues > 0 ? 'danger' : 'zero'}">
            ${attention.blockedIssues}
          </div>
          <div class="attention-stat-label">Lokað</div>
        </div>
        <div class="attention-stat">
          <div class="attention-stat-value ${attention.unassignedWork > 0 ? 'warning' : 'zero'}">
            ${attention.unassignedWork}
          </div>
          <div class="attention-stat-label">Óúthlutað</div>
        </div>
        <div class="attention-stat">
          <div class="attention-stat-value ${attention.pendingReviews > 0 ? 'warning' : 'zero'}">
            ${attention.pendingReviews}
          </div>
          <div class="attention-stat-label">Í bið</div>
        </div>
      `;

      // Render items
      if (attention.items.length === 0) {
        itemsEl.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle" style="color: var(--success);"></i>
            <p>Ekkert þarfnast athygli!</p>
          </div>
        `;
        return;
      }

      const INITIAL_SHOW = 5;

      const renderItem = (item) => {
        const iconClass = item.type;
        const icon = {
          overdue: 'fa-clock',
          blocked: 'fa-ban',
          unassigned: 'fa-user-slash',
          review: 'fa-eye'
        }[item.type] || 'fa-exclamation';

        return `
          <div class="attention-item">
            <div class="attention-item-icon ${iconClass}">
              <i class="fas ${icon}"></i>
            </div>
            <div class="attention-item-content">
              <div class="attention-item-title">${item.message}</div>
              <div class="attention-item-meta">
                ${item.book ? `${item.book} / ` : ''}
                ${item.chapter ? `Kafli ${item.chapter}` : ''}
                ${item.assignedTo ? ` - ${item.assignedTo}` : ''}
                ${item.daysOld ? ` (${item.daysOld} dagar)` : ''}
              </div>
            </div>
            <button class="btn btn-sm btn-primary attention-item-action"
                    onclick="handleAttentionItem('${item.type}', '${item.book}', ${item.chapter}, '${item.stage || ''}')">
              Skoða
            </button>
          </div>
        `;
      };

      const visibleItems = attention.items.slice(0, INITIAL_SHOW);
      const hiddenItems = attention.items.slice(INITIAL_SHOW);

      let html = visibleItems.map(renderItem).join('');

      if (hiddenItems.length > 0) {
        html += `
          <div class="accordion collapsed" id="attention-more-accordion">
            <button class="accordion-header" onclick="toggleAccordion('attention-more-accordion')">
              <div class="accordion-header-left">
                <span class="accordion-toggle">▼</span>
                <span>Sýna ${hiddenItems.length} fleiri atriði</span>
              </div>
            </button>
            <div class="accordion-body">
              ${hiddenItems.map(renderItem).join('')}
            </div>
          </div>
        `;
      }

      itemsEl.innerHTML = html;
    }

    // Toggle accordion open/closed
    function toggleAccordion(accordionId) {
      const accordion = document.getElementById(accordionId);
      if (accordion) {
        accordion.classList.toggle('collapsed');
      }
    }

    // Render workload table
    function renderWorkload(workload) {
      const tbody = document.getElementById('workload-body');

      if (!workload || workload.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">
              <i class="fas fa-user-slash"></i>
              <p>Engar úthlutanir</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = workload.map(user => {
        const initials = escapeHtml(user.username).substring(0, 2).toUpperCase();
        const utilization = user.utilizationPercent || 0;
        const barClass = utilization < 50 ? 'low' : utilization < 80 ? 'medium' : 'high';

        return `
          <tr>
            <td>
              <div class="workload-user">
                <div class="workload-avatar">${initials}</div>
                <span>${escapeHtml(user.username)}</span>
              </div>
            </td>
            <td>${user.pending}</td>
            <td>${user.overdue > 0 ? `<span style="color: var(--danger);">${user.overdue}</span>` : '0'}</td>
            <td style="width: 150px;">
              <div class="workload-bar">
                <div class="workload-bar-fill ${barClass}" style="width: ${Math.min(utilization, 100)}%;"></div>
              </div>
              <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">
                ${utilization}%
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Render ready for assignment list
    function renderReadyList(items) {
      const listEl = document.getElementById('ready-list');
      const INITIAL_SHOW = 4;

      if (!items || items.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>Ekkert tilbúið</p>
          </div>
        `;
        return;
      }

      const renderReadyItem = (item) => `
        <div class="ready-item" onclick="assignChapter('${item.book}', ${item.chapter}, '${item.nextStage}')">
          <div class="ready-item-header">
            <span class="ready-item-title">Kafli ${item.chapter}</span>
            <span class="stage-label ${item.nextStage}">${STAGE_LABELS[item.nextStage] || item.nextStage}</span>
          </div>
          <div class="ready-item-meta">
            ${item.title || item.book} - ${item.progress}% lokið
          </div>
        </div>
      `;

      const visibleItems = items.slice(0, INITIAL_SHOW);
      const hiddenItems = items.slice(INITIAL_SHOW);

      let html = visibleItems.map(renderReadyItem).join('');

      if (hiddenItems.length > 0) {
        html += `
          <div class="accordion collapsed" id="ready-more-accordion">
            <button class="accordion-header" onclick="toggleAccordion('ready-more-accordion')">
              <div class="accordion-header-left">
                <span class="accordion-toggle">▼</span>
                <span>Sýna ${hiddenItems.length} fleiri</span>
              </div>
            </button>
            <div class="accordion-body">
              ${hiddenItems.map(renderReadyItem).join('')}
            </div>
          </div>
        `;
      }

      listEl.innerHTML = html;
    }

    // Render activity list
    function renderActivity(activities) {
      const listEl = document.getElementById('activity-list');
      const INITIAL_SHOW = 5;

      if (!activities || activities.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>Engin virkni</p>
          </div>
        `;
        return;
      }

      const renderActivityItem = (activity) => `
        <div class="activity-item">
          <div class="activity-icon" style="${activity.color ? `background: ${activity.color}20; color: ${activity.color};` : ''}">
            <i class="fas ${activity.icon || 'fa-circle'}"></i>
          </div>
          <div class="activity-content">
            <div class="activity-text">
              <strong>${activity.userId || 'Kerfi'}</strong>
              ${activity.description || activity.type}
              ${activity.book ? `í ${activity.book}` : ''}
              ${activity.chapter ? `kafla ${activity.chapter}` : ''}
            </div>
            <div class="activity-time">${activity.timeAgo || ''}</div>
          </div>
        </div>
      `;

      const visibleActivities = activities.slice(0, INITIAL_SHOW);
      const hiddenActivities = activities.slice(INITIAL_SHOW);

      let html = visibleActivities.map(renderActivityItem).join('');

      if (hiddenActivities.length > 0) {
        html += `
          <div class="accordion collapsed" id="activity-more-accordion">
            <button class="accordion-header" onclick="toggleAccordion('activity-more-accordion')">
              <div class="accordion-header-left">
                <span class="accordion-toggle">▼</span>
                <span>Sýna ${hiddenActivities.length} fleiri</span>
              </div>
            </button>
            <div class="accordion-body">
              ${hiddenActivities.map(renderActivityItem).join('')}
            </div>
          </div>
        `;
      }

      listEl.innerHTML = html;
    }

    // Handle attention item click
    function handleAttentionItem(type, book, chapter, stage) {
      switch (type) {
        case 'blocked':
          window.location.href = `/issues?category=BLOCKED`;
          break;
        case 'review':
          window.location.href = `/reviews`;
          break;
        default:
          window.location.href = `/status/${book}`;
      }
    }

    // Navigate to chapter status
    function assignChapter(book, chapter, stage) {
      window.location.href = `/status/${book}`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      // Auto-refresh every 2 minutes
      setInterval(loadDashboard, 120000);
    });
  </script>
</body>
</html>
