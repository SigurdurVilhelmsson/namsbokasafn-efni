<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Myndir - Námsbókasafn</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/my-work">Mín verkefni</a>
      <a href="/workflow">Verkflæði</a>
      <a href="/status">Stjórnborð</a>
      <a href="/editor">Ritstjóri</a>
      <a href="/terminology">Orðasafn</a>
      <a href="/decisions">Ákvarðanir</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stjórnborð</a>
      <a href="/admin" class="admin-only admin-link">Stjórnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um þema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notification-bell" id="notification-bell" title="Tilkynningar" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h2 class="card-title">Myndaþýðingaeftirlit</h2>
      <div class="form-group">
        <label class="form-label">Veldu bók</label>
        <select class="form-select" id="book-select" onchange="loadBookImages()">
          <option value="">Veldu bók...</option>
          <option value="efnafraedi">Efnafræði (Chemistry 2e)</option>
        </select>
      </div>
    </div>

    <div id="book-stats" style="display: none;">
      <div class="card">
        <h2 class="card-title">Yfirlit bókar</h2>
        <div class="grid grid-5" id="stats-grid"></div>
      </div>

      <div class="card">
        <h2 class="card-title">Kaflar</h2>
        <table class="table">
          <thead>
            <tr><th>Kafli</th><th>Samtals</th><th>Í bið</th><th>Þýtt</th><th>Samþykkt</th><th>Framvinda</th></tr>
          </thead>
          <tbody id="chapters-body"></tbody>
        </table>
      </div>
    </div>

    <div id="chapter-images" style="display: none;">
      <div class="card">
        <h2 class="card-title">Myndir í kafla <span id="chapter-num"></span></h2>
        <button class="btn btn-secondary" onclick="backToOverview()">Til baka í yfirlit</button>
        <div id="images-grid" class="grid grid-3" style="margin-top: 1rem;"></div>
      </div>
    </div>
  </main>

  <script>
    let currentBook = '';

    const STATUS_LABELS = {
      'pending': 'Í bið',
      'in-progress': 'Í vinnslu',
      'translated': 'Þýtt',
      'approved': 'Samþykkt'
    };

    async function loadBookImages() {
      currentBook = document.getElementById('book-select').value;
      if (!currentBook) {
        document.getElementById('book-stats').style.display = 'none';
        return;
      }

      const res = await fetch('/api/images/' + currentBook);
      const data = await res.json();

      document.getElementById('book-stats').style.display = 'block';
      document.getElementById('chapter-images').style.display = 'none';

      const t = data.totals;
      document.getElementById('stats-grid').innerHTML =
        '<div class="stat-card"><div class="stat-value">' + t.total + '</div><div class="stat-label">Samtals</div></div>' +
        '<div class="stat-card"><div class="stat-value">' + t.pending + '</div><div class="stat-label">Í bið</div></div>' +
        '<div class="stat-card"><div class="stat-value">' + t.inProgress + '</div><div class="stat-label">Í vinnslu</div></div>' +
        '<div class="stat-card"><div class="stat-value">' + t.translated + '</div><div class="stat-label">Þýtt</div></div>' +
        '<div class="stat-card"><div class="stat-value">' + t.percentComplete + '%</div><div class="stat-label">Lokið</div></div>';

      document.getElementById('chapters-body').innerHTML = data.chapters.map(ch =>
        '<tr onclick="loadChapterImages(' + ch.chapter + ')" style="cursor: pointer;">' +
          '<td>Kafli ' + ch.chapter + '</td>' +
          '<td>' + ch.total + '</td>' +
          '<td>' + ch.pending + '</td>' +
          '<td>' + ch.translated + '</td>' +
          '<td>' + ch.approved + '</td>' +
          '<td><div class="progress-bar"><div class="progress-bar-fill" style="width: ' +
            (ch.total > 0 ? Math.round((ch.translated + ch.approved) / ch.total * 100) : 0) + '%"></div></div></td>' +
        '</tr>'
      ).join('');
    }

    async function loadChapterImages(chapter) {
      document.getElementById('book-stats').style.display = 'none';
      document.getElementById('chapter-images').style.display = 'block';
      document.getElementById('chapter-num').textContent = chapter;

      const res = await fetch('/api/images/' + currentBook + '/' + chapter);
      const data = await res.json();

      document.getElementById('images-grid').innerHTML = data.images.map(img =>
        '<div class="image-card">' +
          '<div class="image-status status-' + img.status + '">' + (STATUS_LABELS[img.status] || img.status) + '</div>' +
          '<div class="image-id">' + img.id + '</div>' +
          (img.containsText ? '<div class="image-tag">Inniheldur texta</div>' : '') +
          '<div class="image-actions">' +
            (img.editLink ? '<a href="' + img.editLink + '" target="_blank" class="btn btn-secondary">Breyta upprunaskrá</a>' : '') +
            '<button class="btn btn-primary" onclick="uploadImage(\'' + img.id + '\', ' + chapter + ')">Hlaða upp</button>' +
          '</div>' +
        '</div>'
      ).join('');
    }

    function backToOverview() {
      document.getElementById('book-stats').style.display = 'block';
      document.getElementById('chapter-images').style.display = 'none';
    }

    function uploadImage(imageId, chapter) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/png,image/jpeg';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        const res = await fetch('/api/images/' + currentBook + '/' + chapter + '/' + imageId + '/upload', {
          method: 'POST',
          body: formData
        });

        if (res.ok) {
          loadChapterImages(chapter);
        } else {
          alert('Villa við að hlaða upp');
        }
      };
      input.click();
    }
  </script>

  <script src="/js/theme.js"></script>

  <style>
    /* Page-specific styles for images management */

    .card { padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }

    .form-select { max-width: 300px; }

    /* Grid */
    .grid { display: grid; gap: 1rem; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-5 { grid-template-columns: repeat(5, 1fr); }

    /* Stat cards */
    .stat-card { text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 0.5rem; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); }

    /* Table */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    .table tbody tr:hover { background: var(--gray-50); }

    /* Image cards */
    .image-card { background: var(--gray-50); border-radius: 0.5rem; padding: 1rem; }
    .image-status { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600; margin-bottom: 0.5rem; }
    .status-pending { background: var(--warning-light); color: #92400e; }
    .status-in-progress { background: var(--primary-light); color: #1e40af; }
    .status-translated { background: #d1fae5; color: #065f46; }
    .status-approved { background: var(--success-light); color: #166534; }
    .image-id { font-weight: 500; margin-bottom: 0.5rem; }
    .image-tag { font-size: 0.625rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .image-actions { display: flex; gap: 0.5rem; }

    @media (max-width: 768px) { .grid-3, .grid-5 { grid-template-columns: 1fr; } }
  </style>
</body>
</html>
