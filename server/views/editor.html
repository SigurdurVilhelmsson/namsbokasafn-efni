<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ritstj√≥ri - N√°msb√≥kasafn</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header class="header">
    <h1>N√°msb√≥kasafn</h1>
    <nav>
      <a href="/my-work">M√≠n verkefni</a>
      <a href="/status">Stj√≥rnbor√∞</a>
      <a href="/editor" class="active">Ritstj√≥ri</a>
      <a href="/terminology">Or√∞asafn</a>
      <a href="/decisions">√Åkvar√∞anir</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" id="theme-toggle" title="Skipta um √æema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notification-bell" id="notification-bell">
        <button class="bell-btn" id="bell-btn" title="Tilkynningar">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
        </button>
        <div class="notification-dropdown" id="notification-dropdown" style="display: none;">
          <div class="dropdown-header">
            <span>Tilkynningar</span>
            <button class="btn-link" id="mark-all-read-btn">Merkja allt lesi√∞</button>
          </div>
          <div class="notification-list" id="notification-list">
            <p class="text-muted center">Hle√∞ur...</p>
          </div>
          <div class="dropdown-footer">
            <a href="#" id="view-all-notifications">Sj√° allar tilkynningar</a>
          </div>
        </div>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <!-- Section Selector (shown when no section selected) -->
    <div class="card" id="section-selector">
      <h2 class="card-title">Velja kafla til a√∞ breyta</h2>
      <div class="grid grid-2">
        <div class="form-group">
          <label class="form-label">B√≥k</label>
          <select class="form-select" id="book-select">
            <option value="">Veldu b√≥k...</option>
            <option value="efnafraedi">Efnafr√¶√∞i</option>
            <option value="liffraedi">L√≠ffr√¶√∞i</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Kafli</label>
          <select class="form-select" id="chapter-select" disabled>
            <option value="">Veldu kafla...</option>
          </select>
        </div>
      </div>
      <div id="sections-list" class="sections-list" style="display: none;">
        <h3>Hlutar √≠ kafla:</h3>
        <div id="sections-container"></div>
      </div>
    </div>

    <!-- Editor (shown when section selected) -->
    <div id="editor-container" style="display: none;">
      <div class="editor-header">
        <div class="editor-title">
          <button class="btn btn-secondary btn-small" id="back-btn">
            <i class="fas fa-arrow-left"></i> Til baka
          </button>
          <h2 id="section-title">Kafli</h2>
          <div class="split-indicator" id="split-indicator" style="display: none;">
            <span class="split-badge" id="split-badge"></span>
            <button class="split-nav-btn" id="split-prev" title="Fyrri hluti">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="split-nav-btn" id="split-next" title="N√¶sti hluti">
              <i class="fas fa-chevron-right"></i>
            </button>
            <button class="split-info-btn" id="split-info-btn" title="Uppl√Ωsingar um skiptingu">
              <i class="fas fa-info-circle"></i>
            </button>
          </div>
        </div>
        <div class="editor-actions">
          <button class="btn btn-icon spell-check-toggle" id="spell-check-btn" onclick="toggleSpellCheck()" title="Kveikja/sl√∂kkva √° stafsetningarleit">
            <i class="fas fa-spell-check"></i>
            <span class="spell-check-status" id="spell-check-status">‚úì</span>
          </button>
          <span class="save-status" id="save-status"></span>
          <div class="presence-indicator" id="presence-indicator" style="display: none;">
            <div class="presence-avatars" id="presence-avatars"></div>
            <span class="presence-text" id="presence-text"></span>
          </div>
          <button class="btn btn-secondary" id="save-btn">
            <i class="fas fa-save"></i> Vista
          </button>
          <button class="btn btn-primary" id="submit-btn">
            <i class="fas fa-paper-plane"></i> Senda
          </button>
          <div class="dropdown" id="more-dropdown">
            <button class="btn btn-secondary" id="more-btn" onclick="toggleMoreMenu()">
              <i class="fas fa-ellipsis-h"></i> Meira
              <span class="dropdown-badge" id="more-badge" style="display: none;">!</span>
            </button>
            <div class="dropdown-menu" id="more-menu" style="display: none;">
              <button class="dropdown-item" id="toggle-source-btn" title="S√Ωna/fela enska texta">
                <i class="fas fa-columns"></i> EN/IS tv√≠skipting
                <span class="dropdown-item-hint">Ctrl+E</span>
              </button>
              <button class="dropdown-item" id="comments-btn" title="Athugasemdir">
                <i class="fas fa-comments"></i> Athugasemdir
                <span class="comment-count dropdown-item-badge" id="comment-count-badge" style="display: none;">0</span>
              </button>
              <button class="dropdown-item" id="history-btn" title="√ötg√°fusaga">
                <i class="fas fa-history"></i> √ötg√°fusaga
              </button>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" id="terminology-btn" title="Or√∞auppfletting">
                <i class="fas fa-book"></i> Or√∞asafn
                <span class="dropdown-item-hint">Ctrl+T</span>
              </button>
              <button class="dropdown-item" id="decisions-btn" title="Tengdar √°kvar√∞anir">
                <i class="fas fa-gavel"></i> √Åkvar√∞anir
                <span class="decision-count dropdown-item-badge" id="decision-count-badge" style="display: none;">0</span>
              </button>
              <button class="dropdown-item" id="issues-btn" title="Atri√∞i √≠ √æessum kafla">
                <i class="fas fa-exclamation-triangle"></i> Atri√∞i
                <span class="issue-count dropdown-item-badge" id="issue-count-badge" style="display: none;">0</span>
              </button>
              <button class="dropdown-item" id="notes-btn" title="Pers√≥nulegar minnispunktar" onclick="closeMoreMenu(); toggleNotes();">
                <i class="fas fa-sticky-note"></i> M√≠nir minnispunktar
                <span class="notes-indicator" id="notes-indicator" style="display: none;"><i class="fas fa-circle"></i></span>
              </button>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" id="keyboard-help-btn" onclick="showKeyboardHelp()">
                <i class="fas fa-keyboard"></i> Fl√Ωtilyklar
                <span class="dropdown-item-hint">?</span>
              </button>
              <button class="dropdown-item" id="tutorial-btn" onclick="document.getElementById('more-menu').style.display='none'; startTutorial();">
                <i class="fas fa-graduation-cap"></i> Lei√∞s√∂gn
              </button>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" id="export-pdf-btn" onclick="closeMoreMenu(); exportToPDF();">
                <i class="fas fa-file-pdf"></i> Prenta / PDF
                <span class="dropdown-item-hint">Ctrl+P</span>
              </button>
              <button class="dropdown-item" id="export-word-btn" onclick="closeMoreMenu(); exportToWord();">
                <i class="fas fa-file-word"></i> Hla√∞a ni√∞ur Word
              </button>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" id="consistency-check-btn" onclick="closeMoreMenu(); checkConsistency();">
                <i class="fas fa-spell-check"></i> Athuga samr√¶mi
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Pending review warning -->
      <div class="alert alert-warning" id="pending-review-alert" style="display: none;">
        <i class="fas fa-clock"></i>
        <span id="pending-review-text"></span>
      </div>

      <!-- Changes requested feedback banner -->
      <div class="alert alert-feedback" id="feedback-alert" style="display: none;">
        <div class="feedback-header">
          <i class="fas fa-comment-dots"></i>
          <strong>Breytingar √≥skast</strong>
          <span class="feedback-meta" id="feedback-meta"></span>
          <button class="btn-dismiss" onclick="dismissFeedback()">&times;</button>
        </div>
        <div class="feedback-notes" id="feedback-notes"></div>
      </div>

      <!-- Assignment banner (if assigned to current user) -->
      <div class="alert alert-info" id="assignment-banner" style="display: none;">
        <i class="fas fa-user-check"></i>
        <span id="assignment-text"></span>
      </div>

      <!-- Chapter Progress Bar (enhanced visual indicator) -->
      <div class="chapter-progress" id="chapter-progress" style="display: none;">
        <div class="chapter-progress-header">
          <span class="chapter-progress-title" id="chapter-progress-title">Kafli 1</span>
          <span class="chapter-progress-summary" id="chapter-progress-summary">0/0 hlutar kl√°rir</span>
        </div>
        <div class="chapter-sections-bar" id="chapter-sections-bar">
          <!-- Section indicators will be generated by JS -->
        </div>
        <div class="progress-nav">
          <button class="btn btn-secondary btn-small" id="prev-section-btn" disabled title="Fyrri hluti">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="progress-info">
            <span class="progress-label">Hluti <span id="current-section-num">1</span> af <span id="total-sections">1</span></span>
            <span class="progress-status" id="progress-status"></span>
          </div>
          <button class="btn btn-secondary btn-small" id="next-section-btn" disabled title="N√¶sti hluti">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- Contextual Editor Guidance -->
      <div class="guidance-panel" id="guidance-panel">
        <div class="guidance-header" onclick="toggleGuidance()">
          <span class="guidance-title">
            <i class="fas fa-lightbulb"></i>
            <span id="guidance-stage-title">Lei√∞beiningar</span>
          </span>
          <span class="guidance-toggle" id="guidance-toggle">
            <i class="fas fa-chevron-down"></i>
          </span>
        </div>
        <div class="guidance-content" id="guidance-content">
          <!-- Pass 1 Guidance (Linguistic Review) -->
          <div id="guidance-pass1" class="guidance-stage" style="display: none;">
            <div class="guidance-section guidance-do">
              <h4><i class="fas fa-check-circle"></i> Ger√∞u</h4>
              <ul>
                <li>Lei√∞r√©ttu m√°lfr√¶√∞ivillur og stafsetningarvillur</li>
                <li>B√¶ttu or√∞alag og setningaskipan</li>
                <li>Athuga√∞u hugtakanotkun samkv√¶mt or√∞asafni</li>
                <li>Merktu √≥lj√≥s atri√∞i me√∞ <code>&lt;!-- SPURNING: ... --&gt;</code></li>
              </ul>
            </div>
            <div class="guidance-section guidance-dont">
              <h4><i class="fas fa-times-circle"></i> Ekki gera</h4>
              <ul>
                <li>Umbreyta einingum (m√≠lu ‚Üí km) - √æa√∞ er Pass 2</li>
                <li>B√¶ta vi√∞ √≠slenskum d√¶mum - √æa√∞ er Pass 2</li>
                <li>Breyta efnislegri merkingu frumtextans</li>
              </ul>
            </div>
            <div class="guidance-section guidance-tip">
              <h4><i class="fas fa-info-circle"></i> √Åbending</h4>
              <p>√ûetta er <strong>tr√∫ver√∞ug √æ√Ω√∞ing</strong> - h√∫n √æarf a√∞ vera n√°kv√¶m gagnvart frumtexta. Sta√∞f√¶ring kemur √≠ Pass 2.</p>
            </div>
          </div>

          <!-- Pass 2 Guidance (Localization) -->
          <div id="guidance-pass2" class="guidance-stage" style="display: none;">
            <div class="guidance-section guidance-do">
              <h4><i class="fas fa-check-circle"></i> N√∫ m√°ttu</h4>
              <ul>
                <li>Umbreyta einingum (¬∞F ‚Üí ¬∞C, m√≠lu ‚Üí km)</li>
                <li>B√¶ta vi√∞ √≠slenskum/evr√≥pskum samhengi</li>
                <li>Skipta √∫t bandar√≠skum tilv√≠sunum fyrir vi√∞eigandi</li>
                <li>Nota sta√∞f√¶ringarskr√° til a√∞ skr√° breytingar</li>
              </ul>
            </div>
            <div class="guidance-section guidance-dont">
              <h4><i class="fas fa-times-circle"></i> Ekki gera</h4>
              <ul>
                <li>Ey√∞a v√≠sindalegum uppl√Ωsingum</li>
                <li>Breyta efnafr√¶√∞ilegum form√∫lum</li>
                <li>Gera sta√∞f√¶ringar √°n skr√°ningar</li>
              </ul>
            </div>
            <div class="guidance-section guidance-tip">
              <h4><i class="fas fa-info-circle"></i> √Åbending</h4>
              <p>Nota√∞u <code>/localize-chapter</code> til a√∞ f√° till√∂gur a√∞ sta√∞f√¶ringum.</p>
            </div>

            <!-- Localization Tools (Pass 2 only) -->
            <div class="localization-tools">
              <h4><i class="fas fa-tools"></i> Sta√∞f√¶ringarverkf√¶ri</h4>
              <div class="loc-tools-grid">
                <button class="btn btn-secondary btn-small" onclick="showUnitConverter()" title="Umbreyta einingum">
                  <i class="fas fa-calculator"></i> Einingar
                </button>
                <button class="btn btn-secondary btn-small" onclick="showLocalizationLog()" title="Sta√∞f√¶ringarskr√°">
                  <i class="fas fa-list-check"></i> Skr√° (<span id="loc-log-count">0</span>)
                </button>
              </div>
            </div>
          </div>

          <!-- Default Guidance -->
          <div id="guidance-default" class="guidance-stage">
            <div class="guidance-section guidance-tip">
              <h4><i class="fas fa-info-circle"></i> Almennar lei√∞beiningar</h4>
              <ul>
                <li>Vista√∞u reglulega me√∞ <kbd>Ctrl+S</kbd></li>
                <li>Tv√≠smelltu √° or√∞ e√∞a nota√∞u <kbd>Ctrl+T</kbd> til a√∞ fletta upp √≠ or√∞asafni</li>
                <li>Nota√∞u EN/IS hnappinn til a√∞ sj√° enska textann</li>
                <li>Sko√∞a√∞u √∫tg√°fus√∂gu til a√∞ endurheimta eldri √∫tg√°fur</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Side-by-side view -->
      <div class="editor-content" id="editor-content">
        <div class="source-panel" id="source-panel" style="display: none;">
          <div class="panel-header">
            <h3>Enska (upprunalegur texti)</h3>
          </div>
          <div class="source-content" id="source-content"></div>
        </div>
        <div class="editor-panel">
          <div class="panel-header">
            <h3>√çslenska (√æ√Ω√∞ing)</h3>
          </div>
          <textarea id="markdown-editor"></textarea>
          <!-- Keyboard hints moved to modal - access via More menu -->
          <div class="keyboard-hints-mini" id="keyboard-hints-mini">
            <span class="hint-mini"><kbd>Ctrl+S</kbd> Vista</span>
            <span class="hint-mini hint-separator">|</span>
            <span class="hint-mini"><kbd>Ctrl+T</kbd> Or√∞asafn</span>
            <span class="hint-mini hint-separator">|</span>
            <span class="hint-mini"><kbd>?</kbd> Hj√°lp</span>
          </div>
        </div>
      </div>

      <!-- History sidebar -->
      <div class="history-sidebar" id="history-sidebar" style="display: none;">
        <div class="sidebar-header">
          <h3>√ötg√°fusaga</h3>
          <button class="btn-close" id="close-history">&times;</button>
        </div>
        <div class="history-list" id="history-list"></div>
      </div>

      <!-- Comments sidebar -->
      <div class="comments-sidebar" id="comments-sidebar" style="display: none;">
        <div class="sidebar-header">
          <h3><i class="fas fa-comments"></i> Athugasemdir</h3>
          <button class="btn-close" id="close-comments">&times;</button>
        </div>
        <div class="comments-actions">
          <button class="btn btn-primary btn-small" id="add-comment-btn" onclick="showAddCommentModal()">
            <i class="fas fa-plus"></i> B√¶ta vi√∞ athugasemd
          </button>
          <button class="btn btn-secondary btn-small" onclick="addQuestionComment()">
            <i class="fas fa-question-circle"></i> Spurning
          </button>
        </div>
        <div class="comments-filter">
          <label>
            <input type="checkbox" id="filter-questions" checked onchange="renderComments()"> Spurningar
          </label>
          <label>
            <input type="checkbox" id="filter-comments" checked onchange="renderComments()"> Athugasemdir
          </label>
        </div>
        <div class="comments-list" id="comments-list">
          <p class="text-muted center">Engar athugasemdir</p>
        </div>
      </div>

      <!-- Terminology lookup panel -->
      <div class="terminology-panel" id="terminology-panel" style="display: none;">
        <div class="terminology-header">
          <div class="terminology-header-left">
            <i class="fas fa-search"></i>
            <span class="terminology-query" id="terminology-query"></span>
          </div>
          <button class="btn-close" onclick="hideTerminologyPanel()" title="Loka (Esc)">&times;</button>
        </div>
        <div class="terminology-hint">
          <i class="fas fa-lightbulb"></i>
          <span>Tv√≠smelltu √° or√∞ til a√∞ fletta upp e√∞a nota√∞u <kbd>Ctrl</kbd>+<kbd>T</kbd></span>
        </div>
        <div class="terminology-results" id="terminology-results">
          <p class="loading"><i class="fas fa-spinner"></i> Leita...</p>
        </div>
        <div class="terminology-footer">
          <button class="btn btn-secondary btn-small" onclick="proposeNewTerm()">
            <i class="fas fa-plus"></i> N√Ωtt hugtak
          </button>
          <a href="/terminology" target="_blank" class="btn btn-secondary btn-small">
            <i class="fas fa-external-link-alt"></i> Or√∞asafn
          </a>
        </div>
      </div>

      <!-- Personal Notes sidebar -->
      <div class="notes-sidebar" id="notes-sidebar" style="display: none;">
        <div class="sidebar-header">
          <h3><i class="fas fa-sticky-note"></i> M√≠nir minnispunktar</h3>
          <button class="btn-close" id="close-notes">&times;</button>
        </div>
        <div class="notes-info">
          <p class="text-muted text-small">Pers√≥nulegir minnispunktar (ekki s√Ωnilegir √∂√∞rum)</p>
        </div>
        <div class="notes-editor">
          <textarea class="notes-textarea" id="notes-textarea" placeholder="Skrifa√∞u minnispunkta h√©r..."></textarea>
          <div class="notes-actions">
            <button class="btn btn-primary btn-small" onclick="saveNote()">
              <i class="fas fa-save"></i> Vista
            </button>
            <button class="btn btn-icon btn-small" id="pin-note-btn" onclick="togglePinNote()" title="Festa minnispunkt">
              <i class="fas fa-thumbtack"></i>
            </button>
            <button class="btn btn-icon btn-small" onclick="deleteNote()" title="Ey√∞a minnispunkti">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="notes-save-status" id="notes-save-status"></div>
        <div class="notes-all-section">
          <div class="notes-section-header" onclick="toggleAllNotes()">
            <span><i class="fas fa-list"></i> Allir minnispunktar</span>
            <i class="fas fa-chevron-down notes-expand-icon" id="notes-expand-icon"></i>
          </div>
          <div class="notes-all-list" id="notes-all-list" style="display: none;">
            <p class="text-muted center">Hle√∞ur...</p>
          </div>
        </div>
      </div>

      <!-- Related Decisions sidebar -->
      <div class="decisions-sidebar" id="decisions-sidebar" style="display: none;">
        <div class="sidebar-header">
          <h3><i class="fas fa-gavel"></i> Tengdar √°kvar√∞anir</h3>
          <button class="btn-close" id="close-decisions">&times;</button>
        </div>
        <div class="decisions-info">
          <p class="text-muted text-small">√Åkvar√∞anir sem tengjast or√∞um √≠ √æessum hluta</p>
        </div>
        <div class="decisions-actions">
          <button class="btn btn-primary btn-small" onclick="showNewDecisionModal()">
            <i class="fas fa-plus"></i> Skr√° √°kv√∂r√∞un
          </button>
          <button class="btn btn-secondary btn-small" onclick="refreshRelatedDecisions()">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div class="decisions-list" id="decisions-list">
          <p class="text-muted center">Hle√∞ur...</p>
        </div>
        <div class="decisions-footer">
          <a href="/decisions" target="_blank" class="btn btn-secondary btn-small btn-block">
            <i class="fas fa-external-link-alt"></i> Sj√° allar √°kvar√∞anir
          </a>
        </div>
      </div>

      <!-- Issues sidebar -->
      <div class="issues-sidebar" id="issues-sidebar" style="display: none;">
        <div class="sidebar-header">
          <h3><i class="fas fa-exclamation-triangle"></i> Atri√∞i</h3>
          <button class="btn-close" id="close-issues">&times;</button>
        </div>
        <div class="issues-info">
          <p class="text-muted text-small">Atri√∞i sem √æarf a√∞ leysa √≠ √æessum kafla</p>
        </div>
        <div class="issues-tabs">
          <button class="issue-tab active" data-tab="quick" onclick="switchIssueTab('quick')">
            Flj√≥tleg <span class="tab-count" id="quick-count">0</span>
          </button>
          <button class="issue-tab" data-tab="discussion" onclick="switchIssueTab('discussion')">
            Umr√¶√∞a <span class="tab-count" id="discussion-count">0</span>
          </button>
        </div>
        <div class="issues-list" id="issues-list">
          <p class="text-muted center">Hle√∞ur...</p>
        </div>
        <div class="issues-footer">
          <button class="btn btn-secondary btn-small" onclick="reportNewIssue()">
            <i class="fas fa-flag"></i> Tilkynna atri√∞i
          </button>
          <a href="/issues" target="_blank" class="btn btn-secondary btn-small">
            <i class="fas fa-external-link-alt"></i> √ñll atri√∞i
          </a>
        </div>
      </div>

      <!-- Terminology sidebar -->
      <div class="terminology-sidebar" id="terminology-sidebar" style="display: none;">
        <div class="sidebar-header">
          <h3><i class="fas fa-book"></i> Or√∞auppfletting</h3>
          <button class="btn-close" id="close-terminology">&times;</button>
        </div>
        <div class="terminology-search">
          <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="terminology-search" class="form-input" placeholder="Leita a√∞ or√∞i...">
          </div>
          <p class="text-muted text-small">Sl√°√∞u inn or√∞ til a√∞ leita √≠ or√∞asafni</p>
        </div>
        <div class="terminology-results" id="terminology-results">
          <div class="terminology-placeholder">
            <i class="fas fa-lightbulb"></i>
            <p>Leita√∞u a√∞ ensku e√∞a √≠slensku or√∞i</p>
          </div>
        </div>
        <div class="terminology-stats" id="terminology-stats" style="display: none;">
          <div class="stat-row">
            <span class="stat-label">Sam√æykkt:</span>
            <span class="stat-value" id="term-stat-approved">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">√ç bi√∞:</span>
            <span class="stat-value" id="term-stat-proposed">0</span>
          </div>
        </div>
        <div class="terminology-footer">
          <button class="btn btn-primary btn-small" onclick="openTermProposalFromSidebar()">
            <i class="fas fa-plus"></i> Leggja til or√∞
          </button>
          <a href="/terminology" target="_blank" class="btn btn-secondary btn-small">
            <i class="fas fa-external-link-alt"></i> Or√∞asafn
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- Propose Term Modal -->
  <div class="modal" id="propose-term-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Leggja til n√Ωtt or√∞</h3>
        <button class="btn-close" onclick="closeProposalModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Enska</label>
          <input type="text" id="propose-english" class="form-input" placeholder="English term">
        </div>
        <div class="form-group">
          <label class="form-label">√çslenska</label>
          <input type="text" id="propose-icelandic" class="form-input" placeholder="√çslenskt or√∞">
        </div>
        <div class="form-group">
          <label class="form-label">Athugasemdir (valfrj√°lst)</label>
          <textarea id="propose-notes" class="form-textarea" rows="2" placeholder="Sk√Ωringar..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProposalModal()">H√¶tta vi√∞</button>
        <button class="btn btn-primary" onclick="submitTermProposal()">Leggja til</button>
      </div>
    </div>
  </div>

  <!-- Unit Converter Modal -->
  <div class="modal" id="unit-converter-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-calculator"></i> Umbreyta einingum</h3>
        <button class="btn-close" onclick="closeUnitConverter()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Tegund</label>
          <select class="form-select" id="unit-type" onchange="updateUnitOptions()">
            <option value="temperature">Hitastig</option>
            <option value="length">Lengd</option>
            <option value="mass">Massi</option>
            <option value="volume">R√∫mm√°l</option>
            <option value="pressure">√ûr√Ωstingur</option>
          </select>
        </div>
        <div class="unit-conversion-row">
          <div class="form-group">
            <label class="form-label">Fr√°</label>
            <div class="input-with-unit">
              <input type="number" id="unit-from-value" class="form-input" step="any" oninput="calculateConversion()">
              <select class="form-select" id="unit-from" onchange="calculateConversion()"></select>
            </div>
          </div>
          <span class="conversion-arrow"><i class="fas fa-arrow-right"></i></span>
          <div class="form-group">
            <label class="form-label">Til</label>
            <div class="input-with-unit">
              <input type="text" id="unit-to-value" class="form-input" readonly>
              <select class="form-select" id="unit-to" onchange="calculateConversion()"></select>
            </div>
          </div>
        </div>
        <div class="conversion-preview" id="conversion-preview" style="display: none;">
          <p>Setja inn: <code id="conversion-insert-text"></code></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUnitConverter()">Loka</button>
        <button class="btn btn-primary" onclick="insertConversion()" id="insert-conversion-btn" disabled>
          <i class="fas fa-plus"></i> Setja inn
        </button>
      </div>
    </div>
  </div>

  <!-- Localization Log Modal -->
  <div class="modal" id="localization-log-modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3><i class="fas fa-list-check"></i> Sta√∞f√¶ringarskr√°</h3>
        <button class="btn-close" onclick="closeLocalizationLog()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Skr√°√∞u allar sta√∞f√¶ringar sem √æ√∫ gerir. √ûetta hj√°lpar ritstj√≥rum a√∞ skilja hva√∞a breytingar voru ger√∞ar og hvers vegna.</p>

        <!-- Add new entry form -->
        <div class="loc-log-add">
          <div class="form-group">
            <label class="form-label">Tegund breytingar</label>
            <select class="form-select" id="loc-log-type">
              <option value="unit">Einingaumbreyting</option>
              <option value="cultural">Menningarleg a√∞l√∂gun</option>
              <option value="example">√çslenkt d√¶mi</option>
              <option value="reference">Tilv√≠sun breytt</option>
              <option value="other">Anna√∞</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Upprunalegt (EN/US)</label>
            <input type="text" id="loc-log-original" class="form-input" placeholder="t.d. 32¬∞F, New York, John Smith...">
          </div>
          <div class="form-group">
            <label class="form-label">Sta√∞f√¶rt (IS)</label>
            <input type="text" id="loc-log-localized" class="form-input" placeholder="t.d. 0¬∞C, Reykjav√≠k, J√≥n J√≥nsson...">
          </div>
          <div class="form-group">
            <label class="form-label">Sk√Ωring (valfrj√°lst)</label>
            <input type="text" id="loc-log-reason" class="form-input" placeholder="Hvers vegna var √æessi breyting ger√∞?">
          </div>
          <button class="btn btn-primary" onclick="addLocLogEntry()">
            <i class="fas fa-plus"></i> B√¶ta vi√∞
          </button>
        </div>

        <!-- Log entries list -->
        <div class="loc-log-list" id="loc-log-list">
          <p class="text-muted center">Engar skr√°ningar enn</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeLocalizationLog()">Loka</button>
      </div>
    </div>
  </div>

  <!-- Add Comment Modal -->
  <div class="modal" id="add-comment-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-comment-dots"></i> B√¶ta vi√∞ athugasemd</h3>
        <button class="btn-close" onclick="closeAddCommentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Tegund</label>
          <select class="form-select" id="comment-type">
            <option value="ATHUGASEMD">Athugasemd</option>
            <option value="SPURNING">Spurning</option>
            <option value="TODO">Verkefni</option>
            <option value="ATHUGA">√ûarf a√∞ athuga</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Athugasemd</label>
          <textarea id="comment-text" class="form-textarea" rows="3" placeholder="Skrifa√∞u athugasemd h√©r..."></textarea>
        </div>
        <div class="comment-preview" id="comment-preview">
          <label class="form-label">Forsko√∞un:</label>
          <code id="comment-preview-text"></code>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddCommentModal()">H√¶tta vi√∞</button>
        <button class="btn btn-primary" onclick="insertComment()">
          <i class="fas fa-plus"></i> Setja inn
        </button>
      </div>
    </div>
  </div>

  <!-- New Decision Modal (from editor) -->
  <div class="modal" id="new-decision-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-gavel"></i> Skr√° √°kv√∂r√∞un</h3>
        <button class="btn-close" onclick="closeNewDecisionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="decision-context" id="decision-context">
          <span class="context-book" id="decision-context-book"></span>
          <span class="context-sep">/</span>
          <span class="context-chapter" id="decision-context-chapter"></span>
          <span class="context-sep">/</span>
          <span class="context-section" id="decision-context-section"></span>
        </div>
        <div class="form-group">
          <label class="form-label">Flokkur *</label>
          <select class="form-select" id="decision-type">
            <option value="">Veldu flokk...</option>
            <option value="terminology">üìñ Hugtak</option>
            <option value="localization">üåç Sta√∞f√¶ring</option>
            <option value="style">‚úçÔ∏è St√≠ll</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Enska</label>
            <input type="text" id="decision-english" class="form-input" placeholder="Upprunalegt or√∞/setning">
          </div>
          <div class="form-group">
            <label class="form-label">√çslenska</label>
            <input type="text" id="decision-icelandic" class="form-input" placeholder="√û√Ω√∞ing/val">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">R√∂kstu√∞ningur *</label>
          <textarea id="decision-rationale" class="form-textarea" rows="3" placeholder="Hvers vegna var √æessi √°kv√∂r√∞un tekin?"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNewDecisionModal()">H√¶tta vi√∞</button>
        <button class="btn btn-primary" onclick="submitNewDecision()">
          <i class="fas fa-check"></i> Skr√°
        </button>
      </div>
    </div>
  </div>

  <!-- Split Info Modal -->
  <div class="split-info-modal" id="split-info-modal">
    <div class="split-info-content">
      <h3><i class="fas fa-cut"></i> Skipt skr√°</h3>
      <div class="split-explanation">
        <strong>Af hverju er √æessi hluti skipt?</strong><br>
        √ûegar kafli er mj√∂g langur (yfir 18.000 stafir) er hann sj√°lfkrafa skipt √≠ sm√¶rri hluta
        fyrir v√©l√æ√Ω√∞ingu. √ûetta tryggir betri g√¶√∞i v√©l√æ√Ω√∞ingar og au√∞veldari yfirfer√∞.<br><br>
        <strong>√û√∫ √æarft a√∞ yfirfara hvern hluta fyrir sig.</strong> Nota√∞u √∂rvatakkana til a√∞ flakka
        √° milli hluta e√∞a smelltu √° hluta h√©r a√∞ ne√∞an.
      </div>
      <h4>Hlutar √≠ √æessari skiptingu:</h4>
      <ul class="split-parts-list" id="split-parts-list">
        <!-- Populated dynamically -->
      </ul>
      <div style="text-align: right; margin-top: 1rem;">
        <button class="btn btn-primary" onclick="closeSplitInfoModal()">Loka</button>
      </div>
    </div>
  </div>

  <!-- Keyboard Help Modal -->
  <div class="modal" id="keyboard-help-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-keyboard"></i> Fl√Ωtilyklar</h3>
        <button class="btn-close" onclick="closeKeyboardHelp()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="keyboard-help-grid">
          <div class="keyboard-help-section">
            <h4>Ritstj√≥rn</h4>
            <div class="shortcut-list">
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>S</kbd><span>Vista</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>B</kbd><span>Feitletra</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>I</kbd><span>Sk√°letra</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>M</kbd><span>B√¶ta vi√∞ athugasemd</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>Z</kbd><span>Afturkalla</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>Y</kbd><span>Endurgera</span></div>
            </div>
          </div>
          <div class="keyboard-help-section">
            <h4>Hli√∞arspj√∂ld</h4>
            <div class="shortcut-list">
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>E</kbd><span>EN/IS tv√≠skipting</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>T</kbd><span>Or√∞asafn</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>H</kbd><span>√ötg√°fusaga</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>K</kbd><span>Athugasemdir</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>J</kbd><span>Atri√∞i</span></div>
              <div class="shortcut-item"><kbd>Ctrl</kbd>+<kbd>N</kbd><span>M√≠nir minnispunktar</span></div>
            </div>
          </div>
          <div class="keyboard-help-section">
            <h4>Flakk</h4>
            <div class="shortcut-list">
              <div class="shortcut-item"><kbd>Alt</kbd>+<kbd>‚Üê</kbd><span>Fyrri hluti</span></div>
              <div class="shortcut-item"><kbd>Alt</kbd>+<kbd>‚Üí</kbd><span>N√¶sti hluti</span></div>
              <div class="shortcut-item"><kbd>Esc</kbd><span>Loka √∂llum gluggum</span></div>
            </div>
          </div>
          <div class="keyboard-help-section">
            <h4>Hj√°lp</h4>
            <div class="shortcut-list">
              <div class="shortcut-item"><kbd>?</kbd> e√∞a <kbd>F1</kbd><span>S√Ωna √æessa hj√°lp</span></div>
              <div class="shortcut-item"><kbd>F11</kbd><span>Heilskj√°r</span></div>
              <div class="shortcut-item"><span class="hint-action">Tv√≠smelltu</span><span>Fletta upp or√∞i</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeKeyboardHelp(); startTutorial();">
          <i class="fas fa-graduation-cap"></i> Byrja lei√∞s√∂gn
        </button>
        <button class="btn btn-primary" onclick="closeKeyboardHelp()">Loka</button>
      </div>
    </div>
  </div>

  <!-- Tutorial Overlay -->
  <div class="tutorial-overlay" id="tutorial-overlay"></div>
  <div class="tutorial-tooltip" id="tutorial-tooltip">
    <div class="tutorial-tooltip-content">
      <div class="tutorial-step-indicator" id="tutorial-step-indicator"></div>
      <h4 id="tutorial-title"></h4>
      <p id="tutorial-description"></p>
    </div>
    <div class="tutorial-tooltip-footer">
      <button class="btn btn-secondary btn-small" id="tutorial-skip" onclick="endTutorial()">Sleppa</button>
      <div class="tutorial-nav">
        <button class="btn btn-secondary btn-small" id="tutorial-prev" onclick="prevTutorialStep()">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="btn btn-primary btn-small" id="tutorial-next" onclick="nextTutorialStep()">
          N√¶sta <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- First-time Welcome Modal -->
  <div class="modal" id="welcome-modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3><i class="fas fa-graduation-cap"></i> Velkomin/n √≠ ritstj√≥rann!</h3>
      </div>
      <div class="modal-body" style="text-align: center; padding: 2rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üéì</div>
        <p style="font-size: 1rem; color: var(--gray-600); margin-bottom: 1.5rem;">
          √ûetta er fyrsta skipti sem √æ√∫ opnar ritstj√≥rann.<br>
          Viltu fara √≠ stutta lei√∞s√∂gn um helstu a√∞ger√∞ir?
        </p>
        <p style="font-size: 0.875rem; color: var(--gray-500);">
          √û√∫ getur alltaf fari√∞ √≠ lei√∞s√∂gn aftur me√∞ √æv√≠ a√∞ √Ωta √° <kbd>?</kbd>
        </p>
      </div>
      <div class="modal-footer" style="justify-content: center; gap: 1rem;">
        <button class="btn btn-secondary" onclick="dismissWelcome(false)">
          Sleppa
        </button>
        <button class="btn btn-primary" onclick="dismissWelcome(true)">
          <i class="fas fa-play"></i> Byrja lei√∞s√∂gn
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    let currentBook = null;
    let currentChapter = null;
    let currentSection = null;
    let editor = null;
    let autosaveTimer = null;
    let lastSavedContent = '';
    let isSourceVisible = false;

    // ========================================
    // MORE DROPDOWN MENU (Simplified Header)
    // ========================================

    function toggleMoreMenu() {
      const menu = document.getElementById('more-menu');
      const isVisible = menu.style.display !== 'none';
      menu.style.display = isVisible ? 'none' : 'block';

      // Close when clicking outside
      if (!isVisible) {
        setTimeout(() => {
          document.addEventListener('click', closeMoreMenuOnClickOutside);
        }, 0);
      }
    }

    function closeMoreMenuOnClickOutside(e) {
      const dropdown = document.getElementById('more-dropdown');
      if (!dropdown.contains(e.target)) {
        document.getElementById('more-menu').style.display = 'none';
        document.removeEventListener('click', closeMoreMenuOnClickOutside);
      }
    }

    function closeMoreMenu() {
      document.getElementById('more-menu').style.display = 'none';
      document.removeEventListener('click', closeMoreMenuOnClickOutside);
    }

    // ========================================
    // EXPORT FUNCTIONS
    // ========================================

    function exportToPDF() {
      // Create a print-friendly version
      const content = editor?.value() || '';
      const title = document.getElementById('section-title')?.textContent || '√û√Ω√∞ing';

      // Open print dialog
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="is">
        <head>
          <meta charset="UTF-8">
          <title>${escapeHtml(title)}</title>
          <style>
            @page { margin: 2cm; }
            body {
              font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
              line-height: 1.8;
              font-size: 12pt;
              color: #1a1a1a;
              max-width: 100%;
            }
            h1 { font-size: 18pt; margin-bottom: 1.5em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5em; }
            h2 { font-size: 14pt; margin-top: 1.5em; }
            h3 { font-size: 12pt; margin-top: 1em; }
            p { margin: 0.75em 0; text-align: justify; }
            blockquote { margin: 1em 2em; padding-left: 1em; border-left: 3px solid #2563eb; }
            code { background: #f5f5f5; padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; }
            pre { background: #f5f5f5; padding: 1em; border-radius: 5px; overflow-x: auto; }
            table { border-collapse: collapse; width: 100%; margin: 1em 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background: #f5f5f5; }
            img { max-width: 100%; height: auto; }
            .footer { margin-top: 2em; padding-top: 1em; border-top: 1px solid #e5e7eb; font-size: 10pt; color: #666; }
          </style>
        </head>
        <body>
          <h1>${escapeHtml(title)}</h1>
          ${renderMarkdownToHtml(content)}
          <div class="footer">
            <p>N√°msb√≥kasafn - ${new Date().toLocaleDateString('is-IS')}</p>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 250);
    }

    function exportToWord() {
      const content = editor?.value() || '';
      const title = document.getElementById('section-title')?.textContent || '√û√Ω√∞ing';

      // Create HTML document that Word can open
      const html = `
        <!DOCTYPE html>
        <html xmlns:o="urn:schemas-microsoft-com:office:office"
              xmlns:w="urn:schemas-microsoft-com:office:word"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <meta charset="UTF-8">
          <title>${escapeHtml(title)}</title>
          <!--[if gte mso 9]>
          <xml>
            <w:WordDocument>
              <w:View>Print</w:View>
              <w:Zoom>100</w:Zoom>
              <w:DoNotOptimizeForBrowser/>
            </w:WordDocument>
          </xml>
          <![endif]-->
          <style>
            body { font-family: 'Calibri', sans-serif; font-size: 12pt; line-height: 1.5; }
            h1 { font-size: 16pt; font-weight: bold; margin-bottom: 12pt; }
            h2 { font-size: 14pt; font-weight: bold; margin-top: 12pt; }
            h3 { font-size: 12pt; font-weight: bold; }
            p { margin: 6pt 0; }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid black; padding: 6pt; }
            th { background: #f0f0f0; }
          </style>
        </head>
        <body>
          <h1>${escapeHtml(title)}</h1>
          ${renderMarkdownToHtml(content)}
        </body>
        </html>
      `;

      // Create blob and download
      const blob = new Blob([html], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '${title.replace(/[^a-zA-Z0-9]/g, '_')}.doc';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Skr√° hla√∞i√∞ ni√∞ur', 'success');
    }

    function renderMarkdownToHtml(markdown) {
      // Simple markdown to HTML conversion
      // Use EasyMDE's built-in preview if available
      if (editor && editor.markdown) {
        return editor.markdown(markdown);
      }

      // Fallback: basic conversion
      let html = markdown
        // Headers
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        // Bold and italic
        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Links
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        // Lists
        .replace(/^\s*[-*]\s+(.*)$/gim, '<li>$1</li>')
        // Code blocks
        .replace(/```([^`]+)```/gs, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Blockquotes
        .replace(/^>\s*(.*)$/gim, '<blockquote>$1</blockquote>')
        // Paragraphs
        .replace(/\n\n/g, '</p><p>')
        // Line breaks
        .replace(/\n/g, '<br>');

      return '<p>' + html + '</p>';
    }

    // ========================================
    // CONSISTENCY CHECKER
    // ========================================

    async function checkConsistency() {
      if (!editor) {
        showToast('Enginn ritstj√≥ri hla√∞inn', 'error');
        return;
      }

      const content = editor.value();
      const sourceContent = document.getElementById('source-content')?.textContent || '';
      const bookId = document.getElementById('book-select')?.value || 'efnafraedi';

      if (!content.trim()) {
        showToast('Ekkert efni til a√∞ athuga', 'warning');
        return;
      }

      showToast('Athuga samr√¶mi...', 'info');

      try {
        const res = await fetch('/api/terminology/check-consistency', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content,
            sourceContent,
            bookId
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Villa vi√∞ athugun');
        }

        showConsistencyResults(data);
      } catch (err) {
        console.error('Consistency check error:', err);
        showToast('Villa vi√∞ samr√¶misathugun: ' + err.message, 'error');
      }
    }

    function showConsistencyResults(data) {
      const { issues, stats } = data;

      // Create or update results modal
      let modal = document.getElementById('consistency-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'consistency-modal';
        modal.className = 'modal-backdrop';
        modal.innerHTML = `
          <div class="modal consistency-results-modal">
            <div class="modal-header">
              <h3><i class="fas fa-spell-check"></i> Samr√¶misathugun</h3>
              <button class="btn btn-icon" onclick="closeConsistencyModal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="modal-body" id="consistency-modal-body">
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeConsistencyModal()">Loka</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      const body = document.getElementById('consistency-modal-body');

      // Show stats summary
      let html = `
        <div class="consistency-stats">
          <div class="stat-item">
            <span class="stat-value">${stats.termsChecked}</span>
            <span class="stat-label">Hugt√∂k athuga√∞</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">${stats.issuesFound}</span>
            <span class="stat-label">Vandam√°l fundin</span>
          </div>
          <div class="stat-item ${stats.issuesFound === 0 ? 'success' : 'warning'}">
            <i class="fas ${stats.issuesFound === 0 ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
          </div>
        </div>
      `;

      if (issues.length === 0) {
        html += `
          <div class="consistency-success">
            <i class="fas fa-check-circle"></i>
            <p>Engin samr√¶misvandam√°l fundust!</p>
            <p class="subtext">√ñll hugt√∂k eru √≠ samr√¶mi vi√∞ hugtakagagnagrunn.</p>
          </div>
        `;
      } else {
        html += `<div class="consistency-issues">`;

        issues.forEach((issue, idx) => {
          const iconClass = issue.type === 'inconsistent_translation'
            ? 'fa-exchange-alt text-warning'
            : 'fa-question-circle text-info';

          const typeLabel = issue.type === 'inconsistent_translation'
            ? '√ìsamr√¶mi √≠ √æ√Ω√∞ingu'
            : 'Vantar √≠ hugtakagagnagrunn';

          html += `
            <div class="consistency-issue">
              <div class="issue-header">
                <i class="fas ${iconClass}"></i>
                <span class="issue-type">${typeLabel}</span>
              </div>
              <div class="issue-content">
                <div class="issue-term">
                  <strong>Enska:</strong> ${escapeHtml(issue.englishTerm)}
                </div>
                ${issue.foundTranslation ? `
                  <div class="issue-found">
                    <strong>Fundi√∞ √≠ texta:</strong> <mark>${escapeHtml(issue.foundTranslation)}</mark>
                  </div>
                ` : ''}
                ${issue.expectedTranslation ? `
                  <div class="issue-expected">
                    <strong>Sam√æykkt √æ√Ω√∞ing:</strong> <span class="expected-term">${escapeHtml(issue.expectedTranslation)}</span>
                  </div>
                ` : ''}
                ${issue.context ? `
                  <div class="issue-context">
                    <strong>Samhengi:</strong> <code>${escapeHtml(issue.context)}</code>
                  </div>
                ` : ''}
              </div>
              ${issue.type === 'inconsistent_translation' ? `
                <button class="btn btn-sm btn-link" onclick="jumpToTerm('${escapeHtml(issue.foundTranslation || issue.englishTerm)}')">
                  <i class="fas fa-search"></i> Finna √≠ texta
                </button>
              ` : ''}
            </div>
          `;
        });

        html += `</div>`;
      }

      body.innerHTML = html;
      modal.style.display = 'flex';
    }

    function closeConsistencyModal() {
      const modal = document.getElementById('consistency-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function jumpToTerm(term) {
      if (!editor || !term) return;

      const content = editor.value();
      const index = content.toLowerCase().indexOf(term.toLowerCase());

      if (index !== -1) {
        // Close modal
        closeConsistencyModal();

        // Focus editor and select the term
        editor.codemirror.focus();

        // Find line and character position
        let line = 0;
        let ch = 0;
        let pos = 0;
        const lines = content.split('\n');

        for (let i = 0; i < lines.length; i++) {
          if (pos + lines[i].length >= index) {
            line = i;
            ch = index - pos;
            break;
          }
          pos += lines[i].length + 1; // +1 for newline
        }

        // Select the term
        editor.codemirror.setSelection(
          { line, ch },
          { line, ch: ch + term.length }
        );

        // Scroll into view
        editor.codemirror.scrollIntoView({ line, ch }, 100);

        showToast('Hugtak fundi√∞ og vali√∞', 'success');
      } else {
        showToast('Hugtak fannst ekki √≠ texta', 'warning');
      }
    }

    function updateMoreBadge() {
      // Show badge if there are unread items (comments, issues, decisions)
      const commentCount = parseInt(document.getElementById('comment-count-badge')?.textContent || '0');
      const decisionCount = parseInt(document.getElementById('decision-count-badge')?.textContent || '0');
      const issueCount = parseInt(document.getElementById('issue-count-badge')?.textContent || '0');

      const total = commentCount + decisionCount + issueCount;
      const badge = document.getElementById('more-badge');
      if (badge) {
        badge.style.display = total > 0 ? 'inline' : 'none';
      }
    }

    // ========================================
    // KEYBOARD HELP MODAL
    // ========================================

    function showKeyboardHelp() {
      document.getElementById('more-menu').style.display = 'none';
      document.getElementById('keyboard-help-modal').style.display = 'flex';
    }

    function closeKeyboardHelp() {
      document.getElementById('keyboard-help-modal').style.display = 'none';
    }

    // Global keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // '?' key shows keyboard help (when not in an input)
      if (e.key === '?' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
        e.preventDefault();
        showKeyboardHelp();
      }

      // Escape closes modals/dropdowns/sidebars
      if (e.key === 'Escape') {
        // Close dropdowns
        document.getElementById('more-menu').style.display = 'none';

        // Close modals
        document.getElementById('keyboard-help-modal').style.display = 'none';
        document.getElementById('split-info-modal').style.display = 'none';
        if (typeof closeConsistencyModal === 'function') closeConsistencyModal();

        // Close all sidebars
        document.getElementById('history-sidebar').style.display = 'none';
        document.getElementById('comments-sidebar').style.display = 'none';
        document.getElementById('decisions-sidebar').style.display = 'none';
        document.getElementById('issues-sidebar').style.display = 'none';
        document.getElementById('terminology-sidebar').style.display = 'none';
        document.getElementById('notes-sidebar').style.display = 'none';
      }

      // Ctrl+E toggles source view
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        toggleSourcePanel();
      }

      // Ctrl+T opens terminology
      if (e.ctrlKey && e.key === 't' && editor) {
        e.preventDefault();
        toggleTerminology();
      }

      // Ctrl+N opens personal notes
      if (e.ctrlKey && e.key === 'n' && editor) {
        e.preventDefault();
        toggleNotes();
      }

      // Ctrl+H opens history
      if (e.ctrlKey && e.key === 'h' && editor) {
        e.preventDefault();
        toggleHistory();
      }

      // Ctrl+J opens issues
      if (e.ctrlKey && e.key === 'j' && editor) {
        e.preventDefault();
        toggleIssues();
      }

      // Ctrl+K opens comments
      if (e.ctrlKey && e.key === 'k' && editor) {
        e.preventDefault();
        toggleComments();
      }

      // Alt+Arrow for section navigation
      if (e.altKey && e.key === 'ArrowLeft') {
        e.preventDefault();
        navigateSection(-1);
      }
      if (e.altKey && e.key === 'ArrowRight') {
        e.preventDefault();
        navigateSection(1);
      }

      // F1 for keyboard help
      if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardHelp();
      }
    });

    // ========================================
    // UNSAVED CHANGES WARNING
    // ========================================

    // Unsaved changes warning
    function hasUnsavedChanges() {
      return editor && editor.value() !== lastSavedContent;
    }

    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges()) {
        e.preventDefault();
        e.returnValue = '√ìvista√∞ar breytingar - viltu yfirgefa s√≠√∞una?';
        return e.returnValue;
      }
    });

    // ========================================
    // DARK MODE / THEME
    // ========================================

    const THEME_STORAGE_KEY = 'namsbokasafn_theme';

    function initTheme() {
      const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);

      if (savedTheme) {
        setTheme(savedTheme);
      } else {
        // Use system preference if no saved preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        setTheme(prefersDark ? 'dark' : 'light');
      }

      // Listen for system preference changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem(THEME_STORAGE_KEY)) {
          setTheme(e.matches ? 'dark' : 'light');
        }
      });
    }

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      updateThemeIcon(theme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      setTheme(newTheme);
      localStorage.setItem(THEME_STORAGE_KEY, newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('theme-icon');
      if (icon) {
        icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
    }

    // Initialize theme early to prevent flash
    initTheme();

    // Initialize page
    async function init() {
      // Check auth
      const authRes = await fetch('/api/auth/me');
      const authData = await authRes.json();
      const userEl = document.getElementById('user-info');

      if (!authData.authenticated) {
        userEl.innerHTML = '<a href="/api/auth/login?redirect=/editor" class="btn btn-primary">Innskr√°ning</a>';
        return;
      }

      userEl.innerHTML = '<img src="' + authData.user.avatar + '" alt=""><span>' + authData.user.name + '</span>';

      // Check URL params for direct link
      const params = new URLSearchParams(window.location.search);
      const book = params.get('book');
      const chapter = params.get('chapter');
      const section = params.get('section');

      if (book && chapter && section) {
        document.getElementById('book-select').value = book;
        await loadChapters(book);
        document.getElementById('chapter-select').value = chapter;
        await loadSections(book, chapter);
        await loadEditor(book, chapter, section);
      }

      // Setup event listeners
      setupEventListeners();
    }

    function setupEventListeners() {
      document.getElementById('book-select').addEventListener('change', async (e) => {
        const book = e.target.value;
        if (book) {
          await loadChapters(book);
        } else {
          document.getElementById('chapter-select').disabled = true;
          document.getElementById('chapter-select').innerHTML = '<option value="">Veldu kafla...</option>';
          document.getElementById('sections-list').style.display = 'none';
        }
      });

      document.getElementById('chapter-select').addEventListener('change', async (e) => {
        const chapter = e.target.value;
        const book = document.getElementById('book-select').value;
        if (book && chapter) {
          await loadSections(book, chapter);
        }
      });

      document.getElementById('back-btn').addEventListener('click', () => {
        if (hasUnsavedChanges()) {
          if (!confirm('√û√∫ ert me√∞ √≥vista√∞ar breytingar. Viltu yfirgefa ritstj√≥rann?')) {
            return;
          }
        }
        showSectionSelector();
      });

      document.getElementById('save-btn').addEventListener('click', saveContent);
      document.getElementById('submit-btn').addEventListener('click', submitForReview);
      document.getElementById('toggle-source-btn').addEventListener('click', toggleSourcePanel);
      document.getElementById('history-btn').addEventListener('click', toggleHistory);
      document.getElementById('close-history').addEventListener('click', () => {
        document.getElementById('history-sidebar').style.display = 'none';
      });

      // Notes close button
      document.getElementById('close-notes').addEventListener('click', () => {
        document.getElementById('notes-sidebar').style.display = 'none';
      });

      // Comments button
      document.getElementById('comments-btn').addEventListener('click', toggleComments);
      document.getElementById('close-comments').addEventListener('click', () => {
        document.getElementById('comments-sidebar').style.display = 'none';
      });

      // Ctrl+S to save
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          if (editor && hasUnsavedChanges()) {
            saveContent();
          }
        }
        // Ctrl+M to add comment
        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
          e.preventDefault();
          if (editor) {
            showAddCommentModal();
          }
        }
      });
    }

    async function loadChapters(book) {
      const chapterSelect = document.getElementById('chapter-select');
      chapterSelect.innerHTML = '<option value="">Hle√∞ur...</option>';
      chapterSelect.disabled = true;

      try {
        const res = await fetch('/api/books/' + book);
        const data = await res.json();

        chapterSelect.innerHTML = '<option value="">Veldu kafla...</option>' +
          data.chapters.map(c => '<option value="' + c.chapter + '">Kafli ' + c.chapter + ': ' + (c.titleIs || c.title) + '</option>').join('');
        chapterSelect.disabled = false;
      } catch (err) {
        chapterSelect.innerHTML = '<option value="">Villa vi√∞ a√∞ hla√∞a k√∂flum</option>';
      }
    }

    async function loadSections(book, chapter) {
      const container = document.getElementById('sections-container');
      const sectionsList = document.getElementById('sections-list');
      container.innerHTML = '<p>Hle√∞ur...</p>';
      sectionsList.style.display = 'block';

      try {
        const res = await fetch('/api/editor/' + book + '/' + chapter);
        const data = await res.json();

        if (data.sections.length === 0) {
          container.innerHTML = '<p class="text-muted">Engir hlutar fundust √≠ √æessum kafla.</p>';
          return;
        }

        container.innerHTML = data.sections.map(s => {
          const statusClass = s.source === 'faithful' ? 'status-edited' : 'status-mt';
          const statusLabel = s.source === 'faithful' ? 'Breytt' : 'MT √∫ttak';

          // Add split indicator if this is a split section
          let splitBadge = '';
          if (s.splitInfo) {
            splitBadge = '<span class="split-badge-small" title="Skipt skr√°: hluti ' +
              s.splitInfo.partNumber + ' af ' + s.splitInfo.totalParts + '">' +
              '<i class="fas fa-cut"></i> ' + s.splitInfo.partNumber + '/' + s.splitInfo.totalParts +
              '</span>';
          }

          return '<div class="section-item" data-section="' + s.section + '">' +
            '<span class="section-name">' + s.section + splitBadge + '</span>' +
            '<span class="section-status ' + statusClass + '">' + statusLabel + '</span>' +
            '<button class="btn btn-primary btn-small" onclick="loadEditor(\'' + book + '\', \'' + chapter + '\', \'' + s.section + '\')">Opna</button>' +
            '</div>';
        }).join('');

        currentBook = book;
        currentChapter = chapter;
      } catch (err) {
        container.innerHTML = '<p class="text-error">Villa: ' + err.message + '</p>';
      }
    }

    async function loadEditor(book, chapter, section) {
      currentBook = book;
      currentChapter = chapter;
      currentSection = section;

      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('book', book);
      url.searchParams.set('chapter', chapter);
      url.searchParams.set('section', section);
      window.history.pushState({}, '', url);

      // Show editor, hide selector
      document.getElementById('section-selector').style.display = 'none';
      document.getElementById('editor-container').style.display = 'block';
      document.getElementById('section-title').textContent = 'Kafli ' + section;

      try {
        const res = await fetch('/api/editor/' + book + '/' + chapter + '/' + section);
        const data = await res.json();

        // Set source content
        document.getElementById('source-content').innerHTML = data.content.en
          ? '<pre>' + escapeHtml(data.content.en) + '</pre>'
          : '<p class="text-muted">Enski textinn er ekki tilt√¶kur.</p>';

        // Show pending review warning if exists
        const alertEl = document.getElementById('pending-review-alert');
        if (data.pendingReview) {
          document.getElementById('pending-review-text').textContent =
            '√ûessi hluti er √≠ bi√∞ eftir yfirfer√∞ (sent af ' + data.pendingReview.submittedBy + ')';
          alertEl.style.display = 'flex';
        } else {
          alertEl.style.display = 'none';
        }

        // Show recent feedback (changes requested) if exists
        showRecentFeedback(data.recentFeedback);

        // Initialize EasyMDE
        initEditor(data.content.is || '');

        // Detect and set guidance stage
        const stage = detectStage(data);
        setGuidanceStage(stage);

        // Check for assignment
        checkAssignment(book, chapter, section);

        // Load history
        loadHistory(book, chapter, section);

        // Load section progress
        loadSectionProgress(book, chapter, section);

        // Parse comments after a short delay
        setTimeout(parseAndDisplayComments, 500);

        // Load related decisions (after content is loaded)
        setTimeout(loadRelatedDecisions, 1000);

        // Load decision highlights for enforcement
        loadDecisionHighlights(book, chapter);

        // Load chapter issues
        setTimeout(loadChapterIssues, 1200);

        // Update split indicator if this is a split file
        updateSplitIndicator(data.splitInfo);

      } catch (err) {
        alert('Villa vi√∞ a√∞ hla√∞a kafla: ' + err.message);
      }
    }

    function initEditor(content) {
      // Destroy existing editor if any
      if (editor) {
        editor.toTextArea();
        editor = null;
      }

      editor = new EasyMDE({
        element: document.getElementById('markdown-editor'),
        initialValue: content,
        spellChecker: false, // Disable EasyMDE's English-only spell checker
        autosave: {
          enabled: false // We'll handle autosave ourselves
        },
        toolbar: [
          'bold', 'italic', 'heading', '|',
          'quote', 'unordered-list', 'ordered-list', '|',
          'link', 'image', '|',
          'preview', 'side-by-side', 'fullscreen', '|',
          'guide'
        ],
        placeholder: 'Skrifa√∞u √æ√Ω√∞ingu h√©r...',
        status: ['lines', 'words', 'cursor'],
        previewImagesInEditor: true,
        sideBySideFullscreen: false,
        inputStyle: 'contenteditable' // Required for browser spell check
      });

      lastSavedContent = content;

      // Setup autosave
      editor.codemirror.on('change', () => {
        updateSaveStatus('unsaved');
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(autoSave, 30000); // Autosave after 30s of no typing
      });

      // Setup terminology lookup
      setupTerminologyLookup();

      // Setup spell checking
      setupSpellCheck();

      // Load personal note indicator
      loadNoteIndicator();

      // Start presence tracking
      startPresenceTracking();
    }

    async function loadNoteIndicator() {
      if (!currentBook || !currentChapter || !currentSection) return;

      try {
        const res = await fetch(`/api/editor/${currentBook}/${currentChapter}/${currentSection}/notes`);
        const data = await res.json();

        currentNoteContent = data.note.content || '';
        notePinned = data.note.pinned || false;
        updateNotesIndicator();
      } catch (err) {
        // Silently fail - notes are not critical
        console.error('Error loading note indicator:', err);
      }
    }

    // ========================================
    // PRESENCE TRACKING
    // ========================================

    let presenceInterval = null;
    const PRESENCE_POLL_INTERVAL = 30000; // 30 seconds

    async function registerPresence() {
      if (!currentBook || !currentChapter || !currentSection) return;

      try {
        const res = await fetch(`/api/editor/${currentBook}/${currentChapter}/${currentSection}/presence`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (data.success) {
          updatePresenceIndicator(data.presence.others);
        }
      } catch (err) {
        console.error('Error registering presence:', err);
      }
    }

    async function clearPresence() {
      if (!currentBook || !currentChapter || !currentSection) return;

      try {
        await fetch(`/api/editor/${currentBook}/${currentChapter}/${currentSection}/presence`, {
          method: 'DELETE'
        });
      } catch (err) {
        console.error('Error clearing presence:', err);
      }
    }

    function startPresenceTracking() {
      // Register immediately
      registerPresence();

      // Clear any existing interval
      if (presenceInterval) {
        clearInterval(presenceInterval);
      }

      // Poll periodically
      presenceInterval = setInterval(registerPresence, PRESENCE_POLL_INTERVAL);
    }

    function stopPresenceTracking() {
      if (presenceInterval) {
        clearInterval(presenceInterval);
        presenceInterval = null;
      }
      clearPresence();
      hidePresenceIndicator();
    }

    function updatePresenceIndicator(others) {
      const indicator = document.getElementById('presence-indicator');
      const avatarsEl = document.getElementById('presence-avatars');
      const textEl = document.getElementById('presence-text');

      if (!others || others.length === 0) {
        indicator.style.display = 'none';
        return;
      }

      // Show indicator
      indicator.style.display = 'flex';

      // Render avatars (max 3)
      const displayOthers = others.slice(0, 3);
      avatarsEl.innerHTML = displayOthers.map(user => {
        if (user.avatar) {
          return `<img src="${escapeHtml(user.avatar)}" alt="${escapeHtml(user.username)}" title="${escapeHtml(user.username)}" class="presence-avatar">`;
        } else {
          const initial = (user.username || '?').charAt(0).toUpperCase();
          return `<div class="presence-avatar presence-avatar-placeholder" title="${escapeHtml(user.username)}">${initial}</div>`;
        }
      }).join('');

      // Show additional count if more than 3
      if (others.length > 3) {
        avatarsEl.innerHTML += `<div class="presence-avatar presence-avatar-more">+${others.length - 3}</div>`;
      }

      // Text
      if (others.length === 1) {
        textEl.textContent = `${others[0].username} er a√∞ breyta`;
      } else {
        textEl.textContent = `${others.length} a√∞rir eru a√∞ breyta`;
      }
    }

    function hidePresenceIndicator() {
      const indicator = document.getElementById('presence-indicator');
      indicator.style.display = 'none';
    }

    // Clear presence when leaving page
    window.addEventListener('beforeunload', () => {
      // Use sendBeacon for reliable unload tracking
      if (currentBook && currentChapter && currentSection && navigator.sendBeacon) {
        navigator.sendBeacon(`/api/editor/${currentBook}/${currentChapter}/${currentSection}/presence?_method=DELETE`);
      }
    });

    // Handle visibility change (user switches tabs)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // User left - stop polling but don't clear presence yet
        if (presenceInterval) {
          clearInterval(presenceInterval);
          presenceInterval = null;
        }
      } else {
        // User returned - resume tracking
        if (currentBook && currentChapter && currentSection && editor) {
          startPresenceTracking();
        }
      }
    });

    async function autoSave() {
      const content = editor.value();
      if (content === lastSavedContent) return;

      updateSaveStatus('saving');
      try {
        const res = await fetch('/api/editor/' + currentBook + '/' + currentChapter + '/' + currentSection + '/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (data.success) {
          lastSavedContent = content;
          updateSaveStatus('saved');
        } else {
          updateSaveStatus('error');
        }
      } catch (err) {
        updateSaveStatus('error');
      }
    }

    async function saveContent() {
      const content = editor.value();
      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      updateSaveStatus('saving');

      try {
        const res = await fetch('/api/editor/' + currentBook + '/' + currentChapter + '/' + currentSection + '/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        const data = await res.json();
        if (data.success) {
          lastSavedContent = content;
          updateSaveStatus('saved');
          loadHistory(currentBook, currentChapter, currentSection);
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki vista√∞'));
          updateSaveStatus('error');
        }
      } catch (err) {
        alert('Villa: ' + err.message);
        updateSaveStatus('error');
      } finally {
        btn.disabled = false;
      }
    }

    async function submitForReview() {
      const content = editor.value();

      if (!confirm('Ertu viss um a√∞ √æ√∫ viljir senda √æessa √æ√Ω√∞ingu til yfirfer√∞ar?')) {
        return;
      }

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;

      try {
        const res = await fetch('/api/editor/' + currentBook + '/' + currentChapter + '/' + currentSection + '/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        const data = await res.json();

        if (data.success) {
          alert('√û√Ω√∞ing send til yfirfer√∞ar!');
          lastSavedContent = content;
          updateSaveStatus('saved');

          // Show pending review alert
          document.getElementById('pending-review-text').textContent =
            '√ûessi hluti er √≠ bi√∞ eftir yfirfer√∞';
          document.getElementById('pending-review-alert').style.display = 'flex';

          loadHistory(currentBook, currentChapter, currentSection);
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki sent'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    }

    function updateSaveStatus(status) {
      const el = document.getElementById('save-status');
      const messages = {
        unsaved: '<i class="fas fa-circle text-warning"></i> √ìvista√∞',
        saving: '<i class="fas fa-spinner fa-spin"></i> Vistar...',
        saved: '<i class="fas fa-check text-success"></i> Vista√∞',
        error: '<i class="fas fa-exclamation-triangle text-error"></i> Villa'
      };
      el.innerHTML = messages[status] || '';
    }

    function toggleSourcePanel() {
      isSourceVisible = !isSourceVisible;
      const panel = document.getElementById('source-panel');
      const content = document.getElementById('editor-content');

      if (isSourceVisible) {
        panel.style.display = 'block';
        content.classList.add('side-by-side');
      } else {
        panel.style.display = 'none';
        content.classList.remove('side-by-side');
      }
    }

    function toggleHistory() {
      const sidebar = document.getElementById('history-sidebar');
      const isVisible = sidebar.style.display !== 'none';

      // Close other sidebars
      document.getElementById('comments-sidebar').style.display = 'none';
      document.getElementById('decisions-sidebar').style.display = 'none';
      document.getElementById('issues-sidebar').style.display = 'none';
      document.getElementById('terminology-sidebar').style.display = 'none';
      document.getElementById('notes-sidebar').style.display = 'none';

      sidebar.style.display = isVisible ? 'none' : 'block';
    }

    // ========================================
    // PERSONAL NOTES
    // ========================================

    let currentNoteContent = '';
    let notePinned = false;

    function toggleNotes() {
      const sidebar = document.getElementById('notes-sidebar');
      const isVisible = sidebar.style.display !== 'none';

      // Close other sidebars
      document.getElementById('comments-sidebar').style.display = 'none';
      document.getElementById('decisions-sidebar').style.display = 'none';
      document.getElementById('issues-sidebar').style.display = 'none';
      document.getElementById('terminology-sidebar').style.display = 'none';
      document.getElementById('history-sidebar').style.display = 'none';

      sidebar.style.display = isVisible ? 'none' : 'block';

      if (!isVisible) {
        loadCurrentNote();
      }
    }

    async function loadCurrentNote() {
      if (!currentBook || !currentChapter || !currentSection) return;

      try {
        const res = await fetch(`/api/editor/${currentBook}/${currentChapter}/${currentSection}/notes`);
        const data = await res.json();

        const textarea = document.getElementById('notes-textarea');
        textarea.value = data.note.content || '';
        currentNoteContent = data.note.content || '';
        notePinned = data.note.pinned || false;

        updatePinButton();
        updateNotesIndicator();
      } catch (err) {
        console.error('Error loading note:', err);
      }
    }

    async function saveNote() {
      if (!currentBook || !currentChapter || !currentSection) return;

      const textarea = document.getElementById('notes-textarea');
      const content = textarea.value;

      updateNotesSaveStatus('saving');

      try {
        const res = await fetch(`/api/editor/${currentBook}/${currentChapter}/${currentSection}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, pinned: notePinned })
        });

        const data = await res.json();

        if (data.success) {
          currentNoteContent = content;
          updateNotesSaveStatus('saved');
          updateNotesIndicator();
          showToast('Minnispunktur vista√∞ur', 'success');
        } else {
          updateNotesSaveStatus('error');
          showToast('Villa vi√∞ a√∞ vista minnispunkt', 'error');
        }
      } catch (err) {
        console.error('Error saving note:', err);
        updateNotesSaveStatus('error');
        showToast('Villa vi√∞ a√∞ vista minnispunkt', 'error');
      }
    }

    async function deleteNote() {
      if (!currentBook || !currentChapter || !currentSection) return;

      if (!confirm('Ertu viss um a√∞ √æ√∫ viljir ey√∞a √æessum minnispunkti?')) return;

      try {
        const res = await fetch(`/api/editor/${currentBook}/${currentChapter}/${currentSection}/notes`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (data.success) {
          document.getElementById('notes-textarea').value = '';
          currentNoteContent = '';
          notePinned = false;
          updatePinButton();
          updateNotesIndicator();
          showToast('Minnispunkti eytt', 'success');
        }
      } catch (err) {
        console.error('Error deleting note:', err);
        showToast('Villa vi√∞ a√∞ ey√∞a minnispunkti', 'error');
      }
    }

    async function togglePinNote() {
      if (!currentBook || !currentChapter || !currentSection) return;

      // Save first if there's content
      const textarea = document.getElementById('notes-textarea');
      if (textarea.value.trim()) {
        notePinned = !notePinned;
        await saveNote();
        updatePinButton();
      }
    }

    function updatePinButton() {
      const btn = document.getElementById('pin-note-btn');
      if (notePinned) {
        btn.classList.add('active');
        btn.title = 'Losa minnispunkt';
      } else {
        btn.classList.remove('active');
        btn.title = 'Festa minnispunkt';
      }
    }

    function updateNotesIndicator() {
      const indicator = document.getElementById('notes-indicator');
      const hasNote = currentNoteContent && currentNoteContent.trim().length > 0;
      indicator.style.display = hasNote ? 'inline' : 'none';
    }

    function updateNotesSaveStatus(status) {
      const el = document.getElementById('notes-save-status');
      const messages = {
        saving: '<i class="fas fa-spinner fa-spin"></i> Vistar...',
        saved: '<i class="fas fa-check"></i> Vista√∞',
        error: '<i class="fas fa-exclamation-triangle"></i> Villa'
      };
      el.innerHTML = messages[status] || '';

      if (status === 'saved') {
        setTimeout(() => { el.innerHTML = ''; }, 2000);
      }
    }

    async function toggleAllNotes() {
      const list = document.getElementById('notes-all-list');
      const icon = document.getElementById('notes-expand-icon');
      const isVisible = list.style.display !== 'none';

      if (isVisible) {
        list.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      } else {
        list.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        loadAllNotes();
      }
    }

    async function loadAllNotes() {
      const list = document.getElementById('notes-all-list');
      list.innerHTML = '<p class="loading">Hle√∞ur...</p>';

      try {
        const res = await fetch('/api/editor/notes/all');
        const data = await res.json();

        if (data.notes.length === 0) {
          list.innerHTML = '<p class="text-muted center">Engir minnispunktar</p>';
          return;
        }

        list.innerHTML = data.notes.map(note => {
          const date = new Date(note.updatedAt).toLocaleDateString('is-IS');
          const preview = note.content.substring(0, 60) + (note.content.length > 60 ? '...' : '');
          const pinIcon = note.pinned ? '<i class="fas fa-thumbtack text-primary"></i> ' : '';

          return `
            <div class="note-item" onclick="goToNoteSection('${note.book}', '${note.chapter}', '${note.section}')">
              <div class="note-item-header">
                ${pinIcon}
                <span class="note-location">K${note.chapter} / ${note.section}</span>
                <span class="note-date">${date}</span>
              </div>
              <div class="note-preview">${escapeHtml(preview)}</div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading all notes:', err);
        list.innerHTML = '<p class="text-error center">Villa vi√∞ a√∞ hla√∞a minnispunktum</p>';
      }
    }

    function goToNoteSection(book, chapter, section) {
      // Update URL and load section
      const url = new URL(window.location);
      url.searchParams.set('book', book);
      url.searchParams.set('chapter', chapter);
      url.searchParams.set('section', section);
      window.history.pushState({}, '', url);

      document.getElementById('book-select').value = book;
      loadChapters(book).then(() => {
        document.getElementById('chapter-select').value = chapter;
        loadSections(book, chapter).then(() => {
          loadEditor(book, chapter, section);
        });
      });

      // Close notes sidebar
      document.getElementById('notes-sidebar').style.display = 'none';
    }

    async function loadHistory(book, chapter, section) {
      const listEl = document.getElementById('history-list');
      listEl.innerHTML = '<p>Hle√∞ur...</p>';

      try {
        const res = await fetch('/api/editor/' + book + '/' + chapter + '/' + section + '/history');
        const data = await res.json();

        if (data.history.length === 0) {
          listEl.innerHTML = '<p class="text-muted">Engin saga enn.</p>';
          return;
        }

        listEl.innerHTML = data.history.map(h => {
          const date = new Date(h.createdAt).toLocaleString('is-IS');
          const typeLabel = h.isSubmission ? '<span class="badge badge-primary">Sent</span>' : '';
          return '<div class="history-item" data-id="' + h.id + '">' +
            '<div class="history-meta">' +
            '<span class="history-user">' + escapeHtml(h.username) + '</span>' +
            '<span class="history-date">' + date + '</span>' +
            typeLabel +
            '</div>' +
            '<button class="btn btn-secondary btn-small" onclick="restoreVersion(' + h.id + ')">Endurheimta</button>' +
            '</div>';
        }).join('');
      } catch (err) {
        listEl.innerHTML = '<p class="text-error">Villa: ' + err.message + '</p>';
      }
    }

    async function restoreVersion(historyId) {
      if (!confirm('Ertu viss um a√∞ √æ√∫ viljir endurheimta √æessa √∫tg√°fu? N√∫verandi breytingar munu tapast.')) {
        return;
      }

      try {
        const res = await fetch('/api/editor/' + currentBook + '/' + currentChapter + '/' + currentSection + '/restore/' + historyId, {
          method: 'POST'
        });
        const data = await res.json();

        if (data.success) {
          // Reload the editor
          await loadEditor(currentBook, currentChapter, currentSection);
          alert('√ötg√°fa endurheimtu!');
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki endurheimtu'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    function showSectionSelector() {
      document.getElementById('section-selector').style.display = 'block';
      document.getElementById('editor-container').style.display = 'none';

      // Clear URL params
      const url = new URL(window.location);
      url.searchParams.delete('section');
      window.history.pushState({}, '', url);

      // Stop presence tracking
      stopPresenceTracking();

      // Destroy editor
      if (editor) {
        editor.toTextArea();
        editor = null;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================
    // TERMINOLOGY LOOKUP
    // ========================================

    // ========================================
    // SPELL CHECK
    // ========================================

    let spellCheckEnabled = localStorage.getItem('spellCheckEnabled') !== 'false';

    function setupSpellCheck() {
      if (!editor || !editor.codemirror) return;

      const cm = editor.codemirror;

      // Get the CodeMirror wrapper element
      const cmWrapper = cm.getWrapperElement();

      // Enable spell checking on the editor
      if (spellCheckEnabled) {
        enableSpellCheck(cmWrapper);
      }

      // Update the UI indicator
      updateSpellCheckIndicator();
    }

    function enableSpellCheck(cmWrapper) {
      // Set language to Icelandic for browser spell checking
      cmWrapper.setAttribute('lang', 'is');
      cmWrapper.setAttribute('spellcheck', 'true');

      // Also set on the lines element for contenteditable mode
      const lines = cmWrapper.querySelector('.CodeMirror-lines');
      if (lines) {
        lines.setAttribute('lang', 'is');
        lines.setAttribute('spellcheck', 'true');
      }

      // For textarea fallback
      const textarea = cmWrapper.querySelector('textarea');
      if (textarea) {
        textarea.setAttribute('lang', 'is');
        textarea.setAttribute('spellcheck', 'true');
      }
    }

    function disableSpellCheck(cmWrapper) {
      cmWrapper.setAttribute('spellcheck', 'false');
      const lines = cmWrapper.querySelector('.CodeMirror-lines');
      if (lines) {
        lines.setAttribute('spellcheck', 'false');
      }
      const textarea = cmWrapper.querySelector('textarea');
      if (textarea) {
        textarea.setAttribute('spellcheck', 'false');
      }
    }

    function toggleSpellCheck() {
      spellCheckEnabled = !spellCheckEnabled;
      localStorage.setItem('spellCheckEnabled', spellCheckEnabled);

      if (editor && editor.codemirror) {
        const cmWrapper = editor.codemirror.getWrapperElement();
        if (spellCheckEnabled) {
          enableSpellCheck(cmWrapper);
          showToast('Stafsetningarleit virkju√∞', 'success');
        } else {
          disableSpellCheck(cmWrapper);
          showToast('Stafsetningarleit √≥virkju√∞', 'info');
        }
      }

      updateSpellCheckIndicator();
    }

    function updateSpellCheckIndicator() {
      const btn = document.getElementById('spell-check-btn');
      if (btn) {
        btn.classList.toggle('active', spellCheckEnabled);
        btn.title = spellCheckEnabled
          ? 'Stafsetningarleit virk (smelltu til a√∞ sl√∂kkva)'
          : 'Stafsetningarleit √≥virk (smelltu til a√∞ virkja)';
      }
    }

    // ========================================
    // TERMINOLOGY LOOKUP
    // ========================================

    let terminologyTimer = null;
    let lastTermQuery = '';
    let lastCursorCoords = null;

    function setupTerminologyLookup() {
      if (!editor || !editor.codemirror) return;

      const cm = editor.codemirror;

      // Listen for cursor activity (selection changes)
      cm.on('cursorActivity', () => {
        clearTimeout(terminologyTimer);
        // Only auto-lookup after a brief pause when selecting
        if (cm.somethingSelected()) {
          terminologyTimer = setTimeout(() => checkForTerminology(false), 800);
        }
      });

      // Listen for double-click to select word - more immediate
      cm.on('dblclick', (cm, event) => {
        // Store cursor position for positioning the panel
        storeCursorPosition();
        setTimeout(() => checkForTerminology(true), 50);
      });

      // Add keyboard shortcut Ctrl+T for manual lookup
      cm.setOption('extraKeys', {
        ...cm.getOption('extraKeys'),
        'Ctrl-T': function(cm) {
          const selection = cm.getSelection().trim();
          if (selection) {
            storeCursorPosition();
            checkForTerminology(true);
          } else {
            // Prompt for manual search if nothing selected
            openManualTerminologySearch();
          }
        }
      });

      // Close panel on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const panel = document.getElementById('terminology-panel');
          if (panel.style.display !== 'none') {
            hideTerminologyPanel();
            cm.focus();
          }
        }
      });

      // Close panel when clicking outside
      document.addEventListener('click', (e) => {
        const panel = document.getElementById('terminology-panel');
        if (panel.style.display !== 'none' && !panel.contains(e.target)) {
          // Don't close if clicking in the editor (user might be selecting)
          const editorEl = document.querySelector('.EasyMDEContainer');
          if (!editorEl || !editorEl.contains(e.target)) {
            hideTerminologyPanel();
          }
        }
      });
    }

    function storeCursorPosition() {
      if (!editor || !editor.codemirror) return;
      const cm = editor.codemirror;
      const cursor = cm.getCursor();
      lastCursorCoords = cm.cursorCoords(cursor, 'page');
    }

    function checkForTerminology(immediate = false) {
      if (!editor || !editor.codemirror) return;

      const cm = editor.codemirror;
      const selection = cm.getSelection().trim();

      // Only lookup if selection is 2-50 characters and looks like a word/phrase
      if (selection.length < 2 || selection.length > 50 || /[\n\r]/.test(selection)) {
        if (!immediate) hideTerminologyPanel();
        return;
      }

      // Don't repeat the same query unless forced
      if (!immediate && selection === lastTermQuery) return;
      lastTermQuery = selection;

      lookupTerminology(selection);
    }

    async function lookupTerminology(query) {
      const panel = document.getElementById('terminology-panel');
      const resultsEl = document.getElementById('terminology-results');
      const queryEl = document.getElementById('terminology-query');

      queryEl.textContent = '"' + query + '"';
      resultsEl.innerHTML = '<p class="loading"><i class="fas fa-spinner"></i> Leita...</p>';

      // Position panel near cursor
      positionTerminologyPanel();
      panel.style.display = 'block';
      panel.classList.remove('hiding');

      try {
        const res = await fetch('/api/terminology/lookup?q=' + encodeURIComponent(query));
        const data = await res.json();

        if (data.terms && data.terms.length > 0) {
          resultsEl.innerHTML = data.terms.map((term, index) => `
            <div class="term-result" data-icelandic="${escapeHtml(term.icelandic)}">
              <div class="term-main">
                <span class="term-english">${escapeHtml(term.english)}</span>
                <span class="term-arrow">‚Üí</span>
                <span class="term-icelandic">${escapeHtml(term.icelandic)}</span>
              </div>
              <div class="term-meta">
                <span class="term-status status-${term.status}">${formatTermStatus(term.status)}</span>
                ${term.category ? '<span class="term-category">' + escapeHtml(term.category) + '</span>' : ''}
              </div>
              ${term.notes ? '<div class="term-notes">' + escapeHtml(term.notes) + '</div>' : ''}
              <div class="term-actions">
                <button class="btn-insert" onclick="insertTerm('${escapeHtml(term.icelandic)}')">
                  <i class="fas fa-check"></i> Setja inn
                </button>
                <button class="btn-copy" onclick="copyTerm(this, '${escapeHtml(term.icelandic)}')">
                  <i class="fas fa-copy"></i> Afrita
                </button>
              </div>
            </div>
          `).join('');
        } else {
          resultsEl.innerHTML = `
            <div class="no-results">
              <i class="fas fa-search"></i>
              <p>Ekkert hugtak fannst fyrir ‚Äû${escapeHtml(query)}"</p>
              <span class="propose-link" onclick="proposeNewTerm()">
                <i class="fas fa-plus"></i> Leggja til n√Ωtt hugtak
              </span>
            </div>
          `;
        }
      } catch (err) {
        resultsEl.innerHTML = '<p class="error"><i class="fas fa-exclamation-circle"></i> Villa vi√∞ leit</p>';
      }
    }

    function positionTerminologyPanel() {
      const panel = document.getElementById('terminology-panel');

      if (lastCursorCoords) {
        // Position below and to the right of the cursor
        const panelWidth = 380;
        const panelHeight = 400;
        const padding = 10;

        let left = lastCursorCoords.left;
        let top = lastCursorCoords.bottom + padding;

        // Make sure panel stays within viewport
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        if (left + panelWidth > viewportWidth - padding) {
          left = viewportWidth - panelWidth - padding;
        }
        if (left < padding) left = padding;

        if (top + panelHeight > viewportHeight - padding) {
          // Show above the cursor instead
          top = lastCursorCoords.top - panelHeight - padding;
          if (top < padding) top = padding;
        }

        panel.style.left = left + 'px';
        panel.style.top = top + 'px';
        panel.style.right = 'auto';
        panel.style.bottom = 'auto';
      } else {
        // Fallback: position in bottom-right corner
        panel.style.left = 'auto';
        panel.style.top = 'auto';
        panel.style.right = '20px';
        panel.style.bottom = '20px';
      }
    }

    function insertTerm(icelandicTerm) {
      if (!editor || !editor.codemirror) return;

      const cm = editor.codemirror;
      cm.replaceSelection(icelandicTerm);
      hideTerminologyPanel();
      cm.focus();

      // Show brief success indicator
      showToast('Or√∞ sett inn', 'success');
    }

    function copyTerm(button, icelandicTerm) {
      navigator.clipboard.writeText(icelandicTerm).then(() => {
        button.classList.add('copied');
        button.innerHTML = '<i class="fas fa-check"></i> Afrita√∞!';
        setTimeout(() => {
          button.classList.remove('copied');
          button.innerHTML = '<i class="fas fa-copy"></i> Afrita';
        }, 1500);
      }).catch(() => {
        showToast('Gat ekki afrita√∞', 'error');
      });
    }

    function hideTerminologyPanel() {
      const panel = document.getElementById('terminology-panel');
      panel.classList.add('hiding');
      setTimeout(() => {
        panel.style.display = 'none';
        panel.classList.remove('hiding');
      }, 150);
      lastTermQuery = '';
    }

    function openManualTerminologySearch() {
      const query = prompt('Sl√°√∞u inn or√∞ til a√∞ leita √≠ or√∞asafni:');
      if (query && query.trim()) {
        lastTermQuery = '';
        storeCursorPosition();
        lookupTerminology(query.trim());
      }
    }

    function formatTermStatus(status) {
      const names = {
        'approved': 'Sam√æykkt',
        'proposed': '√ç bi√∞',
        'disputed': 'Til umr√¶√∞u'
      };
      return names[status] || status;
    }

    function proposeNewTerm() {
      const queryEl = document.getElementById('terminology-query');
      const query = queryEl.textContent.replace(/"/g, '');

      document.getElementById('propose-english').value = query;
      document.getElementById('propose-icelandic').value = '';
      document.getElementById('propose-notes').value = '';
      document.getElementById('propose-term-modal').style.display = 'flex';
      hideTerminologyPanel();
    }

    function closeProposalModal() {
      document.getElementById('propose-term-modal').style.display = 'none';
    }

    async function submitTermProposal() {
      const english = document.getElementById('propose-english').value.trim();
      const icelandic = document.getElementById('propose-icelandic').value.trim();
      const notes = document.getElementById('propose-notes').value.trim();

      if (!english || !icelandic) {
        showToast('Enska og √≠slenska eru nau√∞synleg', 'error');
        return;
      }

      try {
        const res = await fetch('/api/terminology', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            english,
            icelandic,
            notes: notes || undefined,
            category: 'other',
            source: 'manual'
          })
        });

        const data = await res.json();

        if (data.success || data.term) {
          showToast('Or√∞ b√¶tt vi√∞ √≠ bi√∞ eftir sam√æykki!', 'success');
          closeProposalModal();
        } else {
          showToast('Villa: ' + (data.message || 'Gat ekki b√¶tt vi√∞ or√∞i'), 'error');
        }
      } catch (err) {
        showToast('Villa: ' + err.message, 'error');
      }
    }

    // Toast notification helper
    function showToast(message, type = 'info') {
      // Check if toast container exists, create if not
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px;';
        document.body.appendChild(toastContainer);
      }

      const toast = document.createElement('div');
      const colors = {
        success: 'background: #dcfce7; color: #166534; border-color: #86efac;',
        error: 'background: #fee2e2; color: #991b1b; border-color: #fca5a5;',
        info: 'background: #dbeafe; color: #1e40af; border-color: #93c5fd;'
      };
      toast.style.cssText = `
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: toastIn 0.2s ease-out;
        ${colors[type] || colors.info}
      `;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toastOut 0.2s ease-in forwards';
        setTimeout(() => toast.remove(), 200);
      }, 2500);
    }

    // ========================================
    // FEEDBACK BANNER
    // ========================================

    let feedbackDismissed = false;

    function showRecentFeedback(feedback) {
      const feedbackAlert = document.getElementById('feedback-alert');

      if (!feedback || feedbackDismissed) {
        feedbackAlert.style.display = 'none';
        return;
      }

      // Format the date
      const reviewedAt = new Date(feedback.reviewedAt);
      const dateStr = reviewedAt.toLocaleDateString('is-IS');
      const timeStr = reviewedAt.toLocaleTimeString('is-IS', { hour: '2-digit', minute: '2-digit' });

      // Set metadata
      document.getElementById('feedback-meta').textContent =
        '‚Äî ' + feedback.reviewedBy + ' ‚Ä¢ ' + dateStr + ' ' + timeStr;

      // Set notes
      const notesEl = document.getElementById('feedback-notes');
      if (feedback.notes) {
        notesEl.innerHTML = '<p>' + escapeHtml(feedback.notes).replace(/\n/g, '<br>') + '</p>';
      } else {
        notesEl.innerHTML = '<p class="text-muted"><em>Engar athugasemdir skr√°√∞ar</em></p>';
      }

      feedbackAlert.style.display = 'block';
    }

    function dismissFeedback() {
      feedbackDismissed = true;
      document.getElementById('feedback-alert').style.display = 'none';
    }

    // ========================================
    // SPLIT FILE INDICATOR
    // ========================================

    let currentSplitInfo = null;

    /**
     * Update the split indicator based on API response
     * @param {object|null} splitInfo - Split info from API
     */
    function updateSplitIndicator(splitInfo) {
      const indicator = document.getElementById('split-indicator');
      currentSplitInfo = splitInfo;

      if (!splitInfo) {
        indicator.style.display = 'none';
        return;
      }

      // Show the indicator
      indicator.style.display = 'flex';

      // Update badge text
      const badge = document.getElementById('split-badge');
      badge.textContent = `Hluti ${splitInfo.partNumber} af ${splitInfo.totalParts}`;

      // Update navigation buttons
      const prevBtn = document.getElementById('split-prev');
      const nextBtn = document.getElementById('split-next');

      // Find current part index
      const currentIdx = splitInfo.parts.findIndex(p => p.section === currentSection);

      // Enable/disable prev button
      if (currentIdx > 0) {
        prevBtn.disabled = false;
        prevBtn.onclick = () => {
          const prevPart = splitInfo.parts[currentIdx - 1];
          loadEditor(currentBook, currentChapter, prevPart.section);
        };
      } else {
        prevBtn.disabled = true;
        prevBtn.onclick = null;
      }

      // Enable/disable next button
      if (currentIdx < splitInfo.parts.length - 1) {
        nextBtn.disabled = false;
        nextBtn.onclick = () => {
          const nextPart = splitInfo.parts[currentIdx + 1];
          loadEditor(currentBook, currentChapter, nextPart.section);
        };
      } else {
        nextBtn.disabled = true;
        nextBtn.onclick = null;
      }

      // Update info button
      document.getElementById('split-info-btn').onclick = showSplitInfoModal;
    }

    /**
     * Show the split info modal with explanation
     */
    function showSplitInfoModal() {
      if (!currentSplitInfo) return;

      const list = document.getElementById('split-parts-list');
      list.innerHTML = currentSplitInfo.parts.map(part => {
        const isCurrent = part.section === currentSection;
        const statusLabel = part.source === 'faithful' ? 'Breytt' : 'MT √∫ttak';
        const statusClass = part.source === 'faithful' ? 'faithful' : 'mt-output';

        return `
          <li class="${isCurrent ? 'current' : ''}">
            <span class="part-name">
              <i class="fas ${isCurrent ? 'fa-edit' : 'fa-file-alt'}"></i>
              ${part.section} (hluti ${part.partNumber})
            </span>
            <span class="part-status ${statusClass}">${statusLabel}</span>
            ${!isCurrent ? `<button class="btn btn-secondary btn-small" onclick="loadEditor('${currentBook}', '${currentChapter}', '${part.section}'); closeSplitInfoModal();">Opna</button>` : ''}
          </li>
        `;
      }).join('');

      document.getElementById('split-info-modal').style.display = 'flex';
    }

    /**
     * Close the split info modal
     */
    function closeSplitInfoModal() {
      document.getElementById('split-info-modal').style.display = 'none';
    }

    // Close modal on click outside
    document.getElementById('split-info-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'split-info-modal') {
        closeSplitInfoModal();
      }
    });

    // ========================================
    // GUIDANCE PANEL
    // ========================================

    let guidanceCollapsed = false;
    let currentStage = 'default';

    function toggleGuidance() {
      guidanceCollapsed = !guidanceCollapsed;
      const content = document.getElementById('guidance-content');
      const toggle = document.getElementById('guidance-toggle');

      if (guidanceCollapsed) {
        content.classList.add('collapsed');
        toggle.classList.add('collapsed');
      } else {
        content.classList.remove('collapsed');
        toggle.classList.remove('collapsed');
      }
    }

    function setGuidanceStage(stage) {
      currentStage = stage;

      // Hide all stages
      document.querySelectorAll('.guidance-stage').forEach(el => {
        el.style.display = 'none';
        el.classList.remove('active');
      });

      // Show appropriate stage
      const stageEl = document.getElementById('guidance-' + stage);
      if (stageEl) {
        stageEl.style.display = 'block';
        stageEl.classList.add('active');
      }

      // Update title
      const titles = {
        'pass1': 'Yfirfer√∞ 1 - Tungum√°lalei√∞r√©tting',
        'pass2': 'Yfirfer√∞ 2 - Sta√∞f√¶ring',
        'default': 'Lei√∞beiningar'
      };
      document.getElementById('guidance-stage-title').textContent = titles[stage] || titles.default;
    }

    function detectStage(data) {
      // Check URL params for explicit stage
      const params = new URLSearchParams(window.location.search);
      const stageParam = params.get('stage');

      if (stageParam === 'pass1' || stageParam === 'linguistic') {
        return 'pass1';
      }
      if (stageParam === 'pass2' || stageParam === 'localization') {
        return 'pass2';
      }

      // Detect from data source
      if (data && data.source) {
        if (data.source === 'mt-output' || data.source === '02-mt-output') {
          return 'pass1'; // Working on MT output = Pass 1
        }
        if (data.source === 'faithful' || data.source === '03-faithful') {
          return 'pass2'; // Working on faithful = Pass 2
        }
      }

      return 'default';
    }

    async function checkAssignment(book, chapter, section) {
      try {
        const res = await fetch('/api/workflow/assignments/mine');
        const data = await res.json();

        const assignment = data.assignments.find(a =>
          a.book === book &&
          a.chapter === parseInt(chapter)
        );

        if (assignment) {
          const banner = document.getElementById('assignment-banner');
          const stageLabels = {
            'linguisticReview': 'Yfirfer√∞ 1',
            'editorialPass2': 'Yfirfer√∞ 2',
            'publication': '√ötg√°fa'
          };
          const stageLabel = stageLabels[assignment.stage] || assignment.stage;

          let dueDateText = '';
          if (assignment.dueDate) {
            const dueDate = new Date(assignment.dueDate);
            const now = new Date();
            const daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
            const dateStr = dueDate.toLocaleDateString('is-IS');

            if (daysUntil < 0) {
              const daysOverdue = Math.abs(daysUntil);
              dueDateText = ` <span class="due-overdue">(${daysOverdue} ${daysOverdue === 1 ? 'dagur' : 'dagar'} yfir t√≠ma!)</span>`;
            } else if (daysUntil === 0) {
              dueDateText = ` <span class="due-today">(√≠ dag!)</span>`;
            } else if (daysUntil <= 3) {
              dueDateText = ` <span class="due-soon">(${daysUntil} ${daysUntil === 1 ? 'dagur' : 'dagar'} eftir)</span>`;
            } else {
              dueDateText = ` (skiladagur: ${dateStr})`;
            }
          }

          document.getElementById('assignment-text').innerHTML =
            `√û√©r hefur veri√∞ √∫thluta√∞ √æessum kafla fyrir ${stageLabel}${dueDateText}`;
          banner.style.display = 'flex';

          // Set guidance based on assignment
          if (assignment.stage === 'linguisticReview' || assignment.stage === 'editorialPass1') {
            setGuidanceStage('pass1');
          } else if (assignment.stage === 'editorialPass2') {
            setGuidanceStage('pass2');
          }
        }
      } catch (err) {
        // Assignment check failed, continue without
        console.log('Could not check assignments:', err);
      }
    }

    // ========================================
    // UNIT CONVERTER (Pass 2)
    // ========================================

    const UNIT_CONVERSIONS = {
      temperature: {
        units: [
          { id: 'F', name: '¬∞F (Fahrenheit)' },
          { id: 'C', name: '¬∞C (Celsius)' },
          { id: 'K', name: 'K (Kelvin)' }
        ],
        convert: (val, from, to) => {
          if (from === to) return val;
          // Convert to Celsius first
          let celsius = from === 'F' ? (val - 32) * 5/9 :
                        from === 'K' ? val - 273.15 : val;
          // Convert from Celsius to target
          return to === 'F' ? celsius * 9/5 + 32 :
                 to === 'K' ? celsius + 273.15 : celsius;
        }
      },
      length: {
        units: [
          { id: 'mi', name: 'm√≠la (US)' },
          { id: 'km', name: 'km' },
          { id: 'ft', name: 'fet' },
          { id: 'm', name: 'm' },
          { id: 'in', name: 'tommur' },
          { id: 'cm', name: 'cm' }
        ],
        convert: (val, from, to) => {
          const toMeters = { mi: 1609.34, km: 1000, ft: 0.3048, m: 1, in: 0.0254, cm: 0.01 };
          const meters = val * toMeters[from];
          return meters / toMeters[to];
        }
      },
      mass: {
        units: [
          { id: 'lb', name: 'pund' },
          { id: 'kg', name: 'kg' },
          { id: 'oz', name: '√∫nsur' },
          { id: 'g', name: 'g' }
        ],
        convert: (val, from, to) => {
          const toGrams = { lb: 453.592, kg: 1000, oz: 28.3495, g: 1 };
          const grams = val * toGrams[from];
          return grams / toGrams[to];
        }
      },
      volume: {
        units: [
          { id: 'gal', name: 'gallon (US)' },
          { id: 'L', name: 'L' },
          { id: 'qt', name: 'kvart' },
          { id: 'mL', name: 'mL' },
          { id: 'fl_oz', name: 'fl oz' }
        ],
        convert: (val, from, to) => {
          const toML = { gal: 3785.41, L: 1000, qt: 946.353, mL: 1, fl_oz: 29.5735 };
          const mL = val * toML[from];
          return mL / toML[to];
        }
      },
      pressure: {
        units: [
          { id: 'atm', name: 'atm' },
          { id: 'psi', name: 'psi' },
          { id: 'bar', name: 'bar' },
          { id: 'Pa', name: 'Pa' },
          { id: 'mmHg', name: 'mmHg' }
        ],
        convert: (val, from, to) => {
          const toPa = { atm: 101325, psi: 6894.76, bar: 100000, Pa: 1, mmHg: 133.322 };
          const pa = val * toPa[from];
          return pa / toPa[to];
        }
      }
    };

    function showUnitConverter() {
      updateUnitOptions();
      document.getElementById('unit-converter-modal').style.display = 'flex';
    }

    function closeUnitConverter() {
      document.getElementById('unit-converter-modal').style.display = 'none';
    }

    function updateUnitOptions() {
      const type = document.getElementById('unit-type').value;
      const units = UNIT_CONVERSIONS[type].units;
      const fromSelect = document.getElementById('unit-from');
      const toSelect = document.getElementById('unit-to');

      fromSelect.innerHTML = units.map((u, i) =>
        `<option value="${u.id}" ${i === 0 ? 'selected' : ''}>${u.name}</option>`
      ).join('');

      toSelect.innerHTML = units.map((u, i) =>
        `<option value="${u.id}" ${i === 1 ? 'selected' : ''}>${u.name}</option>`
      ).join('');

      document.getElementById('unit-from-value').value = '';
      document.getElementById('unit-to-value').value = '';
      document.getElementById('conversion-preview').style.display = 'none';
      document.getElementById('insert-conversion-btn').disabled = true;
    }

    function calculateConversion() {
      const type = document.getElementById('unit-type').value;
      const fromVal = parseFloat(document.getElementById('unit-from-value').value);
      const fromUnit = document.getElementById('unit-from').value;
      const toUnit = document.getElementById('unit-to').value;

      if (isNaN(fromVal)) {
        document.getElementById('unit-to-value').value = '';
        document.getElementById('conversion-preview').style.display = 'none';
        document.getElementById('insert-conversion-btn').disabled = true;
        return;
      }

      const result = UNIT_CONVERSIONS[type].convert(fromVal, fromUnit, toUnit);
      const rounded = Math.round(result * 100) / 100;
      document.getElementById('unit-to-value').value = rounded;

      // Format for insertion
      const unitSymbols = { F: '¬∞F', C: '¬∞C', K: 'K', mi: ' m√≠la', km: ' km', ft: ' fet', m: ' m', in: ' tommur', cm: ' cm', lb: ' pund', kg: ' kg', oz: ' √∫nsur', g: ' g', gal: ' gallon', L: ' L', qt: ' kvart', mL: ' mL', fl_oz: ' fl oz', atm: ' atm', psi: ' psi', bar: ' bar', Pa: ' Pa', mmHg: ' mmHg' };

      const insertText = rounded + (unitSymbols[toUnit] || ' ' + toUnit);
      document.getElementById('conversion-insert-text').textContent = insertText;
      document.getElementById('conversion-preview').style.display = 'block';
      document.getElementById('insert-conversion-btn').disabled = false;

      // Store for insertion
      window.conversionToInsert = insertText;
    }

    function insertConversion() {
      if (!editor || !window.conversionToInsert) return;

      editor.codemirror.replaceSelection(window.conversionToInsert);
      editor.codemirror.focus();
      closeUnitConverter();
    }

    // ========================================
    // LOCALIZATION LOG (Pass 2)
    // ========================================

    let localizationLog = [];

    function showLocalizationLog() {
      renderLocLogList();
      document.getElementById('localization-log-modal').style.display = 'flex';
    }

    function closeLocalizationLog() {
      document.getElementById('localization-log-modal').style.display = 'none';
    }

    function addLocLogEntry() {
      const type = document.getElementById('loc-log-type').value;
      const original = document.getElementById('loc-log-original').value.trim();
      const localized = document.getElementById('loc-log-localized').value.trim();
      const reason = document.getElementById('loc-log-reason').value.trim();

      if (!original || !localized) {
        alert('Upprunalegt og sta√∞f√¶rt gildi eru nau√∞synleg');
        return;
      }

      localizationLog.push({
        id: Date.now(),
        type,
        original,
        localized,
        reason,
        timestamp: new Date().toISOString()
      });

      // Clear form
      document.getElementById('loc-log-original').value = '';
      document.getElementById('loc-log-localized').value = '';
      document.getElementById('loc-log-reason').value = '';

      updateLocLogCount();
      renderLocLogList();
    }

    function removeLocLogEntry(id) {
      localizationLog = localizationLog.filter(e => e.id !== id);
      updateLocLogCount();
      renderLocLogList();
    }

    function updateLocLogCount() {
      const countEl = document.getElementById('loc-log-count');
      if (countEl) {
        countEl.textContent = localizationLog.length;
      }
    }

    function renderLocLogList() {
      const container = document.getElementById('loc-log-list');

      if (localizationLog.length === 0) {
        container.innerHTML = '<p class="text-muted center">Engar skr√°ningar enn</p>';
        return;
      }

      const typeLabels = {
        unit: 'üìê Eining',
        cultural: 'üåç Menning',
        example: 'üìù D√¶mi',
        reference: 'üîó Tilv√≠sun',
        other: 'üìå Anna√∞'
      };

      container.innerHTML = localizationLog.map(entry => `
        <div class="loc-log-entry">
          <div class="loc-log-entry-header">
            <span class="loc-log-type">${typeLabels[entry.type] || entry.type}</span>
            <button class="btn-close btn-small" onclick="removeLocLogEntry(${entry.id})">&times;</button>
          </div>
          <div class="loc-log-change">
            <span class="loc-log-original">${escapeHtml(entry.original)}</span>
            <span class="loc-log-arrow">‚Üí</span>
            <span class="loc-log-localized">${escapeHtml(entry.localized)}</span>
          </div>
          ${entry.reason ? '<div class="loc-log-reason">' + escapeHtml(entry.reason) + '</div>' : ''}
        </div>
      `).join('');
    }

    // ========================================
    // CHAPTER PROGRESS BAR (Enhanced)
    // ========================================

    let allSections = [];
    let currentSectionIndex = -1;

    async function loadSectionProgress(book, chapter, currentSectionName) {
      const progressEl = document.getElementById('chapter-progress');

      try {
        const res = await fetch('/api/editor/' + book + '/' + chapter);
        const data = await res.json();

        allSections = data.sections || [];

        if (allSections.length <= 1) {
          progressEl.style.display = 'none';
          return;
        }

        // Find current section index
        currentSectionIndex = allSections.findIndex(s => s.section === currentSectionName);
        if (currentSectionIndex === -1) currentSectionIndex = 0;

        // Count edited vs MT output
        const editedCount = allSections.filter(s => s.source === 'faithful').length;
        const totalCount = allSections.length;

        // Update chapter title
        document.getElementById('chapter-progress-title').textContent = 'Kafli ' + chapter;

        // Update summary
        const summaryEl = document.getElementById('chapter-progress-summary');
        summaryEl.textContent = editedCount + '/' + totalCount + ' hlutar kl√°rir';
        summaryEl.className = 'chapter-progress-summary' + (editedCount === totalCount ? ' all-complete' : '');

        // Generate section indicators bar
        const sectionsBar = document.getElementById('chapter-sections-bar');
        sectionsBar.innerHTML = allSections.map((section, idx) => {
          const isComplete = section.source === 'faithful';
          const isCurrent = idx === currentSectionIndex;
          const sectionLabel = section.section.replace('intro', 'Inng.').replace(/-/g, '.');

          return `
            <button class="section-chip ${isComplete ? 'complete' : ''} ${isCurrent ? 'current' : ''}"
                    onclick="navigateToSection(${idx})"
                    title="${section.section}: ${isComplete ? 'Yfirfari√∞' : 'V√©l√æ√Ω√∞ing'}">
              <span class="section-chip-label">${sectionLabel}</span>
              ${isComplete ? '<i class="fas fa-check"></i>' : ''}
            </button>
          `;
        }).join('');

        // Update display
        document.getElementById('current-section-num').textContent = currentSectionIndex + 1;
        document.getElementById('total-sections').textContent = totalCount;

        // Update status text
        const statusEl = document.getElementById('progress-status');
        if (editedCount === totalCount) {
          statusEl.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Allir hlutar kl√°rir</span>';
        } else {
          const progressPercent = Math.round((editedCount / totalCount) * 100);
          statusEl.textContent = progressPercent + '% kl√°r';
        }

        // Setup navigation buttons
        updateSectionNavButtons();

        document.getElementById('prev-section-btn').onclick = () => navigateSection(-1);
        document.getElementById('next-section-btn').onclick = () => navigateSection(1);

        progressEl.style.display = 'block';

      } catch (err) {
        console.log('Could not load section progress:', err);
        progressEl.style.display = 'none';
      }
    }

    function navigateToSection(index) {
      if (index < 0 || index >= allSections.length) return;
      if (index === currentSectionIndex) return;

      if (hasUnsavedChanges()) {
        if (!confirm('√û√∫ ert me√∞ √≥vista√∞ar breytingar. Viltu halda √°fram?')) {
          return;
        }
      }

      const targetSection = allSections[index];
      loadEditor(currentBook, currentChapter, targetSection.section);
    }

    function updateSectionNavButtons() {
      const prevBtn = document.getElementById('prev-section-btn');
      const nextBtn = document.getElementById('next-section-btn');

      prevBtn.disabled = currentSectionIndex <= 0;
      nextBtn.disabled = currentSectionIndex >= allSections.length - 1;

      // Add tooltips with section names
      if (currentSectionIndex > 0) {
        prevBtn.title = 'Fyrri hluti: ' + allSections[currentSectionIndex - 1].section;
      } else {
        prevBtn.title = 'Fyrri hluti';
      }

      if (currentSectionIndex < allSections.length - 1) {
        nextBtn.title = 'N√¶sti hluti: ' + allSections[currentSectionIndex + 1].section;
      } else {
        nextBtn.title = 'N√¶sti hluti';
      }
    }

    function navigateSection(direction) {
      if (hasUnsavedChanges()) {
        if (!confirm('√û√∫ ert me√∞ √≥vista√∞ar breytingar. Viltu halda √°fram √≠ n√¶sta hluta?')) {
          return;
        }
      }

      const newIndex = currentSectionIndex + direction;
      if (newIndex < 0 || newIndex >= allSections.length) return;

      const nextSection = allSections[newIndex];
      loadEditor(currentBook, currentChapter, nextSection.section);
    }

    // ========================================
    // ========================================
    // DECISION ENFORCEMENT
    // ========================================

    let decisionHighlights = [];

    async function loadDecisionHighlights(book, chapter) {
      try {
        const res = await fetch(`/api/decisions/highlights?book=${book}&chapter=${chapter}`);
        const data = await res.json();

        decisionHighlights = data.highlights || [];

        // Update badge in More menu if there are applicable decisions
        const decisionBadge = document.getElementById('decision-count-badge');
        if (decisionBadge && decisionHighlights.length > 0) {
          decisionBadge.textContent = decisionHighlights.length;
          decisionBadge.style.display = 'inline';
          updateMoreBadge();
        }

      } catch (err) {
        console.log('Could not load decision highlights:', err);
        decisionHighlights = [];
      }
    }

    // Check if content contains any decided terms
    function checkDecisionEnforcement(content) {
      if (!content || decisionHighlights.length === 0) return [];

      const contentLower = content.toLowerCase();
      const matches = [];

      for (const highlight of decisionHighlights) {
        // Look for the English term in the content (case-insensitive)
        const termRegex = new RegExp('\\b' + escapeRegexForSearch(highlight.termLower) + '\\b', 'gi');
        let match;

        while ((match = termRegex.exec(content)) !== null) {
          matches.push({
            term: highlight.term,
            icelandic: highlight.icelandic,
            position: match.index,
            length: match[0].length,
            decisions: highlight.decisions
          });
        }
      }

      return matches;
    }

    function escapeRegexForSearch(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Show decision tooltip for a matched term
    function showDecisionTooltip(match, element) {
      const tooltip = document.createElement('div');
      tooltip.className = 'decision-tooltip';

      const decision = match.decisions[0]; // Show the most recent decision

      tooltip.innerHTML = `
        <div class="decision-tooltip-header">
          <span class="decision-type-badge">${getDecisionTypeIcon(decision.type)}</span>
          √Åkv√∂r√∞un
        </div>
        <div class="decision-tooltip-term">
          <span class="en">${escapeHtml(match.term)}</span>
          <span class="arrow">‚Üí</span>
          <span class="is">${escapeHtml(match.icelandic || 'Engin √æ√Ω√∞ing')}</span>
        </div>
        <div class="decision-tooltip-rationale">${escapeHtml(decision.rationale || '')}</div>
        <div class="decision-tooltip-meta">
          ${escapeHtml(decision.decidedBy)} ¬∑ ${formatDate(decision.decidedAt)}
        </div>
      `;

      // Position the tooltip near the element
      const rect = element.getBoundingClientRect();
      tooltip.style.position = 'fixed';
      tooltip.style.left = rect.left + 'px';
      tooltip.style.top = (rect.bottom + 5) + 'px';
      tooltip.style.zIndex = '10000';

      document.body.appendChild(tooltip);

      // Remove tooltip on click outside or after timeout
      const removeTooltip = () => {
        if (tooltip.parentNode) {
          tooltip.parentNode.removeChild(tooltip);
        }
        document.removeEventListener('click', removeTooltip);
      };

      setTimeout(() => document.addEventListener('click', removeTooltip), 100);
      setTimeout(removeTooltip, 5000); // Auto-remove after 5 seconds
    }

    function getDecisionTypeIcon(type) {
      const icons = {
        terminology: 'üìñ',
        localization: 'üåç',
        style: '‚úçÔ∏è',
        issue: '‚úì'
      };
      return icons[type] || 'üìå';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('is-IS', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // ========================================
    // IN-EDITOR COMMENTS
    // ========================================

    let parsedComments = [];

    function toggleComments() {
      const sidebar = document.getElementById('comments-sidebar');
      const isVisible = sidebar.style.display !== 'none';

      // Close other sidebars
      document.getElementById('history-sidebar').style.display = 'none';
      document.getElementById('decisions-sidebar').style.display = 'none';
      document.getElementById('issues-sidebar').style.display = 'none';
      document.getElementById('terminology-sidebar').style.display = 'none';
      document.getElementById('notes-sidebar').style.display = 'none';

      sidebar.style.display = isVisible ? 'none' : 'block';

      if (!isVisible) {
        parseAndDisplayComments();
      }
    }

    function parseAndDisplayComments() {
      if (!editor) return;

      const content = editor.value();
      parsedComments = [];

      // Match HTML comment patterns: <!-- TYPE: text -->
      const commentRegex = /<!--\s*(ATHUGASEMD|SPURNING|TODO|ATHUGA|COMMENT|QUESTION):\s*([\s\S]*?)\s*-->/gi;

      let match;
      let lineNumber = 0;
      const lines = content.split('\n');
      let charIndex = 0;

      // Build a map of character positions to line numbers
      const lineStarts = [0];
      for (let i = 0; i < lines.length; i++) {
        lineStarts.push(lineStarts[i] + lines[i].length + 1);
      }

      while ((match = commentRegex.exec(content)) !== null) {
        // Find line number for this match
        const matchStart = match.index;
        let line = 0;
        for (let i = 0; i < lineStarts.length - 1; i++) {
          if (matchStart >= lineStarts[i] && matchStart < lineStarts[i + 1]) {
            line = i;
            break;
          }
        }

        const type = match[1].toUpperCase();
        const text = match[2].trim();

        // Normalize type
        const normalizedType = (type === 'COMMENT') ? 'ATHUGASEMD' :
                              (type === 'QUESTION') ? 'SPURNING' : type;

        parsedComments.push({
          type: normalizedType,
          text: text,
          line: line,
          start: match.index,
          end: match.index + match[0].length,
          fullMatch: match[0]
        });
      }

      updateCommentBadge();
      renderComments();
    }

    function updateCommentBadge() {
      const badge = document.getElementById('comment-count-badge');
      const count = parsedComments.length;

      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderComments() {
      const container = document.getElementById('comments-list');
      const showQuestions = document.getElementById('filter-questions').checked;
      const showComments = document.getElementById('filter-comments').checked;

      const filtered = parsedComments.filter(c => {
        if (c.type === 'SPURNING' && !showQuestions) return false;
        if (c.type !== 'SPURNING' && !showComments) return false;
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-muted center">Engar athugasemdir</p>';
        return;
      }

      const typeIcons = {
        'ATHUGASEMD': '<i class="fas fa-comment text-primary"></i>',
        'SPURNING': '<i class="fas fa-question-circle text-warning"></i>',
        'TODO': '<i class="fas fa-tasks text-info"></i>',
        'ATHUGA': '<i class="fas fa-exclamation-triangle text-error"></i>'
      };

      const typeLabels = {
        'ATHUGASEMD': 'Athugasemd',
        'SPURNING': 'Spurning',
        'TODO': 'Verkefni',
        'ATHUGA': 'Athuga'
      };

      container.innerHTML = filtered.map((comment, idx) => `
        <div class="comment-item" data-index="${parsedComments.indexOf(comment)}">
          <div class="comment-header">
            <span class="comment-type ${comment.type.toLowerCase()}">
              ${typeIcons[comment.type] || ''} ${typeLabels[comment.type] || comment.type}
            </span>
            <span class="comment-line">L√≠na ${comment.line + 1}</span>
          </div>
          <div class="comment-text">${escapeHtml(comment.text)}</div>
          <div class="comment-actions">
            <button class="btn btn-secondary btn-small" onclick="goToComment(${parsedComments.indexOf(comment)})" title="Fara √≠ athugasemd">
              <i class="fas fa-arrow-right"></i>
            </button>
            <button class="btn btn-secondary btn-small" onclick="removeComment(${parsedComments.indexOf(comment)})" title="Ey√∞a athugasemd">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function goToComment(index) {
      if (!editor || !editor.codemirror) return;

      const comment = parsedComments[index];
      if (!comment) return;

      const cm = editor.codemirror;
      const content = editor.value();

      // Find the position in the document
      let lineStart = 0;
      const lines = content.split('\n');
      for (let i = 0; i < comment.line; i++) {
        lineStart += lines[i].length + 1;
      }

      // Calculate column
      const col = comment.start - lineStart;

      // Move cursor and select the comment
      cm.setSelection(
        { line: comment.line, ch: col },
        { line: comment.line, ch: col + comment.fullMatch.length }
      );

      // Scroll into view
      cm.scrollIntoView({ line: comment.line, ch: col }, 100);
      cm.focus();
    }

    function removeComment(index) {
      if (!editor || !editor.codemirror) return;

      const comment = parsedComments[index];
      if (!comment) return;

      if (!confirm('Ertu viss um a√∞ √æ√∫ viljir ey√∞a √æessari athugasemd?')) {
        return;
      }

      const cm = editor.codemirror;
      const content = editor.value();

      // Remove the comment from the content
      const newContent = content.substring(0, comment.start) + content.substring(comment.end);

      // Update editor
      editor.value(newContent);

      // Re-parse comments
      parseAndDisplayComments();

      // Mark as unsaved
      updateSaveStatus('unsaved');
    }

    function showAddCommentModal() {
      document.getElementById('comment-type').value = 'ATHUGASEMD';
      document.getElementById('comment-text').value = '';
      updateCommentPreview();
      document.getElementById('add-comment-modal').style.display = 'flex';
      document.getElementById('comment-text').focus();
    }

    function closeAddCommentModal() {
      document.getElementById('add-comment-modal').style.display = 'none';
    }

    function updateCommentPreview() {
      const type = document.getElementById('comment-type').value;
      const text = document.getElementById('comment-text').value.trim() || '...';
      document.getElementById('comment-preview-text').textContent = `<!-- ${type}: ${text} -->`;
    }

    function insertComment() {
      if (!editor || !editor.codemirror) return;

      const type = document.getElementById('comment-type').value;
      const text = document.getElementById('comment-text').value.trim();

      if (!text) {
        alert('Vinsamlegast skrifa√∞u athugasemd');
        return;
      }

      const cm = editor.codemirror;
      const commentText = `<!-- ${type}: ${text} -->`;

      // Insert at cursor position
      cm.replaceSelection(commentText);
      cm.focus();

      closeAddCommentModal();

      // Re-parse comments
      setTimeout(parseAndDisplayComments, 100);

      // Mark as unsaved
      updateSaveStatus('unsaved');
    }

    function addQuestionComment() {
      document.getElementById('comment-type').value = 'SPURNING';
      document.getElementById('comment-text').value = '';
      updateCommentPreview();
      document.getElementById('add-comment-modal').style.display = 'flex';
      document.getElementById('comment-text').focus();
    }

    // Update preview when inputs change
    document.addEventListener('DOMContentLoaded', () => {
      const typeSelect = document.getElementById('comment-type');
      const textArea = document.getElementById('comment-text');

      if (typeSelect) {
        typeSelect.addEventListener('change', updateCommentPreview);
      }
      if (textArea) {
        textArea.addEventListener('input', updateCommentPreview);
      }
    });

    // ========================================
    // RELATED DECISIONS SIDEBAR
    // ========================================

    let relatedDecisions = [];
    let decisionTypes = {
      terminology: { icon: 'üìñ', name: 'Hugtak' },
      localization: { icon: 'üåç', name: 'Sta√∞f√¶ring' },
      issue: { icon: '‚úì', name: 'Vandam√°l' },
      style: { icon: '‚úçÔ∏è', name: 'St√≠ll' }
    };

    function toggleDecisions() {
      const sidebar = document.getElementById('decisions-sidebar');
      const isVisible = sidebar.style.display !== 'none';

      // Close other sidebars
      document.getElementById('history-sidebar').style.display = 'none';
      document.getElementById('comments-sidebar').style.display = 'none';
      document.getElementById('issues-sidebar').style.display = 'none';
      document.getElementById('terminology-sidebar').style.display = 'none';
      document.getElementById('notes-sidebar').style.display = 'none';

      sidebar.style.display = isVisible ? 'none' : 'block';

      if (!isVisible) {
        loadRelatedDecisions();
      }
    }

    async function loadRelatedDecisions() {
      if (!currentBook || !currentSection) {
        document.getElementById('decisions-list').innerHTML =
          '<p class="text-muted center">Veldu hluta til a√∞ sj√° tengdar √°kvar√∞anir</p>';
        return;
      }

      const listEl = document.getElementById('decisions-list');
      listEl.innerHTML = '<p class="text-muted center">Hle√∞ur...</p>';

      try {
        // Get the source content to extract terms
        const sourceContent = document.getElementById('source-content').textContent || '';
        const editorContent = editor ? editor.value() : '';
        const combinedText = sourceContent + ' ' + editorContent;

        // Call the API with the text
        const params = new URLSearchParams({
          text: combinedText.substring(0, 5000), // Limit text length
          book: currentBook,
          limit: 15
        });

        const res = await fetch('/api/decisions/related?' + params);
        const data = await res.json();

        relatedDecisions = data.decisions || [];
        updateDecisionsBadge();
        renderRelatedDecisions();

      } catch (err) {
        console.error('Failed to load related decisions:', err);
        listEl.innerHTML = '<p class="text-error center">Villa vi√∞ a√∞ hla√∞a √°kvar√∞anir</p>';
      }
    }

    function refreshRelatedDecisions() {
      loadRelatedDecisions();
    }

    function updateDecisionsBadge() {
      const badge = document.getElementById('decision-count-badge');
      const count = relatedDecisions.length;

      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderRelatedDecisions() {
      const listEl = document.getElementById('decisions-list');

      if (relatedDecisions.length === 0) {
        listEl.innerHTML = `
          <div class="empty-decisions">
            <p class="text-muted">Engar tengdar √°kvar√∞anir fundust</p>
            <p class="text-small text-muted">Skr√°√∞u √°kv√∂r√∞un √æegar √æ√∫ √æarft a√∞ velja milli m√∂guleika</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = relatedDecisions.map(d => {
        const typeInfo = decisionTypes[d.type] || { icon: 'üìå', name: d.type };
        const date = new Date(d.decidedAt).toLocaleDateString('is-IS');

        return `
          <div class="decision-card" data-id="${d.id}">
            <div class="decision-header-row">
              <span class="decision-type-icon">${typeInfo.icon}</span>
              <span class="decision-badge badge-${d.type}">${typeInfo.name}</span>
              ${d._relevanceScore > 3 ? '<span class="relevance-badge">Mj√∂g vi√∞eigandi</span>' : ''}
            </div>
            <div class="decision-terms">
              ${d.englishTerm ? `<span class="term-en">${escapeHtml(d.englishTerm)}</span>` : ''}
              ${d.englishTerm && d.icelandicTerm ? '<span class="term-arrow">‚Üí</span>' : ''}
              ${d.icelandicTerm ? `<span class="term-is">${escapeHtml(d.icelandicTerm)}</span>` : ''}
            </div>
            <div class="decision-rationale">${escapeHtml(d.rationale)}</div>
            <div class="decision-meta">
              <span class="meta-user">${escapeHtml(d.decidedBy)}</span>
              <span class="meta-date">${date}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function showNewDecisionModal() {
      // Pre-fill context
      document.getElementById('decision-context-book').textContent = currentBook || '-';
      document.getElementById('decision-context-chapter').textContent = currentChapter ? `K.${currentChapter}` : '-';
      document.getElementById('decision-context-section').textContent = currentSection || '-';

      // Clear form
      document.getElementById('decision-type').value = '';
      document.getElementById('decision-english').value = '';
      document.getElementById('decision-icelandic').value = '';
      document.getElementById('decision-rationale').value = '';

      // Pre-fill with selected text if any
      if (editor) {
        const selectedText = editor.codemirror.getSelection();
        if (selectedText) {
          document.getElementById('decision-icelandic').value = selectedText;
        }
      }

      document.getElementById('new-decision-modal').style.display = 'flex';
    }

    function closeNewDecisionModal() {
      document.getElementById('new-decision-modal').style.display = 'none';
    }

    async function submitNewDecision() {
      const type = document.getElementById('decision-type').value;
      const englishTerm = document.getElementById('decision-english').value.trim();
      const icelandicTerm = document.getElementById('decision-icelandic').value.trim();
      const rationale = document.getElementById('decision-rationale').value.trim();

      if (!type) {
        alert('Vinsamlegast veldu flokk');
        return;
      }
      if (!rationale) {
        alert('Vinsamlegast skrifa√∞u r√∂kstu√∞ning');
        return;
      }

      try {
        const res = await fetch('/api/decisions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type,
            englishTerm: englishTerm || undefined,
            icelandicTerm: icelandicTerm || undefined,
            rationale,
            book: currentBook,
            chapter: currentChapter,
            section: currentSection
          })
        });

        const data = await res.json();

        if (data.success) {
          closeNewDecisionModal();
          // Refresh the decisions list
          await loadRelatedDecisions();
          // Show the sidebar if not visible
          document.getElementById('decisions-sidebar').style.display = 'block';
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki skr√°√∞ √°kv√∂r√∞un'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    // Initialize decisions button
    document.addEventListener('DOMContentLoaded', () => {
      const decisionsBtn = document.getElementById('decisions-btn');
      if (decisionsBtn) {
        decisionsBtn.addEventListener('click', toggleDecisions);
      }

      const closeDecisionsBtn = document.getElementById('close-decisions');
      if (closeDecisionsBtn) {
        closeDecisionsBtn.addEventListener('click', () => {
          document.getElementById('decisions-sidebar').style.display = 'none';
        });
      }
    });

    // ========================================
    // ISSUES SIDEBAR
    // ========================================

    let chapterIssues = [];
    let currentIssueTab = 'quick';
    const ISSUE_CATEGORIES = {
      AUTO_FIX: { label: 'Sj√°lfvirkt', class: 'auto-fix', icon: '‚ö°' },
      EDITOR_CONFIRM: { label: 'Sta√∞festa', class: 'editor-confirm', icon: '‚úì' },
      BOARD_REVIEW: { label: 'Umr√¶√∞a', class: 'board-review', icon: 'üí¨' },
      BLOCKED: { label: 'Loka√∞', class: 'blocked', icon: 'üîí' }
    };

    function toggleIssues() {
      const sidebar = document.getElementById('issues-sidebar');
      const isVisible = sidebar.style.display !== 'none';

      // Close other sidebars
      document.getElementById('history-sidebar').style.display = 'none';
      document.getElementById('comments-sidebar').style.display = 'none';
      document.getElementById('decisions-sidebar').style.display = 'none';
      document.getElementById('terminology-sidebar').style.display = 'none';
      document.getElementById('notes-sidebar').style.display = 'none';

      sidebar.style.display = isVisible ? 'none' : 'block';

      if (!isVisible) {
        loadChapterIssues();
      }
    }

    async function loadChapterIssues() {
      if (!currentBook || !currentChapter) {
        document.getElementById('issues-list').innerHTML =
          '<p class="text-muted center">Veldu kafla til a√∞ sj√° atri√∞i</p>';
        return;
      }

      const listEl = document.getElementById('issues-list');
      listEl.innerHTML = '<p class="text-muted center">Hle√∞ur...</p>';

      try {
        const params = new URLSearchParams({
          book: currentBook,
          chapter: currentChapter,
          status: 'pending'
        });

        const res = await fetch('/api/issues?' + params);
        const data = await res.json();

        // Combine issues from categories
        chapterIssues = [
          ...(data.byCategory?.AUTO_FIX || []),
          ...(data.byCategory?.EDITOR_CONFIRM || []),
          ...(data.byCategory?.BOARD_REVIEW || []),
          ...(data.byCategory?.BLOCKED || [])
        ];

        updateIssuesCounts(data.byCategory);
        updateIssuesBadge();
        renderIssues();

      } catch (err) {
        console.error('Failed to load issues:', err);
        listEl.innerHTML = '<p class="text-error center">Villa vi√∞ a√∞ hla√∞a atri√∞i</p>';
      }
    }

    function updateIssuesCounts(byCategory) {
      const quickCount = (byCategory?.AUTO_FIX?.length || 0) + (byCategory?.EDITOR_CONFIRM?.length || 0);
      const discussionCount = (byCategory?.BOARD_REVIEW?.length || 0) + (byCategory?.BLOCKED?.length || 0);

      document.getElementById('quick-count').textContent = quickCount;
      document.getElementById('discussion-count').textContent = discussionCount;
    }

    function updateIssuesBadge() {
      const badge = document.getElementById('issue-count-badge');
      const pendingCount = chapterIssues.filter(i => i.status === 'pending').length;

      if (pendingCount > 0) {
        badge.textContent = pendingCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    function switchIssueTab(tab) {
      currentIssueTab = tab;

      // Update tab styles
      document.querySelectorAll('.issue-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.issue-tab[data-tab="${tab}"]`).classList.add('active');

      renderIssues();
    }

    function renderIssues() {
      const listEl = document.getElementById('issues-list');

      // Filter by tab
      let filtered;
      if (currentIssueTab === 'quick') {
        filtered = chapterIssues.filter(i =>
          i.category === 'AUTO_FIX' || i.category === 'EDITOR_CONFIRM'
        );
      } else {
        filtered = chapterIssues.filter(i =>
          i.category === 'BOARD_REVIEW' || i.category === 'BLOCKED'
        );
      }

      if (filtered.length === 0) {
        const emptyMsg = currentIssueTab === 'quick'
          ? 'Engin einf√∂ld atri√∞i til a√∞ leysa'
          : 'Engin atri√∞i b√≠√∞a umr√¶√∞u';
        listEl.innerHTML = `
          <div class="empty-issues">
            <i class="fas fa-check-circle text-success"></i>
            <p>${emptyMsg}</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = filtered.map(issue => {
        const catInfo = ISSUE_CATEGORIES[issue.category] || { label: issue.category, class: 'default', icon: '?' };

        return `
          <div class="issue-card" data-id="${issue.id}" data-session="${issue.sessionId || ''}">
            <div class="issue-header">
              <span class="issue-badge badge-${catInfo.class}">${catInfo.icon} ${catInfo.label}</span>
              ${issue.sourceFile ? `<span class="issue-file">${escapeHtml(issue.sourceFile.split('/').pop())}</span>` : ''}
            </div>
            <div class="issue-description">${escapeHtml(issue.description)}</div>
            ${issue.context ? `<div class="issue-context"><code>${escapeHtml(issue.context)}</code></div>` : ''}
            ${issue.suggestion ? `<div class="issue-suggestion">Tillaga: <strong>${escapeHtml(issue.suggestion)}</strong></div>` : ''}
            <div class="issue-actions">
              <button class="btn btn-success btn-small" onclick="resolveIssueInline('${issue.id}', '${issue.sessionId || ''}', 'accept')">
                <i class="fas fa-check"></i> Sam√æykkja
              </button>
              ${issue.category !== 'BOARD_REVIEW' && issue.category !== 'BLOCKED' ? `
                <button class="btn btn-secondary btn-small" onclick="resolveIssueInline('${issue.id}', '${issue.sessionId || ''}', 'reject')">
                  <i class="fas fa-times"></i>
                </button>
              ` : ''}
              ${issue.category === 'EDITOR_CONFIRM' || issue.category === 'AUTO_FIX' ? `
                <button class="btn btn-secondary btn-small" onclick="escalateIssue('${issue.id}', '${issue.sessionId || ''}')" title="Flytja √≠ umr√¶√∞u">
                  <i class="fas fa-arrow-up"></i>
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function resolveIssueInline(issueId, sessionId, action) {
      try {
        let url;
        if (sessionId) {
          url = `/api/issues/session/${sessionId}/${issueId}/resolve`;
        } else {
          url = `/api/issues/${issueId}/resolve`;
        }

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action,
            resolution: action === 'accept' ? 'Sam√æykkt √≠ ritstj√≥ra' : 'Hafna√∞ √≠ ritstj√≥ra'
          })
        });

        const data = await res.json();

        if (data.success) {
          // Remove from local list and re-render
          chapterIssues = chapterIssues.filter(i => i.id !== issueId);
          updateIssuesBadge();
          renderIssues();

          // Update counts
          const quickCount = chapterIssues.filter(i =>
            i.category === 'AUTO_FIX' || i.category === 'EDITOR_CONFIRM'
          ).length;
          const discussionCount = chapterIssues.filter(i =>
            i.category === 'BOARD_REVIEW' || i.category === 'BLOCKED'
          ).length;
          document.getElementById('quick-count').textContent = quickCount;
          document.getElementById('discussion-count').textContent = discussionCount;
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki leyst atri√∞i'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    async function escalateIssue(issueId, sessionId) {
      const reason = prompt('Hvers vegna √æarf umr√¶√∞u?');
      if (!reason) return;

      try {
        let url;
        if (sessionId) {
          url = `/api/issues/session/${sessionId}/${issueId}/resolve`;
        } else {
          url = `/api/issues/${issueId}/resolve`;
        }

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'escalate',
            resolution: reason
          })
        });

        const data = await res.json();

        if (data.success) {
          // Update issue category locally and re-render
          const issue = chapterIssues.find(i => i.id === issueId);
          if (issue) {
            issue.category = 'BOARD_REVIEW';
          }
          renderIssues();

          // Update counts
          const quickCount = chapterIssues.filter(i =>
            i.category === 'AUTO_FIX' || i.category === 'EDITOR_CONFIRM'
          ).length;
          const discussionCount = chapterIssues.filter(i =>
            i.category === 'BOARD_REVIEW' || i.category === 'BLOCKED'
          ).length;
          document.getElementById('quick-count').textContent = quickCount;
          document.getElementById('discussion-count').textContent = discussionCount;
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki flutt atri√∞i'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    function reportNewIssue() {
      const description = prompt('L√Ωstu atri√∞inu:');
      if (!description) return;

      fetch('/api/issues/report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          book: currentBook,
          chapter: currentChapter,
          description,
          category: 'EDITOR_CONFIRM',
          location: currentSection
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Atri√∞i tilkynnt!');
          loadChapterIssues();
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki tilkynnt'));
        }
      })
      .catch(err => alert('Villa: ' + err.message));
    }

    // ========================================
    // TERMINOLOGY LOOKUP SIDEBAR
    // ========================================

    let terminologySearchTimeout = null;
    let terminologyStats = null;

    function toggleTerminology() {
      const sidebar = document.getElementById('terminology-sidebar');
      const isVisible = sidebar.style.display !== 'none';

      // Close other sidebars
      document.getElementById('history-sidebar').style.display = 'none';
      document.getElementById('comments-sidebar').style.display = 'none';
      document.getElementById('decisions-sidebar').style.display = 'none';
      document.getElementById('issues-sidebar').style.display = 'none';
      document.getElementById('notes-sidebar').style.display = 'none';

      sidebar.style.display = isVisible ? 'none' : 'block';

      if (!isVisible) {
        // Focus search input
        setTimeout(() => {
          document.getElementById('terminology-search').focus();
        }, 100);

        // Load stats if not loaded
        if (!terminologyStats) {
          loadTerminologyStats();
        }
      }
    }

    async function loadTerminologyStats() {
      try {
        const res = await fetch('/api/terminology/stats');
        const data = await res.json();
        terminologyStats = data;

        document.getElementById('term-stat-approved').textContent = data.byStatus?.approved || 0;
        document.getElementById('term-stat-proposed').textContent = data.byStatus?.proposed || 0;
        document.getElementById('terminology-stats').style.display = 'block';
      } catch (err) {
        console.error('Failed to load terminology stats:', err);
      }
    }

    function handleTerminologySearch(e) {
      const query = e.target.value.trim();

      // Clear previous timeout
      if (terminologySearchTimeout) {
        clearTimeout(terminologySearchTimeout);
      }

      // Debounce search
      terminologySearchTimeout = setTimeout(() => {
        searchTerminology(query);
      }, 300);
    }

    async function searchTerminology(query) {
      const resultsEl = document.getElementById('terminology-results');

      if (!query || query.length < 2) {
        resultsEl.innerHTML = `
          <div class="terminology-placeholder">
            <i class="fas fa-lightbulb"></i>
            <p>Leita√∞u a√∞ ensku e√∞a √≠slensku or√∞i</p>
          </div>
        `;
        return;
      }

      resultsEl.innerHTML = '<p class="text-muted center">Leitar...</p>';

      try {
        const params = new URLSearchParams({ q: query });
        const res = await fetch('/api/terminology/lookup?' + params);
        const data = await res.json();

        renderTerminologyResults(data.terms || [], query);
      } catch (err) {
        console.error('Terminology search failed:', err);
        resultsEl.innerHTML = '<p class="text-error center">Villa vi√∞ leit</p>';
      }
    }

    function renderTerminologyResults(terms, query) {
      const resultsEl = document.getElementById('terminology-results');

      if (terms.length === 0) {
        resultsEl.innerHTML = `
          <div class="terminology-no-results">
            <i class="fas fa-search"></i>
            <p>Ekkert fannst fyrir "${escapeHtml(query)}"</p>
            <button class="btn btn-primary btn-small" onclick="openTermProposalWithQuery('${escapeHtml(query)}')">
              <i class="fas fa-plus"></i> Leggja til √æ√Ω√∞ingu
            </button>
          </div>
        `;
        return;
      }

      resultsEl.innerHTML = terms.map(term => {
        const statusClass = term.status === 'approved' ? 'approved' : term.status === 'disputed' ? 'disputed' : 'proposed';
        const statusIcon = term.status === 'approved' ? '‚úì' : term.status === 'disputed' ? '‚ö†' : '‚óã';
        const statusLabel = term.status === 'approved' ? 'Sam√æykkt' : term.status === 'disputed' ? '√ç umr√¶√∞u' : '√ç bi√∞';

        return `
          <div class="term-card">
            <div class="term-header">
              <span class="term-status term-status-${statusClass}" title="${statusLabel}">${statusIcon}</span>
              <span class="term-english">${escapeHtml(term.english)}</span>
            </div>
            <div class="term-translation">
              <i class="fas fa-arrow-right"></i>
              <strong>${escapeHtml(term.icelandic)}</strong>
            </div>
            ${term.alternatives && term.alternatives.length > 0 ? `
              <div class="term-alternatives">
                <span class="text-muted">A√∞rar:</span> ${term.alternatives.map(a => escapeHtml(a)).join(', ')}
              </div>
            ` : ''}
            ${term.notes ? `
              <div class="term-notes">
                <i class="fas fa-info-circle"></i> ${escapeHtml(term.notes.substring(0, 100))}${term.notes.length > 100 ? '...' : ''}
              </div>
            ` : ''}
            ${term.category && term.category !== 'other' ? `
              <div class="term-category">
                <span class="badge badge-small">${escapeHtml(term.category)}</span>
              </div>
            ` : ''}
            <div class="term-actions">
              <button class="btn btn-secondary btn-tiny" onclick="insertTerm('${escapeHtml(term.icelandic)}')" title="Setja inn √≠ texta">
                <i class="fas fa-paste"></i>
              </button>
              <button class="btn btn-secondary btn-tiny" onclick="copyTerm('${escapeHtml(term.icelandic)}')" title="Afrita">
                <i class="fas fa-copy"></i>
              </button>
              ${term.status !== 'approved' ? `
                <button class="btn btn-secondary btn-tiny" onclick="disputeTerm(${term.id})" title="M√≥tm√¶la">
                  <i class="fas fa-question-circle"></i>
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function insertTerm(icelandic) {
      if (islandEditor && islandEditor.codemirror) {
        const cm = islandEditor.codemirror;
        cm.replaceSelection(icelandic);
        cm.focus();

        // Close sidebar
        document.getElementById('terminology-sidebar').style.display = 'none';
      }
    }

    function copyTerm(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Brief feedback
        const btn = event.target.closest('button');
        const icon = btn.querySelector('i');
        icon.className = 'fas fa-check';
        setTimeout(() => {
          icon.className = 'fas fa-copy';
        }, 1000);
      }).catch(err => {
        console.error('Copy failed:', err);
      });
    }

    function openTermProposalFromSidebar() {
      const searchInput = document.getElementById('terminology-search');
      const query = searchInput ? searchInput.value.trim() : '';
      openTermProposalWithQuery(query);
    }

    function openTermProposalWithQuery(query) {
      // Pre-fill the proposal modal
      const modal = document.getElementById('propose-term-modal');
      const englishInput = document.getElementById('propose-english');
      const icelandicInput = document.getElementById('propose-icelandic');

      // Try to detect if query is English or Icelandic
      // Simple heuristic: if contains Icelandic letters, it's probably Icelandic
      const isIcelandic = /[√°√©√≠√≥√∫√Ω√æ√¶√∂√∞]/i.test(query);

      if (isIcelandic) {
        icelandicInput.value = query;
        englishInput.value = '';
      } else {
        englishInput.value = query;
        icelandicInput.value = '';
      }

      modal.style.display = 'block';
    }

    async function disputeTerm(termId) {
      const comment = prompt('Hvers vegna m√≥tm√¶lir √æ√∫ √æessari √æ√Ω√∞ingu?');
      if (!comment) return;

      const proposedTranslation = prompt('Stingur √æ√∫ upp √° annarri √æ√Ω√∞ingu? (valfrj√°lst)');

      try {
        const res = await fetch(`/api/terminology/${termId}/dispute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment, proposedTranslation: proposedTranslation || null })
        });

        const data = await res.json();

        if (data.success) {
          alert('M√≥tm√¶li skr√°√∞. Or√∞i√∞ fer √≠ yfirfer√∞.');
          // Refresh search
          const query = document.getElementById('terminology-search').value;
          searchTerminology(query);
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki skr√°√∞ m√≥tm√¶li'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    // Initialize terminology button and sidebar
    document.addEventListener('DOMContentLoaded', () => {
      const terminologyBtn = document.getElementById('terminology-btn');
      if (terminologyBtn) {
        terminologyBtn.addEventListener('click', toggleTerminology);
      }

      const closeTerminologyBtn = document.getElementById('close-terminology');
      if (closeTerminologyBtn) {
        closeTerminologyBtn.addEventListener('click', () => {
          document.getElementById('terminology-sidebar').style.display = 'none';
        });
      }

      const terminologySearch = document.getElementById('terminology-search');
      if (terminologySearch) {
        terminologySearch.addEventListener('input', handleTerminologySearch);

        // Also search on Enter
        terminologySearch.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchTerminology(e.target.value.trim());
          }
        });
      }
    });

    // Initialize issues button
    document.addEventListener('DOMContentLoaded', () => {
      const issuesBtn = document.getElementById('issues-btn');
      if (issuesBtn) {
        issuesBtn.addEventListener('click', toggleIssues);
      }

      const closeIssuesBtn = document.getElementById('close-issues');
      if (closeIssuesBtn) {
        closeIssuesBtn.addEventListener('click', () => {
          document.getElementById('issues-sidebar').style.display = 'none';
        });
      }
    });

    // ========================================
    // NOTIFICATION BELL
    // ========================================

    let notificationCheckInterval = null;

    function initNotifications() {
      const bellBtn = document.getElementById('bell-btn');
      const dropdown = document.getElementById('notification-dropdown');
      const markAllBtn = document.getElementById('mark-all-read-btn');

      if (bellBtn) {
        bellBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleNotificationDropdown();
        });
      }

      if (markAllBtn) {
        markAllBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          markAllNotificationsRead();
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (dropdown && !dropdown.contains(e.target) && !bellBtn.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      // Load initial count
      loadNotificationCount();

      // Check for new notifications every 60 seconds
      notificationCheckInterval = setInterval(loadNotificationCount, 60000);
    }

    async function loadNotificationCount() {
      try {
        const res = await fetch('/api/notifications/count');
        const data = await res.json();

        const badge = document.getElementById('notification-badge');
        if (data.count > 0) {
          badge.textContent = data.count > 99 ? '99+' : data.count;
          badge.style.display = 'inline-flex';
        } else {
          badge.style.display = 'none';
        }
      } catch (err) {
        console.error('Failed to load notification count:', err);
      }
    }

    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notification-dropdown');
      const isVisible = dropdown.style.display !== 'none';

      if (isVisible) {
        dropdown.style.display = 'none';
      } else {
        dropdown.style.display = 'block';
        loadNotifications();
      }
    }

    async function loadNotifications() {
      const listEl = document.getElementById('notification-list');
      listEl.innerHTML = '<p class="text-muted center">Hle√∞ur...</p>';

      try {
        const res = await fetch('/api/notifications?limit=10');
        const data = await res.json();

        renderNotifications(data.notifications || []);
      } catch (err) {
        console.error('Failed to load notifications:', err);
        listEl.innerHTML = '<p class="text-error center">Villa vi√∞ a√∞ hla√∞a tilkynningar</p>';
      }
    }

    function renderNotifications(notifications) {
      const listEl = document.getElementById('notification-list');

      if (notifications.length === 0) {
        listEl.innerHTML = `
          <div class="empty-notifications">
            <i class="fas fa-bell-slash"></i>
            <p>Engar tilkynningar</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = notifications.map(n => {
        const timeAgo = formatTimeAgo(n.createdAt);
        const iconMap = {
          'assignment_created': 'fa-user-plus',
          'assignment_handoff': 'fa-exchange-alt',
          'stage_completed': 'fa-check-circle',
          'chapter_kickoff': 'fa-rocket',
          'review_submitted': 'fa-paper-plane',
          'review_approved': 'fa-thumbs-up',
          'changes_requested': 'fa-comment-dots'
        };
        const icon = iconMap[n.type] || 'fa-bell';

        return `
          <div class="notification-item ${n.read ? 'read' : 'unread'}" data-id="${n.id}" onclick="handleNotificationClick(${n.id}, '${n.link || ''}')">
            <div class="notification-icon">
              <i class="fas ${icon}"></i>
            </div>
            <div class="notification-content">
              <div class="notification-title">${escapeHtml(n.title)}</div>
              <div class="notification-message">${escapeHtml(n.message.substring(0, 80))}${n.message.length > 80 ? '...' : ''}</div>
              <div class="notification-time">${timeAgo}</div>
            </div>
            ${!n.read ? '<div class="unread-dot"></div>' : ''}
          </div>
        `;
      }).join('');
    }

    function handleNotificationClick(id, link) {
      // Mark as read
      fetch(`/api/notifications/${id}/read`, { method: 'POST' })
        .then(() => {
          loadNotificationCount();
        })
        .catch(err => console.error('Failed to mark notification as read:', err));

      // Navigate to link if provided
      if (link) {
        window.location.href = link;
      }
    }

    async function markAllNotificationsRead() {
      try {
        await fetch('/api/notifications/read-all', { method: 'POST' });
        loadNotificationCount();
        loadNotifications();
      } catch (err) {
        console.error('Failed to mark all as read:', err);
      }
    }

    function formatTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffMins < 1) return 'R√©tt n√∫na';
      if (diffMins < 60) return `${diffMins} m√≠n. s√≠√∞an`;
      if (diffHours < 24) return `${diffHours} klst. s√≠√∞an`;
      if (diffDays < 7) return `${diffDays} d. s√≠√∞an`;
      return date.toLocaleDateString('is-IS');
    }

    // Initialize notifications on page load
    document.addEventListener('DOMContentLoaded', initNotifications);

    // Initialize on page load
    init();
  </script>

  <style>
    /* ==========================================================================
       EDITOR PAGE SPECIFIC STYLES
       Extends common.css with editor-specific components
       ========================================================================== */

    /* Notification Bell (extended for dropdown) */
    .notification-bell {
      position: relative;
    }
    .bell-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--gray-500);
      font-size: 1.125rem;
      position: relative;
      transition: color 0.15s;
    }
    .bell-btn:hover {
      color: var(--primary);
    }
    .notification-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--error);
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      min-width: 1rem;
      height: 1rem;
      border-radius: 9999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 0.25rem;
    }
    .notification-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      width: 360px;
      max-height: 480px;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }
    .dropdown-header span {
      font-weight: 600;
      font-size: 0.875rem;
    }
    .btn-link {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 0.75rem;
      cursor: pointer;
    }
    .btn-link:hover {
      text-decoration: underline;
    }
    .notification-list {
      max-height: 360px;
      overflow-y: auto;
    }
    .notification-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: background 0.15s;
      position: relative;
    }
    .notification-item:hover {
      background: var(--gray-50);
    }
    .notification-item.unread {
      background: #eff6ff;
    }
    .notification-item.unread:hover {
      background: #dbeafe;
    }
    .notification-icon {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: var(--gray-500);
      font-size: 0.875rem;
    }
    .notification-item.unread .notification-icon {
      background: var(--primary);
      color: white;
    }
    .notification-content {
      flex: 1;
      min-width: 0;
    }
    .notification-title {
      font-weight: 600;
      font-size: 0.8125rem;
      color: var(--gray-900);
      margin-bottom: 0.125rem;
    }
    .notification-message {
      font-size: 0.75rem;
      color: var(--gray-600);
      line-height: 1.4;
      margin-bottom: 0.25rem;
    }
    .notification-time {
      font-size: 0.6875rem;
      color: var(--gray-400);
    }
    .unread-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: var(--primary);
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
    }
    .dropdown-footer {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
      text-align: center;
    }
    .dropdown-footer a {
      font-size: 0.8125rem;
      color: var(--primary);
      text-decoration: none;
    }
    .dropdown-footer a:hover {
      text-decoration: underline;
    }
    .empty-notifications {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--gray-400);
    }
    .empty-notifications i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    .card { background: var(--bg-card); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }

    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: var(--text-primary); }
    .form-select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 0.875rem; background: var(--bg-card); color: var(--text-primary); }
    .form-select:disabled { background: var(--gray-100); }
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }

    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; text-decoration: none; border: none; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-secondary { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-color); }
    .btn-secondary:hover:not(:disabled) { background: var(--gray-100); }
    .btn-small { padding: 0.25rem 0.75rem; font-size: 0.75rem; }
    .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }

    .sections-list { margin-top: 1.5rem; }
    .sections-list h3 { font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); }
    .section-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--gray-100); border-radius: 0.375rem; margin-bottom: 0.5rem; color: var(--text-primary); }
    .section-name { font-family: monospace; font-weight: 500; min-width: 80px; display: flex; align-items: center; gap: 0.5rem; }
    .section-status { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px; }
    .status-edited { background: #dcfce7; color: #166534; }
    .status-mt { background: #dbeafe; color: #1e40af; }
    .section-item .btn { margin-left: auto; }
    .split-badge-small {
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b;
      border-radius: 0.25rem;
      white-space: nowrap;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .split-badge-small i { font-size: 0.5rem; }

    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.75rem 1rem; background: var(--bg-card); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .editor-title { display: flex; align-items: center; gap: 1rem; }
    .editor-title h2 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); }
    .editor-actions { display: flex; align-items: center; gap: 0.75rem; }
    .save-status { font-size: 0.75rem; color: var(--text-muted); }

    /* Presence Indicator */
    .presence-indicator {
      display: none;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      background: var(--warning-light);
      border: 1px solid #fcd34d;
      border-radius: 9999px;
      font-size: 0.75rem;
      color: #92400e;
    }
    .presence-avatars {
      display: flex;
      align-items: center;
    }
    .presence-avatar {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      border: 2px solid white;
      margin-left: -0.375rem;
      object-fit: cover;
    }
    .presence-avatar:first-child {
      margin-left: 0;
    }
    .presence-avatar-placeholder {
      background: var(--primary);
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .presence-avatar-more {
      background: var(--gray-300);
      color: var(--gray-700);
      font-size: 0.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .presence-text {
      white-space: nowrap;
    }

    /* Spell Check Toggle */
    .spell-check-toggle {
      position: relative;
      background: transparent;
      border: 1px solid var(--gray-300);
      padding: 0.375rem 0.625rem;
      border-radius: 0.375rem;
      cursor: pointer;
      color: var(--gray-500);
      font-size: 0.875rem;
      transition: all 0.15s;
    }
    .spell-check-toggle:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }
    .spell-check-toggle.active {
      background: #d1fae5;
      border-color: #10b981;
      color: #047857;
    }
    .spell-check-toggle .spell-check-status {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #10b981;
      color: white;
      font-size: 0.625rem;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .spell-check-toggle:not(.active) .spell-check-status {
      display: none;
    }

    /* Split File Indicator */
    .split-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 0.375rem;
      border: 1px solid #f59e0b;
      font-size: 0.875rem;
    }
    .split-badge {
      font-weight: 600;
      color: #92400e;
      white-space: nowrap;
    }
    .split-nav-btn {
      background: transparent;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      color: #92400e;
      border-radius: 0.25rem;
      transition: background-color 0.15s;
    }
    .split-nav-btn:hover:not(:disabled) {
      background: rgba(146, 64, 14, 0.1);
    }
    .split-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .split-info-btn {
      background: transparent;
      border: none;
      padding: 0.25rem;
      cursor: pointer;
      color: #92400e;
      border-radius: 0.25rem;
    }
    .split-info-btn:hover {
      background: rgba(146, 64, 14, 0.1);
    }

    /* Split Info Modal */
    .split-info-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .split-info-content {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }
    .split-info-content h3 {
      margin: 0 0 1rem;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .split-explanation {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      color: #78350f;
      line-height: 1.5;
    }
    .split-parts-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .split-parts-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
    }
    .split-parts-list li.current {
      background: #fef3c7;
      font-weight: 600;
    }
    .split-parts-list li .part-name {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .split-parts-list li .part-status {
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
    }
    .split-parts-list li .part-status.faithful { background: #dcfce7; color: #166534; }
    .split-parts-list li .part-status.mt-output { background: #dbeafe; color: #1e40af; }
    .split-parts-list li button {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }

    /* Dropdown Menu (More button) */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.25rem;
      min-width: 220px;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      z-index: 1000;
      padding: 0.5rem 0;
    }
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.625rem 1rem;
      border: none;
      background: none;
      color: var(--gray-700);
      font-size: 0.875rem;
      text-align: left;
      cursor: pointer;
      transition: background 0.15s;
    }
    .dropdown-item:hover { background: var(--gray-100); }
    .dropdown-item i { width: 1rem; color: var(--gray-500); }
    .dropdown-item-hint {
      margin-left: auto;
      font-size: 0.75rem;
      color: var(--gray-400);
      font-family: monospace;
    }
    .dropdown-item-badge {
      margin-left: auto;
      background: var(--primary);
      color: white;
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      font-weight: 600;
    }
    .dropdown-divider {
      height: 1px;
      background: var(--gray-200);
      margin: 0.5rem 0;
    }
    .dropdown-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--warning);
      color: white;
      font-size: 0.625rem;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    /* Mini Keyboard Hints (bottom of editor) */
    .keyboard-hints-mini {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      color: var(--gray-500);
      background: var(--gray-50);
      border-radius: 0 0 0.5rem 0.5rem;
    }
    .hint-mini kbd {
      background: var(--gray-200);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-family: monospace;
      font-size: 0.6875rem;
    }
    .hint-separator { color: var(--gray-300); }

    /* Keyboard Help Modal */
    .keyboard-help-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
    .keyboard-help-section h4 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
    }
    .shortcut-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .shortcut-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.875rem;
    }
    .shortcut-item kbd {
      background: var(--gray-100);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-family: monospace;
      font-size: 0.75rem;
      border: 1px solid var(--gray-200);
      margin-right: 0.25rem;
    }
    .shortcut-item span { color: var(--gray-600); }
    .hint-action {
      background: var(--primary-light);
      color: var(--primary);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }

    /* Decision Enforcement Tooltip */
    .decision-tooltip {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      padding: 0.875rem;
      max-width: 320px;
      font-size: 0.875rem;
    }
    .decision-tooltip-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }
    .decision-type-badge {
      font-size: 1rem;
    }
    .decision-tooltip-term {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--gray-50);
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    .decision-tooltip-term .en {
      color: var(--gray-500);
      font-style: italic;
    }
    .decision-tooltip-term .arrow {
      color: var(--gray-400);
    }
    .decision-tooltip-term .is {
      font-weight: 600;
      color: var(--success);
    }
    .decision-tooltip-rationale {
      color: var(--gray-600);
      line-height: 1.4;
      margin-bottom: 0.5rem;
    }
    .decision-tooltip-meta {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    /* Decision highlight in editor (underline style) */
    .decision-highlight {
      text-decoration: underline;
      text-decoration-color: var(--warning);
      text-decoration-style: wavy;
      cursor: help;
    }
    .text-warning { color: var(--warning); }
    .text-success { color: var(--success); }
    .text-error { color: var(--error); }

    .alert { padding: 0.75rem 1rem; border-radius: 0.375rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; }
    .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }

    /* Feedback Alert (Changes Requested) */
    .alert-feedback {
      background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
      border: 1px solid #f9a8d4;
      color: #831843;
      display: block;
      padding: 1rem;
    }
    .alert-feedback .feedback-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .alert-feedback .feedback-header i {
      color: #db2777;
    }
    .alert-feedback .feedback-header strong {
      color: #be185d;
    }
    .alert-feedback .feedback-meta {
      font-size: 0.75rem;
      color: #9d174d;
      margin-left: auto;
    }
    .alert-feedback .btn-dismiss {
      background: none;
      border: none;
      color: #9d174d;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0 0.25rem;
      line-height: 1;
    }
    .alert-feedback .btn-dismiss:hover {
      color: #831843;
    }
    .alert-feedback .feedback-notes {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 0.375rem;
      padding: 0.75rem;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .alert-feedback .feedback-notes p {
      margin: 0;
    }

    .editor-content { display: flex; gap: 1rem; }
    .editor-content.side-by-side .source-panel { flex: 1; }
    .editor-content.side-by-side .editor-panel { flex: 1; }
    .editor-panel { flex: 1; }
    .source-panel { flex: 0 0 40%; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .panel-header { padding: 0.75rem 1rem; background: var(--gray-100); border-bottom: 1px solid var(--gray-200); }
    .panel-header h3 { font-size: 0.875rem; font-weight: 600; color: var(--gray-700); }
    .source-content { padding: 1rem; max-height: calc(100vh - 300px); overflow-y: auto; }
    .source-content pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.875rem; line-height: 1.6; }

    .history-sidebar { position: fixed; top: 60px; right: 0; width: 320px; height: calc(100vh - 60px); background: var(--bg-sidebar); box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 100; overflow-y: auto; }
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-sidebar); }
    .sidebar-header h3 { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); }
    .history-list { padding: 1rem; }
    .history-item { padding: 0.75rem; background: var(--gray-100); border-radius: 0.375rem; margin-bottom: 0.5rem; color: var(--text-primary); }
    .history-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.75rem; }
    .history-user { font-weight: 500; color: var(--text-primary); }
    .history-date { color: var(--text-muted); }
    .badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600; }
    .badge-primary { background: var(--primary); color: white; }

    /* Comments Sidebar */
    .comments-sidebar {
      position: fixed;
      top: 60px;
      right: 0;
      width: 360px;
      height: calc(100vh - 60px);
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 100;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .comments-sidebar .sidebar-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom: none;
    }
    .comments-sidebar .sidebar-header h3 { color: white; }
    .comments-sidebar .btn-close { color: white; opacity: 0.8; }
    .comments-sidebar .btn-close:hover { opacity: 1; }
    .comments-actions {
      padding: 0.75rem;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      gap: 0.5rem;
    }
    .comments-filter {
      padding: 0.5rem 0.75rem;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
    }
    .comments-filter label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
    }
    .comments-list {
      flex: 1;
      padding: 0.75rem;
      overflow-y: auto;
    }
    .comment-item {
      background: var(--gray-50);
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid var(--primary);
    }
    .comment-item:hover {
      background: var(--gray-100);
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .comment-type {
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .comment-type.spurning { color: var(--warning); }
    .comment-type.athugasemd { color: var(--primary); }
    .comment-type.todo { color: #0891b2; }
    .comment-type.athuga { color: var(--error); }
    .comment-line {
      font-size: 0.625rem;
      color: var(--gray-500);
      background: var(--gray-200);
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
    }
    .comment-text {
      font-size: 0.8125rem;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    .comment-actions {
      display: flex;
      gap: 0.25rem;
      justify-content: flex-end;
    }
    .comment-actions .btn {
      padding: 0.25rem 0.5rem;
    }

    /* Comment count badge */
    .comment-count {
      background: var(--error);
      color: white;
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      margin-left: 0.25rem;
    }

    /* Comment preview in modal */
    .comment-preview {
      background: var(--gray-50);
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-top: 0.5rem;
    }
    .comment-preview code {
      display: block;
      font-size: 0.8125rem;
      color: var(--gray-700);
      word-break: break-all;
    }

    /* Text colors for comment types */
    .text-primary { color: var(--primary); }
    .text-info { color: #0891b2; }

    /* Notes Sidebar */
    .notes-sidebar {
      position: fixed;
      top: 60px;
      right: 0;
      width: 360px;
      height: calc(100vh - 60px);
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 100;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .notes-sidebar .sidebar-header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-bottom: none;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .notes-sidebar .sidebar-header h3 {
      color: white;
      font-size: 1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .notes-sidebar .btn-close { color: white; opacity: 0.8; }
    .notes-sidebar .btn-close:hover { opacity: 1; }
    .notes-info {
      padding: 0.5rem 0.75rem;
      background: #fef3c7;
      border-bottom: 1px solid #fcd34d;
    }
    .notes-editor {
      padding: 0.75rem;
      border-bottom: 1px solid var(--gray-200);
    }
    .notes-textarea {
      width: 100%;
      min-height: 120px;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      resize: vertical;
      font-family: inherit;
    }
    .notes-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .notes-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      align-items: center;
    }
    .notes-actions .btn-icon {
      padding: 0.375rem 0.5rem;
    }
    .notes-actions .btn-icon.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .notes-save-status {
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    .notes-all-section {
      border-top: 1px solid var(--gray-200);
      margin-top: auto;
    }
    .notes-section-header {
      padding: 0.75rem 1rem;
      background: var(--gray-50);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .notes-section-header:hover {
      background: var(--gray-100);
    }
    .notes-expand-icon {
      transition: transform 0.2s;
    }
    .notes-all-list {
      max-height: 300px;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .note-item {
      padding: 0.75rem;
      border-radius: 0.375rem;
      background: var(--gray-50);
      margin-bottom: 0.5rem;
      cursor: pointer;
      border-left: 3px solid #f59e0b;
    }
    .note-item:hover {
      background: var(--gray-100);
    }
    .note-item-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }
    .note-location {
      font-weight: 600;
      color: var(--gray-700);
    }
    .note-date {
      color: var(--gray-400);
      margin-left: auto;
    }
    .note-preview {
      font-size: 0.8125rem;
      color: var(--gray-600);
      line-height: 1.4;
    }
    .notes-indicator {
      font-size: 0.5rem;
      color: #f59e0b;
      margin-left: 0.25rem;
    }

    /* Decisions Sidebar */
    .decisions-sidebar {
      position: fixed;
      top: 60px;
      right: 0;
      width: 380px;
      height: calc(100vh - 60px);
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 100;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .decisions-sidebar .sidebar-header {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      color: white;
      border-bottom: none;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .decisions-sidebar .sidebar-header h3 {
      color: white;
      font-size: 1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .decisions-sidebar .btn-close { color: white; opacity: 0.8; }
    .decisions-sidebar .btn-close:hover { opacity: 1; }
    .decisions-info {
      padding: 0.5rem 0.75rem;
      background: #ecfdf5;
      border-bottom: 1px solid #a7f3d0;
    }
    .decisions-info .text-small { font-size: 0.75rem; }
    .decisions-actions {
      padding: 0.75rem;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      gap: 0.5rem;
    }
    .decisions-list {
      flex: 1;
      padding: 0.75rem;
      overflow-y: auto;
    }
    .decisions-footer {
      padding: 0.75rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }
    .btn-block { width: 100%; justify-content: center; }

    /* Decision Card */
    .decision-card {
      background: var(--gray-50);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-left: 3px solid #059669;
      transition: all 0.15s;
    }
    .decision-card:hover {
      background: var(--gray-100);
      border-left-color: #047857;
    }
    .decision-header-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .decision-type-icon {
      font-size: 1rem;
    }
    .decision-badge {
      font-size: 0.625rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-weight: 600;
    }
    .badge-terminology { background: #dcfce7; color: #166534; }
    .badge-localization { background: #dbeafe; color: #1e40af; }
    .badge-issue { background: #fef3c7; color: #92400e; }
    .badge-style { background: #f3e8ff; color: #7c3aed; }
    .relevance-badge {
      font-size: 0.5rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      background: #059669;
      color: white;
      margin-left: auto;
    }
    .decision-terms {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }
    .term-en {
      color: var(--gray-500);
      font-size: 0.875rem;
    }
    .term-arrow {
      color: var(--gray-400);
      font-size: 0.75rem;
    }
    .term-is {
      color: #059669;
      font-weight: 600;
      font-size: 0.875rem;
    }
    .decision-rationale {
      font-size: 0.8125rem;
      color: var(--gray-700);
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }
    .decision-meta {
      display: flex;
      gap: 0.75rem;
      font-size: 0.6875rem;
      color: var(--gray-500);
    }
    .meta-user { font-weight: 500; }
    .empty-decisions {
      text-align: center;
      padding: 2rem 1rem;
    }
    .decision-count {
      background: #059669;
      color: white;
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      margin-left: 0.25rem;
    }

    /* Decision context in modal */
    .decision-context {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      background: var(--gray-50);
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      font-size: 0.8125rem;
    }
    .decision-context .context-book { color: var(--primary); font-weight: 500; }
    .decision-context .context-chapter,
    .decision-context .context-section { color: var(--gray-500); }
    .decision-context .context-sep { color: var(--gray-300); }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Issues Sidebar */
    .issues-sidebar {
      position: fixed;
      top: 60px;
      right: 0;
      width: 400px;
      height: calc(100vh - 60px);
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 100;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .issues-sidebar .sidebar-header {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      color: white;
      border-bottom: none;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .issues-sidebar .sidebar-header h3 {
      color: white;
      font-size: 1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .issues-sidebar .btn-close { color: white; opacity: 0.8; }
    .issues-sidebar .btn-close:hover { opacity: 1; }
    .issues-info {
      padding: 0.5rem 0.75rem;
      background: #fffbeb;
      border-bottom: 1px solid #fcd34d;
    }
    .issues-info .text-small { font-size: 0.75rem; }
    .issues-tabs {
      display: flex;
      border-bottom: 1px solid var(--gray-200);
    }
    .issue-tab {
      flex: 1;
      padding: 0.625rem 0.75rem;
      background: var(--gray-50);
      border: none;
      cursor: pointer;
      font-size: 0.8125rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      color: var(--gray-600);
      transition: all 0.15s;
    }
    .issue-tab:hover { background: var(--gray-100); }
    .issue-tab.active {
      background: white;
      color: var(--warning);
      font-weight: 600;
      border-bottom: 2px solid var(--warning);
    }
    .tab-count {
      background: var(--gray-200);
      color: var(--gray-700);
      font-size: 0.6875rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
    }
    .issue-tab.active .tab-count {
      background: var(--warning);
      color: white;
    }
    .issues-list {
      flex: 1;
      padding: 0.75rem;
      overflow-y: auto;
    }
    .issues-footer {
      padding: 0.75rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
      display: flex;
      gap: 0.5rem;
    }

    /* Issue Card */
    .issue-card {
      background: var(--gray-50);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-left: 3px solid var(--warning);
      transition: all 0.15s;
    }
    .issue-card:hover {
      background: var(--gray-100);
    }
    .issue-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .issue-badge {
      font-size: 0.625rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-weight: 600;
    }
    .badge-auto-fix { background: #dcfce7; color: #166534; }
    .badge-editor-confirm { background: #dbeafe; color: #1e40af; }
    .badge-board-review { background: #fef3c7; color: #92400e; }
    .badge-blocked { background: #fee2e2; color: #991b1b; }
    .issue-file {
      font-size: 0.6875rem;
      color: var(--gray-500);
      font-family: monospace;
      margin-left: auto;
    }
    .issue-description {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.375rem;
    }
    .issue-context {
      margin-bottom: 0.375rem;
    }
    .issue-context code {
      font-size: 0.75rem;
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--gray-600);
    }
    .issue-suggestion {
      font-size: 0.8125rem;
      color: #166534;
      margin-bottom: 0.5rem;
    }
    .issue-suggestion strong {
      color: #15803d;
    }
    .issue-actions {
      display: flex;
      gap: 0.375rem;
    }
    .issue-actions .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
    .btn-success {
      background: var(--success);
      color: white;
    }
    .btn-success:hover { background: #15803d; }
    .empty-issues {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--gray-500);
    }
    .empty-issues i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    .issue-count {
      background: var(--warning);
      color: white;
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      margin-left: 0.25rem;
    }

    /* Terminology Sidebar */
    .terminology-sidebar {
      position: fixed;
      top: 60px;
      right: 0;
      width: 380px;
      height: calc(100vh - 60px);
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 100;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .terminology-sidebar .sidebar-header {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      border-bottom: none;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .terminology-sidebar .sidebar-header h3 {
      color: white;
      font-size: 1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .terminology-sidebar .btn-close { color: white; opacity: 0.8; }
    .terminology-sidebar .btn-close:hover { opacity: 1; }
    .terminology-search {
      padding: 0.75rem;
      background: #eef2ff;
      border-bottom: 1px solid #c7d2fe;
    }
    .search-input-wrapper {
      position: relative;
    }
    .search-input-wrapper i {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
    }
    .search-input-wrapper .form-input {
      padding-left: 2.25rem;
    }
    .terminology-search .text-small {
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }
    .terminology-results {
      flex: 1;
      padding: 0.75rem;
      overflow-y: auto;
    }
    .terminology-placeholder,
    .terminology-no-results {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--gray-500);
    }
    .terminology-placeholder i,
    .terminology-no-results i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
      color: #a5b4fc;
    }
    .terminology-no-results p {
      margin-bottom: 1rem;
    }
    .terminology-stats {
      padding: 0.5rem 0.75rem;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 1rem;
    }
    .stat-row {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
    }
    .stat-label { color: var(--gray-500); }
    .stat-value { font-weight: 600; color: var(--gray-700); }
    .terminology-footer {
      padding: 0.75rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
      display: flex;
      gap: 0.5rem;
    }

    /* Term Card */
    .term-card {
      background: var(--gray-50);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-left: 3px solid #6366f1;
      transition: all 0.15s;
    }
    .term-card:hover {
      background: var(--gray-100);
      border-left-color: #4f46e5;
    }
    .term-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.375rem;
    }
    .term-status {
      font-size: 0.875rem;
      width: 1.25rem;
      text-align: center;
    }
    .term-status-approved { color: #16a34a; }
    .term-status-proposed { color: #6366f1; }
    .term-status-disputed { color: #d97706; }
    .term-english {
      font-size: 0.875rem;
      color: var(--gray-600);
    }
    .term-translation {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.375rem;
    }
    .term-translation i {
      color: var(--gray-400);
      font-size: 0.75rem;
    }
    .term-translation strong {
      color: #4f46e5;
      font-size: 1rem;
    }
    .term-alternatives {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-bottom: 0.375rem;
    }
    .term-notes {
      font-size: 0.75rem;
      color: var(--gray-600);
      background: white;
      padding: 0.375rem 0.5rem;
      border-radius: 0.25rem;
      margin-bottom: 0.375rem;
    }
    .term-notes i {
      color: #6366f1;
      margin-right: 0.25rem;
    }
    .term-category {
      margin-bottom: 0.375rem;
    }
    .badge-small {
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 9999px;
    }
    .term-actions {
      display: flex;
      gap: 0.25rem;
    }
    .btn-tiny {
      padding: 0.25rem 0.375rem;
      font-size: 0.6875rem;
    }

    .text-muted { color: var(--gray-500); }

    /* EasyMDE customizations */
    .EasyMDEContainer { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .EasyMDEContainer .CodeMirror { border: none; border-radius: 0 0 0.5rem 0.5rem; min-height: 400px; }
    .EasyMDEContainer .editor-toolbar { border: none; border-radius: 0.5rem 0.5rem 0 0; background: var(--gray-100); }

    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .editor-content { flex-direction: column; }
      .editor-content.side-by-side .source-panel { flex: none; }
      .history-sidebar { width: 100%; }
      .comments-sidebar { width: 100%; }
      .decisions-sidebar { width: 100%; }
      .issues-sidebar { width: 100%; }
      .terminology-sidebar { width: 100%; }
      .notification-dropdown { width: calc(100vw - 2rem); right: -1rem; }
      .editor-header { flex-direction: column; gap: 1rem; }
      .editor-actions { flex-wrap: wrap; }
      .form-row { grid-template-columns: 1fr; }
    }

    /* Terminology Panel - Enhanced Inline Lookup */
    .terminology-panel {
      position: absolute;
      width: 380px;
      max-height: 450px;
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 300;
      overflow: hidden;
      animation: terminologyPanelIn 0.2s ease-out;
    }
    @keyframes terminologyPanelIn {
      from { opacity: 0; transform: translateY(-10px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .terminology-panel.hiding {
      animation: terminologyPanelOut 0.15s ease-in forwards;
    }
    @keyframes terminologyPanelOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-10px) scale(0.95); }
    }
    .terminology-header {
      padding: 0.875rem 1rem;
      background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .terminology-header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .terminology-header-left i {
      font-size: 1rem;
      opacity: 0.9;
    }
    .terminology-query {
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
    }
    .terminology-header .btn-close {
      color: white;
      opacity: 0.8;
      font-size: 1.25rem;
      line-height: 1;
      background: none;
      border: none;
      cursor: pointer;
    }
    .terminology-header .btn-close:hover {
      opacity: 1;
    }
    .terminology-hint {
      padding: 0.5rem 1rem;
      background: var(--primary-light);
      font-size: 0.75rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .terminology-hint kbd {
      background: white;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-family: inherit;
      font-size: 0.7rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .terminology-results {
      max-height: 280px;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .terminology-results .loading {
      padding: 2rem 1rem;
      text-align: center;
      color: var(--gray-500);
      font-size: 0.875rem;
    }
    .terminology-results .loading i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }
    .terminology-results .no-results {
      padding: 1.5rem 1rem;
      text-align: center;
      color: var(--gray-600);
      font-size: 0.875rem;
    }
    .terminology-results .no-results i {
      font-size: 2rem;
      color: var(--gray-400);
      display: block;
      margin-bottom: 0.5rem;
    }
    .terminology-results .no-results .propose-link {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    .terminology-results .no-results .propose-link:hover {
      text-decoration: underline;
    }
    .terminology-results .error {
      padding: 1rem;
      text-align: center;
      color: var(--error);
      font-size: 0.875rem;
    }
    .terminology-results a { color: var(--primary); }
    .terminology-footer {
      padding: 0.75rem 1rem;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 0.5rem;
      justify-content: space-between;
    }
    .term-result {
      padding: 0.875rem;
      border-radius: 0.5rem;
      margin-bottom: 0.375rem;
      border: 1px solid var(--gray-200);
      transition: all 0.15s ease;
      background: white;
    }
    .term-result:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }
    .term-result:last-child {
      margin-bottom: 0;
    }
    .term-main {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .term-english { color: var(--gray-700); }
    .term-arrow { color: var(--gray-400); font-size: 0.8rem; }
    .term-icelandic {
      color: var(--primary);
      font-weight: 600;
      background: var(--primary-light);
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
    }
    .term-meta {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .term-status {
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
      font-weight: 500;
    }
    .status-approved { background: #dcfce7; color: #166534; }
    .status-proposed { background: #dbeafe; color: #1e40af; }
    .status-disputed { background: #fee2e2; color: #991b1b; }
    .term-category {
      font-size: 0.625rem;
      color: var(--gray-500);
    }
    .term-notes {
      font-size: 0.75rem;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
      font-style: italic;
    }
    .term-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--gray-100);
    }
    .term-actions .btn {
      flex: 1;
      justify-content: center;
    }
    .btn-insert {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      transition: all 0.15s ease;
    }
    .btn-insert:hover {
      background: var(--primary-dark);
    }
    .btn-copy {
      background: white;
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      transition: all 0.15s ease;
    }
    .btn-copy:hover {
      background: var(--gray-50);
    }
    .btn-copy.copied {
      background: #dcfce7;
      color: #166534;
      border-color: #86efac;
    }

    /* Terminology selection indicator in editor */
    .CodeMirror .cm-term-highlight {
      background: rgba(99, 102, 241, 0.15);
      border-bottom: 2px solid var(--primary);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { font-size: 1rem; font-weight: 600; }
    .modal-body { padding: 1.5rem; }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    .form-input, .form-textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }

    /* Consistency Modal */
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1100;
    }
    .consistency-results-modal {
      background: white;
      border-radius: 0.5rem;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .consistency-results-modal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }
    .consistency-results-modal .modal-header h3 {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .consistency-results-modal .modal-body {
      padding: 1.25rem;
      overflow-y: auto;
      flex: 1;
    }
    .consistency-results-modal .modal-footer {
      padding: 0.75rem 1.25rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
      display: flex;
      justify-content: flex-end;
    }

    .consistency-stats {
      display: flex;
      gap: 1.5rem;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 0.5rem;
      margin-bottom: 1.25rem;
      align-items: center;
    }
    .consistency-stats .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .consistency-stats .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-800);
    }
    .consistency-stats .stat-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    .consistency-stats .stat-item.success {
      color: var(--success);
      font-size: 1.5rem;
    }
    .consistency-stats .stat-item.warning {
      color: var(--warning);
      font-size: 1.5rem;
    }

    .consistency-success {
      text-align: center;
      padding: 2rem;
      color: var(--success);
    }
    .consistency-success i {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .consistency-success p {
      font-size: 1rem;
      font-weight: 500;
    }
    .consistency-success .subtext {
      color: var(--gray-500);
      font-size: 0.875rem;
      font-weight: 400;
      margin-top: 0.5rem;
    }

    .consistency-issues {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .consistency-issue {
      border: 1px solid var(--gray-200);
      border-radius: 0.5rem;
      padding: 1rem;
      background: white;
    }
    .consistency-issue .issue-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
    }
    .consistency-issue .issue-type {
      font-weight: 600;
    }
    .consistency-issue .text-warning {
      color: var(--warning);
    }
    .consistency-issue .text-info {
      color: var(--primary);
    }
    .consistency-issue .issue-content {
      font-size: 0.875rem;
      line-height: 1.6;
    }
    .consistency-issue .issue-content > div {
      margin-bottom: 0.5rem;
    }
    .consistency-issue mark {
      background: var(--warning-light);
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
    }
    .consistency-issue .expected-term {
      color: var(--success);
      font-weight: 500;
    }
    .consistency-issue code {
      background: var(--gray-100);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.8125rem;
    }
    .consistency-issue .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      margin-top: 0.5rem;
    }

    /* Guidance Panel */
    .guidance-panel {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .guidance-header {
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .guidance-header:hover { opacity: 0.95; }
    .guidance-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }
    .guidance-toggle { transition: transform 0.2s; }
    .guidance-toggle.collapsed { transform: rotate(-90deg); }
    .guidance-content {
      padding: 1rem;
      transition: max-height 0.3s ease-out;
    }
    .guidance-content.collapsed {
      max-height: 0;
      padding: 0 1rem;
      overflow: hidden;
    }
    .guidance-stage { display: none; }
    .guidance-stage.active { display: block; }
    .guidance-section {
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-bottom: 0.75rem;
    }
    .guidance-section:last-child { margin-bottom: 0; }
    .guidance-section h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .guidance-section ul {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.8125rem;
    }
    .guidance-section li { margin-bottom: 0.25rem; }
    .guidance-section p {
      font-size: 0.8125rem;
      margin: 0;
    }
    .guidance-section code {
      background: rgba(0,0,0,0.1);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }
    .guidance-do {
      background: #dcfce7;
      border: 1px solid #86efac;
    }
    .guidance-do h4 { color: #166534; }
    .guidance-dont {
      background: #fee2e2;
      border: 1px solid #fecaca;
    }
    .guidance-dont h4 { color: #991b1b; }
    .guidance-tip {
      background: #dbeafe;
      border: 1px solid #93c5fd;
    }
    .guidance-tip h4 { color: #1e40af; }

    /* Assignment Banner */
    .alert-info {
      background: #dbeafe;
      border: 1px solid #93c5fd;
      color: #1e40af;
    }

    /* Due date indicators */
    .due-overdue { color: var(--error); font-weight: 600; }
    .due-today { color: var(--warning); font-weight: 600; }
    .due-soon { color: var(--warning); font-weight: 500; }

    /* Keyboard shortcut styling */
    kbd {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: 0.25rem;
      padding: 0.125rem 0.375rem;
      font-family: inherit;
      font-size: 0.75rem;
    }

    /* Keyboard hints bar */
    .keyboard-hints {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 0.5rem 0.75rem;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    .keyboard-hints .hint { white-space: nowrap; }

    /* Localization Tools (Pass 2) */
    .localization-tools {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-top: 0.75rem;
    }
    .localization-tools h4 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .loc-tools-grid {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Unit Converter Modal */
    .unit-conversion-row {
      display: flex;
      align-items: flex-end;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .unit-conversion-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    .input-with-unit {
      display: flex;
      gap: 0.5rem;
    }
    .input-with-unit .form-input {
      flex: 1;
    }
    .input-with-unit .form-select {
      flex: 1;
    }
    .conversion-arrow {
      color: var(--primary);
      padding-bottom: 0.5rem;
    }
    .conversion-preview {
      background: var(--gray-50);
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-top: 0.5rem;
    }
    .conversion-preview code {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-weight: 500;
    }

    /* Localization Log Modal */
    .modal-large {
      max-width: 600px;
    }
    .loc-log-add {
      background: var(--gray-50);
      padding: 1rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }
    .loc-log-add .form-group {
      margin-bottom: 0.75rem;
    }
    .loc-log-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .loc-log-entry {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .loc-log-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .loc-log-type {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--primary);
    }
    .loc-log-change {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      flex-wrap: wrap;
    }
    .loc-log-original {
      color: var(--gray-500);
      text-decoration: line-through;
    }
    .loc-log-arrow {
      color: var(--success);
    }
    .loc-log-localized {
      color: var(--success);
      font-weight: 500;
    }
    .loc-log-reason {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.25rem;
      font-style: italic;
    }

    /* Chapter Progress Bar (Enhanced) */
    .chapter-progress {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .chapter-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .chapter-progress-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
    }
    .chapter-progress-summary {
      font-size: 0.75rem;
      color: var(--gray-500);
      background: var(--gray-100);
      padding: 0.25rem 0.625rem;
      border-radius: 9999px;
    }
    .chapter-progress-summary.all-complete {
      background: var(--success-light);
      color: #166534;
    }

    /* Section Indicators Bar */
    .chapter-sections-bar {
      display: flex;
      gap: 0.375rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
      padding: 0.5rem;
      background: var(--gray-50);
      border-radius: 0.375rem;
    }
    .section-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.625rem;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 0.375rem;
      font-size: 0.75rem;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
    }
    .section-chip:hover {
      background: var(--gray-100);
      border-color: var(--gray-300);
    }
    .section-chip.complete {
      background: var(--success-light);
      border-color: var(--success);
      color: #166534;
    }
    .section-chip.complete i {
      font-size: 0.625rem;
    }
    .section-chip.current {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 600;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    .section-chip.complete.current {
      background: var(--success-light);
      border-color: var(--success);
      color: #166534;
      box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2);
    }
    .section-chip-label {
      white-space: nowrap;
    }

    /* Progress Navigation */
    .progress-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--gray-100);
    }
    .progress-info {
      flex: 1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    .progress-label {
      font-size: 0.8125rem;
      color: var(--gray-600);
    }
    .progress-status {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    /* Legacy support - keep for compatibility */
    .section-progress { display: none; }
    .progress-bar-container {
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      margin: 0.5rem 0;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .progress-status {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    .progress-nav .btn {
      padding: 0.5rem 0.75rem;
    }
    .progress-nav .btn:disabled {
      opacity: 0.3;
    }

    /* Tutorial System */
    .tutorial-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9998;
      pointer-events: none;
    }
    .tutorial-overlay.active {
      display: block;
    }
    .tutorial-highlight {
      position: relative;
      z-index: 9999 !important;
      box-shadow: 0 0 0 4px #8b5cf6, 0 0 0 8px rgba(139, 92, 246, 0.3) !important;
      border-radius: 0.375rem;
      pointer-events: auto;
    }
    .tutorial-tooltip {
      display: none;
      position: fixed;
      z-index: 10000;
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      max-width: 360px;
      animation: tutorialFadeIn 0.3s ease;
    }
    @keyframes tutorialFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tutorial-tooltip.active {
      display: block;
    }
    .tutorial-tooltip-content {
      padding: 1.25rem;
    }
    .tutorial-step-indicator {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 0.75rem;
    }
    .tutorial-step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gray-300);
    }
    .tutorial-step-dot.active {
      background: #8b5cf6;
    }
    .tutorial-step-dot.completed {
      background: #10b981;
    }
    .tutorial-tooltip h4 {
      margin: 0 0 0.5rem;
      color: #6d28d9;
      font-size: 1rem;
    }
    .tutorial-tooltip p {
      margin: 0;
      color: var(--gray-600);
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .tutorial-tooltip-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.25rem;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
      border-radius: 0 0 0.75rem 0.75rem;
    }
    .tutorial-nav {
      display: flex;
      gap: 0.5rem;
    }
    .tutorial-tooltip .btn-primary {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
    }

    /* Floating Feedback Button */
    .feedback-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
    }
    .feedback-fab-btn {
      width: 56px;
      height: 56px;
      border-radius: 28px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(109, 40, 217, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .feedback-fab-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(109, 40, 217, 0.5);
    }
    .feedback-fab-btn.has-tooltip::after {
      content: 'Endurgj√∂f';
      position: absolute;
      right: 100%;
      margin-right: 12px;
      background: var(--gray-800);
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .feedback-fab-btn:hover.has-tooltip::after {
      opacity: 1;
    }

    /* Feedback Modal */
    .feedback-modal {
      display: none;
      position: fixed;
      bottom: 90px;
      right: 24px;
      width: 360px;
      max-width: calc(100vw - 48px);
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      z-index: 1001;
      animation: feedbackSlideUp 0.2s ease;
    }
    @keyframes feedbackSlideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .feedback-modal.visible {
      display: block;
    }
    .feedback-modal-header {
      padding: 1rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .feedback-modal-header h3 {
      margin: 0;
      font-size: 1rem;
      color: #6d28d9;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .feedback-modal-body {
      padding: 1rem;
    }
    .feedback-type-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .feedback-type-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem 0.5rem;
      background: var(--gray-50);
      border: 2px solid transparent;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 0.75rem;
      text-align: center;
    }
    .feedback-type-btn:hover {
      background: var(--gray-100);
    }
    .feedback-type-btn.selected {
      background: #f5f3ff;
      border-color: #8b5cf6;
    }
    .feedback-type-btn i {
      font-size: 1.25rem;
      color: #6d28d9;
    }
    .feedback-textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.375rem;
      font-family: inherit;
      font-size: 0.875rem;
      resize: vertical;
      margin-bottom: 0.5rem;
    }
    .feedback-textarea:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    .feedback-context {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-bottom: 0.75rem;
      padding: 0.5rem;
      background: var(--gray-50);
      border-radius: 0.25rem;
    }
    .feedback-modal-footer {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .feedback-submit-btn {
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 500;
      transition: opacity 0.15s;
    }
    .feedback-submit-btn:hover:not(:disabled) {
      opacity: 0.9;
    }
    .feedback-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .feedback-success {
      text-align: center;
      padding: 2rem 1rem;
    }
    .feedback-success i {
      font-size: 3rem;
      color: #10b981;
      margin-bottom: 1rem;
    }
    .feedback-success h4 {
      margin: 0 0 0.5rem;
      color: var(--gray-800);
    }
    .feedback-success p {
      margin: 0;
      color: var(--gray-500);
      font-size: 0.875rem;
    }
  </style>

  <!-- Floating Feedback Button -->
  <div class="feedback-fab">
    <button class="feedback-fab-btn has-tooltip" onclick="toggleFeedbackModal()" title="Senda endurgj√∂f">
      <i class="fas fa-comment-dots"></i>
    </button>
  </div>

  <!-- Feedback Modal -->
  <div class="feedback-modal" id="feedback-modal">
    <div class="feedback-modal-header">
      <h3><i class="fas fa-comment-dots"></i> Endurgj√∂f</h3>
      <button class="btn-close" onclick="closeFeedbackModal()">&times;</button>
    </div>
    <div class="feedback-modal-body" id="feedback-form-container">
      <div class="feedback-type-grid">
        <button class="feedback-type-btn" data-type="translation_error" onclick="selectFeedbackType(this)">
          <i class="fas fa-language"></i>
          Villa √≠ √æ√Ω√∞ingu
        </button>
        <button class="feedback-type-btn" data-type="technical_issue" onclick="selectFeedbackType(this)">
          <i class="fas fa-bug"></i>
          T√¶knilegt vandam√°l
        </button>
        <button class="feedback-type-btn" data-type="improvement" onclick="selectFeedbackType(this)">
          <i class="fas fa-lightbulb"></i>
          Tillaga
        </button>
        <button class="feedback-type-btn" data-type="other" onclick="selectFeedbackType(this)">
          <i class="fas fa-comment"></i>
          Anna√∞
        </button>
      </div>
      <div class="feedback-context" id="feedback-context">
        <i class="fas fa-map-marker-alt"></i> <span id="feedback-location">Hle√∞ur...</span>
      </div>
      <textarea class="feedback-textarea" id="feedback-message" placeholder="L√Ωstu athugasemdinni √æinni h√©r... (l√°gmark 10 stafir)"></textarea>
    </div>
    <div class="feedback-modal-footer">
      <a href="/feedback" target="_blank" style="font-size: 0.75rem; color: var(--gray-500);">
        <i class="fas fa-external-link-alt"></i> N√°kv√¶mara form
      </a>
      <button class="feedback-submit-btn" id="feedback-submit-btn" onclick="submitQuickFeedback()" disabled>
        <i class="fas fa-paper-plane"></i> Senda
      </button>
    </div>
  </div>

  <script>
    // ========================================
    // FLOATING FEEDBACK BUTTON
    // ========================================
    let selectedFeedbackType = null;

    function toggleFeedbackModal() {
      const modal = document.getElementById('feedback-modal');
      if (modal.classList.contains('visible')) {
        closeFeedbackModal();
      } else {
        openFeedbackModal();
      }
    }

    function openFeedbackModal() {
      const modal = document.getElementById('feedback-modal');
      modal.classList.add('visible');

      // Update context with current location
      updateFeedbackContext();

      // Reset form
      resetFeedbackForm();
    }

    function closeFeedbackModal() {
      const modal = document.getElementById('feedback-modal');
      modal.classList.remove('visible');
    }

    function updateFeedbackContext() {
      const location = document.getElementById('feedback-location');
      if (currentBook && currentChapter && currentSection) {
        location.textContent = `${currentBook} / Kafli ${currentChapter} / ${currentSection}`;
      } else if (currentBook && currentChapter) {
        location.textContent = `${currentBook} / Kafli ${currentChapter}`;
      } else {
        location.textContent = 'Ritstj√≥ri';
      }
    }

    function selectFeedbackType(btn) {
      // Deselect all
      document.querySelectorAll('.feedback-type-btn').forEach(b => b.classList.remove('selected'));
      // Select this one
      btn.classList.add('selected');
      selectedFeedbackType = btn.dataset.type;
      updateFeedbackSubmitButton();
    }

    function updateFeedbackSubmitButton() {
      const message = document.getElementById('feedback-message').value.trim();
      const submitBtn = document.getElementById('feedback-submit-btn');
      submitBtn.disabled = !selectedFeedbackType || message.length < 10;
    }

    function resetFeedbackForm() {
      selectedFeedbackType = null;
      document.querySelectorAll('.feedback-type-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('feedback-message').value = '';
      document.getElementById('feedback-submit-btn').disabled = true;

      // Restore form if showing success
      document.getElementById('feedback-form-container').innerHTML = `
        <div class="feedback-type-grid">
          <button class="feedback-type-btn" data-type="translation_error" onclick="selectFeedbackType(this)">
            <i class="fas fa-language"></i>
            Villa √≠ √æ√Ω√∞ingu
          </button>
          <button class="feedback-type-btn" data-type="technical_issue" onclick="selectFeedbackType(this)">
            <i class="fas fa-bug"></i>
            T√¶knilegt vandam√°l
          </button>
          <button class="feedback-type-btn" data-type="improvement" onclick="selectFeedbackType(this)">
            <i class="fas fa-lightbulb"></i>
            Tillaga
          </button>
          <button class="feedback-type-btn" data-type="other" onclick="selectFeedbackType(this)">
            <i class="fas fa-comment"></i>
            Anna√∞
          </button>
        </div>
        <div class="feedback-context" id="feedback-context">
          <i class="fas fa-map-marker-alt"></i> <span id="feedback-location">Hle√∞ur...</span>
        </div>
        <textarea class="feedback-textarea" id="feedback-message" placeholder="L√Ωstu athugasemdinni √æinni h√©r... (l√°gmark 10 stafir)" oninput="updateFeedbackSubmitButton()"></textarea>
      `;
      updateFeedbackContext();
    }

    async function submitQuickFeedback() {
      const message = document.getElementById('feedback-message').value.trim();
      if (!selectedFeedbackType || message.length < 10) return;

      const submitBtn = document.getElementById('feedback-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sendir...';

      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: selectedFeedbackType,
            book: currentBook || null,
            chapter: currentChapter ? String(currentChapter) : null,
            section: currentSection || null,
            message: message
          })
        });

        if (!response.ok) {
          throw new Error('Villa vi√∞ a√∞ senda endurgj√∂f');
        }

        // Show success
        document.getElementById('feedback-form-container').innerHTML = `
          <div class="feedback-success">
            <i class="fas fa-check-circle"></i>
            <h4>Takk fyrir!</h4>
            <p>Endurgj√∂fin √æ√≠n hefur veri√∞ m√≥ttekin.</p>
          </div>
        `;

        // Hide footer buttons
        document.querySelector('.feedback-modal-footer').style.display = 'none';

        // Auto-close after 2 seconds
        setTimeout(() => {
          closeFeedbackModal();
          // Restore form for next time
          setTimeout(() => {
            document.querySelector('.feedback-modal-footer').style.display = 'flex';
            resetFeedbackForm();
          }, 300);
        }, 2000);

      } catch (err) {
        alert('Villa: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Senda';
      }
    }

    // Close feedback modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeFeedbackModal();
      }
    });

    // Add input listener for textarea
    document.getElementById('feedback-message')?.addEventListener('input', updateFeedbackSubmitButton);

    // ========================================
    // TUTORIAL / WALKTHROUGH SYSTEM
    // ========================================

    const TUTORIAL_STORAGE_KEY = 'namsbokasafn_tutorial_completed';
    let currentTutorialStep = 0;
    let tutorialActive = false;

    // Tutorial steps - each step highlights an element and shows explanation
    const tutorialSteps = [
      {
        title: 'Velkomin/n √≠ ritstj√≥rann!',
        description: '√ûetta er √æ√Ω√∞ingarritstj√≥rinn √æar sem √æ√∫ sko√∞ar og lagar v√©l√æ√Ω√∞ingar. H√©r eru helstu a√∞ger√∞irnar.',
        element: null, // No element - just intro
        position: 'center'
      },
      {
        title: '√û√Ω√∞ingartextinn',
        description: 'H√©r er √≠slenska √æ√Ω√∞ingin sem √æ√∫ vinnur me√∞. √û√∫ getur breytt textanum beint og nota√∞ Markdown-sni√∞.',
        element: '.EasyMDEContainer',
        position: 'top'
      },
      {
        title: 'Vista breytingar',
        description: 'Smelltu √° "Vista" til a√∞ vista breytingar. Ritstj√≥rinn vistar l√≠ka sj√°lfkrafa √° 30 sek√∫ndna fresti.',
        element: '#save-btn',
        position: 'bottom'
      },
      {
        title: 'Senda til yfirfer√∞ar',
        description: '√ûegar √æ√∫ ert s√°tt/s√°ttur vi√∞ √æ√Ω√∞inguna, smelltu √° "Senda" til a√∞ senda hana til ritstj√≥ra.',
        element: '#submit-btn',
        position: 'bottom'
      },
      {
        title: 'Meira valmynd',
        description: 'H√©r finnur √æ√∫ fleiri valkosti: EN/IS samanbur√∞, athugasemdir, √∫tg√°fus√∂gu, og or√∞asafn.',
        element: '#more-dropdown',
        position: 'bottom'
      },
      {
        title: 'Or√∞auppfletting',
        description: 'Tv√≠smelltu √° hva√∞a or√∞ sem er til a√∞ fletta √æv√≠ upp √≠ or√∞asafninu. E√∞a √Ωttu √° Ctrl+T.',
        element: '.EasyMDEContainer',
        position: 'top'
      },
      {
        title: 'Fl√Ωtilyklar',
        description: '√ùttu √° ? hven√¶r sem er til a√∞ sj√° alla fl√Ωtilykla. Ctrl+S vistar, Ctrl+E s√Ωnir enska textann.',
        element: null,
        position: 'center'
      },
      {
        title: 'Endurgj√∂f',
        description: 'Ef √æ√∫ finnur villur e√∞a hefur till√∂gur, smelltu √° fj√≥lubl√°a hnappinn ne√∞st til h√¶gri.',
        element: '.feedback-fab',
        position: 'top-left'
      },
      {
        title: '√û√∫ ert tilb√∫in/n!',
        description: 'Gangi √æ√©r vel me√∞ √æ√Ω√∞inguna! Ef √æ√∫ √æarft hj√°lp, ekki hika vi√∞ a√∞ nota endurgj√∂farhnappinn.',
        element: null,
        position: 'center'
      }
    ];

    /**
     * Check if user is new and show welcome modal
     */
    function checkFirstTimeUser() {
      // Only check after editor is loaded with content
      if (!editor || !currentSection) return;

      const completed = localStorage.getItem(TUTORIAL_STORAGE_KEY);
      if (!completed) {
        // Show welcome modal after a short delay
        setTimeout(() => {
          document.getElementById('welcome-modal').style.display = 'flex';
        }, 1000);
      }
    }

    /**
     * Dismiss welcome modal
     */
    function dismissWelcome(startTour) {
      document.getElementById('welcome-modal').style.display = 'none';
      localStorage.setItem(TUTORIAL_STORAGE_KEY, 'true');
      if (startTour) {
        startTutorial();
      }
    }

    /**
     * Start the tutorial
     */
    function startTutorial() {
      if (tutorialActive) return;
      tutorialActive = true;
      currentTutorialStep = 0;

      // Close any open modals/menus
      document.getElementById('more-menu').style.display = 'none';
      document.getElementById('keyboard-help-modal').style.display = 'none';

      // Show overlay
      document.getElementById('tutorial-overlay').classList.add('active');
      document.getElementById('tutorial-tooltip').classList.add('active');

      showTutorialStep(0);
    }

    /**
     * End the tutorial
     */
    function endTutorial() {
      tutorialActive = false;
      currentTutorialStep = 0;

      // Hide overlay and tooltip
      document.getElementById('tutorial-overlay').classList.remove('active');
      document.getElementById('tutorial-tooltip').classList.remove('active');

      // Remove all highlights
      document.querySelectorAll('.tutorial-highlight').forEach(el => {
        el.classList.remove('tutorial-highlight');
      });

      // Mark as completed
      localStorage.setItem(TUTORIAL_STORAGE_KEY, 'true');
    }

    /**
     * Show a specific tutorial step
     */
    function showTutorialStep(stepIndex) {
      const step = tutorialSteps[stepIndex];
      if (!step) {
        endTutorial();
        return;
      }

      currentTutorialStep = stepIndex;

      // Remove previous highlights
      document.querySelectorAll('.tutorial-highlight').forEach(el => {
        el.classList.remove('tutorial-highlight');
      });

      // Highlight current element if specified
      let targetEl = null;
      if (step.element) {
        targetEl = document.querySelector(step.element);
        if (targetEl) {
          targetEl.classList.add('tutorial-highlight');
          // Scroll element into view if needed
          targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      // Update step indicator
      const indicator = document.getElementById('tutorial-step-indicator');
      indicator.innerHTML = tutorialSteps.map((_, i) => {
        let className = 'tutorial-step-dot';
        if (i < stepIndex) className += ' completed';
        else if (i === stepIndex) className += ' active';
        return `<span class="${className}"></span>`;
      }).join('');

      // Update content
      document.getElementById('tutorial-title').textContent = step.title;
      document.getElementById('tutorial-description').textContent = step.description;

      // Update buttons
      document.getElementById('tutorial-prev').style.display = stepIndex > 0 ? 'inline-flex' : 'none';
      const nextBtn = document.getElementById('tutorial-next');
      if (stepIndex === tutorialSteps.length - 1) {
        nextBtn.innerHTML = '<i class="fas fa-check"></i> Lj√∫ka';
      } else {
        nextBtn.innerHTML = 'N√¶sta <i class="fas fa-chevron-right"></i>';
      }

      // Position tooltip
      positionTutorialTooltip(targetEl, step.position);
    }

    /**
     * Position the tutorial tooltip
     */
    function positionTutorialTooltip(targetEl, position) {
      const tooltip = document.getElementById('tutorial-tooltip');
      const tooltipRect = tooltip.getBoundingClientRect();

      if (!targetEl || position === 'center') {
        // Center in viewport
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
        return;
      }

      tooltip.style.transform = 'none';

      const targetRect = targetEl.getBoundingClientRect();
      const padding = 16;

      switch (position) {
        case 'bottom':
          tooltip.style.top = (targetRect.bottom + padding) + 'px';
          tooltip.style.left = Math.max(padding, Math.min(
            targetRect.left + targetRect.width / 2 - 180,
            window.innerWidth - 360 - padding
          )) + 'px';
          break;
        case 'top':
          tooltip.style.top = Math.max(padding, targetRect.top - tooltipRect.height - padding) + 'px';
          tooltip.style.left = Math.max(padding, Math.min(
            targetRect.left + targetRect.width / 2 - 180,
            window.innerWidth - 360 - padding
          )) + 'px';
          break;
        case 'top-left':
          tooltip.style.top = Math.max(padding, targetRect.top - tooltipRect.height - padding) + 'px';
          tooltip.style.left = Math.max(padding, targetRect.right - 360) + 'px';
          break;
        default:
          // Default to bottom
          tooltip.style.top = (targetRect.bottom + padding) + 'px';
          tooltip.style.left = Math.max(padding, targetRect.left) + 'px';
      }
    }

    /**
     * Go to next tutorial step
     */
    function nextTutorialStep() {
      if (currentTutorialStep >= tutorialSteps.length - 1) {
        endTutorial();
      } else {
        showTutorialStep(currentTutorialStep + 1);
      }
    }

    /**
     * Go to previous tutorial step
     */
    function prevTutorialStep() {
      if (currentTutorialStep > 0) {
        showTutorialStep(currentTutorialStep - 1);
      }
    }

    // Keyboard navigation for tutorial
    document.addEventListener('keydown', (e) => {
      if (!tutorialActive) return;

      if (e.key === 'Escape') {
        endTutorial();
      } else if (e.key === 'ArrowRight' || e.key === 'Enter') {
        nextTutorialStep();
      } else if (e.key === 'ArrowLeft') {
        prevTutorialStep();
      }
    });

    // Check for first-time user after editor loads
    const originalLoadEditor = loadEditor;
    loadEditor = async function(book, chapter, section) {
      await originalLoadEditor(book, chapter, section);
      // Check if first time after content is loaded
      setTimeout(checkFirstTimeUser, 500);
    };
  </script>
  <script src="/js/theme.js"></script>
</body>
</html>
