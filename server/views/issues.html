<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atriði - Námsbókasafn</title>
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/workflow">Verkflæði</a>
      <a href="/issues" class="active">Atriði</a>
      <a href="/images">Myndir</a>
      <a href="/status">Staða</a>
    </nav>
    <div class="user-info" id="user-info"></div>
  </header>

  <main class="container">
    <div class="card">
      <h2 class="card-title">Atriðayfirlit</h2>
      <div class="grid grid-4" id="stats">
        <div class="stat-card"><div class="stat-value" id="total-issues">-</div><div class="stat-label">Samtals</div></div>
        <div class="stat-card"><div class="stat-value" id="pending-issues">-</div><div class="stat-label">Í bið</div></div>
        <div class="stat-card"><div class="stat-value" id="auto-fix-issues">-</div><div class="stat-label">Sjálfvirk lagfæring</div></div>
        <div class="stat-card"><div class="stat-value" id="review-issues">-</div><div class="stat-label">Þarf yfirlestur</div></div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Óleyst atriði</h2>
      <div class="filters">
        <select class="form-select" id="filter-book" onchange="loadIssues()">
          <option value="">Allar bækur</option>
          <option value="efnafraedi">Efnafræði</option>
        </select>
        <select class="form-select" id="filter-category" onchange="loadIssues()">
          <option value="">Allir flokkar</option>
          <option value="AUTO_FIX">Sjálfvirk lagfæring</option>
          <option value="EDITOR_CONFIRM">Ritstjóri staðfestir</option>
          <option value="BOARD_REVIEW">Yfirlestur ráðs</option>
          <option value="BLOCKED">Lokað á</option>
        </select>
      </div>
      <table class="table" id="issues-table">
        <thead>
          <tr><th>Flokkur</th><th>Lysing</th><th>Skra</th><th>Kafli</th><th>Adgerdir</th></tr>
        </thead>
        <tbody id="issues-body"></tbody>
      </table>
    </div>
  </main>

  <script>
    // Load stats first
    async function loadStats() {
      const book = document.getElementById('filter-book').value;
      let url = '/api/issues/stats';
      if (book) url += '?book=' + book;

      try {
        const res = await fetch(url);
        const stats = await res.json();

        document.getElementById('total-issues').textContent = stats.total;
        document.getElementById('pending-issues').textContent = stats.pending;
        document.getElementById('auto-fix-issues').textContent = stats.pendingByCategory?.AUTO_FIX || 0;
        document.getElementById('review-issues').textContent =
          (stats.pendingByCategory?.EDITOR_CONFIRM || 0) +
          (stats.pendingByCategory?.BOARD_REVIEW || 0);
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    async function loadIssues() {
      const book = document.getElementById('filter-book').value;
      const category = document.getElementById('filter-category').value;
      let url = '/api/issues?status=pending';
      if (book) url += '&book=' + book;
      if (category) url += '&category=' + category;

      try {
        const res = await fetch(url);
        const data = await res.json();

        // Update stats
        loadStats();

        const tbody = document.getElementById('issues-body');
        const allIssues = [
          ...(data.byCategory.BLOCKED || []),
          ...(data.byCategory.BOARD_REVIEW || []),
          ...(data.byCategory.EDITOR_CONFIRM || []),
          ...(data.byCategory.AUTO_FIX || [])
        ];

        if (allIssues.length === 0) {
          tbody.textContent = '';
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5;
          cell.style.textAlign = 'center';
          cell.style.color = 'var(--gray-500)';
          cell.textContent = 'Engin oleyst atrioi';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

        // Clear and rebuild table using DOM methods for security
        tbody.textContent = '';
        allIssues.forEach(issue => {
          const row = createIssueRow(issue);
          tbody.appendChild(row);
        });

      } catch (err) {
        console.error('Error loading issues:', err);
        const tbody = document.getElementById('issues-body');
        tbody.textContent = '';
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 5;
        cell.style.textAlign = 'center';
        cell.style.color = '#991b1b';
        cell.textContent = 'Villa vio ao saekja atridi';
        row.appendChild(cell);
        tbody.appendChild(row);
      }
    }

    function createIssueRow(issue) {
      const row = document.createElement('tr');

      // Category badge
      const catCell = document.createElement('td');
      const badge = document.createElement('span');
      badge.className = 'status-badge status-' + issue.category.toLowerCase().replace('_','-');
      badge.textContent = getCategoryLabel(issue.category);
      catCell.appendChild(badge);
      row.appendChild(catCell);

      // Description with context
      const descCell = document.createElement('td');
      const descDiv = document.createElement('div');
      descDiv.className = 'issue-desc';
      descDiv.textContent = issue.description || '';
      descCell.appendChild(descDiv);

      if (issue.context) {
        const ctxDiv = document.createElement('div');
        ctxDiv.className = 'issue-context';
        ctxDiv.textContent = issue.context;
        descCell.appendChild(ctxDiv);
      }
      if (issue.suggestion) {
        const sugDiv = document.createElement('div');
        sugDiv.className = 'issue-suggestion';
        sugDiv.textContent = 'Tillaga: ';
        const code = document.createElement('code');
        code.textContent = issue.suggestion;
        sugDiv.appendChild(code);
        descCell.appendChild(sugDiv);
      }
      row.appendChild(descCell);

      // Location
      const locCell = document.createElement('td');
      locCell.className = 'location-cell';
      if (issue.sourceFile) {
        locCell.textContent = issue.sourceFile + (issue.line ? ':' + issue.line : '');
      } else if (issue.sessionId) {
        locCell.textContent = 'Lota ' + issue.sessionId.slice(0,8);
      } else {
        locCell.textContent = '-';
      }
      row.appendChild(locCell);

      // Chapter
      const chapCell = document.createElement('td');
      chapCell.className = 'chapter-cell';
      chapCell.textContent = issue.chapter ? 'Kafli ' + issue.chapter : '-';
      row.appendChild(chapCell);

      // Actions
      const actCell = document.createElement('td');
      actCell.className = 'actions-cell';
      createActionButtons(actCell, issue);
      row.appendChild(actCell);

      return row;
    }

    function createActionButtons(container, issue) {
      const sessionId = issue.sessionId || '';
      const issueId = issue.id;

      if (issue.category === 'AUTO_FIX') {
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'btn btn-success';
        acceptBtn.textContent = 'Samthykkja';
        acceptBtn.onclick = () => resolveIssue(sessionId, issueId, 'accept');
        container.appendChild(acceptBtn);

        const skipBtn = document.createElement('button');
        skipBtn.className = 'btn btn-secondary';
        skipBtn.textContent = 'Sleppa';
        skipBtn.onclick = () => resolveIssue(sessionId, issueId, 'reject');
        container.appendChild(skipBtn);
      } else if (issue.category === 'BLOCKED') {
        const resolveBtn = document.createElement('button');
        resolveBtn.className = 'btn btn-primary';
        resolveBtn.textContent = 'Leysa';
        resolveBtn.onclick = () => showResolveModal(sessionId, issueId);
        container.appendChild(resolveBtn);
      } else {
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'btn btn-success';
        acceptBtn.textContent = 'Samthykkja';
        acceptBtn.onclick = () => resolveIssue(sessionId, issueId, 'accept');
        container.appendChild(acceptBtn);

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn btn-secondary';
        rejectBtn.textContent = 'Hafna';
        rejectBtn.onclick = () => resolveIssue(sessionId, issueId, 'reject');
        container.appendChild(rejectBtn);
      }
    }

    function getCategoryLabel(category) {
      const labels = {
        'AUTO_FIX': 'Sjalfvirkt',
        'EDITOR_CONFIRM': 'Ritstjori',
        'BOARD_REVIEW': 'Rad',
        'BLOCKED': 'Lokad'
      };
      return labels[category] || category;
    }

    async function resolveIssue(sessionId, issueId, action) {
      let url;

      if (sessionId) {
        url = '/api/issues/session/' + sessionId + '/' + issueId + '/resolve';
      } else {
        url = '/api/issues/' + issueId + '/resolve';
      }

      const body = JSON.stringify({
        action,
        resolution: action === 'accept' ? 'Samthykkt' : 'Hafnad'
      });

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body
        });

        if (res.ok) {
          loadIssues();
        } else {
          const err = await res.json();
          alert('Villa: ' + (err.error || 'Othekkt villa'));
        }
      } catch (err) {
        alert('Villa vid ad leysa atridi: ' + err.message);
      }
    }

    function showResolveModal(sessionId, issueId) {
      const resolution = prompt('Lysing a urlausn:');
      if (!resolution) return;
      resolveIssue(sessionId, issueId, 'accept');
    }

    // Initial load
    loadStats();
    loadIssues();
  </script>

  <style>
    :root { --primary: #2563eb; --gray-50: #f9fafb; --gray-200: #e5e7eb; --gray-300: #d1d5db; --gray-500: #6b7280; --gray-700: #374151; --gray-900: #111827; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-50); }
    .header { background: white; border-bottom: 1px solid var(--gray-200); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.25rem; }
    .header nav { display: flex; gap: 1.5rem; }
    .header nav a { color: var(--gray-700); text-decoration: none; font-size: 0.875rem; }
    .header nav a.active { color: var(--primary); }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
    .stat-card { text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 0.5rem; }
    .stat-value { font-size: 2rem; font-weight: 600; color: var(--primary); }
    .stat-label { font-size: 0.75rem; color: var(--gray-500); }
    .filters { display: flex; gap: 1rem; margin-bottom: 1rem; }
    .form-select { padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    .btn { padding: 0.375rem 0.75rem; border-radius: 0.25rem; border: 1px solid var(--gray-300); background: white; cursor: pointer; font-size: 0.75rem; }
    .status-badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600; }
    .status-auto-fix { background: #dcfce7; color: #166534; }
    .status-editor-confirm { background: #dbeafe; color: #1e40af; }
    .status-board-review { background: #fef3c7; color: #92400e; }
    .status-blocked { background: #fee2e2; color: #991b1b; }
    .issue-desc { font-weight: 500; margin-bottom: 0.25rem; }
    .issue-context { font-size: 0.75rem; color: var(--gray-500); font-family: monospace; background: var(--gray-50); padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
    .issue-suggestion { font-size: 0.75rem; color: #166534; margin-top: 0.25rem; }
    .issue-suggestion code { background: #dcfce7; padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
    .btn-success { background: #16a34a; color: white; border-color: #16a34a; }
    .btn-success:hover { background: #15803d; }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background: #1d4ed8; }
    .actions-cell { display: flex; gap: 0.25rem; }
    .location-cell { font-size: 0.75rem; font-family: monospace; color: var(--gray-500); }
    .chapter-cell { font-size: 0.75rem; }
  </style>
</body>
</html>
