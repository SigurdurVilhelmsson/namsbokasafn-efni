<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atriði - Námsbókasafn</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/my-work">Mín verkefni</a>
      <a href="/workflow">Verkflæði</a>
      <a href="/status">Stjórnborð</a>
      <a href="/segment-editor">Ritstjóri</a>
      <a href="/terminology">Orðasafn</a>
      <a href="/review-queue">Yfirferðarröð</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stjórnborð</a>
      <a href="/admin" class="admin-only admin-link">Stjórnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um þema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notification-bell" id="notification-bell" title="Tilkynningar" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <!-- Summary Stats -->
    <div class="card">
      <h2 class="card-title">Atriðayfirlit</h2>
      <div class="grid grid-3" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="quick-fix-count">-</div>
          <div class="stat-label">Fljótleg lagfæring</div>
          <div class="stat-desc">Ritstjóri leysir</div>
        </div>
        <div class="stat-card stat-warning">
          <div class="stat-value" id="discussion-count">-</div>
          <div class="stat-label">Umræða í hóp</div>
          <div class="stat-desc">Vikulegur fundur</div>
        </div>
        <div class="stat-card stat-success">
          <div class="stat-value" id="resolved-count">-</div>
          <div class="stat-label">Leyst</div>
          <div class="stat-desc">Síðustu 7 daga</div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('quick-fix')">
        Fljótleg lagfæring
        <span class="tab-badge" id="quick-fix-badge">0</span>
      </button>
      <button class="tab" onclick="showTab('discussion')">
        Umræða í hóp
        <span class="tab-badge tab-badge-warning" id="discussion-badge">0</span>
      </button>
      <button class="tab" onclick="showTab('resolved')">Leyst</button>
    </div>

    <!-- Quick Fix Tab -->
    <div id="tab-quick-fix" class="tab-content">
      <div class="card">
        <div class="card-header-flex">
          <h2 class="card-title">Fljótleg lagfæring</h2>
          <p class="card-subtitle">Atriði sem þú getur leyst sjálf(ur) án umræðu</p>
        </div>
        <div class="filters">
          <select class="form-select" id="quick-fix-book-filter" onchange="loadQuickFix()">
            <option value="">Allar bækur</option>
            <option value="efnafraedi">Efnafræði</option>
          </select>
        </div>
        <div id="quick-fix-list" class="issues-list">
          <p class="text-muted">Hleður...</p>
        </div>
      </div>
    </div>

    <!-- Team Discussion Tab -->
    <div id="tab-discussion" class="tab-content" style="display: none;">
      <div class="card">
        <div class="card-header-flex">
          <h2 class="card-title">Umræða í hóp</h2>
          <p class="card-subtitle">Atriði sem þarf að ræða á vikulegum fundi</p>
        </div>
        <div class="filters">
          <select class="form-select" id="discussion-book-filter" onchange="loadDiscussion()">
            <option value="">Allar bækur</option>
            <option value="efnafraedi">Efnafræði</option>
          </select>
        </div>
        <div id="discussion-list" class="issues-list">
          <p class="text-muted">Hleður...</p>
        </div>
      </div>
    </div>

    <!-- Resolved Tab -->
    <div id="tab-resolved" class="tab-content" style="display: none;">
      <div class="card">
        <div class="card-header-flex">
          <h2 class="card-title">Leyst atriði</h2>
          <p class="card-subtitle">Síðustu 7 daga</p>
        </div>
        <div id="resolved-list" class="issues-list">
          <p class="text-muted">Hleður...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Resolve Modal -->
  <div class="modal" id="resolve-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Leysa atriði</h3>
        <button class="btn-close" onclick="closeResolveModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="issue-preview" id="resolve-issue-preview"></div>
        <div class="form-group">
          <label class="form-label">Úrlausn</label>
          <textarea id="resolve-notes" class="form-textarea" rows="3" placeholder="Lýstu hvernig þú leystir atriðið..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeResolveModal()">Hætta við</button>
        <button class="btn btn-success" onclick="submitResolve()">Leysa</button>
      </div>
    </div>
  </div>

  <!-- Flag for Discussion Modal -->
  <div class="modal" id="flag-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Flytja í umræðu</h3>
        <button class="btn-close" onclick="closeFlagModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="issue-preview" id="flag-issue-preview"></div>
        <div class="form-group">
          <label class="form-label">Af hverju þarf umræðu?</label>
          <textarea id="flag-reason" class="form-textarea" rows="3" placeholder="Útskýrðu hvers vegna þetta þarf umræðu í hóp..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeFlagModal()">Hætta við</button>
        <button class="btn btn-warning" onclick="submitFlag()">Flytja í umræðu</button>
      </div>
    </div>
  </div>

    <script src="/js/htmlUtils.js"></script>
  <script>
    let currentTab = 'quick-fix';
    let selectedIssue = null;

    // Toggle accordion open/closed
    function toggleAccordion(accordionId) {
      const accordion = document.getElementById(accordionId);
      if (accordion) {
        accordion.classList.toggle('collapsed');
      }
    }

    // Map old categories to simple tiers
    const SIMPLE_TIER_MAP = {
      'AUTO_FIX': 'QUICK_FIX',
      'EDITOR_CONFIRM': 'QUICK_FIX',
      'BOARD_REVIEW': 'TEAM_DISCUSSION',
      'BLOCKED': 'TEAM_DISCUSSION'
    };

    // ============================================================================
    // TAB NAVIGATION
    // ============================================================================

    function showTab(tabId) {
      currentTab = tabId;

      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');

      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      document.getElementById('tab-' + tabId).style.display = 'block';

      if (tabId === 'quick-fix') loadQuickFix();
      else if (tabId === 'discussion') loadDiscussion();
      else if (tabId === 'resolved') loadResolved();
    }

    // ============================================================================
    // DATA LOADING
    // ============================================================================

    async function loadStats() {
      try {
        const res = await fetch('/api/issues/stats');
        const stats = await res.json();

        // Calculate simple tier counts
        let quickFixCount = (stats.pendingByCategory?.AUTO_FIX || 0) +
                           (stats.pendingByCategory?.EDITOR_CONFIRM || 0);
        let discussionCount = (stats.pendingByCategory?.BOARD_REVIEW || 0) +
                              (stats.pendingByCategory?.BLOCKED || 0);

        document.getElementById('quick-fix-count').textContent = quickFixCount;
        document.getElementById('discussion-count').textContent = discussionCount;
        document.getElementById('resolved-count').textContent = stats.resolvedLast7Days || 0;

        document.getElementById('quick-fix-badge').textContent = quickFixCount;
        document.getElementById('discussion-badge').textContent = discussionCount;

      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    async function loadQuickFix() {
      const container = document.getElementById('quick-fix-list');
      const book = document.getElementById('quick-fix-book-filter').value;
      container.innerHTML = '<p class="text-muted">Hleður...</p>';

      try {
        let url = '/api/issues?status=pending';
        if (book) url += '&book=' + book;

        const res = await fetch(url);
        const data = await res.json();

        // Filter to QUICK_FIX tier (AUTO_FIX + EDITOR_CONFIRM)
        const issues = [
          ...(data.byCategory?.AUTO_FIX || []),
          ...(data.byCategory?.EDITOR_CONFIRM || [])
        ];

        if (issues.length === 0) {
          container.innerHTML = '<div class="empty-state"><p class="text-success">✓ Engin atriði í fljótlegri lagfæringu</p><p class="text-muted">Öll einföld atriði hafa verið leyst. Frábært!</p></div>';
          return;
        }

        container.innerHTML = issues.map(issue => renderQuickFixItem(issue)).join('');

      } catch (err) {
        console.error('Error loading quick fix:', err);
        container.innerHTML = '<p class="text-error">Villa við að sækja atriði</p>';
      }
    }

    async function loadDiscussion() {
      const container = document.getElementById('discussion-list');
      const book = document.getElementById('discussion-book-filter').value;
      container.innerHTML = '<p class="text-muted">Hleður...</p>';

      try {
        let url = '/api/issues?status=pending';
        if (book) url += '&book=' + book;

        const res = await fetch(url);
        const data = await res.json();

        // Filter to TEAM_DISCUSSION tier (BOARD_REVIEW + BLOCKED)
        const issues = [
          ...(data.byCategory?.BLOCKED || []),
          ...(data.byCategory?.BOARD_REVIEW || [])
        ];

        if (issues.length === 0) {
          container.innerHTML = '<div class="empty-state"><p class="text-success">✓ Engin atriði bíða umræðu</p><p class="text-muted">Engir flóknir kostir eru í bið. Hópurinn hefur tekist á við allt!</p></div>';
          return;
        }

        container.innerHTML = issues.map(issue => renderDiscussionItem(issue)).join('');

      } catch (err) {
        console.error('Error loading discussion:', err);
        container.innerHTML = '<p class="text-error">Villa við að sækja atriði</p>';
      }
    }

    async function loadResolved() {
      const container = document.getElementById('resolved-list');
      container.innerHTML = '<p class="text-muted">Hleður...</p>';

      try {
        const res = await fetch('/api/issues?status=resolved&limit=50');
        const data = await res.json();

        const issues = data.issues || [];

        if (issues.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>Engin leyst atriði fundust</p><p class="text-muted">Leyst atriði munu birtast hér þegar ritstjórar leysa úr þeim.</p></div>';
          return;
        }

        container.innerHTML = issues.map(issue => renderResolvedItem(issue)).join('');

      } catch (err) {
        console.error('Error loading resolved:', err);
        container.innerHTML = '<p class="text-error">Villa við að sækja atriði</p>';
      }
    }

    // ============================================================================
    // RENDERING
    // ============================================================================

    function renderQuickFixItem(issue) {
      const categoryLabel = issue.category === 'AUTO_FIX' ? 'Sjálfvirkt' : 'Staðfesta';
      const categoryClass = issue.category === 'AUTO_FIX' ? 'auto-fix' : 'editor-confirm';

      return `
        <div class="issue-item">
          <div class="issue-main">
            <span class="issue-badge badge-${categoryClass}">${categoryLabel}</span>
            <div class="issue-content">
              <div class="issue-desc">${escapeHtml(issue.description)}</div>
              ${issue.context ? `<div class="issue-context">${escapeHtml(issue.context)}</div>` : ''}
              ${issue.suggestion ? `<div class="issue-suggestion">Tillaga: <code>${escapeHtml(issue.suggestion)}</code></div>` : ''}
            </div>
          </div>
          <div class="issue-meta">
            ${issue.sourceFile ? `<span class="issue-location">${escapeHtml(issue.sourceFile)}${issue.line ? ':' + issue.line : ''}</span>` : ''}
            ${issue.chapter ? `<span class="issue-chapter">Kafli ${issue.chapter}</span>` : ''}
          </div>
          <div class="issue-actions">
            <button class="btn btn-success btn-sm" onclick="resolveIssue('${issue.id}', '${issue.sessionId || ''}')">
              Leysa
            </button>
            <button class="btn btn-secondary btn-sm" onclick="flagForDiscussion('${issue.id}', '${issue.sessionId || ''}')">
              Flytja í umræðu
            </button>
          </div>
        </div>
      `;
    }

    function renderDiscussionItem(issue) {
      const isBlocked = issue.category === 'BLOCKED';
      const categoryLabel = isBlocked ? 'Lokað á' : 'Umræða';
      const categoryClass = isBlocked ? 'blocked' : 'board-review';

      return `
        <div class="issue-item ${isBlocked ? 'issue-blocked' : ''}">
          <div class="issue-main">
            <span class="issue-badge badge-${categoryClass}">${categoryLabel}</span>
            <div class="issue-content">
              <div class="issue-desc">${escapeHtml(issue.description)}</div>
              ${issue.context ? `<div class="issue-context">${escapeHtml(issue.context)}</div>` : ''}
              ${issue.suggestion ? `<div class="issue-suggestion">Tillaga: <code>${escapeHtml(issue.suggestion)}</code></div>` : ''}
            </div>
          </div>
          <div class="issue-meta">
            ${issue.sourceFile ? `<span class="issue-location">${escapeHtml(issue.sourceFile)}${issue.line ? ':' + issue.line : ''}</span>` : ''}
            ${issue.chapter ? `<span class="issue-chapter">Kafli ${issue.chapter}</span>` : ''}
            ${issue.flagReason ? `<div class="issue-flag-reason">Ástæða: ${escapeHtml(issue.flagReason)}</div>` : ''}
          </div>
          <div class="issue-actions">
            <button class="btn btn-success btn-sm" onclick="resolveIssue('${issue.id}', '${issue.sessionId || ''}')">
              Leysa eftir umræðu
            </button>
          </div>
        </div>
      `;
    }

    function renderResolvedItem(issue) {
      const resolvedDate = issue.resolvedAt ? new Date(issue.resolvedAt).toLocaleDateString('is-IS') : '-';

      return `
        <div class="issue-item issue-resolved">
          <div class="issue-main">
            <span class="issue-badge badge-resolved">Leyst</span>
            <div class="issue-content">
              <div class="issue-desc">${escapeHtml(issue.description)}</div>
              ${issue.resolution ? `<div class="issue-resolution">Úrlausn: ${escapeHtml(issue.resolution)}</div>` : ''}
            </div>
          </div>
          <div class="issue-meta">
            <span class="issue-resolved-by">Leyst af ${escapeHtml(issue.resolvedBy || 'óþekktur')}</span>
            <span class="issue-resolved-date">${resolvedDate}</span>
          </div>
        </div>
      `;
    }

    // ============================================================================
    // ACTIONS
    // ============================================================================

    function resolveIssue(issueId, sessionId) {
      selectedIssue = { id: issueId, sessionId };
      document.getElementById('resolve-notes').value = '';
      document.getElementById('resolve-modal').style.display = 'flex';
    }

    function closeResolveModal() {
      document.getElementById('resolve-modal').style.display = 'none';
      selectedIssue = null;
    }

    async function submitResolve() {
      if (!selectedIssue) return;

      const notes = document.getElementById('resolve-notes').value.trim();

      try {
        let url;
        if (selectedIssue.sessionId) {
          url = `/api/issues/session/${selectedIssue.sessionId}/${selectedIssue.id}/resolve`;
        } else {
          url = `/api/issues/${selectedIssue.id}/resolve`;
        }

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'accept',
            resolution: notes || 'Leyst'
          })
        });

        if (res.ok) {
          closeResolveModal();
          loadStats();
          if (currentTab === 'quick-fix') loadQuickFix();
          else if (currentTab === 'discussion') loadDiscussion();
        } else {
          const err = await res.json();
          alert('Villa: ' + (err.error || 'Óþekkt villa'));
        }
      } catch (err) {
        alert('Villa við að leysa atriði: ' + err.message);
      }
    }

    function flagForDiscussion(issueId, sessionId) {
      selectedIssue = { id: issueId, sessionId };
      document.getElementById('flag-reason').value = '';
      document.getElementById('flag-modal').style.display = 'flex';
    }

    function closeFlagModal() {
      document.getElementById('flag-modal').style.display = 'none';
      selectedIssue = null;
    }

    async function submitFlag() {
      if (!selectedIssue) return;

      const reason = document.getElementById('flag-reason').value.trim();
      if (!reason) {
        alert('Vinsamlegast útskýrðu hvers vegna þetta þarf umræðu');
        return;
      }

      try {
        let url;
        if (selectedIssue.sessionId) {
          url = `/api/issues/session/${selectedIssue.sessionId}/${selectedIssue.id}/escalate`;
        } else {
          url = `/api/issues/${selectedIssue.id}/escalate`;
        }

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reason,
            newCategory: 'BOARD_REVIEW'
          })
        });

        if (res.ok) {
          closeFlagModal();
          loadStats();
          loadQuickFix();
        } else {
          const err = await res.json();
          alert('Villa: ' + (err.error || 'Óþekkt villa'));
        }
      } catch (err) {
        alert('Villa við að flytja atriði: ' + err.message);
      }
    }

    // ============================================================================
    // UTILITIES
    // ============================================================================
    // Initial load
    loadStats();
    loadQuickFix();
  </script>

  <script src="/js/theme.js"></script>
  <script src="/js/nav.js"></script>

  <style>
    /* Page-specific styles for issues management */

    .container { max-width: 1000px; }

    /* Cards */
    .card { padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem; }
    .card-subtitle { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem; }

    /* Stats Grid */
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .stat-card { text-align: center; padding: 1.5rem 1rem; background: var(--gray-50); border-radius: 0.5rem; border: 2px solid transparent; }
    .stat-card:first-child { border-color: var(--primary); background: var(--primary-light); }
    .stat-card.stat-warning { border-color: var(--warning); background: var(--warning-light); }
    .stat-card.stat-success { border-color: var(--success); background: var(--success-light); }
    .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--primary); }
    .stat-warning .stat-value { color: var(--warning); }
    .stat-success .stat-value { color: var(--success); }
    .stat-label { font-size: 0.875rem; font-weight: 600; margin-top: 0.25rem; }
    .stat-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }

    /* Tab Badge */
    .tab-badge { background: var(--gray-200); color: var(--gray-700); padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .tab.active .tab-badge { background: white; color: var(--primary); }
    .tab-badge-warning { background: var(--warning-light); color: #92400e; }

    /* Filters */
    .filters { margin-bottom: 1rem; }

    /* Issues List */
    .issues-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .issue-item { padding: 1rem; background: var(--gray-50); border-radius: 0.5rem; border: 1px solid var(--border-color); }
    .issue-item:hover { border-color: var(--gray-300); }
    .issue-blocked { border-left: 4px solid var(--error); }
    .issue-resolved { opacity: 0.7; }
    .issue-main { display: flex; gap: 0.75rem; margin-bottom: 0.5rem; }
    .issue-badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600; flex-shrink: 0; height: fit-content; }
    .badge-auto-fix { background: var(--success-light); color: #166534; }
    .badge-editor-confirm { background: var(--primary-light); color: #1e40af; }
    .badge-board-review { background: var(--warning-light); color: #92400e; }
    .badge-blocked { background: var(--error-light); color: #991b1b; }
    .badge-resolved { background: var(--gray-200); color: var(--gray-700); }
    .issue-content { flex: 1; min-width: 0; }
    .issue-desc { font-weight: 500; font-size: 0.9375rem; margin-bottom: 0.25rem; }
    .issue-context { font-size: 0.75rem; color: var(--text-muted); font-family: monospace; background: var(--bg-card); padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    .issue-suggestion { font-size: 0.8125rem; color: #166534; margin-top: 0.25rem; }
    .issue-suggestion code { background: var(--success-light); padding: 0.125rem 0.25rem; border-radius: 0.25rem; }
    .issue-resolution { font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.25rem; font-style: italic; }
    .issue-meta { display: flex; gap: 1rem; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; flex-wrap: wrap; }
    .issue-location { font-family: monospace; }
    .issue-flag-reason { font-style: italic; margin-top: 0.25rem; }
    .issue-actions { display: flex; gap: 0.5rem; }

    /* Issue Preview */
    .issue-preview { background: var(--gray-50); padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem; }

    @media (max-width: 768px) {
      .grid-3 { grid-template-columns: 1fr; }
      .issue-main { flex-direction: column; gap: 0.5rem; }
      .issue-actions { flex-wrap: wrap; }
    }
  </style>
</body>
</html>
