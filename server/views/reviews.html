<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yfirferðir - Námsbókasafn</title>
  <link rel="stylesheet" href="/css/common.css">
  <style>
    /* ==========================================================================
       REVIEWS PAGE — Basalt & Vellum
       Unified review interface: reviews list + review queue in tabbed view.
       ========================================================================== */

    /* ========================================
       FILTER TABS
       ======================================== */

    .filter-tabs {
      display: flex;
      gap: var(--spacing-xs);
      border-bottom: 1px solid var(--border);
      margin-bottom: var(--spacing-lg);
    }

    .filter-tab {
      padding: var(--spacing-sm) var(--spacing-md);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: var(--text-base);
      font-family: var(--font-body);
      color: var(--text-secondary);
      transition: all var(--transition-fast);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      white-space: nowrap;
    }

    .filter-tab:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .filter-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 500;
    }

    .filter-tab .tab-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.25rem;
      height: 1.25rem;
      padding: 0 0.375rem;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
      margin-left: var(--spacing-xs);
      background: var(--bg-elevated);
      color: var(--text-muted);
    }

    .filter-tab.active .tab-count {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    /* ========================================
       CONTROLS BAR
       ======================================== */

    .controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      gap: var(--spacing-md);
    }

    .controls-bar .filter-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    /* ========================================
       SLA SUMMARY PANEL
       ======================================== */

    .sla-panel {
      margin-bottom: var(--spacing-lg);
    }

    .sla-stats {
      display: flex;
      gap: var(--spacing-lg);
      flex-wrap: wrap;
    }

    .sla-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 70px;
    }

    .sla-stat-value {
      font-size: var(--text-xl);
      font-weight: 700;
      line-height: 1;
    }

    .sla-stat-label {
      font-size: var(--text-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: var(--spacing-xs);
    }

    .sla-stat.sla-on-track .sla-stat-value  { color: var(--success); }
    .sla-stat.sla-at-risk .sla-stat-value    { color: var(--warning); }
    .sla-stat.sla-overdue .sla-stat-value    { color: var(--accent); }
    .sla-stat.sla-critical .sla-stat-value   { color: var(--error); }
    .sla-stat.sla-avg .sla-stat-value        { color: var(--info); }
    .sla-stat-value.perf-good                { color: var(--success); }
    .sla-stat-value.perf-ok                  { color: var(--warning); }
    .sla-stat-value.perf-bad                 { color: var(--error); }

    .sla-oldest {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: var(--spacing-md);
      padding: 0.75rem var(--spacing-md);
      background: var(--error-subtle);
      border: 1px solid var(--error);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      color: var(--error);
    }

    /* ========================================
       BULK ACTIONS BAR
       ======================================== */

    .bulk-actions-bar {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: 0.75rem var(--spacing-md);
      background: var(--accent-subtle);
      border: 1px solid var(--accent);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
    }

    .bulk-count {
      font-weight: 500;
      color: var(--accent);
    }

    .th-checkbox, .td-checkbox {
      width: 40px;
      text-align: center;
    }

    .review-checkbox,
    #select-all {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
      accent-color: var(--accent);
    }

    /* ========================================
       TABLE — SLA COLUMNS
       ======================================== */

    .th-sla { width: 200px; }
    .td-sla { padding: 0.5rem 0.75rem; }

    .sla-cell {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .sla-bar-container {
      position: relative;
      width: 100%;
    }

    .sla-bar {
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      overflow: visible;
      display: flex;
    }

    .sla-bar-fill {
      height: 100%;
      border-radius: 3px 0 0 3px;
      transition: width var(--transition-slow);
    }

    .sla-bar-fill.sla-on-track  { background: var(--success); }
    .sla-bar-fill.sla-at-risk   { background: var(--warning); }
    .sla-bar-fill.sla-overdue   { background: var(--accent); }
    .sla-bar-fill.sla-critical  { background: var(--error); }

    .sla-bar-overflow {
      height: 100%;
      background: repeating-linear-gradient(
        45deg,
        var(--error),
        var(--error) 2px,
        var(--error-subtle) 2px,
        var(--error-subtle) 4px
      );
      border-radius: 0 3px 3px 0;
    }

    .sla-bar-target {
      position: absolute;
      right: 0;
      top: -2px;
      bottom: -2px;
      width: 2px;
      background: var(--text-muted);
    }

    .sla-bar-target::after {
      content: '';
      position: absolute;
      top: -3px;
      right: -3px;
      width: 8px;
      height: 3px;
      background: var(--text-muted);
      border-radius: 1px;
    }

    .sla-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.6875rem;
    }

    .sla-status-badge {
      padding: 0.125rem 0.375rem;
      border-radius: var(--radius-full);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-size: var(--text-xs);
    }

    .sla-status-badge.sla-on-track  { background: var(--success-subtle); color: var(--success); }
    .sla-status-badge.sla-at-risk   { background: var(--warning-subtle); color: var(--warning); }
    .sla-status-badge.sla-overdue   { background: var(--accent-subtle);  color: var(--accent); }
    .sla-status-badge.sla-critical  { background: var(--error-subtle);   color: var(--error); }

    .sla-time {
      color: var(--text-muted);
    }

    /* Row highlighting based on SLA status */
    tr.sla-critical             { background: var(--error-subtle); }
    tr.sla-critical:hover       { background: var(--error-subtle); filter: brightness(1.05); }
    tr.sla-overdue              { background: var(--warning-subtle); }
    tr.sla-overdue:hover        { background: var(--warning-subtle); filter: brightness(1.05); }
    tr.sla-at-risk              { background: var(--warning-subtle); }
    tr.sla-at-risk:hover        { background: var(--warning-subtle); filter: brightness(1.05); }

    /* ========================================
       REVIEW QUEUE — BADGES
       ======================================== */

    .rq-table th { white-space: nowrap; }
    .rq-table code {
      font-size: var(--text-sm);
      background: var(--bg-elevated);
      padding: 0.125rem 0.375rem;
      border-radius: var(--radius-sm);
    }

    .rq-badges {
      display: flex;
      gap: 0.375rem;
      flex-wrap: wrap;
    }

    .rq-badge {
      display: inline-block;
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: var(--radius-full);
      white-space: nowrap;
    }

    .rq-badge-pending  { background: var(--accent-subtle);  color: var(--accent); }
    .rq-badge-approved { background: var(--success-subtle); color: var(--success); }
    .rq-badge-rejected { background: var(--error-subtle);   color: var(--error); }
    .rq-badge-discuss  { background: var(--warning-subtle); color: var(--warning); }

    .rq-sla {
      display: inline-block;
      font-size: var(--text-xs);
      font-weight: 600;
      padding: 0.25rem 0.625rem;
      border-radius: var(--radius-full);
      white-space: nowrap;
    }

    .rq-sla.sla-on-track  { background: var(--success-subtle); color: var(--success); }
    .rq-sla.sla-at-risk   { background: var(--warning-subtle); color: var(--warning); }
    .rq-sla.sla-overdue   { background: var(--accent-subtle);  color: var(--accent); }
    .rq-sla.sla-critical  { background: var(--error-subtle);   color: var(--error); }

    /* ========================================
       MODAL — REVIEW DETAIL
       ======================================== */

    .review-modal .modal-content {
      max-width: 900px;
      display: flex;
      flex-direction: column;
    }

    .review-modal .modal-header h3 {
      font-family: var(--font-heading);
      font-size: var(--text-lg);
    }

    .review-info {
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }

    .info-row {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-xs);
      font-size: var(--text-base);
    }

    .info-label {
      font-weight: 500;
      color: var(--text-muted);
      min-width: 80px;
    }

    /* Modal tab content */
    .modal-tab-content {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      max-height: 400px;
      overflow: auto;
    }

    .modal-tab-content pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: var(--font-mono);
      font-size: var(--text-base);
      line-height: 1.6;
      margin: 0;
      color: var(--text-primary);
    }

    .notes-section {
      margin-top: var(--spacing-md);
    }

    /* ========================================
       DIFF VIEW (inline fallback)
       ======================================== */

    .diff-line-del {
      background: var(--error-subtle);
      color: var(--error);
    }

    .diff-line-add {
      background: var(--success-subtle);
      color: var(--success);
    }

    .diff-line-ctx {
      color: var(--text-secondary);
    }

    /* Diff2html overrides */
    .d2h-wrapper { font-size: var(--text-sm); }
    .d2h-file-header { display: none; }

    /* ========================================
       CATEGORY BADGES
       ======================================== */

    .category-badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      background: var(--bg-elevated);
      color: var(--text-muted);
    }

    .category-badge.terminology { background: var(--accent-subtle); color: var(--accent); }
    .category-badge.accuracy    { background: var(--error-subtle);   color: var(--error); }
    .category-badge.readability { background: var(--success-subtle); color: var(--success); }
    .category-badge.style       { background: var(--info-subtle);    color: var(--info); }
    .category-badge.omission    { background: var(--warning-subtle); color: var(--warning); }

    /* ========================================
       RESPONSIVE
       ======================================== */

    @media (max-width: 1024px) {
      .sla-stats { gap: var(--spacing-md); }
      .sla-stat { min-width: 50px; }
      .th-sla { width: 150px; }
    }

    @media (max-width: 768px) {
      .filter-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .review-modal .modal-content {
        width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
      }

      .bulk-actions-bar { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <main class="page-content" id="main-content" data-page="reviews" data-title="Yfirferðir">

    <!-- ============================================================
         FILTER TABS
         ============================================================ -->

    <div class="filter-tabs" role="tablist" aria-label="Sía yfirferðir">
      <button class="filter-tab active" role="tab" data-filter="all" aria-selected="true" onclick="switchFilterTab('all')">
        Allar <span class="tab-count" id="count-all">0</span>
      </button>
      <button class="filter-tab" role="tab" data-filter="pending" aria-selected="false" onclick="switchFilterTab('pending')">
        &#205; bi&#240; <span class="tab-count" id="count-pending">0</span>
      </button>
      <button class="filter-tab" role="tab" data-filter="approved" aria-selected="false" onclick="switchFilterTab('approved')">
        Samþykktar <span class="tab-count" id="count-approved">0</span>
      </button>
      <button class="filter-tab" role="tab" data-filter="rejected" aria-selected="false" onclick="switchFilterTab('rejected')">
        Hafna&#240; <span class="tab-count" id="count-rejected">0</span>
      </button>
      <button class="filter-tab" role="tab" data-filter="queue" aria-selected="false" onclick="switchFilterTab('queue')">
        Yfirfer&#240;arr&#246;&#240; <span class="tab-count" id="count-queue">0</span>
      </button>
    </div>

    <!-- ============================================================
         CONTROLS BAR — book filter
         ============================================================ -->

    <div class="controls-bar">
      <div class="filter-controls">
        <label for="book-filter" class="form-label" style="margin:0">B&#243;k:</label>
        <select id="book-filter" class="form-select">
          <option value="">Allar b&#230;kur</option>
          <option value="efnafraedi">Efnafr&#230;&#240;i</option>
          <option value="liffraedi">L&#237;ffr&#230;&#240;i</option>
        </select>
      </div>
    </div>

    <!-- ============================================================
         SLA SUMMARY — shown when reviews are loaded
         ============================================================ -->

    <div class="accordion sla-panel" id="sla-accordion" style="display: none;">
      <button class="accordion-header" aria-expanded="true" onclick="toggleAccordion('sla-accordion')">
        <div class="accordion-header-left">
          <span class="accordion-toggle">&#9660;</span>
          <span>SLA Sta&#240;a</span>
        </div>
        <span style="font-size:var(--text-xs);color:var(--text-muted)">Markmi&#240;: <strong id="sla-target-days">2</strong> dagar</span>
      </button>
      <div class="accordion-body" id="sla-summary">
        <div class="sla-stats">
          <div class="sla-stat sla-on-track">
            <span class="sla-stat-value" id="sla-on-track">0</span>
            <span class="sla-stat-label">&#193; r&#233;ttri lei&#240;</span>
          </div>
          <div class="sla-stat sla-at-risk">
            <span class="sla-stat-value" id="sla-at-risk">0</span>
            <span class="sla-stat-label">&#193; m&#246;rkum</span>
          </div>
          <div class="sla-stat sla-overdue">
            <span class="sla-stat-value" id="sla-overdue">0</span>
            <span class="sla-stat-label">Yfir t&#237;ma</span>
          </div>
          <div class="sla-stat sla-critical">
            <span class="sla-stat-value" id="sla-critical">0</span>
            <span class="sla-stat-label">Mj&#246;g seint</span>
          </div>
          <div class="sla-stat sla-avg">
            <span class="sla-stat-value" id="sla-avg">0</span>
            <span class="sla-stat-label">Me&#240;altal (dagar)</span>
          </div>
          <div class="sla-stat sla-performance">
            <span class="sla-stat-value" id="sla-performance">-</span>
            <span class="sla-stat-label">SLA fylgni</span>
          </div>
        </div>
        <div class="sla-oldest" id="sla-oldest" style="display: none;">
          <span>&#9888;</span>
          <span>Elsta yfirfer&#240;: <strong id="oldest-review-info"></strong></span>
          <button class="btn btn-sm btn-primary" id="view-oldest-btn">Sko&#240;a</button>
        </div>
      </div>
    </div>

    <!-- ============================================================
         TAB PANELS
         ============================================================ -->

    <!-- Reviews Panel (all / pending / approved / rejected) -->
    <div class="tab-panel active" id="panel-reviews">
      <div class="card">
        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="bulk-actions-bar" style="display: none;">
          <span class="bulk-count"><span id="selected-count">0</span> valin</span>
          <button class="btn btn-sm btn-success" onclick="bulkApprove()">Sam&#254;ykkja valin</button>
          <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Hreinsa val</button>
        </div>

        <div id="reviews-list">
          <div class="loading-state"><span class="spinner"></span><span>Hle&#240;ur...</span></div>
        </div>
      </div>
    </div>

    <!-- Review Queue Panel -->
    <div class="tab-panel" id="panel-queue">
      <div class="card">
        <div id="queue-content">
          <div class="loading-state"><span class="spinner"></span><span>Hle&#240;ur...</span></div>
        </div>
      </div>
    </div>

    <!-- ============================================================
         REVIEW DETAIL MODAL
         ============================================================ -->

    <div class="modal review-modal" role="dialog" aria-modal="true" id="review-modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modal-title">Yfirfer&#240;</h3>
          <button class="btn-close" id="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="review-info">
            <div class="info-row">
              <span class="info-label">Sent af:</span>
              <span id="review-author"></span>
            </div>
            <div class="info-row">
              <span class="info-label">T&#237;mi:</span>
              <span id="review-date"></span>
            </div>
            <div class="info-row">
              <span class="info-label">Skr&#225;:</span>
              <code id="review-file"></code>
            </div>
          </div>

          <!-- Modal Tab navigation -->
          <div class="tabs" role="tablist">
            <button class="tab active" data-tab="content">&#222;&#253;&#240;ing</button>
            <button class="tab" data-tab="source">Enska</button>
            <button class="tab" data-tab="diff">Breytingar</button>
          </div>

          <!-- Modal Tab content -->
          <div class="modal-tab-content" id="tab-content">
            <pre id="content-view"></pre>
          </div>
          <div class="modal-tab-content" id="tab-source" style="display: none;">
            <pre id="source-view"></pre>
          </div>
          <div class="modal-tab-content" id="tab-diff" style="display: none;">
            <div id="diff-view"></div>
          </div>

          <!-- Notes for changes requested -->
          <div class="notes-section" id="notes-section" style="display: none;">
            <label class="form-label">Athugasemdir:</label>
            <textarea id="review-notes" class="form-textarea" placeholder="Skrifaðu hvaða breytingar þarf að gera..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-warning" id="request-changes-btn">
            Bi&#240;ja um breytingar
          </button>
          <button class="btn btn-success" id="approve-btn">
            Sam&#254;ykkja
          </button>
          <button class="btn btn-primary" id="approve-commit-btn">
            Sam&#254;ykkja og skrifa
          </button>
        </div>
      </div>
    </div>

  </main>

  <script src="/js/layout.js"></script>
  <script src="/js/theme.js"></script>
  <script src="/js/htmlUtils.js"></script>
  <script>
    // ========================================
    // STATE
    // ========================================

    var currentReviewId = null;
    var currentReview = null;
    var selectedReviews = new Set();
    var allReviews = [];
    var currentFilter = 'all';

    // ========================================
    // INITIALIZATION
    // ========================================

    function init() {
      // Wait for layout.js to load auth, then check role
      window.addEventListener('userLoaded', function (e) {
        var user = e.detail;
        if (!user || !['admin', 'head-editor'].includes(user.role)) {
          document.getElementById('reviews-list').innerHTML =
            '<div class="alert alert-warning">&#222;&#250; hefur ekki r&#233;ttindi til a&#240; sko&#240;a yfirfer&#240;ir.</div>';
          return;
        }
        loadReviews();
        loadQueue();
        updateBadge();
      });

      // Setup event listeners
      setupEventListeners();
    }

    function setupEventListeners() {
      document.getElementById('book-filter').addEventListener('change', function () {
        if (currentFilter === 'queue') {
          loadQueue();
        } else {
          loadReviews();
        }
      });

      document.getElementById('close-modal').addEventListener('click', closeModal);
      document.getElementById('approve-btn').addEventListener('click', function () { approveReview(false); });
      document.getElementById('approve-commit-btn').addEventListener('click', function () { approveReview(true); });
      document.getElementById('request-changes-btn').addEventListener('click', toggleNotesSection);

      // Modal tab switching
      document.querySelectorAll('#review-modal .tab').forEach(function (tab) {
        tab.addEventListener('click', function () { switchModalTab(tab.dataset.tab); });
      });

      // Close modal on escape
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeModal();
      });

      // Close modal on backdrop click
      document.getElementById('review-modal').addEventListener('click', function (e) {
        if (e.target.id === 'review-modal') closeModal();
      });
    }

    // ========================================
    // FILTER TABS
    // ========================================

    function switchFilterTab(filter) {
      currentFilter = filter;

      // Update tab styling
      document.querySelectorAll('.filter-tab').forEach(function (tab) {
        var isActive = tab.dataset.filter === filter;
        tab.classList.toggle('active', isActive);
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });

      // Show/hide panels
      var showQueue = (filter === 'queue');
      document.getElementById('panel-reviews').classList.toggle('active', !showQueue);
      document.getElementById('panel-queue').classList.toggle('active', showQueue);

      // SLA panel visible only on reviews (not queue)
      var slaAccordion = document.getElementById('sla-accordion');
      if (showQueue) {
        slaAccordion.style.display = 'none';
      }

      if (showQueue) {
        loadQueue();
      } else {
        filterReviewsList(filter);
      }
    }

    function filterReviewsList(filter) {
      if (!allReviews.length) return;

      var filtered = allReviews;
      if (filter === 'pending') {
        filtered = allReviews.filter(function (r) { return r.status === 'pending'; });
      } else if (filter === 'approved') {
        filtered = allReviews.filter(function (r) { return r.status === 'approved'; });
      } else if (filter === 'rejected') {
        filtered = allReviews.filter(function (r) { return r.status === 'rejected' || r.status === 'changes_requested'; });
      }

      renderReviewsTable(filtered);
    }

    function updateTabCounts() {
      var counts = { all: allReviews.length, pending: 0, approved: 0, rejected: 0 };
      allReviews.forEach(function (r) {
        if (r.status === 'pending') counts.pending++;
        else if (r.status === 'approved') counts.approved++;
        else if (r.status === 'rejected' || r.status === 'changes_requested') counts.rejected++;
      });

      document.getElementById('count-all').textContent = counts.all;
      document.getElementById('count-pending').textContent = counts.pending;
      document.getElementById('count-approved').textContent = counts.approved;
      document.getElementById('count-rejected').textContent = counts.rejected;
    }

    // ========================================
    // LOAD REVIEWS (reviews API)
    // ========================================

    async function loadReviews() {
      var listEl = document.getElementById('reviews-list');
      var book = document.getElementById('book-filter').value;

      listEl.innerHTML = '<div class="loading-state"><span class="spinner"></span><span>Hle\u00F0ur...</span></div>';

      try {
        var url = book ? '/api/reviews?book=' + book : '/api/reviews';
        var data = await fetchJson(url);

        // Update SLA summary
        updateSLASummary(data.slaStats);

        if (!data.reviews || data.reviews.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><p>Engar yfirfer\u00F0ir \u00ED bi\u00F0</p></div>';
          allReviews = [];
          selectedReviews.clear();
          updateBulkActionsBar();
          updateTabCounts();
          return;
        }

        allReviews = data.reviews;
        selectedReviews.clear();
        updateBulkActionsBar();
        updateTabCounts();

        // Apply current filter
        filterReviewsList(currentFilter === 'queue' ? 'all' : currentFilter);
      } catch (err) {
        listEl.innerHTML = '<div class="alert alert-error">Villa: ' + escapeHtml(err.message) + '</div>';
      }
    }

    function renderReviewsTable(reviews) {
      var listEl = document.getElementById('reviews-list');

      if (!reviews || reviews.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><p>Engar yfirfer\u00F0ir \u00ED \u00FEessum flokki</p></div>';
        return;
      }

      var html = '<table class="data-table">' +
        '<thead><tr>' +
        '<th class="th-checkbox"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>' +
        '<th>Kafli</th><th>Sent af</th><th class="th-sla">SLA Sta\u00F0a</th><th></th></tr></thead>' +
        '<tbody>';

      reviews.forEach(function (r) {
        var sla = r.sla || {};
        var slaClass = sla.statusClass || 'sla-on-track';
        var slaPercent = Math.min(sla.slaPercentage || 0, 100);
        var slaOverflow = (sla.slaPercentage || 0) > 100 ? Math.min((sla.slaPercentage - 100), 100) : 0;

        html += '<tr data-id="' + r.id + '" class="' + slaClass + '">' +
          '<td class="td-checkbox"><input type="checkbox" class="review-checkbox" value="' + r.id + '" onchange="toggleReviewSelect(' + r.id + ')"></td>' +
          '<td><strong>' + escapeHtml(r.book) + '</strong> / K' + escapeHtml(String(r.chapter)) + ' / ' + escapeHtml(r.section) + '</td>' +
          '<td>' + escapeHtml(r.submittedByUsername) + '</td>' +
          '<td class="td-sla">' +
            '<div class="sla-cell">' +
              '<div class="sla-bar-container">' +
                '<div class="sla-bar">' +
                  '<div class="sla-bar-fill ' + slaClass + '" style="width: ' + slaPercent + '%"></div>' +
                  (slaOverflow > 0 ? '<div class="sla-bar-overflow" style="width: ' + slaOverflow + '%"></div>' : '') +
                '</div>' +
                '<div class="sla-bar-target" title="Markmi\u00F0: ' + ((sla.target && sla.target.days) || 2) + ' dagar"></div>' +
              '</div>' +
              '<div class="sla-info">' +
                '<span class="sla-status-badge ' + slaClass + '">' + escapeHtml(sla.statusLabel || '-') + '</span>' +
                '<span class="sla-time">' + escapeHtml(sla.timeMessage || '-') + '</span>' +
              '</div>' +
            '</div>' +
          '</td>' +
          '<td><button class="btn btn-sm btn-primary" onclick="openReview(' + r.id + ')">Sko\u00F0a</button></td>' +
          '</tr>';
      });

      html += '</tbody></table>';
      listEl.innerHTML = html;
    }

    // ========================================
    // LOAD REVIEW QUEUE (segment-editor API)
    // ========================================

    async function loadQueue() {
      var container = document.getElementById('queue-content');
      var book = document.getElementById('book-filter').value || 'efnafraedi';

      container.innerHTML = '<div class="loading-state"><span class="spinner"></span><span>Hle\u00F0ur...</span></div>';

      try {
        var data = await fetchJson('/api/segment-editor/review-queue?book=' + encodeURIComponent(book));

        if (!data.reviews || data.reviews.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>Engar yfirfer\u00F0ir \u00ED bi\u00F0</p></div>';
          document.getElementById('count-queue').textContent = '0';
          return;
        }

        document.getElementById('count-queue').textContent = data.reviews.length;
        renderQueueTable(data.reviews, book);
      } catch (err) {
        container.innerHTML = '<div class="alert alert-error">' + escapeHtml(err.message) + '</div>';
      }
    }

    function renderQueueTable(reviews, book) {
      var container = document.getElementById('queue-content');

      var html = '<table class="data-table rq-table">' +
        '<thead><tr>' +
          '<th>Kafli</th>' +
          '<th>Eining</th>' +
          '<th>Ritstj\u00F3ri</th>' +
          '<th>Sent</th>' +
          '<th>Breytingar</th>' +
          '<th>SLA</th>' +
          '<th></th>' +
        '</tr></thead>' +
        '<tbody>';

      reviews.forEach(function (r) {
        var slaClass = slaToClass(r.sla);
        var slaLabel = slaToLabel(r.sla);
        var submittedDate = r.submitted_at ? new Date(r.submitted_at).toLocaleDateString('is-IS') : '-';
        var moduleId = r.module_id || '-';
        var chapter = r.chapter || '-';
        var editor = r.submitted_by_username || '-';

        var pending = r.pending_edits || 0;
        var approved = r.approved_edits || 0;
        var rejected = r.rejected_edits || 0;
        var discuss = r.discuss_edits || 0;

        var editorUrl = '/segment-editor?book=' + encodeURIComponent(book) +
          '&chapter=' + encodeURIComponent(chapter) +
          '&module=' + encodeURIComponent(moduleId) +
          '&reviewId=' + encodeURIComponent(r.id);

        html += '<tr class="' + slaClass + '">' +
          '<td>' + escapeHtml(String(chapter)) + '</td>' +
          '<td><code>' + escapeHtml(String(moduleId)) + '</code></td>' +
          '<td>' + escapeHtml(String(editor)) + '</td>' +
          '<td>' + escapeHtml(submittedDate) + '</td>' +
          '<td class="rq-badges">' +
            (pending > 0 ? '<span class="rq-badge rq-badge-pending">' + pending + ' bi\u00F0</span>' : '') +
            (approved > 0 ? '<span class="rq-badge rq-badge-approved">' + approved + ' sam\u00FE.</span>' : '') +
            (rejected > 0 ? '<span class="rq-badge rq-badge-rejected">' + rejected + ' hafn.</span>' : '') +
            (discuss > 0 ? '<span class="rq-badge rq-badge-discuss">' + discuss + ' umr.</span>' : '') +
            ((pending + approved + rejected + discuss === 0) ? '<span class="text-muted">-</span>' : '') +
          '</td>' +
          '<td><span class="rq-sla ' + slaClass + '">' + escapeHtml(slaLabel) + '</span></td>' +
          '<td><a href="' + editorUrl + '" class="btn btn-sm btn-primary">Yfirfara</a></td>' +
        '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ========================================
    // SLA HELPERS (for queue)
    // ========================================

    function slaToClass(sla) {
      if (!sla) return 'sla-on-track';
      var map = {
        'on-track': 'sla-on-track',
        'at-risk': 'sla-at-risk',
        'overdue': 'sla-overdue',
        'critical': 'sla-critical'
      };
      return map[sla] || 'sla-on-track';
    }

    function slaToLabel(sla) {
      if (!sla) return '\u00C1 r\u00E9ttri lei\u00F0';
      var map = {
        'on-track': '\u00C1 r\u00E9ttri lei\u00F0',
        'at-risk': '\u00C1 m\u00F6rkum',
        'overdue': 'Yfir t\u00EDma',
        'critical': 'Mj\u00F6g seint'
      };
      return map[sla] || sla;
    }

    // ========================================
    // SLA SUMMARY (reviews API)
    // ========================================

    function toggleAccordion(accordionId) {
      var accordion = document.getElementById(accordionId);
      if (accordion) {
        accordion.classList.toggle('collapsed');
      }
    }

    function updateSLASummary(stats) {
      var accordion = document.getElementById('sla-accordion');
      if (!stats) {
        accordion.style.display = 'none';
        return;
      }

      accordion.style.display = 'block';
      document.getElementById('sla-target-days').textContent = (stats.target && stats.target.targetDays) || 2;
      document.getElementById('sla-on-track').textContent = stats.onTrack || 0;
      document.getElementById('sla-at-risk').textContent = stats.atRisk || 0;
      document.getElementById('sla-overdue').textContent = stats.overdue || 0;
      document.getElementById('sla-critical').textContent = stats.critical || 0;
      document.getElementById('sla-avg').textContent = stats.avgDaysPending || 0;

      // SLA performance percentage
      var perfEl = document.getElementById('sla-performance');
      var perf = stats.total > 0
        ? Math.round((stats.onTrack / stats.total) * 100)
        : 100;
      perfEl.textContent = perf + '%';
      perfEl.className = 'sla-stat-value ' + (perf >= 80 ? 'perf-good' : perf >= 50 ? 'perf-ok' : 'perf-bad');

      // Oldest review
      var oldestEl = document.getElementById('sla-oldest');
      if (stats.oldest && stats.oldest.sla && stats.oldest.sla.isCritical) {
        var oldest = stats.oldest;
        document.getElementById('oldest-review-info').textContent =
          oldest.book + ' K' + oldest.chapter + ' - ' + oldest.sla.daysPending + ' dagar \u00ED bi\u00F0';
        document.getElementById('view-oldest-btn').onclick = function () { openReview(oldest.id); };
        oldestEl.style.display = 'flex';
      } else {
        oldestEl.style.display = 'none';
      }
    }

    // ========================================
    // BADGE COUNT
    // ========================================

    async function updateBadge() {
      try {
        var data = await fetchJson('/api/reviews/count');
        // Badge is handled by layout.js notification bell if needed
      } catch (err) {
        // Ignore badge errors
      }
    }

    // ========================================
    // REVIEW DETAIL — open / close
    // ========================================

    async function openReview(id) {
      currentReviewId = id;

      try {
        var review = await fetchJson('/api/reviews/' + id);
        currentReview = review;

        // Set modal content
        document.getElementById('modal-title').textContent =
          review.book + ' / Kafli ' + review.chapter + ' / ' + review.section;
        document.getElementById('review-author').textContent = review.submittedByUsername;
        document.getElementById('review-date').textContent = new Date(review.submittedAt).toLocaleString('is-IS');
        document.getElementById('review-file').textContent = review.filePath;

        // Set content
        document.getElementById('content-view').textContent = review.content || '(Enginn texti)';
        document.getElementById('source-view').textContent = review.enContent || '(Enski textinn er ekki tilt\u00E6kur)';

        // Generate diff
        generateDiff(review.currentContent || '', review.content || '');

        // Reset state
        document.getElementById('notes-section').style.display = 'none';
        document.getElementById('review-notes').value = '';
        switchModalTab('content');

        // Show modal
        document.getElementById('review-modal').style.display = 'flex';
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    function closeModal() {
      document.getElementById('review-modal').style.display = 'none';
      currentReviewId = null;
      currentReview = null;
    }

    // ========================================
    // MODAL TABS
    // ========================================

    function switchModalTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('#review-modal .tab').forEach(function (t) {
        t.classList.toggle('active', t.dataset.tab === tabName);
      });

      // Update content
      document.getElementById('tab-content').style.display = tabName === 'content' ? 'block' : 'none';
      document.getElementById('tab-source').style.display = tabName === 'source' ? 'block' : 'none';
      document.getElementById('tab-diff').style.display = tabName === 'diff' ? 'block' : 'none';
    }

    // ========================================
    // DIFF GENERATION
    // ========================================

    function generateDiff(oldContent, newContent) {
      var diffEl = document.getElementById('diff-view');

      if (!oldContent) {
        diffEl.innerHTML = '<p class="text-muted">Engin fyrri \u00FAtg\u00E1fa til samanburðar (n\u00FDr texti)</p>';
        return;
      }

      // Generate unified diff
      var diff = createUnifiedDiff(oldContent, newContent);

      if (typeof Diff2HtmlUI !== 'undefined') {
        var diff2htmlUi = new Diff2HtmlUI(diffEl, diff, {
          drawFileList: false,
          matching: 'lines',
          outputFormat: 'side-by-side'
        });
        diff2htmlUi.draw();
      } else {
        // Inline fallback with colored lines
        var lines = diff.split('\n');
        var html = '<pre>';
        lines.forEach(function (line) {
          if (line.startsWith('-') && !line.startsWith('---')) {
            html += '<span class="diff-line-del">' + escapeHtml(line) + '</span>\n';
          } else if (line.startsWith('+') && !line.startsWith('+++')) {
            html += '<span class="diff-line-add">' + escapeHtml(line) + '</span>\n';
          } else {
            html += '<span class="diff-line-ctx">' + escapeHtml(line) + '</span>\n';
          }
        });
        html += '</pre>';
        diffEl.innerHTML = html;
      }
    }

    function createUnifiedDiff(oldStr, newStr) {
      var oldLines = oldStr.split('\n');
      var newLines = newStr.split('\n');

      var diff = '--- a/file.md\n+++ b/file.md\n';
      var maxLines = Math.max(oldLines.length, newLines.length);

      for (var i = 0; i < maxLines; i++) {
        var oldLine = oldLines[i];
        var newLine = newLines[i];

        if (oldLine === newLine) {
          diff += ' ' + (oldLine || '') + '\n';
        } else {
          if (oldLine !== undefined) {
            diff += '-' + oldLine + '\n';
          }
          if (newLine !== undefined) {
            diff += '+' + newLine + '\n';
          }
        }
      }

      return diff;
    }

    // ========================================
    // NOTES SECTION
    // ========================================

    function toggleNotesSection() {
      var section = document.getElementById('notes-section');
      var isVisible = section.style.display !== 'none';

      if (isVisible) {
        section.style.display = 'none';
      } else {
        section.style.display = 'block';
        document.getElementById('review-notes').focus();
      }
    }

    // ========================================
    // APPROVE / REQUEST CHANGES
    // ========================================

    async function approveReview(commit) {
      if (!currentReviewId) return;

      var action = commit ? 'sam\u00FEykkja og skrifa (commit)' : 'sam\u00FEykkja';
      if (!confirm('Ertu viss um a\u00F0 \u00FE\u00FA viljir ' + action + ' \u00FEessa \u00FE\u00FD\u00F0ingu?')) {
        return;
      }

      var btn = commit ? document.getElementById('approve-commit-btn') : document.getElementById('approve-btn');
      var originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner spinner-sm"></span> Vinnur...';

      try {
        var data = await fetchJson('/api/reviews/' + currentReviewId + '/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ commit: commit })
        });

        if (data.success) {
          var msg = '\u00DE\u00FD\u00F0ing sam\u00FEykkt!';
          if (data.committed) {
            msg += '\n\nCommit SHA: ' + data.commitSha;
          }
          alert(msg);
          closeModal();
          loadReviews();
          updateBadge();
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki sam\u00FEykkt'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function requestChanges() {
      if (!currentReviewId) return;

      var notes = document.getElementById('review-notes').value.trim();
      if (!notes) {
        alert('Vinsamlegast skrifaðu athugasemdir');
        document.getElementById('review-notes').focus();
        return;
      }

      var btn = document.getElementById('request-changes-btn');
      btn.disabled = true;

      try {
        var data = await fetchJson('/api/reviews/' + currentReviewId + '/changes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes: notes })
        });

        if (data.success) {
          alert('Athugasemdir sendar til ritstj\u00F3ra.');
          closeModal();
          loadReviews();
          updateBadge();
        } else {
          alert('Villa: ' + (data.error || 'Gat ekki sent athugasemdir'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    }

    // ========================================
    // BULK OPERATIONS
    // ========================================

    function toggleSelectAll() {
      var selectAllCheckbox = document.getElementById('select-all');
      var checkboxes = document.querySelectorAll('.review-checkbox');

      checkboxes.forEach(function (cb) {
        cb.checked = selectAllCheckbox.checked;
        var reviewId = parseInt(cb.value);
        if (selectAllCheckbox.checked) {
          selectedReviews.add(reviewId);
        } else {
          selectedReviews.delete(reviewId);
        }
      });

      updateBulkActionsBar();
    }

    function toggleReviewSelect(reviewId) {
      if (selectedReviews.has(reviewId)) {
        selectedReviews.delete(reviewId);
      } else {
        selectedReviews.add(reviewId);
      }

      // Update select-all checkbox state
      var selectAllCheckbox = document.getElementById('select-all');
      var checkboxes = document.querySelectorAll('.review-checkbox');
      var allChecked = Array.from(checkboxes).every(function (cb) { return cb.checked; });
      var someChecked = Array.from(checkboxes).some(function (cb) { return cb.checked; });

      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;

      updateBulkActionsBar();
    }

    function updateBulkActionsBar() {
      var bar = document.getElementById('bulk-actions-bar');
      var countEl = document.getElementById('selected-count');

      if (selectedReviews.size > 0) {
        bar.style.display = 'flex';
        countEl.textContent = selectedReviews.size;
      } else {
        bar.style.display = 'none';
      }
    }

    function clearSelection() {
      selectedReviews.clear();
      var checkboxes = document.querySelectorAll('.review-checkbox');
      checkboxes.forEach(function (cb) { cb.checked = false; });
      var selectAll = document.getElementById('select-all');
      if (selectAll) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }
      updateBulkActionsBar();
    }

    async function bulkApprove() {
      if (selectedReviews.size === 0) return;

      var count = selectedReviews.size;
      if (!confirm('Ertu viss um a\u00F0 \u00FE\u00FA viljir sam\u00FEykkja ' + count + (count === 1 ? ' yfirfer\u00F0' : ' yfirfer\u00F0ir') + '?')) {
        return;
      }

      try {
        var reviewIds = Array.from(selectedReviews);
        var data = await fetchJson('/api/reviews/bulk/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reviewIds: reviewIds,
            commit: false
          })
        });

        // Show results
        var message = 'Sam\u00FEykkt: ' + data.summary.approved;
        if (data.summary.skipped > 0) {
          message += '\nSleppt: ' + data.summary.skipped;
        }
        if (data.summary.failed > 0) {
          message += '\nMist\u00F3kst: ' + data.summary.failed;
        }
        alert(message);
      } catch (err) {
        console.error('Bulk approve error:', err);
        alert('Villa vi\u00F0 fj\u00F6ldasam\u00FEykkt: ' + err.message);
      }

      // Refresh list
      clearSelection();
      loadReviews();
      updateBadge();
    }

    // ========================================
    // INITIALIZE
    // ========================================

    init();
  </script>
</body>
</html>
