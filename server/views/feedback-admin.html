<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stjórnborð endurgjafar - Námsbókasafn</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/my-work">Mín verkefni</a>
      <a href="/workflow">Verkflæði</a>
      <a href="/status">Stjórnborð</a>
      <a href="/editor">Ritstjóri</a>
      <a href="/terminology">Orðasafn</a>
      <a href="/decisions">Ákvarðanir</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stjórnborð</a>
      <a href="/admin" class="admin-only admin-link">Stjórnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um þema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notification-bell" id="notification-bell" title="Tilkynningar" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <nav class="breadcrumb">
      <a href="/admin">Stjórnandi</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current">Endurgjöf</span>
    </nav>

    <!-- Stats Cards -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-icon open"><i class="fas fa-inbox"></i></div>
        <div class="stat-content">
          <span class="stat-value" id="stat-open">-</span>
          <span class="stat-label">Opin</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon progress"><i class="fas fa-spinner"></i></div>
        <div class="stat-content">
          <span class="stat-value" id="stat-progress">-</span>
          <span class="stat-label">Í vinnslu</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon resolved"><i class="fas fa-check-circle"></i></div>
        <div class="stat-content">
          <span class="stat-value" id="stat-resolved">-</span>
          <span class="stat-label">Leyst</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon total"><i class="fas fa-comments"></i></div>
        <div class="stat-content">
          <span class="stat-value" id="stat-total">-</span>
          <span class="stat-label">Samtals</span>
        </div>
      </div>
    </div>

    <!-- Filters & List -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Endurgjöf</h2>
        <div class="filter-controls">
          <select id="status-filter" class="form-select form-select-small">
            <option value="">Allar stöður</option>
            <option value="open" selected>Opin</option>
            <option value="in_progress">Í vinnslu</option>
            <option value="resolved">Leyst</option>
            <option value="wont_fix">Verður ekki lagað</option>
          </select>
          <select id="type-filter" class="form-select form-select-small">
            <option value="">Allar tegundir</option>
            <option value="translation_error">Villa í þýðingu</option>
            <option value="technical_issue">Tæknilegt vandamál</option>
            <option value="improvement">Tillaga að bætingu</option>
            <option value="other">Annað</option>
          </select>
          <select id="priority-filter" class="form-select form-select-small">
            <option value="">Öll forgangsröðun</option>
            <option value="critical">Mjög há</option>
            <option value="high">Há</option>
            <option value="normal">Venjuleg</option>
            <option value="low">Lág</option>
          </select>
        </div>
      </div>
      <div id="feedback-list">
        <p class="loading"><i class="fas fa-spinner fa-spin"></i> Hleður...</p>
      </div>
      <div class="pagination" id="pagination" style="display: none;">
        <button class="btn btn-secondary btn-small" id="prev-btn" disabled>
          <i class="fas fa-chevron-left"></i> Fyrri
        </button>
        <span id="page-info"></span>
        <button class="btn btn-secondary btn-small" id="next-btn">
          Næsta <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </main>

  <!-- Feedback Detail Modal -->
  <div class="modal" id="feedback-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Endurgjöf #<span id="modal-id"></span></h2>
        <button class="btn-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Metadata -->
        <div class="feedback-meta">
          <div class="meta-row">
            <span class="meta-label">Tegund:</span>
            <span id="detail-type" class="badge"></span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Staða:</span>
            <select id="detail-status" class="form-select form-select-small">
              <option value="open">Opið</option>
              <option value="in_progress">Í vinnslu</option>
              <option value="resolved">Leyst</option>
              <option value="wont_fix">Verður ekki lagað</option>
            </select>
          </div>
          <div class="meta-row">
            <span class="meta-label">Forgangur:</span>
            <select id="detail-priority" class="form-select form-select-small">
              <option value="low">Lágur</option>
              <option value="normal">Venjulegur</option>
              <option value="high">Hár</option>
              <option value="critical">Mjög hár</option>
            </select>
          </div>
          <div class="meta-row">
            <span class="meta-label">Staðsetning:</span>
            <span id="detail-location"></span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Sent:</span>
            <span id="detail-created"></span>
          </div>
          <div class="meta-row" id="detail-contact-row" style="display: none;">
            <span class="meta-label">Tengiliður:</span>
            <span id="detail-contact"></span>
          </div>
        </div>

        <!-- Message -->
        <div class="feedback-message">
          <h3>Skilaboð</h3>
          <div id="detail-message" class="message-content"></div>
        </div>

        <!-- Responses -->
        <div class="feedback-responses" id="responses-section">
          <h3>Svör</h3>
          <div id="responses-list"></div>

          <!-- Add Response -->
          <div class="add-response">
            <textarea id="response-input" class="form-textarea" rows="3" placeholder="Skrifa svar..."></textarea>
            <div class="response-actions">
              <label class="checkbox-label">
                <input type="checkbox" id="response-internal">
                Innanhússathugasemd (ekki sýnilegt notanda)
              </label>
              <button class="btn btn-primary btn-small" onclick="addResponse()">
                <i class="fas fa-reply"></i> Svara
              </button>
            </div>
          </div>
        </div>

        <!-- Resolution Notes (for resolved items) -->
        <div class="resolution-section" id="resolution-section" style="display: none;">
          <h3>Lausn</h3>
          <div id="resolution-notes" class="message-content"></div>
          <div class="resolution-meta">
            <span>Leyst af: <strong id="resolved-by"></strong></span>
            <span id="resolved-at"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Loka</button>
        <button class="btn btn-success" id="resolve-btn" onclick="resolveFeedback()">
          <i class="fas fa-check"></i> Merkja sem leyst
        </button>
      </div>
    </div>
  </div>

  <!-- Resolve Modal -->
  <div class="modal" id="resolve-modal" style="display: none;">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2>Merkja sem leyst</h2>
        <button class="btn-close" onclick="closeResolveModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Lausnarathugasemd (valfrjálst)</label>
          <textarea id="resolution-input" class="form-textarea" rows="3" placeholder="Lýsið því hvað var gert til að leysa málið..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeResolveModal()">Hætta við</button>
        <button class="btn btn-success" onclick="confirmResolve()">
          <i class="fas fa-check"></i> Staðfesta
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentFeedback = null;
    let currentOffset = 0;
    const LIMIT = 20;

    async function init() {
      // Check auth
      const authRes = await fetch('/api/auth/me');
      const authData = await authRes.json();
      const userEl = document.getElementById('user-info');

      if (!authData.authenticated) {
        userEl.innerHTML = '<a href="/api/auth/login?redirect=/admin/feedback" class="btn btn-primary">Innskráning</a>';
        document.getElementById('feedback-list').innerHTML =
          '<div class="alert alert-warning">Vinsamlegast skráðu þig inn til að skoða endurgjöf.</div>';
        return;
      }

      if (!['admin', 'head-editor'].includes(authData.user.role)) {
        document.getElementById('feedback-list').innerHTML =
          '<div class="alert alert-warning">Þú hefur ekki réttindi til að skoða endurgjöf.</div>';
        return;
      }

      userEl.innerHTML = '<img src="' + authData.user.avatar + '" alt=""><span>' + authData.user.name + '</span>';

      // Load data
      loadStats();
      loadFeedback();

      // Setup filters
      document.getElementById('status-filter').addEventListener('change', () => { currentOffset = 0; loadFeedback(); });
      document.getElementById('type-filter').addEventListener('change', () => { currentOffset = 0; loadFeedback(); });
      document.getElementById('priority-filter').addEventListener('change', () => { currentOffset = 0; loadFeedback(); });

      // Pagination
      document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentOffset >= LIMIT) {
          currentOffset -= LIMIT;
          loadFeedback();
        }
      });
      document.getElementById('next-btn').addEventListener('click', () => {
        currentOffset += LIMIT;
        loadFeedback();
      });

      // Modal close on escape/backdrop
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeModal(); closeResolveModal(); }
      });
      document.getElementById('feedback-modal').addEventListener('click', (e) => {
        if (e.target.id === 'feedback-modal') closeModal();
      });
      document.getElementById('resolve-modal').addEventListener('click', (e) => {
        if (e.target.id === 'resolve-modal') closeResolveModal();
      });
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/feedback/stats');
        const stats = await res.json();

        document.getElementById('stat-open').textContent = stats.open || 0;
        document.getElementById('stat-progress').textContent = stats.inProgress || 0;
        document.getElementById('stat-resolved').textContent = stats.byStatus?.resolved || 0;
        document.getElementById('stat-total').textContent = stats.total || 0;
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    async function loadFeedback() {
      const listEl = document.getElementById('feedback-list');
      const status = document.getElementById('status-filter').value;
      const type = document.getElementById('type-filter').value;
      const priority = document.getElementById('priority-filter').value;

      listEl.innerHTML = '<p class="loading"><i class="fas fa-spinner fa-spin"></i> Hleður...</p>';

      try {
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (type) params.append('type', type);
        if (priority) params.append('priority', priority);
        params.append('limit', LIMIT);
        params.append('offset', currentOffset);

        const res = await fetch('/api/feedback?' + params.toString());
        const data = await res.json();

        if (data.items.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Engin endurgjöf fannst</p></div>';
          document.getElementById('pagination').style.display = 'none';
          return;
        }

        listEl.innerHTML = '<table class="table">' +
          '<thead><tr><th>#</th><th>Tegund</th><th>Skilaboð</th><th>Staða</th><th>Forgangur</th><th>Dags</th><th></th></tr></thead>' +
          '<tbody>' +
          data.items.map(f => {
            const date = new Date(f.createdAt).toLocaleDateString('is-IS');
            const statusClass = getStatusClass(f.status);
            const priorityClass = getPriorityClass(f.priority);
            return '<tr class="' + (f.priority === 'critical' || f.priority === 'high' ? 'high-priority' : '') + '">' +
              '<td>' + f.id + '</td>' +
              '<td><span class="badge badge-type">' + f.typeLabel + '</span></td>' +
              '<td class="message-preview">' + escapeHtml(f.message.substring(0, 60)) + (f.message.length > 60 ? '...' : '') + '</td>' +
              '<td><span class="badge badge-' + statusClass + '">' + f.statusLabel + '</span></td>' +
              '<td><span class="badge badge-' + priorityClass + '">' + f.priorityLabel + '</span></td>' +
              '<td>' + date + '</td>' +
              '<td><button class="btn btn-primary btn-small" onclick="openFeedback(' + f.id + ')">Skoða</button></td>' +
              '</tr>';
          }).join('') +
          '</tbody></table>';

        // Pagination
        const pag = document.getElementById('pagination');
        pag.style.display = 'flex';
        document.getElementById('prev-btn').disabled = currentOffset === 0;
        document.getElementById('next-btn').disabled = currentOffset + data.items.length >= data.total;
        document.getElementById('page-info').textContent =
          (currentOffset + 1) + '-' + (currentOffset + data.items.length) + ' af ' + data.total;

      } catch (err) {
        listEl.innerHTML = '<div class="alert alert-error">Villa: ' + err.message + '</div>';
      }
    }

    function getStatusClass(status) {
      const map = { open: 'open', in_progress: 'progress', resolved: 'success', wont_fix: 'muted' };
      return map[status] || 'default';
    }

    function getPriorityClass(priority) {
      const map = { critical: 'critical', high: 'high', normal: 'normal', low: 'low' };
      return map[priority] || 'default';
    }

    async function openFeedback(id) {
      try {
        const res = await fetch('/api/feedback/' + id);
        const feedback = await res.json();
        currentFeedback = feedback;

        // Populate modal
        document.getElementById('modal-id').textContent = feedback.id;
        document.getElementById('detail-type').textContent = feedback.typeLabel;
        document.getElementById('detail-type').className = 'badge badge-type';
        document.getElementById('detail-status').value = feedback.status;
        document.getElementById('detail-priority').value = feedback.priority;

        // Location
        const location = [feedback.book, feedback.chapter, feedback.section].filter(Boolean).join(' / ');
        document.getElementById('detail-location').textContent = location || '(Ekki tilgreint)';

        // Time
        document.getElementById('detail-created').textContent = new Date(feedback.createdAt).toLocaleString('is-IS');

        // Contact
        if (feedback.userName || feedback.userEmail) {
          document.getElementById('detail-contact-row').style.display = 'flex';
          let contact = feedback.userName || '';
          if (feedback.userEmail) {
            contact += (contact ? ' - ' : '') + '<a href="mailto:' + feedback.userEmail + '">' + feedback.userEmail + '</a>';
          }
          document.getElementById('detail-contact').innerHTML = contact;
        } else {
          document.getElementById('detail-contact-row').style.display = 'none';
        }

        // Message
        document.getElementById('detail-message').textContent = feedback.message;

        // Responses
        const responsesList = document.getElementById('responses-list');
        if (feedback.responses && feedback.responses.length > 0) {
          responsesList.innerHTML = feedback.responses.map(r => {
            const date = new Date(r.createdAt).toLocaleString('is-IS');
            return '<div class="response ' + (r.isInternal ? 'internal' : '') + '">' +
              '<div class="response-header">' +
              '<strong>' + escapeHtml(r.responderName) + '</strong>' +
              (r.isInternal ? ' <span class="badge badge-muted">Innanhúss</span>' : '') +
              '<span class="response-date">' + date + '</span>' +
              '</div>' +
              '<p>' + escapeHtml(r.message) + '</p>' +
              '</div>';
          }).join('');
        } else {
          responsesList.innerHTML = '<p class="text-muted">Engin svör ennþá</p>';
        }

        // Resolution
        if (feedback.status === 'resolved' && feedback.resolutionNotes) {
          document.getElementById('resolution-section').style.display = 'block';
          document.getElementById('resolution-notes').textContent = feedback.resolutionNotes;
          document.getElementById('resolved-by').textContent = feedback.resolvedByName || '-';
          document.getElementById('resolved-at').textContent = feedback.resolvedAt ?
            new Date(feedback.resolvedAt).toLocaleString('is-IS') : '';
        } else {
          document.getElementById('resolution-section').style.display = 'none';
        }

        // Resolve button visibility
        document.getElementById('resolve-btn').style.display =
          feedback.status !== 'resolved' ? 'inline-flex' : 'none';

        // Clear response input
        document.getElementById('response-input').value = '';
        document.getElementById('response-internal').checked = false;

        // Attach status/priority change handlers
        document.getElementById('detail-status').onchange = () => updateStatus();
        document.getElementById('detail-priority').onchange = () => updatePriority();

        // Show modal
        document.getElementById('feedback-modal').style.display = 'flex';
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    function closeModal() {
      document.getElementById('feedback-modal').style.display = 'none';
      currentFeedback = null;
    }

    async function updateStatus() {
      if (!currentFeedback) return;
      const status = document.getElementById('detail-status').value;

      try {
        const res = await fetch('/api/feedback/' + currentFeedback.id + '/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        const data = await res.json();
        if (data.success) {
          loadStats();
          loadFeedback();
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    async function updatePriority() {
      if (!currentFeedback) return;
      const priority = document.getElementById('detail-priority').value;

      try {
        const res = await fetch('/api/feedback/' + currentFeedback.id + '/priority', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ priority })
        });
        const data = await res.json();
        if (data.success) {
          loadFeedback();
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    async function addResponse() {
      if (!currentFeedback) return;
      const message = document.getElementById('response-input').value.trim();
      const isInternal = document.getElementById('response-internal').checked;

      if (!message) {
        alert('Vinsamlegast skrifaðu svar');
        return;
      }

      try {
        const res = await fetch('/api/feedback/' + currentFeedback.id + '/respond', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, isInternal })
        });
        const data = await res.json();

        if (data.success) {
          // Refresh to show new response
          openFeedback(currentFeedback.id);
        } else {
          alert('Villa: ' + data.message);
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    function resolveFeedback() {
      document.getElementById('resolve-modal').style.display = 'flex';
    }

    function closeResolveModal() {
      document.getElementById('resolve-modal').style.display = 'none';
      document.getElementById('resolution-input').value = '';
    }

    async function confirmResolve() {
      if (!currentFeedback) return;
      const notes = document.getElementById('resolution-input').value.trim();

      try {
        const res = await fetch('/api/feedback/' + currentFeedback.id + '/resolve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });
        const data = await res.json();

        if (data.success) {
          closeResolveModal();
          closeModal();
          loadStats();
          loadFeedback();
        } else {
          alert('Villa: ' + data.message);
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    init();
  </script>

  <script src="/js/theme.js"></script>

  <style>
    /* Page-specific styles for feedback admin */

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: white; border-radius: 0.5rem; padding: 1.25rem; display: flex; align-items: center; gap: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-icon { width: 48px; height: 48px; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .stat-icon.open { background: #dbeafe; color: #2563eb; }
    .stat-icon.progress { background: #fef3c7; color: #d97706; }
    .stat-icon.resolved { background: #dcfce7; color: #16a34a; }
    .stat-icon.total { background: var(--gray-100); color: var(--gray-500); }
    .stat-content { display: flex; flex-direction: column; }
    .stat-value { font-size: 1.5rem; font-weight: 600; }
    .stat-label { font-size: 0.75rem; color: var(--gray-500); }

    .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }
    .card-title { font-size: 1.125rem; font-weight: 600; }

    .filter-controls { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .form-select { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
    .form-select-small { padding: 0.375rem 0.5rem; font-size: 0.75rem; }
    .form-textarea { width: 100%; padding: 0.625rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; resize: vertical; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.375rem; }
    .form-group { margin-bottom: 1rem; }

    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; text-decoration: none; border: none; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-secondary { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: #15803d; }
    .btn-small { padding: 0.25rem 0.75rem; font-size: 0.75rem; }
    .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-500); line-height: 1; }

    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
    .table th { font-weight: 500; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase; }
    .table tr.high-priority { background: #fef2f2; }
    .message-preview { max-width: 250px; color: var(--gray-700); font-size: 0.875rem; }

    .badge { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; }
    .badge-type { background: var(--gray-100); color: var(--gray-700); }
    .badge-open { background: #dbeafe; color: #1d4ed8; }
    .badge-progress { background: #fef3c7; color: #92400e; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-muted { background: var(--gray-100); color: var(--gray-500); }
    .badge-critical { background: #fee2e2; color: #991b1b; }
    .badge-high { background: #fed7aa; color: #9a3412; }
    .badge-normal { background: var(--gray-100); color: var(--gray-700); }
    .badge-low { background: #e0e7ff; color: #4338ca; }

    .loading { color: var(--gray-500); text-align: center; padding: 2rem; }
    .empty-state { text-align: center; padding: 3rem; color: var(--gray-500); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; }
    .alert { padding: 1rem; border-radius: 0.375rem; }
    .alert-error { background: #fee2e2; color: #991b1b; }
    .alert-warning { background: #fef3c7; color: #92400e; }

    .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); }
    #page-info { font-size: 0.875rem; color: var(--gray-500); }

    /* Modal */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; border-radius: 0.5rem; width: 90%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; }
    .modal-content.modal-small { max-width: 450px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-200); }
    .modal-header h2 { font-size: 1.125rem; font-weight: 600; }
    .modal-body { flex: 1; padding: 1.5rem; overflow-y: auto; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); }

    .feedback-meta { background: var(--gray-50); padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem; }
    .meta-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .meta-row:last-child { margin-bottom: 0; }
    .meta-label { font-weight: 500; color: var(--gray-500); min-width: 100px; }

    .feedback-message, .feedback-responses, .resolution-section { margin-top: 1.5rem; }
    .feedback-message h3, .feedback-responses h3, .resolution-section h3 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--gray-700);
    }
    .message-content {
      background: var(--gray-50);
      padding: 1rem;
      border-radius: 0.375rem;
      white-space: pre-wrap;
      font-size: 0.9rem;
    }

    .response { background: var(--gray-50); padding: 0.75rem 1rem; border-radius: 0.375rem; margin-bottom: 0.5rem; }
    .response.internal { background: #fef3c7; border-left: 3px solid #d97706; }
    .response-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; font-size: 0.8rem; }
    .response-date { color: var(--gray-500); margin-left: auto; }
    .response p { font-size: 0.875rem; margin: 0; }

    .add-response { margin-top: 1rem; }
    .response-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--gray-500); cursor: pointer; }

    .resolution-meta { margin-top: 0.5rem; font-size: 0.8rem; color: var(--gray-500); display: flex; gap: 1rem; }

    .text-muted { color: var(--gray-500); font-size: 0.875rem; }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .filter-controls { flex-direction: column; }
      .modal-content { width: 100%; height: 100%; max-height: 100%; border-radius: 0; }
    }
  </style>

  <script src="/js/theme.js"></script>
</body>
</html>
