<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√Åkvar√∞anir - N√°msb√≥kasafn</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>
  <header class="header">
    <h1>N√°msb√≥kasafn</h1>
    <nav>
      <a href="/my-work">M√≠n verkefni</a>
      <a href="/workflow">Verkfl√¶√∞i</a>
      <a href="/status">Stj√≥rnbor√∞</a>
      <a href="/editor">Ritstj√≥ri</a>
      <a href="/terminology">Or√∞asafn</a>
      <a href="/decisions">√Åkvar√∞anir</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stj√≥rnbor√∞</a>
      <a href="/admin" class="admin-only admin-link">Stj√≥rnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um √æema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notification-bell" id="notification-bell" title="Tilkynningar" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <div class="page-header">
      <h1>√Åkvar√∞anaskr√°</h1>
      <p class="subtitle">Sameinu√∞ skr√° yfir allar √æ√Ω√∞ingar- og ritstj√≥rnar√°kvar√∞anir</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìñ</div>
        <div class="stat-value" id="stat-terminology">-</div>
        <div class="stat-label">Hugt√∂k</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üåç</div>
        <div class="stat-value" id="stat-localization">-</div>
        <div class="stat-label">Sta√∞f√¶ringar</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úì</div>
        <div class="stat-value" id="stat-issue">-</div>
        <div class="stat-label">Vandam√°l</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-value" id="stat-week">-</div>
        <div class="stat-label">S√≠√∞ustu 7 daga</div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="card">
      <div class="search-bar">
        <input type="text" id="search-input" class="search-input" placeholder="Leita a√∞ √°kv√∂r√∞un (enska, √≠slenska, r√∂kstu√∞ningur)..." onkeyup="handleSearchKeyup(event)">
        <button class="btn btn-primary" onclick="searchDecisions()">
          <span class="icon">üîç</span> Leita
        </button>
      </div>
      <div class="accordion" id="filters-accordion">
        <button class="accordion-header" onclick="toggleAccordion('filters-accordion')">
          <div class="accordion-header-left">
            <span class="accordion-toggle">‚ñº</span>
            <span>S√≠ur</span>
          </div>
          <span id="active-filters-badge" class="badge" style="display: none;">0</span>
        </button>
        <div class="accordion-body">
          <div class="filters" style="margin: 0; padding: 0; border: none;">
            <select class="form-select" id="filter-type" onchange="searchDecisions(); updateFilterBadge();">
              <option value="">Allir flokkar</option>
            </select>
            <select class="form-select" id="filter-book" onchange="searchDecisions(); updateFilterBadge();">
              <option value="">Allar b√¶kur</option>
              <option value="efnafraedi">Efnafr√¶√∞i</option>
            </select>
            <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Hreinsa</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="card">
      <div class="card-header-flex">
        <h2 class="card-title">√Åkvar√∞anir</h2>
        <button class="btn btn-primary btn-sm" onclick="openNewDecisionModal()">
          + Skr√° √°kv√∂r√∞un
        </button>
      </div>
      <div id="results-list" class="results-list">
        <p class="text-muted">Hle√∞ur...</p>
      </div>
      <div id="pagination" class="pagination" style="display: none;">
        <button class="btn btn-secondary btn-sm" id="load-more-btn" onclick="loadMore()">
          Hla√∞a fleiri...
        </button>
        <span class="pagination-info" id="pagination-info"></span>
      </div>
    </div>
  </main>

  <!-- New Decision Modal -->
  <div class="modal" id="new-decision-modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>Skr√° n√Ωja √°kv√∂r√∞un</h3>
        <button class="btn-close" onclick="closeNewDecisionModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Flokkur *</label>
            <select class="form-select" id="new-type" required>
              <option value="">Veldu flokk...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">B√≥k</label>
            <select class="form-select" id="new-book">
              <option value="">Ekki s√©rt√¶kt</option>
              <option value="efnafraedi">Efnafr√¶√∞i</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Enska (frumtexti)</label>
            <input type="text" id="new-english" class="form-input" placeholder="Upprunalegur texti e√∞a hugtak">
          </div>
          <div class="form-group">
            <label class="form-label">√çslenska (√æ√Ω√∞ing/val)</label>
            <input type="text" id="new-icelandic" class="form-input" placeholder="Valin √æ√Ω√∞ing e√∞a a√∞l√∂gun">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">R√∂kstu√∞ningur *</label>
          <textarea id="new-rationale" class="form-textarea" rows="4" placeholder="√ötsk√Ωr√∞u hvers vegna √æessi √°kv√∂r√∞un var tekin..." required></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Kafli</label>
            <input type="number" id="new-chapter" class="form-input" placeholder="t.d. 1" min="0" max="99">
          </div>
          <div class="form-group">
            <label class="form-label">Hluti</label>
            <input type="text" id="new-section" class="form-input" placeholder="t.d. 1-2">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNewDecisionModal()">H√¶tta vi√∞</button>
        <button class="btn btn-primary" onclick="submitNewDecision()">Skr√° √°kv√∂r√∞un</button>
      </div>
    </div>
  </div>

  <script>
    let currentOffset = 0;
    let hasMore = false;
    let decisionTypes = [];

    // Toggle accordion open/closed
    function toggleAccordion(accordionId) {
      const accordion = document.getElementById(accordionId);
      if (accordion) {
        accordion.classList.toggle('collapsed');
      }
    }

    // Update filter badge to show active filter count
    function updateFilterBadge() {
      const type = document.getElementById('filter-type').value;
      const book = document.getElementById('filter-book').value;

      let activeCount = 0;
      if (type) activeCount++;
      if (book) activeCount++;

      const badge = document.getElementById('active-filters-badge');
      if (activeCount > 0) {
        badge.textContent = activeCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    async function init() {
      await loadTypes();
      await loadStats();

      // Restore filters from URL params
      restoreFiltersFromURL();

      await searchDecisions();
    }

    function restoreFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);

      const query = params.get('q');
      const type = params.get('type');
      const book = params.get('book');

      if (query) document.getElementById('search-input').value = query;
      if (type) document.getElementById('filter-type').value = type;
      if (book) document.getElementById('filter-book').value = book;
    }

    function updateURL() {
      const query = document.getElementById('search-input').value.trim();
      const type = document.getElementById('filter-type').value;
      const book = document.getElementById('filter-book').value;

      const params = new URLSearchParams();
      if (query) params.set('q', query);
      if (type) params.set('type', type);
      if (book) params.set('book', book);

      const newURL = params.toString()
        ? `${window.location.pathname}?${params}`
        : window.location.pathname;

      window.history.replaceState({}, '', newURL);
    }

    async function loadTypes() {
      try {
        const res = await fetch('/api/decisions/types');
        const data = await res.json();
        decisionTypes = data.types;

        // Populate filter dropdown
        const filterSelect = document.getElementById('filter-type');
        const newTypeSelect = document.getElementById('new-type');

        for (const type of data.types) {
          const option1 = document.createElement('option');
          option1.value = type.value;
          option1.textContent = type.icon + ' ' + type.name;
          filterSelect.appendChild(option1);

          const option2 = document.createElement('option');
          option2.value = type.value;
          option2.textContent = type.icon + ' ' + type.name;
          newTypeSelect.appendChild(option2);
        }
      } catch (err) {
        console.error('Failed to load types:', err);
      }
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/decisions/stats');
        const stats = await res.json();

        document.getElementById('stat-terminology').textContent = stats.byType?.terminology || 0;
        document.getElementById('stat-localization').textContent = stats.byType?.localization || 0;
        document.getElementById('stat-issue').textContent = stats.byType?.issue || 0;
        document.getElementById('stat-week').textContent = stats.last7Days || 0;
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    // ============================================================================
    // SEARCH
    // ============================================================================

    function handleSearchKeyup(event) {
      if (event.key === 'Enter') {
        searchDecisions();
      }
    }

    async function searchDecisions(append = false) {
      const container = document.getElementById('results-list');
      const paginationEl = document.getElementById('pagination');

      if (!append) {
        currentOffset = 0;
        container.innerHTML = '<p class="text-muted">Hle√∞ur...</p>';
        updateURL();
      }

      const query = document.getElementById('search-input').value.trim();
      const type = document.getElementById('filter-type').value;
      const book = document.getElementById('filter-book').value;

      try {
        const params = new URLSearchParams({
          limit: 30,
          offset: currentOffset
        });
        if (query) params.set('q', query);
        if (type) params.set('type', type);
        if (book) params.set('book', book);

        const res = await fetch('/api/decisions?' + params);
        const data = await res.json();

        hasMore = data.hasMore;

        if (data.decisions.length === 0 && !append) {
          container.innerHTML = '<div class="empty-state"><p>Engar √°kvar√∞anir fundust</p><p class="text-muted">Pr√≥fa√∞u a√∞ breyta leitarskilyr√∞um e√∞a <a href="#" onclick="openNewDecisionModal()">skr√°√∞u n√Ωja √°kv√∂r√∞un</a></p></div>';
          paginationEl.style.display = 'none';
          return;
        }

        const html = data.decisions.map(d => renderDecision(d)).join('');

        if (append) {
          container.innerHTML += html;
        } else {
          container.innerHTML = html;
        }

        document.getElementById('pagination-info').textContent =
          `S√Ωni ${currentOffset + data.decisions.length} af ${data.total}`;
        paginationEl.style.display = hasMore ? 'flex' : 'none';

      } catch (err) {
        console.error('Search error:', err);
        if (!append) {
          container.innerHTML = '<p class="text-error">Villa vi√∞ a√∞ s√¶kja √°kvar√∞anir</p>';
        }
      }
    }

    function loadMore() {
      currentOffset += 30;
      searchDecisions(true);
    }

    function clearFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('filter-type').value = '';
      document.getElementById('filter-book').value = '';
      searchDecisions();
    }

    // ============================================================================
    // RENDERING
    // ============================================================================

    function renderDecision(decision) {
      const typeInfo = decisionTypes.find(t => t.value === decision.type) || { icon: 'üìå', name: decision.type };
      const date = new Date(decision.decidedAt).toLocaleDateString('is-IS');

      let location = '';
      if (decision.book) {
        location = decision.book;
        if (decision.chapter) location += ' / K.' + decision.chapter;
        if (decision.section) location += ' / ' + decision.section;
      }

      return `
        <div class="decision-item">
          <div class="decision-header">
            <span class="decision-type">${typeInfo.icon}</span>
            <div class="decision-terms">
              ${decision.englishTerm ? `<span class="term-english">${escapeHtml(decision.englishTerm)}</span>` : ''}
              ${decision.englishTerm && decision.icelandicTerm ? '<span class="term-arrow">‚Üí</span>' : ''}
              ${decision.icelandicTerm ? `<span class="term-icelandic">${escapeHtml(decision.icelandicTerm)}</span>` : ''}
              ${!decision.englishTerm && !decision.icelandicTerm ? `<span class="term-none">${typeInfo.name}</span>` : ''}
            </div>
            <span class="decision-badge badge-${decision.type}">${typeInfo.name}</span>
          </div>
          <div class="decision-rationale">
            ${escapeHtml(decision.rationale)}
          </div>
          <div class="decision-meta">
            <span class="decision-user">${escapeHtml(decision.decidedBy)}</span>
            <span class="decision-date">${date}</span>
            ${location ? `<span class="decision-location">${escapeHtml(location)}</span>` : ''}
          </div>
        </div>
      `;
    }

    // ============================================================================
    // NEW DECISION
    // ============================================================================

    function openNewDecisionModal() {
      document.getElementById('new-type').value = '';
      document.getElementById('new-book').value = '';
      document.getElementById('new-english').value = '';
      document.getElementById('new-icelandic').value = '';
      document.getElementById('new-rationale').value = '';
      document.getElementById('new-chapter').value = '';
      document.getElementById('new-section').value = '';
      document.getElementById('new-decision-modal').style.display = 'flex';
    }

    function closeNewDecisionModal() {
      document.getElementById('new-decision-modal').style.display = 'none';
    }

    async function submitNewDecision() {
      const type = document.getElementById('new-type').value;
      const rationale = document.getElementById('new-rationale').value.trim();

      if (!type) {
        alert('Vinsamlegast veldu flokk');
        return;
      }
      if (!rationale) {
        alert('Vinsamlegast skrifa√∞u r√∂kstu√∞ning');
        return;
      }

      const data = {
        type,
        englishTerm: document.getElementById('new-english').value.trim() || undefined,
        icelandicTerm: document.getElementById('new-icelandic').value.trim() || undefined,
        rationale,
        book: document.getElementById('new-book').value || undefined,
        chapter: document.getElementById('new-chapter').value || undefined,
        section: document.getElementById('new-section').value.trim() || undefined
      };

      try {
        const res = await fetch('/api/decisions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (result.success) {
          alert('√Åkv√∂r√∞un skr√°√∞!');
          closeNewDecisionModal();
          loadStats();
          searchDecisions();
        } else {
          alert('Villa: ' + (result.error || 'Gat ekki skr√°√∞ √°kv√∂r√∞un'));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    // ============================================================================
    // UTILITIES
    // ============================================================================

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize on page load
    init();
  </script>

  <style>
    /* ==========================================================================
       DECISIONS PAGE SPECIFIC STYLES
       Extends common.css with page-specific components
       ========================================================================== */

    /* Container override */
    .container { max-width: 900px; }

    /* Card padding override */
    .card { padding: 1.5rem; }

    /* Page Header */
    .page-header { margin-bottom: 1.5rem; }
    .page-header h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
    .page-header .subtitle { color: var(--text-muted); font-size: 0.9375rem; }

    /* Search Input (page-specific variant) */
    .search-input { flex: 1; padding: 0.625rem 1rem; border: 1px solid var(--border-color); border-radius: 0.375rem; font-size: 0.9375rem; background: var(--bg-card); color: var(--text-primary); }
    .search-input:focus { outline: none; border-color: var(--primary); }

    /* Results */
    .results-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .decision-item { padding: 1rem; background: var(--gray-50); border-radius: 0.5rem; border: 1px solid var(--gray-200); }
    .decision-item:hover { border-color: var(--gray-300); }
    .decision-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .decision-type { font-size: 1.25rem; }
    .decision-terms { flex: 1; font-size: 0.9375rem; }
    .term-english { color: var(--gray-500); }
    .term-arrow { margin: 0 0.375rem; color: var(--gray-400); }
    .term-icelandic { color: var(--primary); font-weight: 500; }
    .term-none { color: var(--gray-500); font-style: italic; }
    .decision-badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 600; }
    .badge-terminology { background: #dcfce7; color: #166534; }
    .badge-localization { background: #dbeafe; color: #1e40af; }
    .badge-issue { background: #fef3c7; color: #92400e; }
    .badge-style { background: #f3e8ff; color: #7c3aed; }
    .decision-rationale { font-size: 0.875rem; color: var(--gray-700); line-height: 1.6; margin-bottom: 0.5rem; }
    .decision-meta { display: flex; gap: 1rem; font-size: 0.75rem; color: var(--gray-500); flex-wrap: wrap; }
    .decision-user { font-weight: 500; }
    .decision-location { font-family: monospace; }

    /* Pagination info (override for this page) */
    .pagination-info { font-size: 0.75rem; color: var(--text-muted); }

    /* Icon helper */
    .icon { font-size: 1rem; }

    /* Page-specific responsive */
    @media (max-width: 768px) {
      .decision-header { flex-wrap: wrap; }
    }
  </style>
  <script src="/js/theme.js"></script>
</body>
</html>
