<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fundaráætlun - Námsbókasafn</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/my-work">Mín verkefni</a>
      <a href="/status">Stjórnborð</a>
      <a href="/editor">Ritstjóri</a>
      <a href="/terminology">Orðasafn</a>
      <a href="/meetings" class="active">Fundir</a>
    </nav>
    <div class="user-info" id="user-info"></div>
  </header>

  <main class="container">
    <div class="page-header">
      <div class="page-title">
        <h2><i class="fas fa-clipboard-list"></i> Fundaráætlun</h2>
        <p class="text-muted">Sjálfvirk áætlun fyrir ritstjórnarfundi</p>
      </div>
      <div class="page-actions">
        <select class="form-select" id="book-filter">
          <option value="">Allar bækur</option>
          <option value="efnafraedi">Efnafræði</option>
          <option value="liffraedi">Líffræði</option>
        </select>
        <button class="btn btn-primary" id="generate-btn">
          <i class="fas fa-sync-alt"></i> Uppfæra
        </button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards" id="summary-cards">
      <div class="summary-card urgent">
        <div class="card-icon"><i class="fas fa-exclamation-circle"></i></div>
        <div class="card-content">
          <div class="card-value" id="urgent-count">-</div>
          <div class="card-label">Brýn mál</div>
        </div>
      </div>
      <div class="summary-card discussion">
        <div class="card-icon"><i class="fas fa-comments"></i></div>
        <div class="card-content">
          <div class="card-value" id="discussion-count">-</div>
          <div class="card-label">Til umræðu</div>
        </div>
      </div>
      <div class="summary-card terminology">
        <div class="card-icon"><i class="fas fa-book"></i></div>
        <div class="card-content">
          <div class="card-value" id="terminology-count">-</div>
          <div class="card-label">Hugtök</div>
        </div>
      </div>
      <div class="summary-card deadlines">
        <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
        <div class="card-content">
          <div class="card-value" id="deadlines-count">-</div>
          <div class="card-label">Skiladagar</div>
        </div>
      </div>
    </div>

    <!-- Agenda Content -->
    <div class="agenda-container" id="agenda-container">
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Hleður fundaráætlun...
      </div>
    </div>

    <!-- Export Options -->
    <div class="export-bar" id="export-bar" style="display: none;">
      <span class="export-label">Flytja út:</span>
      <button class="btn btn-secondary btn-small" id="export-markdown">
        <i class="fas fa-file-alt"></i> Markdown
      </button>
      <button class="btn btn-secondary btn-small" id="export-html">
        <i class="fas fa-file-code"></i> HTML
      </button>
      <button class="btn btn-secondary btn-small" id="print-agenda">
        <i class="fas fa-print"></i> Prenta
      </button>
    </div>
  </main>

  <script>
    let currentAgenda = null;

    async function init() {
      await loadUserInfo();
      await loadAgenda();

      // Event listeners
      document.getElementById('generate-btn').addEventListener('click', loadAgenda);
      document.getElementById('book-filter').addEventListener('change', loadAgenda);
      document.getElementById('export-markdown').addEventListener('click', () => exportAgenda('markdown'));
      document.getElementById('export-html').addEventListener('click', () => exportAgenda('html'));
      document.getElementById('print-agenda').addEventListener('click', printAgenda);
    }

    async function loadUserInfo() {
      try {
        const res = await fetch('/api/auth/me');
        const data = await res.json();

        if (data.user) {
          document.getElementById('user-info').innerHTML = `
            <span>${data.user.username}</span>
            <span class="badge badge-${data.user.role}">${data.user.role}</span>
          `;
        }
      } catch (err) {
        console.error('Failed to load user info:', err);
      }
    }

    async function loadAgenda() {
      const container = document.getElementById('agenda-container');
      const exportBar = document.getElementById('export-bar');
      const book = document.getElementById('book-filter').value;

      container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Hleður fundaráætlun...</div>';
      exportBar.style.display = 'none';

      try {
        const params = new URLSearchParams();
        if (book) params.append('book', book);
        params.append('includeProgress', 'true');

        const res = await fetch('/api/meetings/agenda?' + params);
        const agenda = await res.json();

        currentAgenda = agenda;
        renderAgenda(agenda);
        updateSummaryCards(agenda.summary);
        exportBar.style.display = 'flex';

      } catch (err) {
        console.error('Failed to load agenda:', err);
        container.innerHTML = '<div class="error"><i class="fas fa-exclamation-triangle"></i> Villa við að hlaða fundaráætlun</div>';
      }
    }

    function updateSummaryCards(summary) {
      if (!summary) return;

      document.getElementById('urgent-count').textContent = summary.overdueCount || 0;
      document.getElementById('discussion-count').textContent = summary.boardReviewItems || 0;
      document.getElementById('terminology-count').textContent = summary.disputedTerms || 0;
      document.getElementById('deadlines-count').textContent = summary.dueThisWeek || 0;
    }

    function renderAgenda(agenda) {
      const container = document.getElementById('agenda-container');

      if (!agenda.sections || agenda.sections.length === 0) {
        container.innerHTML = `
          <div class="empty-agenda">
            <i class="fas fa-check-circle"></i>
            <h3>Engin atriði á dagskrá</h3>
            <p>Engin atriði krefjast umræðu á næsta fundi.</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="agenda-meta">
          <span><i class="fas fa-clock"></i> Uppfært: ${new Date(agenda.generatedAt).toLocaleString('is-IS')}</span>
          <span><i class="fas fa-user"></i> ${agenda.generatedBy}</span>
        </div>
      `;

      for (const section of agenda.sections) {
        const priorityClass = section.priority === 1 ? 'priority-urgent' : section.priority === 2 ? 'priority-discussion' : '';
        const icon = getSectionIcon(section.priority);

        html += `
          <div class="agenda-section ${priorityClass}">
            <div class="section-header">
              <h3><i class="fas ${icon}"></i> ${escapeHtml(section.title)}</h3>
              <span class="item-count">${section.items.length} atriði</span>
            </div>
            <div class="section-items">
        `;

        for (const item of section.items) {
          html += renderAgendaItem(item);
        }

        html += '</div></div>';
      }

      container.innerHTML = html;
    }

    function getSectionIcon(priority) {
      switch (priority) {
        case 1: return 'fa-exclamation-circle';
        case 2: return 'fa-comments';
        case 3: return 'fa-book';
        case 4: return 'fa-calendar-alt';
        case 5: return 'fa-check-circle';
        default: return 'fa-list';
      }
    }

    function renderAgendaItem(item) {
      switch (item.type) {
        case 'overdue_assignment':
          return `
            <div class="agenda-item item-overdue">
              <div class="item-badge badge-urgent">${item.daysOverdue}d seint</div>
              <div class="item-content">
                <div class="item-title">${item.book} kafli ${item.chapter} - ${item.stageLabel}</div>
                <div class="item-meta">
                  <span><i class="fas fa-user"></i> ${escapeHtml(item.assignedTo)}</span>
                  <span><i class="fas fa-calendar"></i> ${new Date(item.dueDate).toLocaleDateString('is-IS')}</span>
                </div>
              </div>
              <div class="item-actions">
                <a href="/assignments?book=${item.book}" class="btn btn-secondary btn-tiny">Skoða</a>
              </div>
            </div>
          `;

        case 'board_review':
          return `
            <div class="agenda-item item-discussion">
              <div class="item-badge badge-discussion">Umræða</div>
              <div class="item-content">
                <div class="item-title">${item.book} kafli ${item.chapter}</div>
                <div class="item-description">${escapeHtml(item.description)}</div>
                ${item.context ? `<blockquote class="item-context">${escapeHtml(item.context)}</blockquote>` : ''}
                ${item.suggestion ? `<div class="item-suggestion"><strong>Tillaga:</strong> ${escapeHtml(item.suggestion)}</div>` : ''}
              </div>
              <div class="item-actions">
                <button class="btn btn-success btn-tiny" onclick="resolveItem('${item.id}', 'accept')">Samþykkja</button>
                <button class="btn btn-secondary btn-tiny" onclick="resolveItem('${item.id}', 'reject')">Hafna</button>
              </div>
            </div>
          `;

        case 'disputed_term':
          return `
            <div class="agenda-item item-terminology">
              <div class="item-badge badge-term">${item.status}</div>
              <div class="item-content">
                <div class="item-title">
                  <span class="term-english">${escapeHtml(item.english)}</span>
                  <i class="fas fa-arrow-right"></i>
                  <span class="term-icelandic">${escapeHtml(item.icelandic)}</span>
                </div>
                ${item.category ? `<div class="item-category"><span class="badge">${item.category}</span></div>` : ''}
                ${item.notes ? `<div class="item-notes">${escapeHtml(item.notes)}</div>` : ''}
                ${item.disputeComment ? `<div class="item-dispute"><i class="fas fa-comment"></i> ${escapeHtml(item.disputeComment)}</div>` : ''}
              </div>
              <div class="item-actions">
                <a href="/terminology?id=${item.id}" class="btn btn-secondary btn-tiny">Leysa</a>
              </div>
            </div>
          `;

        case 'upcoming_deadline':
          return `
            <div class="agenda-item item-deadline">
              <div class="item-badge badge-deadline">${item.daysUntil}d</div>
              <div class="item-content">
                <div class="item-title">${item.book} kafli ${item.chapter} - ${item.stageLabel}</div>
                <div class="item-meta">
                  <span><i class="fas fa-user"></i> ${escapeHtml(item.assignedTo)}</span>
                  <span><i class="fas fa-calendar"></i> ${new Date(item.dueDate).toLocaleDateString('is-IS')}</span>
                </div>
              </div>
            </div>
          `;

        case 'recent_decision':
          return `
            <div class="agenda-item item-decision">
              <div class="item-badge badge-decision">${item.decisionType}</div>
              <div class="item-content">
                <div class="item-title">
                  ${item.englishTerm ? `<span class="term-english">${escapeHtml(item.englishTerm)}</span> <i class="fas fa-arrow-right"></i>` : ''}
                  <span class="term-icelandic">${escapeHtml(item.icelandicTerm || item.rationale?.substring(0, 50) || '')}</span>
                </div>
                <div class="item-meta">
                  <span><i class="fas fa-user"></i> ${escapeHtml(item.decidedBy)}</span>
                  <span><i class="fas fa-clock"></i> ${new Date(item.decidedAt).toLocaleDateString('is-IS')}</span>
                </div>
              </div>
            </div>
          `;

        default:
          return `<div class="agenda-item">${JSON.stringify(item)}</div>`;
      }
    }

    async function resolveItem(itemId, action) {
      // This would call the issue resolution API
      alert(`Aðgerð: ${action} fyrir atriði ${itemId}\n\nÞessi virkni verður útfærð með tengingu við /api/issues/:id/resolve`);
    }

    async function exportAgenda(format) {
      const book = document.getElementById('book-filter').value;
      const params = new URLSearchParams({ format });
      if (book) params.append('book', book);

      const url = `/api/meetings/agenda?${params}`;

      if (format === 'markdown') {
        const res = await fetch(url);
        const text = await res.text();
        downloadFile(text, `fundaraetlun-${new Date().toISOString().slice(0,10)}.md`, 'text/markdown');
      } else if (format === 'html') {
        window.open(url, '_blank');
      }
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function printAgenda() {
      window.print();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    init();
  </script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #16a34a;
      --warning: #d97706;
      --error: #dc2626;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.6; }

    .header { background: white; border-bottom: 1px solid var(--gray-200); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.25rem; color: var(--primary); }
    .header nav { display: flex; gap: 1.5rem; }
    .header nav a { color: var(--gray-700); text-decoration: none; font-size: 0.875rem; }
    .header nav a.active { color: var(--primary); font-weight: 500; }
    .user-info { display: flex; align-items: center; gap: 0.5rem; }

    .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .page-title h2 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .page-title .text-muted { font-size: 0.875rem; color: var(--gray-500); }
    .page-actions { display: flex; gap: 0.5rem; align-items: center; }

    .form-select { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }

    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; text-decoration: none; transition: all 0.15s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-300); }
    .btn-secondary:hover { background: var(--gray-200); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #15803d; }
    .btn-small { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
    .btn-tiny { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

    .badge { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.6875rem; font-weight: 600; }
    .badge-admin { background: #fef3c7; color: #92400e; }
    .badge-editor { background: #dbeafe; color: #1e40af; }

    /* Summary Cards */
    .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .summary-card { background: white; border-radius: 0.5rem; padding: 1rem; display: flex; align-items: center; gap: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .summary-card.urgent .card-icon { background: #fee2e2; color: var(--error); }
    .summary-card.discussion .card-icon { background: #fef3c7; color: var(--warning); }
    .summary-card.terminology .card-icon { background: #e0e7ff; color: #4f46e5; }
    .summary-card.deadlines .card-icon { background: #dbeafe; color: var(--primary); }
    .card-icon { width: 3rem; height: 3rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .card-value { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); }
    .card-label { font-size: 0.8125rem; color: var(--gray-500); }

    /* Agenda Container */
    .agenda-container { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-height: 400px; }
    .loading, .error, .empty-agenda { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; color: var(--gray-500); }
    .loading i, .error i, .empty-agenda i { font-size: 2rem; margin-bottom: 1rem; }
    .empty-agenda i { color: var(--success); }
    .empty-agenda h3 { color: var(--gray-700); margin-bottom: 0.5rem; }

    .agenda-meta { padding: 1rem; border-bottom: 1px solid var(--gray-200); display: flex; gap: 1.5rem; font-size: 0.8125rem; color: var(--gray-500); }
    .agenda-meta i { margin-right: 0.25rem; }

    /* Agenda Sections */
    .agenda-section { border-bottom: 1px solid var(--gray-200); }
    .agenda-section:last-child { border-bottom: none; }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); }
    .section-header h3 { font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .item-count { font-size: 0.75rem; background: var(--gray-200); color: var(--gray-600); padding: 0.125rem 0.5rem; border-radius: 9999px; }

    .priority-urgent .section-header { background: #fef2f2; }
    .priority-urgent .section-header h3 { color: var(--error); }
    .priority-discussion .section-header { background: #fffbeb; }
    .priority-discussion .section-header h3 { color: var(--warning); }

    .section-items { padding: 0.5rem; }

    /* Agenda Items */
    .agenda-item { display: flex; align-items: flex-start; gap: 1rem; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem; background: var(--gray-50); transition: background 0.15s; }
    .agenda-item:hover { background: var(--gray-100); }
    .agenda-item:last-child { margin-bottom: 0; }

    .item-badge { font-size: 0.625rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600; white-space: nowrap; }
    .badge-urgent { background: #fee2e2; color: #991b1b; }
    .badge-discussion { background: #fef3c7; color: #92400e; }
    .badge-term { background: #e0e7ff; color: #3730a3; }
    .badge-deadline { background: #dbeafe; color: #1e40af; }
    .badge-decision { background: #dcfce7; color: #166534; }

    .item-content { flex: 1; min-width: 0; }
    .item-title { font-weight: 600; font-size: 0.875rem; color: var(--gray-800); margin-bottom: 0.25rem; }
    .item-description { font-size: 0.8125rem; color: var(--gray-600); margin-bottom: 0.375rem; }
    .item-context { font-size: 0.75rem; color: var(--gray-500); background: white; border-left: 3px solid var(--gray-300); padding: 0.5rem; margin: 0.375rem 0; }
    .item-suggestion { font-size: 0.8125rem; color: var(--success); }
    .item-meta { display: flex; gap: 1rem; font-size: 0.75rem; color: var(--gray-500); }
    .item-meta i { margin-right: 0.25rem; }
    .item-notes { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; }
    .item-dispute { font-size: 0.75rem; color: var(--warning); margin-top: 0.25rem; }
    .item-category { margin-top: 0.25rem; }

    .term-english { color: var(--gray-600); }
    .term-icelandic { color: var(--primary); font-weight: 600; }

    .item-actions { display: flex; gap: 0.25rem; flex-shrink: 0; }

    /* Export Bar */
    .export-bar { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; padding: 1rem; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .export-label { font-size: 0.8125rem; color: var(--gray-500); }

    /* Responsive */
    @media (max-width: 768px) {
      .summary-cards { grid-template-columns: repeat(2, 1fr); }
      .page-header { flex-direction: column; gap: 1rem; align-items: stretch; }
      .page-actions { justify-content: flex-end; }
      .agenda-item { flex-direction: column; gap: 0.5rem; }
      .item-actions { align-self: flex-end; }
    }

    @media print {
      .header, .page-actions, .export-bar, .item-actions { display: none !important; }
      .container { max-width: none; padding: 0; }
      .agenda-container { box-shadow: none; }
      .page-header { margin-bottom: 1rem; }
    }
  </style>
</body>
</html>
