<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M√≠n verkefni - N√°msb√≥kasafn</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header class="header">
    <h1>N√°msb√≥kasafn</h1>
    <nav>
      <a href="/my-work">M√≠n verkefni</a>
      <a href="/workflow">Verkfl√¶√∞i</a>
      <a href="/status">Stj√≥rnbor√∞</a>
      <a href="/editor">Ritstj√≥ri</a>
      <a href="/terminology">Or√∞asafn</a>
      <a href="/decisions">√Åkvar√∞anir</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stj√≥rnbor√∞</a>
      <a href="/admin" class="admin-only admin-link">Stj√≥rnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um √æema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notification-bell" id="notification-bell" title="Tilkynningar" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span class="notification-badge" id="notification-count" style="display: none;">0</span>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <!-- Focus Mode (default) -->
    <div id="focus-view">
      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="welcome-text">
          <h1 id="greeting">Hle√∞ur...</h1>
          <p class="greeting-subtitle" id="greeting-subtitle"></p>
        </div>
        <div class="view-toggle">
          <button class="btn btn-secondary btn-sm" onclick="toggleView('detailed')">
            <span class="toggle-icon">üìã</span> N√°kv√¶mt yfirlit
          </button>
        </div>
      </div>

      <!-- Alert Banner (if needed) -->
      <div class="alert-banner" id="alert-banner" style="display: none;">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <span class="alert-text" id="alert-text"></span>
      </div>

      <!-- Blocked Issues Banner (critical - always show first) -->
      <div class="blocked-banner" id="blocked-banner" style="display: none;">
        <div class="blocked-header">
          <span class="blocked-icon">üö´</span>
          <strong>Verk st√∂√∞va√∞</strong>
          <span class="blocked-count" id="blocked-count">0</span>
        </div>
        <div class="blocked-list" id="blocked-list">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Current Task Card -->
      <div class="current-task-section" id="current-task-section">
        <h2 class="section-label">N√∫verandi verkefni</h2>
        <div class="current-task-card" id="current-task-card">
          <div class="loading-state">
            <p>Hle√∞ur verkefnum...</p>
          </div>
        </div>
      </div>

      <!-- Up Next Section -->
      <div class="up-next-section" id="up-next-section" style="display: none;">
        <h2 class="section-label">N√¶st √° dagskr√° <span class="count-badge" id="up-next-count">0</span></h2>
        <div class="up-next-list" id="up-next-list"></div>
      </div>

      <!-- Quick Stats -->
      <div class="quick-stats" id="quick-stats">
        <div class="stat-item">
          <span class="stat-value" id="stat-completed">-</span>
          <span class="stat-label">Kl√°ru√∞ √≠ vikunni</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-pending">-</span>
          <span class="stat-label">B√≠√∞ur yfirfer√∞ar</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-terms">-</span>
          <span class="stat-label">Or√∞atill√∂gur</span>
        </div>
      </div>
    </div>

    <!-- Detailed View (hidden by default) -->
    <div id="detailed-view" style="display: none;">
      <!-- View Toggle -->
      <div class="view-header">
        <h2>N√°kv√¶mt yfirlit</h2>
        <button class="btn btn-primary btn-sm" onclick="toggleView('focus')">
          <span class="toggle-icon">üéØ</span> Einbeitt s√Ωn
        </button>
      </div>

      <!-- Summary Cards -->
      <div class="summary-grid" id="summary-grid">
        <div class="summary-card" id="card-assignments">
          <div class="summary-icon">üìã</div>
          <div class="summary-value" id="summary-assignments">-</div>
          <div class="summary-label">√öthlutanir</div>
        </div>
        <div class="summary-card" id="card-pending">
          <div class="summary-icon">‚è≥</div>
          <div class="summary-value" id="summary-pending">-</div>
          <div class="summary-label">B√≠√∞ur yfirfer√∞ar</div>
        </div>
        <div class="summary-card warning" id="card-changes">
          <div class="summary-icon">üìù</div>
          <div class="summary-value" id="summary-changes">-</div>
          <div class="summary-label">Breytingar √≥skast</div>
        </div>
        <div class="summary-card" id="card-terms">
          <div class="summary-icon">üìñ</div>
          <div class="summary-value" id="summary-terms">-</div>
          <div class="summary-label">Or√∞atill√∂gur</div>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div class="content-grid">
        <!-- Assignments Section -->
        <div class="card assignments-card">
          <div class="card-header">
            <h2 class="card-title">√öthlutanir</h2>
            <span class="badge" id="assignments-badge">0</span>
          </div>
          <div class="card-body" id="assignments-list">
            <p class="text-muted">Hle√∞ur...</p>
          </div>
        </div>

        <!-- Pending Submissions Section -->
        <div class="card submissions-card">
          <div class="card-header">
            <h2 class="card-title">B√≠√∞ur yfirfer√∞ar</h2>
            <span class="badge" id="submissions-badge">0</span>
          </div>
          <div class="card-body" id="submissions-list">
            <p class="text-muted">Hle√∞ur...</p>
          </div>
        </div>

        <!-- Changes Requested Section -->
        <div class="card changes-card">
          <div class="card-header">
            <h2 class="card-title">Breytingar √≥skast</h2>
            <span class="badge badge-warning" id="changes-badge">0</span>
          </div>
          <div class="card-body" id="changes-list">
            <p class="text-muted">Hle√∞ur...</p>
          </div>
        </div>

        <!-- Terminology Proposals Section -->
        <div class="card terms-card">
          <div class="card-header">
            <h2 class="card-title">Or√∞atill√∂gur √æ√≠nar</h2>
            <span class="badge" id="terms-badge">0</span>
          </div>
          <div class="card-body" id="terms-list">
            <p class="text-muted">Hle√∞ur...</p>
          </div>
          <div class="card-footer">
            <a href="/terminology" class="btn btn-secondary btn-sm">Sj√° or√∞asafn</a>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="card activity-card">
        <div class="card-header">
          <h2 class="card-title">N√Ωleg virkni √æ√≠n</h2>
        </div>
        <div class="card-body" id="activity-list">
          <p class="text-muted">Hle√∞ur...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Settings Modal -->
  <div class="modal" id="settings-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-cog"></i> Stillingar</h3>
        <button class="btn-close" onclick="closeSettingsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <h4 class="settings-section-title">Tilkynningar</h4>
        <p class="settings-description">Veldu hvers konar tilkynningar √æ√∫ vilt f√°.</p>

        <div class="preference-list" id="preference-list">
          <p class="loading"><i class="fas fa-spinner fa-spin"></i> Hle√∞ur...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">H√¶tta vi√∞</button>
        <button class="btn btn-primary" onclick="savePreferences()">
          <i class="fas fa-save"></i> Vista
        </button>
      </div>
    </div>
  </div>

    <script src="/js/htmlUtils.js"></script>
  <script>
    let todayData = null;
    let notificationPreferences = null;
    let detailedData = null;
    let currentView = 'focus';

    async function init() {
      // Check auth
      const authRes = await fetch('/api/auth/me');
      const authData = await authRes.json();
      const userEl = document.getElementById('user-info');

      if (!authData.authenticated) {
        userEl.innerHTML = '<a href="/api/auth/login?redirect=/my-work" class="btn btn-primary">Innskr√°ning</a>';
        document.getElementById('greeting').textContent = 'Vinsamlegast skr√°√∞u √æig inn';
        document.getElementById('current-task-card').innerHTML = `
          <div class="empty-state">
            <p>Skr√°√∞u √æig inn til a√∞ sj√° verkefnin √æ√≠n</p>
          </div>
        `;
        return;
      }

      userEl.innerHTML = `
        <button class="btn-icon settings-btn" onclick="openSettingsModal()" title="Stillingar">
          <i class="fas fa-cog"></i>
        </button>
        <img src="${authData.user.avatar}" alt="">
        <span>${authData.user.name}</span>
      `;

      // Load focus view data
      await loadTodayView();
    }

    async function loadTodayView() {
      try {
        const res = await fetch('/api/my-work/today');
        todayData = await res.json();

        // Update greeting
        const hour = new Date().getHours();
        let greeting = 'G√≥√∞an daginn';
        if (hour < 6) greeting = 'G√≥√∞a n√≥tt';
        else if (hour < 12) greeting = 'G√≥√∞an morgun';
        else if (hour < 18) greeting = 'G√≥√∞an daginn';
        else greeting = 'Gott kv√∂ld';

        document.getElementById('greeting').textContent = `${greeting}, ${todayData.user.name}`;

        // Update subtitle based on task count
        const subtitle = todayData.quickStats.totalTasks === 0
          ? 'Engin verkefni √≠ dag - vel gert!'
          : todayData.quickStats.totalTasks === 1
            ? '√û√∫ ert me√∞ 1 verkefni'
            : `√û√∫ ert me√∞ ${todayData.quickStats.totalTasks} verkefni`;
        document.getElementById('greeting-subtitle').textContent = subtitle;

        // Show blocked issues banner (highest priority)
        if (todayData.blockedIssues && todayData.blockedIssues.length > 0) {
          renderBlockedBanner(todayData.blockedIssues);
        }

        // Show alert if needed
        if (todayData.needsAttention.length > 0) {
          const alertBanner = document.getElementById('alert-banner');
          const alertText = document.getElementById('alert-text');

          const overdue = todayData.quickStats.overdue;
          const changes = todayData.quickStats.changesRequested;

          let alertMsg = '';
          if (overdue > 0 && changes > 0) {
            alertMsg = `${overdue} verkefni yfir t√≠ma og ${changes} me√∞ √≥skum um breytingar`;
          } else if (overdue > 0) {
            alertMsg = `${overdue} ${overdue === 1 ? 'verkefni er' : 'verkefni eru'} yfir t√≠ma`;
          } else if (changes > 0) {
            alertMsg = `${changes} ${changes === 1 ? 'verkefni √æarfnast' : 'verkefni √æarfnast'} lagf√¶ringa`;
          }

          if (alertMsg) {
            alertText.textContent = alertMsg;
            alertBanner.style.display = 'flex';
          }
        }

        // Render current task
        renderCurrentTask(todayData.currentTask);

        // Render up next
        renderUpNext(todayData.upNext);

        // Update quick stats
        document.getElementById('stat-completed').textContent = todayData.quickStats.completedThisWeek;
        document.getElementById('stat-pending').textContent = todayData.quickStats.pendingReview;
        document.getElementById('stat-terms').textContent = todayData.quickStats.proposedTerms;

      } catch (err) {
        console.error('Failed to load today view:', err);
        document.getElementById('greeting').textContent = 'Villa vi√∞ a√∞ hla√∞a g√∂gnum';
      }
    }

    function renderCurrentTask(task) {
      const container = document.getElementById('current-task-card');

      if (!task) {
        container.innerHTML = `
          <div class="empty-task">
            <div class="empty-icon">üéâ</div>
            <h3>Ekkert verkefni √≠ dag!</h3>
            <p>√û√∫ hefur loki√∞ √∂llum verkefnum. Slaka√∞u √° e√∞a biddu eftir n√Ωjum √∫thlutanum.</p>
          </div>
        `;
        return;
      }

      const isChangesRequested = task.type === 'changes_requested';
      const priorityClass = task.priority === 1 ? 'priority-urgent' : task.priority === 2 ? 'priority-soon' : '';

      let taskTitle = '';
      let taskMeta = '';

      if (isChangesRequested) {
        taskTitle = `${task.bookLabel} - Kafli ${task.chapter}, ${task.section}`;
        taskMeta = `<span class="meta-reviewer">Athugasemdir fr√° ${escapeHtml(task.reviewedBy)}</span>`;
      } else {
        taskTitle = `${task.bookLabel} - Kafli ${task.chapter}`;
        taskMeta = `<span class="meta-stage">${escapeHtml(task.stageLabel)}</span>`;
        if (task.dueDate) {
          const dueDateClass = task.dueDate.status === 'overdue' ? 'due-overdue' :
                               task.dueDate.status === 'today' ? 'due-today' : '';
          taskMeta += ` <span class="meta-due ${dueDateClass}">${task.priorityLabel}</span>`;
        }
      }

      container.innerHTML = `
        <div class="task-card-content ${priorityClass}">
          <div class="task-priority-badge ${isChangesRequested ? 'badge-changes' : ''}">
            ${isChangesRequested ? 'üìù Breytingar √≥skast' : 'üìã ' + task.priorityLabel}
          </div>
          <h3 class="task-title">${escapeHtml(taskTitle)}</h3>
          <div class="task-meta">${taskMeta}</div>
          ${task.notes ? `<div class="task-notes">${escapeHtml(task.notes)}</div>` : ''}
          <div class="task-actions">
            <a href="${task.editorUrl}" class="btn btn-primary btn-large">
              <span class="btn-icon">‚úèÔ∏è</span>
              ${isChangesRequested ? 'Laga n√∫' : 'Byrja a√∞ vinna'}
            </a>
          </div>
        </div>
      `;
    }

    function renderUpNext(tasks) {
      const section = document.getElementById('up-next-section');
      const container = document.getElementById('up-next-list');
      const countBadge = document.getElementById('up-next-count');
      const INITIAL_SHOW = 3;

      if (!tasks || tasks.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      countBadge.textContent = tasks.length;

      const renderTask = (task) => {
        const isChangesRequested = task.type === 'changes_requested';
        const priorityClass = task.priority === 1 ? 'item-urgent' : task.priority === 2 ? 'item-soon' : '';

        let title = isChangesRequested
          ? `${task.bookLabel} K${task.chapter}/${task.section}`
          : `${task.bookLabel} - Kafli ${task.chapter}`;

        let badge = isChangesRequested
          ? '<span class="item-badge badge-changes">Laga</span>'
          : task.dueDate
            ? `<span class="item-badge ${task.dueDate.status === 'overdue' ? 'badge-overdue' : ''}">${task.priorityLabel}</span>`
            : `<span class="item-badge">${task.stageLabel}</span>`;

        return `
          <a href="${task.editorUrl}" class="up-next-item ${priorityClass}">
            <div class="item-content">
              <span class="item-title">${escapeHtml(title)}</span>
              ${badge}
            </div>
            <span class="item-arrow">‚Üí</span>
          </a>
        `;
      };

      const visibleTasks = tasks.slice(0, INITIAL_SHOW);
      const hiddenTasks = tasks.slice(INITIAL_SHOW);

      let html = visibleTasks.map(renderTask).join('');

      if (hiddenTasks.length > 0) {
        html += `
          <div class="accordion collapsed" id="up-next-more-accordion">
            <button class="accordion-header" onclick="toggleAccordion('up-next-more-accordion')">
              <div class="accordion-header-left">
                <span class="accordion-toggle">‚ñº</span>
                <span>S√Ωna ${hiddenTasks.length} fleiri verkefni</span>
              </div>
            </button>
            <div class="accordion-body">
              ${hiddenTasks.map(renderTask).join('')}
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // Toggle accordion open/closed
    function toggleAccordion(accordionId) {
      const accordion = document.getElementById(accordionId);
      if (accordion) {
        accordion.classList.toggle('collapsed');
      }
    }

    // ========================================
    // DETAILED VIEW (Legacy)
    // ========================================

    async function loadDetailedView() {
      if (detailedData) {
        renderDetailedView();
        return;
      }

      try {
        const res = await fetch('/api/my-work');
        detailedData = await res.json();
        renderDetailedView();
      } catch (err) {
        console.error('Failed to load detailed view:', err);
      }
    }

    function renderDetailedView() {
      // Update summary cards
      document.getElementById('summary-assignments').textContent = detailedData.summary.assignmentsCount;
      document.getElementById('summary-pending').textContent = detailedData.summary.pendingSubmissionsCount;
      document.getElementById('summary-changes').textContent = detailedData.summary.changesRequestedCount;
      document.getElementById('summary-terms').textContent = detailedData.summary.proposedTermsCount;

      // Update badges
      document.getElementById('assignments-badge').textContent = detailedData.summary.assignmentsCount;
      document.getElementById('submissions-badge').textContent = detailedData.summary.pendingSubmissionsCount;
      document.getElementById('changes-badge').textContent = detailedData.summary.changesRequestedCount;
      document.getElementById('terms-badge').textContent = detailedData.summary.proposedTermsCount;

      // Highlight cards with items
      if (detailedData.summary.changesRequestedCount > 0) {
        document.getElementById('card-changes').classList.add('highlight');
      }
      if (detailedData.summary.overdueCount > 0) {
        document.getElementById('card-assignments').classList.add('highlight-error');
      }

      // Render lists
      renderAssignments(detailedData.assignments);
      renderSubmissions(detailedData.pendingSubmissions);
      renderChangesRequested(detailedData.recentReviews.filter(r => r.status === 'changes_requested'));
      renderTerms(detailedData.proposedTerms);
      renderActivity(detailedData.recentActivity);
    }

    function renderAssignments(assignments) {
      const container = document.getElementById('assignments-list');

      if (assignments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p class="text-success">Engar √∫thlutanir √≠ augnablikinu</p>
          </div>
        `;
        return;
      }

      container.innerHTML = assignments.map(a => `
        <div class="work-item ${a.dueDate?.status === 'overdue' ? 'item-overdue' : a.dueDate?.status === 'today' ? 'item-today' : ''}">
          <div class="work-item-main">
            <div class="work-item-title">
              <span class="book-label">${escapeHtml(a.bookLabel)}</span>
              <span class="chapter-label">Kafli ${a.chapter}</span>
              <span class="stage-badge">${escapeHtml(a.stageLabel)}</span>
            </div>
            ${a.notes ? `<div class="work-item-notes">${escapeHtml(a.notes)}</div>` : ''}
            <div class="work-item-meta">
              <span class="assigned-by">√öthluta√∞ af ${escapeHtml(a.assignedBy)}</span>
              ${a.dueDate ? `<span class="due-date due-${a.dueDate.status}">${getDueDateText(a.dueDate)}</span>` : ''}
            </div>
          </div>
          <div class="work-item-action">
            <a href="${a.editorUrl}" class="btn btn-primary btn-sm">Opna</a>
          </div>
        </div>
      `).join('');
    }

    function renderSubmissions(submissions) {
      const container = document.getElementById('submissions-list');

      if (submissions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>Engin verkefni b√≠√∞a yfirfer√∞ar</p>
          </div>
        `;
        return;
      }

      container.innerHTML = submissions.map(s => `
        <div class="work-item">
          <div class="work-item-main">
            <div class="work-item-title">
              <span class="book-label">${escapeHtml(s.bookLabel)}</span>
              <span class="section-label">Kafli ${s.chapter}, hluti ${s.section}</span>
            </div>
            <div class="work-item-meta">
              <span class="submitted-at">Sent ${formatDate(s.submittedAt)}</span>
              <span class="days-pending ${s.daysPending > 3 ? 'text-warning' : ''}">
                (${s.daysPending} ${s.daysPending === 1 ? 'dagur' : 'dagar'} s√≠√∞an)
              </span>
            </div>
          </div>
          <div class="work-item-action">
            <a href="${s.editorUrl}" class="btn btn-secondary btn-sm">Sko√∞a</a>
          </div>
        </div>
      `).join('');
    }

    function renderChangesRequested(reviews) {
      const container = document.getElementById('changes-list');

      if (reviews.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p class="text-success">Engar breytingar √≥skast</p>
          </div>
        `;
        return;
      }

      container.innerHTML = reviews.map(r => `
        <div class="work-item item-attention">
          <div class="work-item-main">
            <div class="work-item-title">
              <span class="book-label">${escapeHtml(r.bookLabel)}</span>
              <span class="section-label">Kafli ${r.chapter}, hluti ${r.section}</span>
            </div>
            ${r.notes ? `<div class="review-notes"><strong>Athugasemd:</strong> ${escapeHtml(r.notes)}</div>` : ''}
            <div class="work-item-meta">
              <span class="reviewed-by">Fr√° ${escapeHtml(r.reviewedBy)}</span>
              <span class="reviewed-at">${formatDate(r.reviewedAt)}</span>
            </div>
          </div>
          <div class="work-item-action">
            <a href="${r.editorUrl}" class="btn btn-primary btn-sm">Laga</a>
          </div>
        </div>
      `).join('');
    }

    function renderTerms(terms) {
      const container = document.getElementById('terms-list');

      if (terms.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>Engar or√∞atill√∂gur √≠ bi√∞</p>
          </div>
        `;
        return;
      }

      container.innerHTML = terms.map(t => `
        <div class="term-item">
          <div class="term-pair">
            <span class="term-en">${escapeHtml(t.english)}</span>
            <span class="term-arrow">‚Üí</span>
            <span class="term-is">${escapeHtml(t.icelandic)}</span>
          </div>
          <div class="term-meta">
            <span class="term-status status-${t.status}">${getStatusLabel(t.status)}</span>
            ${t.discussionCount > 0 ? `<span class="term-discussions">${t.discussionCount} athugasemdir</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    function renderActivity(activities) {
      const container = document.getElementById('activity-list');

      if (!activities || activities.length === 0) {
        container.innerHTML = `<div class="empty-state"><p class="text-muted">Engin virkni skr√°√∞ enn.</p></div>`;
        return;
      }

      container.innerHTML = activities.map(a => `
        <div class="activity-item">
          <span class="activity-icon">${getActivityIcon(a.type)}</span>
          <div class="activity-content">
            <span class="activity-desc">${escapeHtml(a.description)}</span>
            <span class="activity-time">${formatTimeAgo(a.created_at)}</span>
          </div>
        </div>
      `).join('');
    }

    // ========================================
    // VIEW TOGGLE
    // ========================================

    function toggleView(view) {
      currentView = view;
      const focusView = document.getElementById('focus-view');
      const detailedView = document.getElementById('detailed-view');

      if (view === 'focus') {
        focusView.style.display = 'block';
        detailedView.style.display = 'none';
      } else {
        focusView.style.display = 'none';
        detailedView.style.display = 'block';
        loadDetailedView();
      }

      // Store preference
      localStorage.setItem('myWorkView', view);
    }

    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    function formatDate(dateStr) {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleDateString('is-IS');
    }

    function formatTimeAgo(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'R√©tt √≠ √æessu';
      if (diffMins < 60) return `${diffMins} m√≠n s√≠√∞an`;
      if (diffHours < 24) return `${diffHours} klst s√≠√∞an`;
      if (diffDays === 1) return '√ç g√¶r';
      if (diffDays < 7) return `${diffDays} d√∂gum s√≠√∞an`;
      return formatDate(dateStr);
    }

    function getDueDateText(dueInfo) {
      if (!dueInfo) return '';
      if (dueInfo.status === 'overdue') {
        const days = Math.abs(dueInfo.daysUntil);
        return `${days} ${days === 1 ? 'dagur' : 'dagar'} yfir t√≠ma!`;
      }
      if (dueInfo.status === 'today') return 'Skiladagur √≠ dag!';
      if (dueInfo.status === 'soon') {
        return `${dueInfo.daysUntil} ${dueInfo.daysUntil === 1 ? 'dagur' : 'dagar'} eftir`;
      }
      return `Skiladagur: ${dueInfo.formatted}`;
    }

    function getStatusLabel(status) {
      const labels = {
        'proposed': '√ç bi√∞',
        'needs_review': '√ûarf yfirfer√∞',
        'approved': 'Sam√æykkt',
        'disputed': 'Deilt um'
      };
      return labels[status] || status;
    }

    function getActivityIcon(type) {
      const icons = {
        'edit': '‚úèÔ∏è', 'submit': 'üì§', 'approve': '‚úÖ', 'reject': '‚ùå',
        'term_propose': 'üìñ', 'term_approve': '‚úì', 'assign': 'üë§'
      };
      return icons[type] || 'üìå';
    }

    // ========================================
    // BLOCKED ISSUES BANNER
    // ========================================

    function renderBlockedBanner(blockedIssues) {
      const banner = document.getElementById('blocked-banner');
      const countEl = document.getElementById('blocked-count');
      const listEl = document.getElementById('blocked-list');

      if (!blockedIssues || blockedIssues.length === 0) {
        banner.style.display = 'none';
        return;
      }

      countEl.textContent = blockedIssues.length;

      listEl.innerHTML = blockedIssues.map(issue => `
        <div class="blocked-item">
          <div class="blocked-item-main">
            <span class="blocked-item-location">
              ${escapeHtml(issue.bookLabel)} - Kafli ${issue.chapter}
            </span>
            <span class="blocked-item-description">${escapeHtml(issue.description)}</span>
          </div>
          <a href="/issues?id=${issue.id}" class="btn btn-small btn-blocked">
            Sj√° atri√∞i
          </a>
        </div>
      `).join('');

      banner.style.display = 'block';
    }

    // ========================================
    // SETTINGS / NOTIFICATION PREFERENCES
    // ========================================

    async function openSettingsModal() {
      document.getElementById('settings-modal').style.display = 'flex';
      await loadNotificationPreferences();
    }

    function closeSettingsModal() {
      document.getElementById('settings-modal').style.display = 'none';
    }

    async function loadNotificationPreferences() {
      const list = document.getElementById('preference-list');
      list.innerHTML = '<p class="loading"><i class="fas fa-spinner fa-spin"></i> Hle√∞ur...</p>';

      try {
        const res = await fetch('/api/notifications/preferences');
        const data = await res.json();
        notificationPreferences = data.preferences;

        list.innerHTML = Object.entries(data.categories).map(([key, category]) => {
          const prefs = notificationPreferences[key] || { inApp: true, email: true };
          return `
            <div class="preference-item">
              <div class="preference-info">
                <span class="preference-label">${category.label}</span>
                <span class="preference-description">${category.description}</span>
              </div>
              <div class="preference-toggles">
                <label class="toggle-label">
                  <input type="checkbox" id="pref-${key}-inApp" ${prefs.inApp ? 'checked' : ''}>
                  <span class="toggle-text"><i class="fas fa-bell"></i> √ç appinu</span>
                </label>
                <label class="toggle-label">
                  <input type="checkbox" id="pref-${key}-email" ${prefs.email ? 'checked' : ''}>
                  <span class="toggle-text"><i class="fas fa-envelope"></i> T√∂lvup√≥stur</span>
                </label>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading preferences:', err);
        list.innerHTML = '<p class="error">Villa vi√∞ a√∞ hla√∞a stillingum</p>';
      }
    }

    async function savePreferences() {
      const preferences = {};

      // Collect values from checkboxes
      document.querySelectorAll('.preference-item').forEach(item => {
        const inAppInput = item.querySelector('input[id$="-inApp"]');
        const emailInput = item.querySelector('input[id$="-email"]');

        if (inAppInput && emailInput) {
          const key = inAppInput.id.replace('pref-', '').replace('-inApp', '');
          preferences[key] = {
            inApp: inAppInput.checked,
            email: emailInput.checked
          };
        }
      });

      try {
        const res = await fetch('/api/notifications/preferences', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preferences)
        });

        const data = await res.json();

        if (data.success) {
          notificationPreferences = data.preferences;
          closeSettingsModal();
          showToast('Stillingar vista√∞ar', 'success');
        } else {
          showToast('Villa vi√∞ a√∞ vista stillingar', 'error');
        }
      } catch (err) {
        console.error('Error saving preferences:', err);
        showToast('Villa vi√∞ a√∞ vista stillingar', 'error');
      }
    }

    function showToast(message, type = 'info') {
      // Simple toast notification
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize
    init();
  </script>

  <style>
    /* ==========================================================================
       MY-WORK PAGE SPECIFIC STYLES
       Extends common.css with page-specific components
       ========================================================================== */

    /* Container override for narrower content */
    .container { max-width: 800px; }

    /* ========================================
       FOCUS VIEW STYLES
       ======================================== */

    .welcome-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }
    .welcome-text h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }
    .greeting-subtitle {
      color: var(--gray-500);
      font-size: 1rem;
    }
    .view-toggle .btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .toggle-icon { font-size: 1rem; }

    /* Alert Banner */
    .alert-banner {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .alert-icon { font-size: 1.25rem; }
    .alert-text { font-weight: 500; color: #92400e; }

    /* Blocked Issues Banner */
    .blocked-banner {
      background: var(--error-light);
      border: 2px solid var(--error);
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    .blocked-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: rgba(220, 38, 38, 0.1);
      border-bottom: 1px solid rgba(220, 38, 38, 0.2);
    }
    .blocked-icon { font-size: 1.25rem; }
    .blocked-header strong { color: #991b1b; }
    .blocked-count {
      background: var(--error);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      margin-left: auto;
    }
    .blocked-list {
      padding: 0.5rem;
    }
    .blocked-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: white;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
    }
    .blocked-item:last-child { margin-bottom: 0; }
    .blocked-item-main {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .blocked-item-location {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-700);
    }
    .blocked-item-description {
      font-size: 0.875rem;
      color: var(--gray-600);
    }
    .btn-blocked {
      background: var(--error);
      color: white;
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }
    .btn-blocked:hover { background: #b91c1c; }

    /* Section Label */
    .section-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .count-badge {
      background: var(--gray-200);
      color: var(--gray-700);
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
    }

    /* Current Task Card */
    .current-task-section { margin-bottom: 2rem; }

    .current-task-card {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      overflow: hidden;
    }

    .task-card-content {
      padding: 1.5rem;
    }
    .task-card-content.priority-urgent {
      border-left: 4px solid var(--error);
    }
    .task-card-content.priority-soon {
      border-left: 4px solid var(--warning);
    }

    .task-priority-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      background: var(--primary-light);
      color: var(--primary-dark);
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .task-priority-badge.badge-changes {
      background: var(--warning-light);
      color: #92400e;
    }

    .task-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .task-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
      color: var(--gray-500);
    }
    .meta-stage {
      background: var(--gray-100);
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
    }
    .meta-due { font-weight: 500; }
    .meta-due.due-overdue { color: var(--error); }
    .meta-due.due-today { color: var(--warning); }
    .meta-reviewer { font-style: italic; }

    .task-notes {
      background: var(--gray-50);
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      color: var(--gray-700);
      border-left: 3px solid var(--primary);
    }

    .task-actions {
      padding-top: 0.5rem;
    }

    .btn-large {
      padding: 0.875rem 1.5rem;
      font-size: 1rem;
    }
    .btn-icon { margin-right: 0.5rem; }

    /* Empty Task State */
    .empty-task {
      text-align: center;
      padding: 3rem 2rem;
    }
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .empty-task h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--gray-900);
    }
    .empty-task p {
      color: var(--gray-500);
    }

    /* Up Next Section */
    .up-next-section { margin-bottom: 2rem; }

    .up-next-list {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .up-next-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--gray-100);
      text-decoration: none;
      color: var(--gray-900);
      transition: background 0.15s;
    }
    .up-next-item:last-child { border-bottom: none; }
    .up-next-item:hover { background: var(--gray-50); }
    .up-next-item.item-urgent { background: var(--error-light); }
    .up-next-item.item-soon { background: var(--warning-light); }

    .item-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .item-title { font-weight: 500; }
    .item-badge {
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      background: var(--gray-100);
      color: var(--gray-700);
    }
    .item-badge.badge-changes {
      background: var(--warning-light);
      color: #92400e;
    }
    .item-badge.badge-overdue {
      background: var(--error-light);
      color: #991b1b;
    }
    .item-arrow {
      color: var(--gray-400);
      font-size: 1.25rem;
    }

    /* Quick Stats */
    .quick-stats {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-item {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
    }
    .stat-value {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    .stat-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 3rem;
      color: var(--gray-500);
    }

    /* ========================================
       DETAILED VIEW STYLES (Legacy)
       ======================================== */

    .view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .view-header h2 { font-size: 1.5rem; }

    /* Summary Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .summary-card {
      background: white;
      padding: 1.25rem;
      border-radius: 0.5rem;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .summary-card.highlight { border-left: 4px solid var(--warning); }
    .summary-card.highlight-error { border-left: 4px solid var(--error); }
    .summary-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .summary-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
    .summary-card.warning .summary-value { color: var(--warning); }
    .summary-label { font-size: 0.875rem; color: var(--gray-500); }

    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* Card body max height override for this page */
    .card-body { max-height: 400px; overflow-y: auto; }

    /* Work Items */
    .work-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .work-item:last-child { border-bottom: none; }
    .work-item.item-overdue { background: var(--error-light); margin: 0 -1.25rem; padding: 0.875rem 1.25rem; }
    .work-item.item-today { background: var(--warning-light); margin: 0 -1.25rem; padding: 0.875rem 1.25rem; }
    .work-item.item-attention { background: var(--warning-light); margin: 0 -1.25rem; padding: 0.875rem 1.25rem; }

    .work-item-main { flex: 1; }
    .work-item-title { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.25rem; }
    .work-item-notes { font-size: 0.875rem; color: var(--gray-600); margin: 0.25rem 0; font-style: italic; }
    .work-item-meta { font-size: 0.75rem; color: var(--gray-500); display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .work-item-action { margin-left: 1rem; }

    .book-label { font-weight: 600; color: var(--gray-700); }
    .chapter-label, .section-label { color: var(--gray-600); }
    .stage-badge {
      background: var(--primary-light);
      color: #1e40af;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .due-date { font-weight: 500; }
    .due-overdue { color: var(--error); }
    .due-today { color: var(--warning); }

    .review-notes {
      background: white;
      padding: 0.5rem 0.75rem;
      border-radius: 0.25rem;
      margin: 0.5rem 0;
      font-size: 0.875rem;
      border-left: 3px solid var(--warning);
    }

    /* Term Items */
    .term-item {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .term-item:last-child { border-bottom: none; }
    .term-pair { margin-bottom: 0.25rem; }
    .term-en { color: var(--gray-500); }
    .term-arrow { color: var(--gray-400); margin: 0 0.5rem; }
    .term-is { font-weight: 500; color: var(--gray-700); }
    .term-meta { font-size: 0.75rem; display: flex; gap: 0.75rem; }
    .term-status {
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-weight: 500;
    }
    .status-proposed { background: var(--primary-light); color: #1e40af; }
    .status-needs_review { background: var(--warning-light); color: #92400e; }

    /* Activity Items */
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon { font-size: 1rem; }
    .activity-content { flex: 1; }
    .activity-desc { display: block; font-size: 0.875rem; }
    .activity-time { font-size: 0.75rem; color: var(--gray-500); }

    /* Page-specific responsive */
    @media (max-width: 1024px) {
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
      .content-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .welcome-section { flex-direction: column; gap: 1rem; }
      .quick-stats { flex-direction: column; }
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* Settings Button */
    .settings-btn {
      background: transparent;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--gray-400);
      border-radius: 0.375rem;
      transition: color 0.15s, background-color 0.15s;
    }
    .settings-btn:hover {
      color: var(--primary);
      background: var(--gray-100);
    }

    /* Settings Styles (page-specific) */
    .settings-section-title {
      margin: 0 0 0.25rem 0;
      font-size: 1rem;
    }
    .settings-description {
      color: var(--gray-500);
      font-size: 0.875rem;
      margin: 0 0 1rem 0;
    }
    .preference-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .preference-item {
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 0.5rem;
      border: 1px solid var(--gray-200);
    }
    .preference-info {
      margin-bottom: 0.75rem;
    }
    .preference-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .preference-description {
      font-size: 0.8rem;
      color: var(--gray-500);
    }
    .preference-toggles {
      display: flex;
      gap: 1.5rem;
    }
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .toggle-label input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      cursor: pointer;
    }
    .toggle-text {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .toggle-text i {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

  </style>

  <!-- Floating Feedback Button -->
  <div class="feedback-fab">
    <a href="/feedback" class="feedback-fab-btn" title="Senda endurgj√∂f">
      <i class="fas fa-comment-dots"></i>
    </a>
  </div>

  <script src="/js/theme.js"></script>
</body>
</html>
