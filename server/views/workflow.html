<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verkflæði - Námsbókasafn</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/my-work">Mín verkefni</a>
      <a href="/workflow">Verkflæði</a>
      <a href="/status">Stjórnborð</a>
      <a href="/editor">Ritstjóri</a>
      <a href="/terminology">Orðasafn</a>
      <a href="/decisions">Ákvarðanir</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stjórnborð</a>
      <a href="/admin" class="admin-only admin-link">Stjórnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um þema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notifications" id="notifications-widget" style="display: none;">
        <button class="notification-btn" id="notification-btn" title="Tilkynningar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span class="notification-count" id="notification-count" style="display: none;">0</span>
        </button>
        <div class="notification-dropdown" id="notification-dropdown" style="display: none;">
          <div class="dropdown-header">
            <span>Tilkynningar</span>
            <button class="mark-all-read" id="mark-all-read">Merkja allt lesið</button>
          </div>
          <div class="notification-list" id="notification-list"></div>
        </div>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <div class="card" id="start-workflow">
      <h2 class="card-title">Hefja nýtt verkflæði</h2>
      <form id="workflow-form">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">Bók</label>
            <select class="form-select" name="book" id="book-select" required>
              <option value="">Hleður...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Kafli</label>
            <select class="form-select" name="chapter" id="chapter-select" required disabled>
              <option value="">Veldu bók fyrst...</option>
            </select>
          </div>
        </div>
        <div id="chapter-info" class="chapter-info" style="display: none;">
          <p><strong>Kafli inniheldur:</strong> <span id="module-count">0</span> einingar</p>
          <ul id="module-list" class="module-list"></ul>
        </div>

        <!-- Permanent chapter files section -->
        <div id="chapter-files" class="chapter-files" style="display: none;">
          <h4>Skrár kafla</h4>
          <div id="files-loading" style="display: none;">
            <p class="text-muted">Hleður...</p>
          </div>
          <div id="files-status"></div>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn" disabled>Hefja verkflæði</button>
      </form>
    </div>

    <div class="card">
      <h2 class="card-title">Virk verkflæði</h2>
      <div id="active-workflows"><p class="text-muted">Hleður...</p></div>
    </div>

    <div class="card" id="workflow-detail" style="display: none;">
      <h2 class="card-title"><span id="detail-title"></span></h2>
      <div class="steps" id="workflow-steps"></div>
      <div id="step-content"></div>
      <div id="step-actions" class="actions"></div>
    </div>
  </main>

  <script>
    let booksData = {};
    let selectedChapter = null;

    // Load books on page load
    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        const select = document.getElementById('book-select');
        select.innerHTML = '<option value="">Veldu bók...</option>' +
          data.books.map(b => '<option value="' + b.id + '">' + b.titleIs + ' (' + b.title + ')</option>').join('');
      } catch (e) {
        document.getElementById('book-select').innerHTML = '<option value="">Villa við að hlaða bókum</option>';
      }
    }

    // Load chapters when book is selected
    async function loadChapters(bookId) {
      const chapterSelect = document.getElementById('chapter-select');
      const submitBtn = document.getElementById('submit-btn');
      const chapterInfo = document.getElementById('chapter-info');

      if (!bookId) {
        chapterSelect.innerHTML = '<option value="">Veldu bók fyrst...</option>';
        chapterSelect.disabled = true;
        submitBtn.disabled = true;
        chapterInfo.style.display = 'none';
        return;
      }

      chapterSelect.innerHTML = '<option value="">Hleður...</option>';
      chapterSelect.disabled = true;

      try {
        const res = await fetch('/api/books/' + bookId);
        const data = await res.json();
        booksData[bookId] = data;

        chapterSelect.innerHTML = '<option value="">Veldu kafla...</option>' +
          data.chapters.map(c => '<option value="' + c.chapter + '">Kafli ' + c.chapter + ': ' + (c.titleIs || c.title) + '</option>').join('');
        chapterSelect.disabled = false;
        chapterInfo.style.display = 'none';
      } catch (e) {
        chapterSelect.innerHTML = '<option value="">Villa við að hlaða köflum</option>';
      }
    }

    // Show chapter details when chapter is selected
    function showChapterInfo(bookId, chapterNum) {
      const chapterInfo = document.getElementById('chapter-info');
      const chapterFiles = document.getElementById('chapter-files');
      const submitBtn = document.getElementById('submit-btn');

      if (!chapterNum || !booksData[bookId]) {
        chapterInfo.style.display = 'none';
        chapterFiles.style.display = 'none';
        submitBtn.disabled = true;
        selectedChapter = null;
        return;
      }

      const chapter = booksData[bookId].chapters.find(c => c.chapter === parseInt(chapterNum, 10));
      if (!chapter) {
        chapterInfo.style.display = 'none';
        chapterFiles.style.display = 'none';
        submitBtn.disabled = true;
        return;
      }

      selectedChapter = chapter;
      document.getElementById('module-count').textContent = chapter.modules.length;
      document.getElementById('module-list').innerHTML = chapter.modules.map(m =>
        '<li><code>' + m.id + '</code> - ' + m.section + ': ' + m.title + '</li>'
      ).join('');
      chapterInfo.style.display = 'block';
      submitBtn.disabled = false;

      // Load chapter files status
      loadChapterFiles(bookId, chapterNum);
    }

    // Load chapter files status (permanent storage)
    async function loadChapterFiles(bookId, chapterNum) {
      const filesEl = document.getElementById('chapter-files');
      const loadingEl = document.getElementById('files-loading');
      const statusEl = document.getElementById('files-status');

      filesEl.style.display = 'block';
      loadingEl.style.display = 'block';
      statusEl.innerHTML = '';

      try {
        const res = await fetch('/api/books/' + bookId + '/chapters/' + chapterNum + '/files');
        loadingEl.style.display = 'none';

        if (!res.ok) {
          statusEl.innerHTML = '<p class="text-muted">Engar skrár fundust</p>';
          return;
        }

        const data = await res.json();

        if (data.hasRequiredFiles && data.sections && data.sections.length > 0) {
          // Files exist - show download option
          let html = '<div class="files-available">' +
            '<p class="text-success"><strong>✓ Skrár til staðar</strong></p>' +
            '<p class="text-muted">' + data.sections.length + ' einingar með skrár</p>';

          // Show sections list
          html += '<ul class="section-list">';
          for (const section of data.sections) {
            const fileTypes = section.files.map(f => f.type).join(', ');
            html += '<li><code>' + escapeHtml(section.section) + '</code> - ' +
              section.files.length + ' skrár (' + fileTypes + ')</li>';
          }
          html += '</ul>';

          // Recent history
          if (data.recentHistory && data.recentHistory.length > 0) {
            const lastGen = data.recentHistory.find(h => h.action === 'files_generated' || h.action === 'file_generated');
            if (lastGen) {
              const date = new Date(lastGen.created_at).toLocaleString('is-IS');
              html += '<p class="text-muted" style="font-size: 0.75rem;">Síðast búið til: ' + date + '</p>';
            }
          }

          // Actions
          html += '<div class="files-actions">' +
            '<a href="/api/books/' + bookId + '/download?chapter=' + chapterNum + '&type=en-md" class="btn btn-secondary btn-small">Sækja EN .md</a>' +
            '<button type="button" class="btn btn-small" onclick="scanChapterFiles(\'' + bookId + '\', ' + chapterNum + ')">Endurskanna</button>' +
            '</div>';

          html += '</div>';
          statusEl.innerHTML = html;
        } else {
          // No files - offer to generate, scan, or import
          let html = '<div class="files-missing">' +
            '<p class="text-muted">Engar skrár fundust fyrir þennan kafla.</p>' +
            '<div class="files-actions">' +
            '<button type="button" class="btn btn-primary btn-small" onclick="generateFromSource(\'' + bookId + '\', ' + chapterNum + ')"><i class="fas fa-cog"></i> Búa til úr uppruna</button>' +
            '<button type="button" class="btn btn-secondary btn-small" onclick="scanChapterFiles(\'' + bookId + '\', ' + chapterNum + ')">Leita að skrám</button>' +
            '<button type="button" class="btn btn-small" onclick="showImportDialog(\'' + bookId + '\', ' + chapterNum + ')">Flytja inn</button>' +
            '</div>' +
            '</div>';
          statusEl.innerHTML = html;
        }
      } catch (e) {
        loadingEl.style.display = 'none';
        statusEl.innerHTML = '<p class="text-muted">Gat ekki hlaðið skrástöðu</p>';
      }
    }

    // Generate files from source using pipeline-runner
    async function generateFromSource(bookId, chapterNum) {
      if (!confirm('Þetta mun búa til .md skrár úr CNXML uppruna. Þetta getur tekið nokkrar sekúndur. Halda áfram?')) {
        return;
      }

      const statusEl = document.getElementById('files-status');
      statusEl.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Býr til skrár úr uppruna...</p>';

      try {
        const res = await fetch('/api/books/' + bookId + '/chapters/' + chapterNum + '/generate', {
          method: 'POST'
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || data.message || 'Generation failed');
        }

        if (data.success) {
          alert(data.filesGenerated + ' skrár búnar til fyrir kafla ' + chapterNum);
          loadChapterFiles(bookId, chapterNum);
        } else {
          throw new Error(data.error || 'Generation failed');
        }
      } catch (err) {
        alert('Villa við að búa til skrár: ' + err.message);
        loadChapterFiles(bookId, chapterNum);
      }
    }

    // Scan for existing files on disk
    async function scanChapterFiles(bookId, chapterNum) {
      try {
        const res = await fetch('/api/books/' + bookId + '/chapters/' + chapterNum + '/files/scan', {
          method: 'POST'
        });
        const data = await res.json();
        if (data.success) {
          alert('Skönnun lokið: ' + data.found + ' skrár fundnar, ' + data.registered + ' skráðar.');
          loadChapterFiles(bookId, chapterNum);
        } else {
          alert('Villa við skönnun: ' + (data.message || data.error));
        }
      } catch (e) {
        alert('Villa: ' + e.message);
      }
    }

    // Show import dialog for chapter files
    let importBookId = null;
    let importChapterNum = null;

    function showImportDialog(bookId, chapterNum) {
      importBookId = bookId;
      importChapterNum = chapterNum;

      const statusEl = document.getElementById('files-status');
      statusEl.innerHTML = '<div class="import-dialog">' +
        '<h5>Flytja inn .md skrár</h5>' +
        '<p class="text-muted" style="font-size: 0.8125rem;">Veldu .en.md skrár sem búnar voru til með CLI verkfærum.</p>' +
        '<form id="import-form" class="import-form">' +
        '<input type="file" id="import-files" name="files" multiple accept=".md" required>' +
        '<div class="import-actions">' +
        '<button type="submit" class="btn btn-primary btn-small">Flytja inn</button>' +
        '<button type="button" class="btn btn-secondary btn-small" onclick="loadChapterFiles(\'' + bookId + '\', ' + chapterNum + ')">Hætta við</button>' +
        '</div>' +
        '</form>' +
        '</div>';

      // Setup form handler
      document.getElementById('import-form').addEventListener('submit', handleImport);
    }

    async function handleImport(e) {
      e.preventDefault();

      const files = document.getElementById('import-files').files;
      if (!files.length) {
        alert('Veldu skrár til að flytja inn');
        return;
      }

      const formData = new FormData();
      for (const file of files) {
        formData.append('files', file);
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Flytur inn...';

      try {
        const res = await fetch('/api/books/' + importBookId + '/chapters/' + importChapterNum + '/import', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          let msg = 'Innflutningur lokið: ' + data.imported + ' skrár fluttar inn.';
          if (data.errors && data.errors.length > 0) {
            msg += '\n\nVillur:\n' + data.errors.map(e => e.file + ': ' + e.error).join('\n');
          }
          alert(msg);
          loadChapterFiles(importBookId, importChapterNum);
        } else {
          alert('Villa: ' + (data.message || data.error));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Flytja inn';
      }
    }

    // Event listeners
    document.getElementById('book-select').addEventListener('change', (e) => {
      loadChapters(e.target.value);
    });

    document.getElementById('chapter-select').addEventListener('change', (e) => {
      const bookId = document.getElementById('book-select').value;
      showChapterInfo(bookId, e.target.value);
    });

    document.getElementById('workflow-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = document.getElementById('submit-btn');
      const data = {
        book: form.book.value,
        chapter: parseInt(form.chapter.value, 10),
        modules: selectedChapter ? selectedChapter.modules.map(m => ({
          id: m.id,
          section: m.section,
          title: m.title
        })) : []
      };

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Vinnur í ' + data.modules.length + ' einingum...';

      try {
        const res = await fetch('/api/workflow/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.success) {
          showWorkflow(result);
          loadWorkflows();
          // Reset form
          form.reset();
          document.getElementById('chapter-info').style.display = 'none';
        } else if (res.status === 409 && result.existingSession) {
          // Workflow already exists - offer to join
          showExistingWorkflowDialog(result);
        } else {
          alert('Villa: ' + (result.message || result.error));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Hefja verkflæði';
      }
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showExistingWorkflowDialog(result) {
      const existing = result.existingSession;
      const progressText = existing.progress
        ? `${existing.progress.uploaded}/${existing.progress.expected} skrár hlaðið upp`
        : '';

      const contentEl = document.getElementById('step-content');
      contentEl.innerHTML = '';

      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-warning';

      const h3 = document.createElement('h3');
      h3.textContent = 'Verkflæði þegar til staðar';
      alertDiv.appendChild(h3);

      const msgP = document.createElement('p');
      msgP.textContent = result.message;
      alertDiv.appendChild(msgP);

      const infoDiv = document.createElement('div');
      infoDiv.className = 'existing-session-info';
      infoDiv.innerHTML = `
        <p><strong>Byrjað af:</strong> ${escapeHtml(existing.startedBy || 'Óþekktur')}</p>
        <p><strong>Núverandi skref:</strong> ${escapeHtml(existing.currentStep || '')}</p>
        ${progressText ? `<p><strong>Framvinda:</strong> ${escapeHtml(progressText)}</p>` : ''}
        <p><strong>Byrjað:</strong> ${escapeHtml(new Date(existing.startedAt).toLocaleString('is-IS'))}</p>
      `;
      alertDiv.appendChild(infoDiv);

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'dialog-actions';

      const joinBtn = document.createElement('button');
      joinBtn.className = 'btn btn-primary';
      joinBtn.textContent = 'Skoða verkflæði';
      joinBtn.addEventListener('click', () => loadWorkflow(existing.id));
      actionsDiv.appendChild(joinBtn);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = 'Hætta við';
      cancelBtn.addEventListener('click', closeExistingDialog);
      actionsDiv.appendChild(cancelBtn);

      alertDiv.appendChild(actionsDiv);
      contentEl.appendChild(alertDiv);

      document.getElementById('workflow-detail').style.display = 'block';
      document.getElementById('detail-title').textContent = 'Verkflæði þegar til';
      document.getElementById('workflow-steps').innerHTML = '';
      document.getElementById('step-actions').innerHTML = '';
    }

    function closeExistingDialog() {
      document.getElementById('workflow-detail').style.display = 'none';
    }

    function showWorkflow(data) {
      document.getElementById('workflow-detail').style.display = 'block';
      document.getElementById('detail-title').textContent = data.book + ' - Kafli ' + data.chapter;

      const stepsEl = document.getElementById('workflow-steps');
      stepsEl.innerHTML = data.steps.map((step, i) => {
        const cls = step.status === 'completed' ? 'complete' : step.status === 'in-progress' ? 'active' : 'pending';
        return '<div class="step ' + cls + '"><div class="step-number">' + (i + 1) + '</div><div class="step-label">' + step.name + '</div></div>';
      }).join('');

      // Handle currentStep being either an index (number) or step object
      let current;
      if (typeof data.currentStep === 'number') {
        current = data.steps[data.currentStep];
      } else if (data.currentStep && data.currentStep.id) {
        current = data.currentStep;
      } else {
        current = data.steps[0];
      }

      const contentEl = document.getElementById('step-content');
      const actionsEl = document.getElementById('step-actions');

      // Show module processing results if available
      let moduleInfo = '';
      if (data.modulesProcessed !== undefined) {
        moduleInfo = '<p class="module-status"><strong>Einingar:</strong> ' + data.modulesProcessed + ' af ' + data.modulesTotal + ' unnar</p>';
        if (data.errors && data.errors.length > 0) {
          moduleInfo += '<p class="text-error">Villur: ' + data.errors.map(e => e.moduleId).join(', ') + '</p>';
        }
      }

      const stepIndex = data.steps.findIndex(s => s.id === current.id);
      const hasDownloads = data.downloads && Object.keys(data.downloads).length > 0;

      // Count file types
      let mdCount = 0, xliffCount = 0;
      if (data.downloads) {
        for (const type of Object.keys(data.downloads)) {
          if (type.includes('markdown')) mdCount++;
          if (type.includes('xliff')) xliffCount++;
        }
      }

      // Step-specific content
      if (current.id === 'source' || (stepIndex === 0 && current.status === 'completed')) {
        // Source step completed - show download button to proceed
        contentEl.innerHTML =
          '<div class="alert alert-success">' + moduleInfo +
          '<strong>Skref 1: Undirbúningur - Lokið</strong>' +
          '<p>' + mdCount + ' .md skrár og ' + xliffCount + ' .xliff skrár tilbúnar.</p>' +
          '</div>' +
          '<div class="next-action">' +
          '<p>Sæktu .md skrárnar og þýddu þær á <a href="https://malstadur.is" target="_blank">malstadur.is</a> (Erlendur MT)</p>' +
          '<button id="download-proceed" class="btn btn-primary btn-large">Sækja .md skrár og halda áfram →</button>' +
          '</div>';

        document.getElementById('download-proceed')?.addEventListener('click', async () => {
          // Download only MD files as ZIP
          if (data.sessionId) {
            window.open('/api/workflow/' + data.sessionId + '/download-all?filter=md', '_blank');
          }

          // Advance workflow to next step
          try {
            const advRes = await fetch('/api/workflow/' + data.sessionId + '/advance', { method: 'POST' });
            const advResult = await advRes.json();
            if (advResult.success || advResult.error) {
              // Reload to show MT upload step
              setTimeout(() => loadWorkflow(data.sessionId), 500);
            }
          } catch (e) {
            // Even if advance fails, show MT upload step
            setTimeout(() => showMTUploadStep(data), 500);
          }
        });

      } else if (current.id === 'mt-upload') {
        showMTUploadStep(data);

      } else if (current.id === 'faithful-edit') {
        showFaithfulEditStep(data, stepIndex);

      } else if (current.id === 'tm-creation') {
        showTMCreationStep(data, stepIndex);

      } else if (current.id === 'localization') {
        showLocalizationStep(data, stepIndex);

      } else {
        const statusText = current.status === 'completed' ? 'Lokið' : current.status === 'in-progress' ? 'Í vinnslu' : 'Bíður';
        contentEl.innerHTML = '<div class="alert ' + (current.status === 'completed' ? 'alert-success' : 'alert-info') + '">' + moduleInfo + '<strong>Skref ' + (stepIndex + 1) + ': ' + current.name + '</strong><p>Staða: ' + statusText + '</p></div>';
      }

      actionsEl.innerHTML = '';
    }

    function showMTUploadStep(data) {
      const contentEl = document.getElementById('step-content');

      // Get upload progress from data
      const progress = data.uploadProgress || { uploaded: 0, expected: 0, complete: false, missing: [], matchedFiles: [] };
      const expectedFiles = data.session?.expectedFiles?.['mt-upload'] || [];
      const uploadedFiles = data.session?.uploadedFiles?.['mt-upload'] || [];
      const matchedFiles = progress.matchedFiles || [];

      // Create a lookup for matched uploads (by section+part or section)
      const matchedKeys = new Set();
      for (const m of matchedFiles) {
        if (m.section && m.part) {
          matchedKeys.add(m.section + ':' + m.part);
        } else if (m.section) {
          matchedKeys.add(m.section);
        } else if (m.moduleId) {
          matchedKeys.add(m.moduleId);
        }
      }

      // Create file checklist with friendly names
      let checklistHtml = '';
      if (expectedFiles.length > 0) {
        checklistHtml = '<div class="file-checklist"><h4>Skrár sem þarf að hlaða upp:</h4><ul class="checklist">';
        for (const exp of expectedFiles) {
          // Expected is object with section, part, displayName, downloadName, expectedUpload
          const section = typeof exp === 'object' ? exp.section : null;
          const part = typeof exp === 'object' ? exp.part : null;
          const moduleId = typeof exp === 'object' ? exp.moduleId : (exp.match && exp.match(/(m\d+)/)?.[1]);
          const displayName = typeof exp === 'object' ? exp.displayName : exp;
          const downloadName = typeof exp === 'object' ? exp.downloadName : null;
          const expectedUpload = typeof exp === 'object' ? exp.expectedUpload : null;

          // Check if uploaded (by section+part, section, or moduleId)
          let key = null;
          if (section && part) {
            key = section + ':' + part;
          } else if (section) {
            key = section;
          } else if (moduleId) {
            key = moduleId;
          }
          const isUploaded = key && matchedKeys.has(key);
          const icon = isUploaded ? '✓' : '○';
          const cls = isUploaded ? 'uploaded' : 'pending';

          // Show download name and expected upload name for clarity
          let fileInfo = escapeHtml(displayName);
          if (downloadName) {
            fileInfo += '<br><small class="file-names">Niðurhal: <code>' + escapeHtml(downloadName) + '</code>';
            if (expectedUpload) {
              fileInfo += ' → Upphal: <code>' + escapeHtml(expectedUpload) + '</code>';
            }
            fileInfo += '</small>';
          }

          checklistHtml += '<li class="checklist-item ' + cls + '"><span class="check-icon">' + icon + '</span><span class="file-info">' + fileInfo + '</span></li>';
        }
        checklistHtml += '</ul></div>';
      }

      // Show warning if split files
      const hasSplitFiles = expectedFiles.some(exp => exp.part);
      let splitWarning = '';
      if (hasSplitFiles) {
        splitWarning = '<div class="alert alert-warning" style="margin-bottom: 1rem;">' +
          '<strong>⚠️ Stórar skrár skipt upp</strong><br>' +
          'Sumar skrár voru of stórar fyrir Erlendur (>18.000 stafir) og hafa verið skiptar í hluta. ' +
          'Þýddu hvern hluta fyrir sig og hladdu þeim öllum upp.' +
          '</div>';
      }

      // Progress summary
      const progressSummary = progress.expected > 0
        ? '<div class="progress-summary"><strong>' + progress.uploaded + ' af ' + progress.expected + '</strong> skrám hlaðið upp' +
          (progress.complete ? ' <span class="text-success">✓ Tilbúið</span>' : '') + '</div>'
        : '';

      // Issue summary from session
      const sessionIssues = data.session?.issues || [];
      const pendingIssues = sessionIssues.filter(i => i.status === 'pending');
      const blockedIssues = pendingIssues.filter(i => i.category === 'BLOCKED');
      const reviewIssues = pendingIssues.filter(i => i.category === 'EDITOR_CONFIRM' || i.category === 'BOARD_REVIEW');
      const autoFixedCount = sessionIssues.filter(i => i.category === 'AUTO_FIX' && i.status === 'resolved').length;

      let issueSummaryHtml = '';
      if (sessionIssues.length > 0) {
        issueSummaryHtml = '<div class="issue-summary">';
        issueSummaryHtml += '<h4>Atriðagreining:</h4>';
        issueSummaryHtml += '<div class="issue-stats">';
        if (autoFixedCount > 0) {
          issueSummaryHtml += '<span class="issue-stat stat-success">' + autoFixedCount + ' sjálfvirkt lagfært</span>';
        }
        if (reviewIssues.length > 0) {
          issueSummaryHtml += '<span class="issue-stat stat-warning">' + reviewIssues.length + ' þarf yfirlestur</span>';
        }
        if (blockedIssues.length > 0) {
          issueSummaryHtml += '<span class="issue-stat stat-error">' + blockedIssues.length + ' vandamál lokað á</span>';
        }
        issueSummaryHtml += '</div>';
        if (pendingIssues.length > 0) {
          issueSummaryHtml += '<a href="/issues?sessionId=' + (data.sessionId || '') + '" class="btn btn-secondary btn-small" style="margin-top: 0.5rem;">Skoða atriði →</a>';
        }
        issueSummaryHtml += '</div>';
      }

      // Determine if proceed button should be enabled
      const canProceed = progress.complete || progress.expected === 0;

      // Check if blocked issues prevent proceeding
      const cannotProceedDueToIssues = blockedIssues.length > 0;
      const proceedDisabled = !canProceed || cannotProceedDueToIssues;
      const proceedTitle = cannotProceedDueToIssues
        ? 'Leystu vandamál fyrst'
        : (canProceed ? '' : 'Hladdu upp öllum skrám fyrst');

      contentEl.innerHTML =
        '<div class="alert alert-info">' +
        '<strong>Skref 2: Vélþýðing</strong>' +
        splitWarning +
        '<ol class="instructions-list">' +
        '<li>Farðu á <a href="https://malstadur.is" target="_blank">malstadur.is</a></li>' +
        '<li>Hladdu upp .md skránum (ein í einu)</li>' +
        '<li>Veldu enska → íslenska</li>' +
        '<li>Sæktu þýddu skrárnar</li>' +
        '<li>Hladdu þeim upp hér fyrir neðan</li>' +
        '</ol>' +
        progressSummary +
        issueSummaryHtml +
        checklistHtml +
        '<div class="upload-section"><h4>Hlaða upp þýddum .md skrám:</h4>' +
        '<form id="upload-form" class="upload-form">' +
        '<input type="file" name="file" id="upload-file" multiple accept=".md">' +
        '<button type="submit" class="btn btn-secondary">Hlaða upp</button>' +
        '</form>' +
        '<button id="proceed-btn" class="btn btn-primary btn-large" style="margin-top: 1rem;"' +
        (proceedDisabled ? ' disabled title="' + proceedTitle + '"' : '') +
        '>Halda áfram í næsta skref →</button>' +
        '</div></div>';

      setupUploadHandler(data, 'mt-upload');

      // Setup proceed button
      document.getElementById('proceed-btn')?.addEventListener('click', async () => {
        const btn = document.getElementById('proceed-btn');
        if (btn.disabled) {
          alert('Hladdu upp öllum þýddum skrám fyrst (' + progress.uploaded + '/' + progress.expected + ')');
          return;
        }
        try {
          btn.disabled = true;
          btn.textContent = 'Vinnur...';
          // Mark step complete and advance
          const res = await fetch('/api/workflow/' + data.sessionId + '/advance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ markComplete: true })
          });
          const result = await res.json();
          if (result.success || result.complete) {
            loadWorkflow(data.sessionId);
          } else {
            alert('Villa: ' + (result.message || result.error || 'Gat ekki haldið áfram'));
            btn.disabled = false;
            btn.textContent = 'Halda áfram í næsta skref →';
          }
        } catch (e) {
          alert('Villa: ' + e.message);
          btn.disabled = false;
          btn.textContent = 'Halda áfram í næsta skref →';
        }
      });
    }

    function showFaithfulEditStep(data, stepIndex) {
      const contentEl = document.getElementById('step-content');
      const sessionIssues = data.session?.issues || [];
      const pendingIssues = sessionIssues.filter(i => i.status === 'pending');

      let issuesList = '';
      if (pendingIssues.length > 0) {
        issuesList = '<div class="issue-summary"><h4>Atriði til yfirferðar:</h4>' +
          '<p>' + pendingIssues.length + ' atriði þarf að yfirfara</p>' +
          '<a href="/issues?sessionId=' + data.sessionId + '" class="btn btn-secondary btn-small">Opna atriðalista →</a>' +
          '</div>';
      }

      contentEl.innerHTML =
        '<div class="alert alert-info">' +
        '<strong>Skref ' + (stepIndex + 1) + ': 1. yfirferð (Trú þýðing)</strong>' +
        '<p class="step-desc">Málfarsyfirferð á vélþýðingu til að búa til trúa þýðingu.</p>' +
        '<ol class="instructions-list">' +
        '<li>Farðu yfir þýddu skrárnar í <a href="/editor?sessionId=' + data.sessionId + '" target="_blank">ritstjóranum</a></li>' +
        '<li>Leiðréttu málfarsvillur og samræmdu hugtök við <a href="/terminology" target="_blank">orðalista</a></li>' +
        '<li>Notaðu <strong>Ctrl+S</strong> til að vista breytingar</li>' +
        '<li>Þegar búið er, smelltu á "Halda áfram"</li>' +
        '</ol>' +
        issuesList +
        '<div class="action-buttons">' +
        '<a href="/editor?sessionId=' + data.sessionId + '" class="btn btn-secondary" target="_blank">Opna ritstjóra</a>' +
        '<button id="proceed-btn" class="btn btn-primary btn-large">Halda áfram í næsta skref →</button>' +
        '</div>' +
        '</div>';

      setupProceedButton(data);
    }

    function showTMCreationStep(data, stepIndex) {
      const contentEl = document.getElementById('step-content');

      contentEl.innerHTML =
        '<div class="alert alert-info">' +
        '<strong>Skref ' + (stepIndex + 1) + ': Þýðingaminni (TM)</strong>' +
        '<p class="step-desc">Búa til þýðingaminni úr trúrri þýðingu með Matecat Align.</p>' +
        '<ol class="instructions-list">' +
        '<li>Opnaðu <a href="https://matecat.com/align" target="_blank">Matecat Align</a></li>' +
        '<li>Hladdu upp ensku og íslensku skránum</li>' +
        '<li>Samræmdu setningar sem þarf</li>' +
        '<li>Fluttu út TMX skrá</li>' +
        '<li>Hladdu TMX skránni upp hér</li>' +
        '</ol>' +
        '<div class="upload-section">' +
        '<h4>Hlaða upp TMX skrá:</h4>' +
        '<form id="upload-form" class="upload-form">' +
        '<input type="file" name="file" id="upload-file" accept=".tmx">' +
        '<button type="submit" class="btn btn-secondary">Hlaða upp</button>' +
        '</form>' +
        '<button id="proceed-btn" class="btn btn-primary btn-large" style="margin-top: 1rem;">Halda áfram (sleppa TM)</button>' +
        '</div>' +
        '</div>';

      setupUploadHandler(data, 'tm-creation');
      setupProceedButton(data);
    }

    function showLocalizationStep(data, stepIndex) {
      const contentEl = document.getElementById('step-content');
      const sessionIssues = data.session?.issues || [];
      const localizationIssues = sessionIssues.filter(i => i.category === 'BOARD_REVIEW' && i.status === 'pending');

      let issuesList = '';
      if (localizationIssues.length > 0) {
        issuesList = '<div class="issue-summary"><h4>Staðfærsluatriði:</h4>' +
          '<p>' + localizationIssues.length + ' atriði til að staðfæra</p>' +
          '<a href="/localization-review?sessionId=' + data.sessionId + '" class="btn btn-secondary btn-small">Opna staðfærsluyfirlit →</a>' +
          '</div>';
      }

      contentEl.innerHTML =
        '<div class="alert alert-info">' +
        '<strong>Skref ' + (stepIndex + 1) + ': Staðfærsla</strong>' +
        '<p class="step-desc">Aðlaga efni fyrir íslenskt samhengi og nemendur.</p>' +
        '<ol class="instructions-list">' +
        '<li>Farðu yfir staðfærsluatriði</li>' +
        '<li>Umbreyttu einingum (mílu→km, Fahrenheit→Celsius)</li>' +
        '<li>Settu inn íslensk dæmi þar sem við á</li>' +
        '<li>Vistaðu breytingar</li>' +
        '</ol>' +
        issuesList +
        '<div class="action-buttons">' +
        '<a href="/localization-review?sessionId=' + data.sessionId + '" class="btn btn-secondary" target="_blank">Opna staðfærsluyfirlit</a>' +
        '<button id="proceed-btn" class="btn btn-primary btn-large">Halda áfram í næsta skref →</button>' +
        '</div>' +
        '</div>';

      setupProceedButton(data);
    }

    function setupProceedButton(data) {
      document.getElementById('proceed-btn')?.addEventListener('click', async () => {
        const btn = document.getElementById('proceed-btn');
        try {
          btn.disabled = true;
          btn.textContent = 'Vinnur...';
          const res = await fetch('/api/workflow/' + data.sessionId + '/advance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ markComplete: true })
          });
          const result = await res.json();
          if (result.success || result.complete) {
            loadWorkflow(data.sessionId);
          } else {
            alert('Villa: ' + (result.message || result.error || 'Gat ekki haldið áfram'));
            btn.disabled = false;
            btn.textContent = 'Halda áfram í næsta skref →';
          }
        } catch (e) {
          alert('Villa: ' + e.message);
          btn.disabled = false;
          btn.textContent = 'Halda áfram í næsta skref →';
        }
      });
    }

    function setupUploadHandler(data, stepId) {
      const uploadFormEl = document.getElementById('upload-form');
      if (uploadFormEl && data.sessionId) {
        uploadFormEl.onsubmit = async (e) => {
          e.preventDefault();
          const files = document.getElementById('upload-file').files;
          if (!files.length) { alert('Veldu skrár til að hlaða upp'); return; }

          const btn = uploadFormEl.querySelector('button');
          btn.disabled = true;
          btn.textContent = 'Hleður upp...';

          let success = true;
          for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);
            try {
              const res = await fetch('/api/workflow/' + data.sessionId + '/upload/' + stepId, {
                method: 'POST',
                body: formData
              });
              const result = await res.json();
              if (!result.success) {
                alert('Villa: ' + (result.message || result.error));
                success = false;
              }
            } catch (err) {
              alert('Villa: ' + err.message);
              success = false;
            }
          }

          if (success) {
            alert(files.length + ' skrár hlaðið upp!');
            loadWorkflow(data.sessionId);
          } else {
            btn.disabled = false;
            btn.textContent = 'Hlaða upp og halda áfram';
          }
        };
      }
    }

    async function loadWorkflows() {
      try {
        const res = await fetch('/api/workflow/sessions');
        const data = await res.json();
        const el = document.getElementById('active-workflows');

        if (!data.sessions || data.sessions.length === 0) {
          el.innerHTML = '<p class="text-muted">Engin virk verkflæði</p>';
          return;
        }

        el.innerHTML = '<table class="table"><thead><tr><th>Bók</th><th>Kafli</th><th>Framvinda</th><th></th></tr></thead><tbody>' +
          data.sessions.map(s => '<tr><td>' + s.book + '</td><td>K. ' + s.chapter + '</td><td><div class="progress-bar"><div class="progress-bar-fill" style="width:' + s.progress + '%"></div></div></td><td><button class="btn btn-secondary" onclick="loadWorkflow(\'' + s.id + '\')">Skoða</button></td></tr>').join('') +
          '</tbody></table>';
      } catch (e) {
        document.getElementById('active-workflows').innerHTML = '<p class="text-error">Villa við að hlaða verkflæðum</p>';
      }
    }

    async function loadWorkflow(id) {
      const res = await fetch('/api/workflow/' + id);
      const data = await res.json();
      showWorkflow({
        ...data.session,
        sessionId: id,
        downloads: data.downloads,
        uploadProgress: data.uploadProgress,
        session: data.session  // Keep full session for file tracking
      });
    }

    // Auth check and init
    fetch('/api/auth/me').then(r => r.json()).then(data => {
      const el = document.getElementById('user-info');
      if (data.authenticated) {
        el.innerHTML = '<img src="' + data.user.avatar + '" alt=""><span>' + data.user.name + '</span>';
        loadBooks();
        loadWorkflows();
        initNotifications(data.user);
      } else {
        el.innerHTML = '<a href="/api/auth/login" class="btn btn-primary">Innskráning</a>';
        // Update form to show login required
        document.getElementById('book-select').innerHTML = '<option value="">Innskráning krafist</option>';
        document.getElementById('book-select').disabled = true;
        document.getElementById('chapter-select').disabled = true;
        document.getElementById('submit-btn').disabled = true;
      }
    });

    // Notification widget functions
    async function initNotifications(user) {
      // Show notification widget
      document.getElementById('notifications-widget').style.display = 'block';

      // Load pending review count for admins/head-editors
      if (['admin', 'head-editor'].includes(user.role)) {
        try {
          const res = await fetch('/api/reviews/count');
          const data = await res.json();
          const badge = document.getElementById('reviews-badge');
          if (data.count > 0) {
            badge.textContent = data.count;
            badge.style.display = 'inline';
          }
        } catch (e) { /* ignore */ }
      }

      // Load notifications
      await loadNotifications();

      // Setup notification button
      document.getElementById('notification-btn').addEventListener('click', toggleNotificationDropdown);
      document.getElementById('mark-all-read').addEventListener('click', markAllNotificationsRead);

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const widget = document.getElementById('notifications-widget');
        if (!widget.contains(e.target)) {
          document.getElementById('notification-dropdown').style.display = 'none';
        }
      });
    }

    async function loadNotifications() {
      try {
        const res = await fetch('/api/notifications?unread=true');
        const data = await res.json();

        // Update count
        const countEl = document.getElementById('notification-count');
        if (data.unreadCount > 0) {
          countEl.textContent = data.unreadCount;
          countEl.style.display = 'inline';
        } else {
          countEl.style.display = 'none';
        }

        // Update list
        const listEl = document.getElementById('notification-list');
        if (data.notifications.length === 0) {
          listEl.innerHTML = '<div class="notification-empty">Engar nýjar tilkynningar</div>';
        } else {
          listEl.innerHTML = data.notifications.map(n => {
            const date = new Date(n.createdAt).toLocaleString('is-IS');
            return '<div class="notification-item' + (n.read ? '' : ' unread') + '" data-id="' + n.id + '">' +
              '<div class="notification-title">' + escapeHtml(n.title) + '</div>' +
              '<div class="notification-message">' + escapeHtml(n.message).substring(0, 100) + '</div>' +
              '<div class="notification-date">' + date + '</div>' +
              (n.link ? '<a href="' + n.link + '" class="notification-link">Skoða</a>' : '') +
              '</div>';
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load notifications:', e);
      }
    }

    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notification-dropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    async function markAllNotificationsRead() {
      try {
        await fetch('/api/notifications/read-all', { method: 'POST' });
        await loadNotifications();
      } catch (e) {
        console.error('Failed to mark notifications as read:', e);
      }
    }
  </script>

  <script src="/js/theme.js"></script>
  <script src="/js/nav.js"></script>

  <style>
    /* Page-specific styles for workflow management */

    .container { max-width: 1000px; }
    .card { padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }

    .form-select:disabled { background: var(--gray-50); cursor: not-allowed; }

    /* Grid */
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }

    /* Chapter info */
    .chapter-info { background: var(--gray-50); border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem; }
    .chapter-info p { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .module-list { font-size: 0.75rem; color: var(--text-muted); list-style: none; max-height: 150px; overflow-y: auto; }
    .module-list li { padding: 0.25rem 0; }
    .module-list code { background: var(--gray-200); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem; }

    /* Workflow steps */
    .steps { display: flex; gap: 0.5rem; margin-bottom: 2rem; }
    .step { flex: 1; text-align: center; }
    .step-number { width: 2rem; height: 2rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem; background: var(--gray-200); }
    .step.complete .step-number { background: var(--success); color: white; }
    .step.active .step-number { background: var(--primary); color: white; }
    .step-label { font-size: 0.75rem; color: var(--text-muted); }

    /* Table */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }

    /* Actions */
    .actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .action-buttons { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }

    /* Downloads and uploads */
    .downloads { margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .downloads ul { list-style: none; display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .module-status { margin-bottom: 0.5rem; }
    .upload-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    .upload-section h4 { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .upload-form { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .upload-form input[type="file"] { flex: 1; min-width: 200px; }

    /* Step content */
    .step-desc { font-size: 0.875rem; margin: 0.5rem 0; opacity: 0.8; }
    .instructions { margin: 0.75rem 0; line-height: 1.8; }
    .instructions-list { margin: 1rem 0; padding-left: 1.5rem; }
    .instructions-list li { margin: 0.5rem 0; }
    .uploaded-count { color: var(--success); font-weight: 500; margin: 0.5rem 0; }
    .next-action { margin-top: 1rem; padding: 1.5rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid var(--primary); text-align: center; }
    .next-action p { margin-bottom: 1rem; }
    .btn-large { padding: 0.75rem 2rem; font-size: 1rem; }

    /* File checklist */
    .file-checklist { margin: 1rem 0; padding: 1rem; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .file-checklist h4 { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .checklist { list-style: none; margin: 0; padding: 0; }
    .checklist-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0; font-size: 0.875rem; border-bottom: 1px solid var(--gray-50); }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-item.uploaded { color: var(--success); }
    .checklist-item.pending { color: var(--text-muted); }
    .check-icon { width: 1.25rem; text-align: center; font-weight: bold; }
    .checklist-item.uploaded .check-icon { color: var(--success); }
    .progress-summary { margin: 0.75rem 0; padding: 0.75rem; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .text-success { color: var(--success); }
    .file-names { display: block; margin-top: 0.25rem; color: var(--text-muted); }
    .file-names code { background: var(--gray-200); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem; }
    .file-info { flex: 1; }

    /* Warning alert */
    .alert-warning h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .existing-session-info { margin: 1rem 0; padding: 0.75rem; background: rgba(255,255,255,0.5); border-radius: 0.25rem; }
    .existing-session-info p { margin: 0.25rem 0; font-size: 0.875rem; }
    .dialog-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }

    /* Issue summary */
    .issue-summary { margin: 1rem 0; padding: 1rem; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .issue-summary h4 { font-size: 0.875rem; margin-bottom: 0.5rem; color: var(--text-secondary); }
    .issue-stats { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .issue-stat { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .stat-success { background: var(--success-light); color: #166534; }
    .stat-warning { background: var(--warning-light); color: #92400e; }
    .stat-error { background: var(--error-light); color: #991b1b; }
    .btn-small { padding: 0.25rem 0.75rem; font-size: 0.75rem; }

    /* Nav badge */
    .nav-badge { background: var(--error); color: white; font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 9999px; font-weight: 600; margin-left: 0.25rem; }

    /* Notification widget */
    .notifications { position: relative; }
    .notification-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; color: var(--text-secondary); position: relative; }
    .notification-btn:hover { background: var(--gray-100); }
    .notification-count { position: absolute; top: 0; right: 0; background: var(--error); color: white; font-size: 0.625rem; min-width: 1rem; height: 1rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
    .notification-dropdown { position: absolute; top: 100%; right: 0; width: 320px; background: var(--bg-card); border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 1000; margin-top: 0.5rem; }
    .dropdown-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); }
    .dropdown-header span { font-weight: 600; font-size: 0.875rem; }
    .mark-all-read { background: none; border: none; color: var(--primary); font-size: 0.75rem; cursor: pointer; }
    .notification-list { max-height: 300px; overflow-y: auto; }
    .notification-item { padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); }
    .notification-item.unread { background: var(--primary-light); }
    .notification-item:last-child { border-bottom: none; }
    .notification-title { font-weight: 500; font-size: 0.875rem; margin-bottom: 0.25rem; }
    .notification-message { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .notification-date { font-size: 0.625rem; color: var(--text-muted); }
    .notification-link { font-size: 0.75rem; color: var(--primary); }
    .notification-empty { padding: 2rem; text-align: center; color: var(--text-muted); font-size: 0.875rem; }

    /* Chapter files section */
    .chapter-files {
      background: var(--gray-50);
      border-radius: 0.375rem;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
    }
    .chapter-files h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text-secondary);
    }
    .files-available, .files-missing {
      font-size: 0.875rem;
    }
    .section-list {
      list-style: none;
      margin: 0.5rem 0;
      padding: 0;
      max-height: 120px;
      overflow-y: auto;
      font-size: 0.75rem;
    }
    .section-list li {
      padding: 0.25rem 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .section-list li:last-child {
      border-bottom: none;
    }
    .section-list code {
      background: var(--gray-200);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
    }
    .files-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    /* Import dialog */
    .import-dialog {
      padding: 0.5rem 0;
    }
    .import-dialog h5 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .import-form {
      margin-top: 0.75rem;
    }
    .import-form input[type="file"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px dashed var(--border-color);
      border-radius: 0.375rem;
      background: var(--bg-card);
      margin-bottom: 0.75rem;
    }
    .import-actions {
      display: flex;
      gap: 0.5rem;
    }

    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } .notification-dropdown { width: 280px; right: -1rem; } }
  </style>
</body>
</html>
