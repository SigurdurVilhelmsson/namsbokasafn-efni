<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verkfl√¶√∞i - N√°msb√≥kasafn</title>
  <link rel="stylesheet" href="/css/common.css">
</head>
<body>
  <header class="header">
    <h1>N√°msb√≥kasafn</h1>
    <nav>
      <a href="/my-work">M√≠n verkefni</a>
      <a href="/workflow">Verkfl√¶√∞i</a>
      <a href="/status">Stj√≥rnbor√∞</a>
      <a href="/editor">Ritstj√≥ri</a>
      <a href="/terminology">Or√∞asafn</a>
      <a href="/decisions">√Åkvar√∞anir</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stj√≥rnbor√∞</a>
      <a href="/admin" class="admin-only admin-link">Stj√≥rnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um √æema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="notifications" id="notifications-widget" style="display: none;">
        <button class="notification-btn" id="notification-btn" title="Tilkynningar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span class="notification-count" id="notification-count" style="display: none;">0</span>
        </button>
        <div class="notification-dropdown" id="notification-dropdown" style="display: none;">
          <div class="dropdown-header">
            <span>Tilkynningar</span>
            <button class="mark-all-read" id="mark-all-read">Merkja allt lesi√∞</button>
          </div>
          <div class="notification-list" id="notification-list"></div>
        </div>
      </div>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <div class="card" id="start-workflow">
      <h2 class="card-title">Hefja n√Ωtt verkfl√¶√∞i</h2>
      <form id="workflow-form">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">B√≥k</label>
            <select class="form-select" name="book" id="book-select" required>
              <option value="">Hle√∞ur...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Kafli</label>
            <select class="form-select" name="chapter" id="chapter-select" required disabled>
              <option value="">Veldu b√≥k fyrst...</option>
            </select>
          </div>
        </div>
        <div id="chapter-info" class="chapter-info" style="display: none;">
          <p><strong>Kafli inniheldur:</strong> <span id="module-count">0</span> einingar</p>
          <ul id="module-list" class="module-list"></ul>
        </div>

        <!-- Permanent chapter files section -->
        <div id="chapter-files" class="chapter-files" style="display: none;">
          <h4>Skr√°r kafla</h4>
          <div id="files-loading" style="display: none;">
            <p class="text-muted">Hle√∞ur...</p>
          </div>
          <div id="files-status"></div>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn" disabled>Hefja verkfl√¶√∞i</button>
      </form>
    </div>

    <div class="card">
      <h2 class="card-title">Virk verkfl√¶√∞i</h2>
      <div id="active-workflows"><p class="text-muted">Hle√∞ur...</p></div>
    </div>

    <div class="card" id="workflow-detail" style="display: none;">
      <h2 class="card-title"><span id="detail-title"></span></h2>
      <div class="steps" id="workflow-steps"></div>
      <div id="step-content"></div>
      <div id="step-actions" class="actions"></div>
    </div>
  </main>

  <!-- Overwrite Confirmation Modal -->
  <div id="overwrite-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeOverwriteModal()"></div>
    <div class="modal-content">
      <h3 id="modal-title">Sta√∞festa birtingu</h3>
      <p id="modal-description"></p>
      <div id="overwrite-list-container" style="display: none;">
        <p class="text-warning"><strong>Eftirfarandi skr√°r ver√∞a yfirskrifa√∞ar:</strong></p>
        <ul id="overwrite-list" class="overwrite-list"></ul>
      </div>
      <div id="create-list-container" style="display: none;">
        <p class="text-muted"><strong>N√Ωjar skr√°r:</strong></p>
        <ul id="create-list" class="create-list"></ul>
      </div>
      <div id="modal-warning" class="modal-warning" style="display: none;"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeOverwriteModal()">H√¶tta vi√∞</button>
        <button class="btn btn-primary" id="confirm-publish-btn">Birta</button>
      </div>
    </div>
  </div>

  <script>
    let booksData = {};
    let selectedChapter = null;
    let currentUser = null;  // Track logged-in user for role checks

    // Load books on page load
    async function loadBooks() {
      try {
        const res = await fetch('/api/books');
        const data = await res.json();
        const select = document.getElementById('book-select');
        select.innerHTML = '<option value="">Veldu b√≥k...</option>' +
          data.books.map(b => '<option value="' + b.id + '">' + b.titleIs + ' (' + b.title + ')</option>').join('');
      } catch (e) {
        document.getElementById('book-select').innerHTML = '<option value="">Villa vi√∞ a√∞ hla√∞a b√≥kum</option>';
      }
    }

    // Load chapters when book is selected
    async function loadChapters(bookId) {
      const chapterSelect = document.getElementById('chapter-select');
      const submitBtn = document.getElementById('submit-btn');
      const chapterInfo = document.getElementById('chapter-info');

      if (!bookId) {
        chapterSelect.innerHTML = '<option value="">Veldu b√≥k fyrst...</option>';
        chapterSelect.disabled = true;
        submitBtn.disabled = true;
        chapterInfo.style.display = 'none';
        return;
      }

      chapterSelect.innerHTML = '<option value="">Hle√∞ur...</option>';
      chapterSelect.disabled = true;

      try {
        const res = await fetch('/api/books/' + bookId);
        const data = await res.json();
        booksData[bookId] = data;

        // Build chapter options
        let options = '<option value="">Veldu kafla...</option>';

        // Regular chapters
        options += data.chapters.map(c =>
          '<option value="' + c.chapter + '">Kafli ' + c.chapter + ': ' + (c.titleIs || c.title) + '</option>'
        ).join('');

        // Appendices (if any)
        if (data.appendices && data.appendices.length > 0) {
          options += '<optgroup label="Vi√∞aukar">';
          options += data.appendices.map((a, i) =>
            '<option value="appendix-' + (i + 1) + '" data-appendix-id="' + a.id + '">Vi√∞auki ' + String.fromCharCode(65 + i) + ': ' + (a.titleIs || a.title) + '</option>'
          ).join('');
          options += '</optgroup>';
        }

        chapterSelect.innerHTML = options;
        chapterSelect.disabled = false;
        chapterInfo.style.display = 'none';
      } catch (e) {
        chapterSelect.innerHTML = '<option value="">Villa vi√∞ a√∞ hla√∞a k√∂flum</option>';
      }
    }

    // Show chapter details when chapter is selected
    function showChapterInfo(bookId, chapterNum) {
      const chapterInfo = document.getElementById('chapter-info');
      const chapterFiles = document.getElementById('chapter-files');
      const submitBtn = document.getElementById('submit-btn');

      if (!chapterNum || !booksData[bookId]) {
        chapterInfo.style.display = 'none';
        chapterFiles.style.display = 'none';
        submitBtn.disabled = true;
        selectedChapter = null;
        return;
      }

      // Check if it's an appendix
      if (String(chapterNum).startsWith('appendix-')) {
        const appendixIndex = parseInt(chapterNum.replace('appendix-', ''), 10) - 1;
        const appendices = booksData[bookId].appendices || [];
        const appendix = appendices[appendixIndex];

        if (!appendix) {
          chapterInfo.style.display = 'none';
          chapterFiles.style.display = 'none';
          submitBtn.disabled = true;
          return;
        }

        // Create a chapter-like object for the appendix
        selectedChapter = {
          chapter: chapterNum,
          title: appendix.title,
          titleIs: appendix.titleIs,
          isAppendix: true,
          appendixLetter: String.fromCharCode(65 + appendixIndex),
          modules: [{
            id: appendix.id,
            section: 'appendix-' + String.fromCharCode(65 + appendixIndex).toLowerCase(),
            title: appendix.title,
            titleIs: appendix.titleIs
          }]
        };

        document.getElementById('module-count').textContent = '1 (vi√∞auki)';
        document.getElementById('module-list').innerHTML =
          '<li><code>' + appendix.id + '</code> - Vi√∞auki ' + selectedChapter.appendixLetter + ': ' + appendix.title + '</li>';
        chapterInfo.style.display = 'block';
        submitBtn.disabled = false;

        // Load files for appendix (use chapter 0 or special appendix path)
        loadChapterFiles(bookId, chapterNum);
        checkWorkflowProgress(bookId, chapterNum);
        return;
      }

      // Regular chapter
      const chapter = booksData[bookId].chapters.find(c => c.chapter === parseInt(chapterNum, 10));
      if (!chapter) {
        chapterInfo.style.display = 'none';
        chapterFiles.style.display = 'none';
        submitBtn.disabled = true;
        return;
      }

      selectedChapter = chapter;
      document.getElementById('module-count').textContent = chapter.modules.length;
      document.getElementById('module-list').innerHTML = chapter.modules.map(m =>
        '<li><code>' + m.id + '</code> - ' + m.section + ': ' + m.title + '</li>'
      ).join('');
      chapterInfo.style.display = 'block';
      submitBtn.disabled = false;

      // Load chapter files status and check for workflow progress
      loadChapterFiles(bookId, chapterNum);
      checkWorkflowProgress(bookId, chapterNum);
    }

    // Check for existing workflow progress
    async function checkWorkflowProgress(bookId, chapterNum) {
      try {
        const res = await fetch('/api/workflow/check/' + bookId + '/' + chapterNum);
        if (!res.ok) return;

        const data = await res.json();

        // Update submit button based on progress
        const submitBtn = document.getElementById('submit-btn');
        const chapterInfo = document.getElementById('chapter-info');

        // If there's an active session, show join option
        if (data.activeSession) {
          let progressHtml = '<div class="workflow-progress active-session">' +
            '<p class="text-info"><strong>‚ö° Virkt verkfl√¶√∞i</strong></p>' +
            '<p class="text-muted">Byrja√∞ af ' + escapeHtml(data.activeSession.startedBy) +
            ' - ' + escapeHtml(data.activeSession.currentStep) + '</p>' +
            '<div class="progress-actions">' +
            '<button type="button" class="btn btn-primary btn-small" onclick="loadWorkflow(\'' + data.activeSession.id + '\')">Sko√∞a verkfl√¶√∞i</button>' +
            '</div></div>';

          // Prepend to chapter info
          const existingProgress = chapterInfo.querySelector('.workflow-progress');
          if (existingProgress) existingProgress.remove();
          chapterInfo.insertAdjacentHTML('afterbegin', progressHtml);

          submitBtn.textContent = 'Hefja n√Ωtt (√≥h√°√∞)';
          return;
        }

        // If there's resumable progress, show resume option
        if (data.hasProgress && data.progress.canResume) {
          const stepNames = {
            'source': 'Undirb√∫ningur',
            'mt-upload': 'V√©l√æ√Ω√∞ing',
            'faithful-edit': '1. yfirfer√∞',
            'tm-creation': '√û√Ω√∞ingaminni',
            'localization': 'Sta√∞f√¶rsla'
          };

          const completedNames = data.progress.completedSteps.map(s => stepNames[s] || s).join(', ');
          const resumeStepName = stepNames[data.progress.resumeStep] || data.progress.resumeStep;

          let progressHtml = '<div class="workflow-progress resumable">' +
            '<p class="text-success"><strong>‚úì Framvinda til sta√∞ar</strong></p>' +
            '<p class="text-muted">Loki√∞: ' + escapeHtml(completedNames) + '</p>' +
            '<p class="text-muted">N√¶sta skref: ' + escapeHtml(resumeStepName) + '</p>';

          // Show completed step downloads
          if (data.downloads && Object.keys(data.downloads).length > 0) {
            progressHtml += '<div class="completed-downloads">';
            for (const [step, info] of Object.entries(data.downloads)) {
              if (info.fileCount > 0) {
                progressHtml += '<span class="download-badge">' +
                  escapeHtml(stepNames[step] || step) + ': ' + info.fileCount + ' skr√°r</span>';
              }
            }
            progressHtml += '</div>';
          }

          progressHtml += '<div class="progress-actions">' +
            '<button type="button" class="btn btn-primary btn-small" onclick="resumeWorkflow(\'' + bookId + '\', ' + chapterNum + ')">Halda √°fram ‚Üí</button>' +
            '<button type="button" class="btn btn-secondary btn-small" onclick="startFreshWorkflow()">Byrja upp √° n√Ωtt</button>' +
            '</div></div>';

          // Prepend to chapter info
          const existingProgress = chapterInfo.querySelector('.workflow-progress');
          if (existingProgress) existingProgress.remove();
          chapterInfo.insertAdjacentHTML('afterbegin', progressHtml);

          // Update submit button
          submitBtn.textContent = 'Byrja upp √° n√Ωtt';
        } else {
          // No progress - remove any existing progress UI
          const existingProgress = chapterInfo.querySelector('.workflow-progress');
          if (existingProgress) existingProgress.remove();
          submitBtn.textContent = 'Hefja verkfl√¶√∞i';
        }

      } catch (e) {
        console.error('Error checking workflow progress:', e);
      }
    }

    // Resume workflow from existing progress
    async function resumeWorkflow(bookId, chapterNum) {
      if (!selectedChapter) {
        alert('Enginn kafli valinn');
        return;
      }

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Hle√∞ur...';

      try {
        const res = await fetch('/api/workflow/resume', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            book: bookId,
            chapter: parseInt(chapterNum, 10),
            modules: selectedChapter.modules.map(m => ({
              id: m.id,
              section: m.section,
              title: m.title
            }))
          })
        });

        const result = await res.json();
        if (result.success) {
          showWorkflow(result);
          loadWorkflows();
        } else {
          alert('Villa: ' + (result.message || result.error));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Hefja verkfl√¶√∞i';
      }
    }

    // Start fresh workflow (used when progress exists but user wants to restart)
    function startFreshWorkflow() {
      const progressEl = document.querySelector('.workflow-progress');
      if (progressEl) progressEl.remove();

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.textContent = 'Hefja verkfl√¶√∞i';
    }

    // Load chapter files status (permanent storage)
    async function loadChapterFiles(bookId, chapterNum) {
      const filesEl = document.getElementById('chapter-files');
      const loadingEl = document.getElementById('files-loading');
      const statusEl = document.getElementById('files-status');

      filesEl.style.display = 'block';
      loadingEl.style.display = 'block';
      statusEl.innerHTML = '';

      try {
        const res = await fetch('/api/books/' + bookId + '/chapters/' + chapterNum + '/files');
        loadingEl.style.display = 'none';

        if (!res.ok) {
          statusEl.innerHTML = '<p class="text-muted">Engar skr√°r fundust</p>';
          return;
        }

        const data = await res.json();

        if (data.hasRequiredFiles && data.sections && data.sections.length > 0) {
          // Files exist - show download option
          let html = '<div class="files-available">' +
            '<p class="text-success"><strong>‚úì Skr√°r til sta√∞ar</strong></p>' +
            '<p class="text-muted">' + data.sections.length + ' einingar me√∞ skr√°r</p>';

          // Show sections list
          html += '<ul class="section-list">';
          for (const section of data.sections) {
            const fileTypes = section.files.map(f => f.type).join(', ');
            html += '<li><code>' + escapeHtml(section.section) + '</code> - ' +
              section.files.length + ' skr√°r (' + fileTypes + ')</li>';
          }
          html += '</ul>';

          // Recent history
          if (data.recentHistory && data.recentHistory.length > 0) {
            const lastGen = data.recentHistory.find(h => h.action === 'files_generated' || h.action === 'file_generated');
            if (lastGen) {
              const date = new Date(lastGen.created_at).toLocaleString('is-IS');
              html += '<p class="text-muted" style="font-size: 0.75rem;">S√≠√∞ast b√∫i√∞ til: ' + date + '</p>';
            }
          }

          // Actions
          html += '<div class="files-actions">' +
            '<a href="/api/books/' + bookId + '/download?chapter=' + chapterNum + '&type=en-md" class="btn btn-secondary btn-small">S√¶kja EN .md</a>' +
            '<button type="button" class="btn btn-small" onclick="scanChapterFiles(\'' + bookId + '\', ' + chapterNum + ')">Endurskanna</button>' +
            '</div>';

          html += '</div>';
          statusEl.innerHTML = html;
        } else {
          // No files - offer to generate, scan, or import
          let html = '<div class="files-missing">' +
            '<p class="text-muted">Engar skr√°r fundust fyrir √æennan kafla.</p>' +
            '<div class="files-actions">' +
            '<button type="button" class="btn btn-primary btn-small" onclick="generateFromSource(\'' + bookId + '\', ' + chapterNum + ')"><i class="fas fa-cog"></i> B√∫a til √∫r uppruna</button>' +
            '<button type="button" class="btn btn-secondary btn-small" onclick="scanChapterFiles(\'' + bookId + '\', ' + chapterNum + ')">Leita a√∞ skr√°m</button>' +
            '<button type="button" class="btn btn-small" onclick="showImportDialog(\'' + bookId + '\', ' + chapterNum + ')">Flytja inn</button>' +
            '</div>' +
            '</div>';
          statusEl.innerHTML = html;
        }
      } catch (e) {
        loadingEl.style.display = 'none';
        statusEl.innerHTML = '<p class="text-muted">Gat ekki hla√∞i√∞ skr√°st√∂√∞u</p>';
      }
    }

    // Generate files from source using pipeline-runner
    async function generateFromSource(bookId, chapterNum) {
      if (!confirm('√ûetta mun b√∫a til .md skr√°r √∫r CNXML uppruna. √ûetta getur teki√∞ nokkrar sek√∫ndur. Halda √°fram?')) {
        return;
      }

      const statusEl = document.getElementById('files-status');
      statusEl.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> B√Ωr til skr√°r √∫r uppruna...</p>';

      try {
        const res = await fetch('/api/books/' + bookId + '/chapters/' + chapterNum + '/generate', {
          method: 'POST'
        });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || data.message || 'Generation failed');
        }

        if (data.success) {
          alert(data.filesGenerated + ' skr√°r b√∫nar til fyrir kafla ' + chapterNum);
          loadChapterFiles(bookId, chapterNum);
        } else {
          throw new Error(data.error || 'Generation failed');
        }
      } catch (err) {
        alert('Villa vi√∞ a√∞ b√∫a til skr√°r: ' + err.message);
        loadChapterFiles(bookId, chapterNum);
      }
    }

    // Scan for existing files on disk
    async function scanChapterFiles(bookId, chapterNum) {
      try {
        const res = await fetch('/api/books/' + bookId + '/chapters/' + chapterNum + '/files/scan', {
          method: 'POST'
        });
        const data = await res.json();
        if (data.success) {
          alert('Sk√∂nnun loki√∞: ' + data.found + ' skr√°r fundnar, ' + data.registered + ' skr√°√∞ar.');
          loadChapterFiles(bookId, chapterNum);
        } else {
          alert('Villa vi√∞ sk√∂nnun: ' + (data.message || data.error));
        }
      } catch (e) {
        alert('Villa: ' + e.message);
      }
    }

    // Show import dialog for chapter files
    let importBookId = null;
    let importChapterNum = null;

    function showImportDialog(bookId, chapterNum) {
      importBookId = bookId;
      importChapterNum = chapterNum;

      const statusEl = document.getElementById('files-status');
      statusEl.innerHTML = '<div class="import-dialog">' +
        '<h5>Flytja inn .md skr√°r</h5>' +
        '<p class="text-muted" style="font-size: 0.8125rem;">Veldu .en.md skr√°r sem b√∫nar voru til me√∞ CLI verkf√¶rum.</p>' +
        '<form id="import-form" class="import-form">' +
        '<input type="file" id="import-files" name="files" multiple accept=".md" required>' +
        '<div class="import-actions">' +
        '<button type="submit" class="btn btn-primary btn-small">Flytja inn</button>' +
        '<button type="button" class="btn btn-secondary btn-small" onclick="loadChapterFiles(\'' + bookId + '\', ' + chapterNum + ')">H√¶tta vi√∞</button>' +
        '</div>' +
        '</form>' +
        '</div>';

      // Setup form handler
      document.getElementById('import-form').addEventListener('submit', handleImport);
    }

    async function handleImport(e) {
      e.preventDefault();

      const files = document.getElementById('import-files').files;
      if (!files.length) {
        alert('Veldu skr√°r til a√∞ flytja inn');
        return;
      }

      const formData = new FormData();
      for (const file of files) {
        formData.append('files', file);
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Flytur inn...';

      try {
        const res = await fetch('/api/books/' + importBookId + '/chapters/' + importChapterNum + '/import', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          let msg = 'Innflutningur loki√∞: ' + data.imported + ' skr√°r fluttar inn.';
          if (data.errors && data.errors.length > 0) {
            msg += '\n\nVillur:\n' + data.errors.map(e => e.file + ': ' + e.error).join('\n');
          }
          alert(msg);
          loadChapterFiles(importBookId, importChapterNum);
        } else {
          alert('Villa: ' + (data.message || data.error));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Flytja inn';
      }
    }

    // Event listeners
    document.getElementById('book-select').addEventListener('change', (e) => {
      loadChapters(e.target.value);
    });

    document.getElementById('chapter-select').addEventListener('change', (e) => {
      const bookId = document.getElementById('book-select').value;
      showChapterInfo(bookId, e.target.value);
    });

    document.getElementById('workflow-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = document.getElementById('submit-btn');
      const data = {
        book: form.book.value,
        chapter: parseInt(form.chapter.value, 10),
        modules: selectedChapter ? selectedChapter.modules.map(m => ({
          id: m.id,
          section: m.section,
          title: m.title
        })) : []
      };

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Vinnur √≠ ' + data.modules.length + ' einingum...';

      try {
        const res = await fetch('/api/workflow/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.success) {
          showWorkflow(result);
          loadWorkflows();
          // Reset form
          form.reset();
          document.getElementById('chapter-info').style.display = 'none';
        } else if (res.status === 409 && result.existingSession) {
          // Workflow already exists - offer to join
          showExistingWorkflowDialog(result);
        } else {
          alert('Villa: ' + (result.message || result.error));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Hefja verkfl√¶√∞i';
      }
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Toggle file checklist expand/collapse
    function toggleChecklist() {
      const checklist = document.getElementById('file-checklist');
      if (checklist) {
        checklist.classList.toggle('collapsed');
      }
    }

    function showExistingWorkflowDialog(result) {
      const existing = result.existingSession;
      const progressText = existing.progress
        ? `${existing.progress.uploaded}/${existing.progress.expected} skr√°r hla√∞i√∞ upp`
        : '';

      const contentEl = document.getElementById('step-content');
      contentEl.innerHTML = '';

      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-warning';

      const h3 = document.createElement('h3');
      h3.textContent = 'Verkfl√¶√∞i √æegar til sta√∞ar';
      alertDiv.appendChild(h3);

      const msgP = document.createElement('p');
      msgP.textContent = result.message;
      alertDiv.appendChild(msgP);

      const infoDiv = document.createElement('div');
      infoDiv.className = 'existing-session-info';
      infoDiv.innerHTML = `
        <p><strong>Byrja√∞ af:</strong> ${escapeHtml(existing.startedBy || '√ì√æekktur')}</p>
        <p><strong>N√∫verandi skref:</strong> ${escapeHtml(existing.currentStep || '')}</p>
        ${progressText ? `<p><strong>Framvinda:</strong> ${escapeHtml(progressText)}</p>` : ''}
        <p><strong>Byrja√∞:</strong> ${escapeHtml(new Date(existing.startedAt).toLocaleString('is-IS'))}</p>
      `;
      alertDiv.appendChild(infoDiv);

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'dialog-actions';

      const joinBtn = document.createElement('button');
      joinBtn.className = 'btn btn-primary';
      joinBtn.textContent = 'Sko√∞a verkfl√¶√∞i';
      joinBtn.addEventListener('click', () => loadWorkflow(existing.id));
      actionsDiv.appendChild(joinBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-danger';
      deleteBtn.textContent = 'Ey√∞a og byrja aftur';
      deleteBtn.addEventListener('click', () => deleteExistingSession(existing.id));
      actionsDiv.appendChild(deleteBtn);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = 'H√¶tta vi√∞';
      cancelBtn.addEventListener('click', closeExistingDialog);
      actionsDiv.appendChild(cancelBtn);

      alertDiv.appendChild(actionsDiv);
      contentEl.appendChild(alertDiv);

      document.getElementById('workflow-detail').style.display = 'block';
      document.getElementById('detail-title').textContent = 'Verkfl√¶√∞i √æegar til';
      document.getElementById('workflow-steps').innerHTML = '';
      document.getElementById('step-actions').innerHTML = '';
    }

    async function deleteExistingSession(sessionId) {
      if (!confirm('Ertu viss um a√∞ √æ√∫ viljir ey√∞a √æessu verkfl√¶√∞i? √ñll g√∂gn munu tapast.')) {
        return;
      }

      try {
        const res = await fetch('/api/workflow/' + sessionId, {
          method: 'DELETE'
        });
        const result = await res.json();

        if (result.success) {
          alert('Verkfl√¶√∞i eytt. √û√∫ getur n√∫ byrja√∞ n√Ωtt verkfl√¶√∞i.');
          closeExistingDialog();
          // Refresh the workflows list
          loadWorkflows();
        } else {
          alert('Villa: ' + (result.message || result.error));
        }
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    function closeExistingDialog() {
      document.getElementById('workflow-detail').style.display = 'none';
    }

    async function showWorkflow(data) {
      document.getElementById('workflow-detail').style.display = 'block';
      document.getElementById('detail-title').textContent = data.book + ' - Kafli ' + data.chapter;

      const stepsEl = document.getElementById('workflow-steps');
      stepsEl.innerHTML = data.steps.map((step, i) => {
        const cls = step.status === 'completed' ? 'complete' : step.status === 'in-progress' ? 'active' : 'pending';
        return '<div class="step ' + cls + '"><div class="step-number">' + (i + 1) + '</div><div class="step-label">' + step.name + '</div></div>';
      }).join('');

      // Handle currentStep being either an index (number) or step object
      let current;
      if (typeof data.currentStep === 'number') {
        current = data.steps[data.currentStep];
      } else if (data.currentStep && data.currentStep.id) {
        current = data.currentStep;
      } else {
        current = data.steps[0];
      }

      const contentEl = document.getElementById('step-content');
      const actionsEl = document.getElementById('step-actions');

      // Show module processing results if available
      let moduleInfo = '';
      if (data.modulesProcessed !== undefined) {
        moduleInfo = '<p class="module-status"><strong>Einingar:</strong> ' + data.modulesProcessed + ' af ' + data.modulesTotal + ' unnar</p>';
        if (data.errors && data.errors.length > 0) {
          moduleInfo += '<p class="text-error">Villur: ' + data.errors.map(e => e.moduleId).join(', ') + '</p>';
        }
      }

      const stepIndex = data.steps.findIndex(s => s.id === current.id);
      const hasDownloads = data.downloads && Object.keys(data.downloads).length > 0;

      // Count file types
      let mdCount = 0, xliffCount = 0;
      if (data.downloads) {
        for (const type of Object.keys(data.downloads)) {
          if (type.includes('markdown')) mdCount++;
          if (type.includes('xliff')) xliffCount++;
        }
      }

      // Step-specific content
      if (current.id === 'source' || (stepIndex === 0 && current.status === 'completed')) {
        // Source step completed - show download button and git commit option
        const isAdmin = currentUser?.role === 'admin';
        const gitCommitButton = isAdmin
          ? '<button id="git-commit-btn" class="btn btn-secondary" title="Vista skr√°r √≠ GitHub">Vista √≠ GitHub</button>'
          : '';

        contentEl.innerHTML =
          '<div class="alert alert-success">' + moduleInfo +
          '<strong>Skref 1: Undirb√∫ningur - Loki√∞</strong>' +
          '<p>' + mdCount + ' .md skr√°r og ' + xliffCount + ' .xliff skr√°r tilb√∫nar.</p>' +
          '</div>' +
          '<div class="next-action">' +
          '<p>S√¶ktu .md skr√°rnar og √æ√Ωddu √æ√¶r √° <a href="https://malstadur.is" target="_blank">malstadur.is</a> (Erlendur MT)</p>' +
          '<div class="step-action-buttons">' +
          '<button id="download-proceed" class="btn btn-primary btn-large">S√¶kja .md skr√°r og halda √°fram ‚Üí</button>' +
          gitCommitButton +
          '</div>' +
          '</div>';

        document.getElementById('download-proceed')?.addEventListener('click', async () => {
          // Download only MD files as ZIP
          if (data.sessionId) {
            window.open('/api/workflow/' + data.sessionId + '/download-all?filter=md', '_blank');
          }

          // Advance workflow to next step
          try {
            const advRes = await fetch('/api/workflow/' + data.sessionId + '/advance', { method: 'POST' });
            const advResult = await advRes.json();
            if (advResult.success || advResult.error) {
              // Reload to show MT upload step
              setTimeout(() => loadWorkflow(data.sessionId), 500);
            }
          } catch (e) {
            // Even if advance fails, show MT upload step
            setTimeout(() => showMTUploadStep(data), 500);
          }
        });

        // Setup git commit button (admin only)
        setupGitCommitButton(data.sessionId);

      } else if (current.id === 'mt-upload') {
        showMTUploadStep(data);

      } else if (current.id === 'faithful-edit') {
        await showFaithfulEditStep(data, stepIndex);

      } else if (current.id === 'tm-creation') {
        showTMCreationStep(data, stepIndex);

      } else if (current.id === 'localization') {
        await showLocalizationStep(data, stepIndex);

      } else {
        const statusText = current.status === 'completed' ? 'Loki√∞' : current.status === 'in-progress' ? '√ç vinnslu' : 'B√≠√∞ur';
        contentEl.innerHTML = '<div class="alert ' + (current.status === 'completed' ? 'alert-success' : 'alert-info') + '">' + moduleInfo + '<strong>Skref ' + (stepIndex + 1) + ': ' + current.name + '</strong><p>Sta√∞a: ' + statusText + '</p></div>';
      }

      actionsEl.innerHTML = '';
    }

    function showMTUploadStep(data) {
      const contentEl = document.getElementById('step-content');

      // Get upload progress from data
      const progress = data.uploadProgress || { uploaded: 0, expected: 0, complete: false, missing: [], matchedFiles: [] };
      const expectedFiles = data.session?.expectedFiles?.['mt-upload'] || [];
      const matchedFiles = progress.matchedFiles || [];
      const hasSplitFiles = expectedFiles.some(exp => exp.part);
      const progressPercent = progress.expected > 0
        ? Math.round((progress.uploaded / progress.expected) * 100) : 0;

      // Issue analysis
      const sessionIssues = data.session?.issues || [];
      const pendingIssues = sessionIssues.filter(i => i.status === 'pending');
      const blockedIssues = pendingIssues.filter(i => i.category === 'BLOCKED');

      // Build the page with modular functions
      contentEl.innerHTML = '<div class="mt-upload-content">' +
        buildMTStepHeader(progress, progressPercent) +
        buildMTUploadZone(data.sessionId) +
        (hasSplitFiles ? buildMTWarningBanner(data.sessionId) : '') +
        buildMTFilesAccordion(expectedFiles, matchedFiles, progress, progressPercent) +
        buildMTSupplementaryAccordion(data.supplementaryFiles, data.sessionId) +
        buildMTInstructionsAccordion() +
        buildMTIssuesSection(sessionIssues, data.sessionId) +
        buildMTStepNav(data, progress, blockedIssues) +
        '</div>';

      // Setup interactions
      setupMTDropzone(data.sessionId, data);
      setupUploadHandler(data, 'mt-upload');
      setupRollbackButton(data);
      setupMTProceedButton(data, progress);
      setupGitCommitButton(data.sessionId);
    }

    // Build step header with circular progress ring
    function buildMTStepHeader(progress, progressPercent) {
      const circumference = 2 * Math.PI * 18; // radius = 18
      const offset = circumference - (progressPercent / 100) * circumference;

      return '<div class="step-header">' +
        '<div class="step-header-left">' +
        '<h3><span class="step-num">2</span> V√©l√æ√Ω√∞ing</h3>' +
        '<p>√û√Ωddu skr√°r √° malstadur.is</p>' +
        '</div>' +
        '<div class="step-header-right">' +
        '<svg class="progress-ring" viewBox="0 0 48 48">' +
        '<circle class="progress-ring-bg" cx="24" cy="24" r="18"/>' +
        '<circle class="progress-ring-fill" cx="24" cy="24" r="18" ' +
        'stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '"/>' +
        '</svg>' +
        '<span class="progress-ring-text">' + progress.uploaded + '/' + progress.expected + '</span>' +
        '</div>' +
        '</div>';
    }

    // Build the upload dropzone (primary action)
    function buildMTUploadZone(sessionId) {
      return '<div class="upload-hero">' +
        '<div class="dropzone" id="dropzone">' +
        '<div class="dropzone-icon">üìÅ</div>' +
        '<div class="dropzone-text">Drag√∞u .md skr√°r hinga√∞</div>' +
        '<div class="dropzone-hint">e√∞a</div>' +
        '<input type="file" id="dropzone-input" multiple accept=".md">' +
        '<button type="button" class="btn btn-secondary" onclick="document.getElementById(\'dropzone-input\').click()">Velja skr√°r</button>' +
        '</div>' +
        '</div>';
    }

    // Build dismissible warning banner for split files
    function buildMTWarningBanner(sessionId) {
      // Check if user has dismissed this warning
      const dismissKey = 'mt-split-warning-dismissed-' + sessionId;
      if (localStorage.getItem(dismissKey)) {
        return '';
      }

      return '<div class="warning-banner" id="split-warning">' +
        '<span class="warning-banner-icon">‚ö†Ô∏è</span>' +
        '<div class="warning-banner-content">' +
        '<strong>Sumar skr√°r voru skiptar √≠ hluta</strong>' +
        '<p>√û√Ωddu hvern hluta fyrir sig og hladdu √æeim √∂llum upp.</p>' +
        '</div>' +
        '<button class="warning-dismiss" onclick="dismissMTWarning(\'' + sessionId + '\')" title="Loka">√ó</button>' +
        '</div>';
    }

    // Dismiss split files warning
    function dismissMTWarning(sessionId) {
      const dismissKey = 'mt-split-warning-dismissed-' + sessionId;
      localStorage.setItem(dismissKey, 'true');
      const warning = document.getElementById('split-warning');
      if (warning) {
        warning.style.display = 'none';
      }
    }

    // Build collapsible files accordion
    function buildMTFilesAccordion(expectedFiles, matchedFiles, progress, progressPercent) {
      if (expectedFiles.length === 0) {
        return '';
      }

      // Create lookup for matched uploads
      const matchedKeys = new Set();
      for (const m of matchedFiles) {
        if (m.section && m.part) {
          matchedKeys.add(m.section + ':' + m.part);
        } else if (m.section) {
          matchedKeys.add(m.section);
        } else if (m.moduleId) {
          matchedKeys.add(m.moduleId);
        }
      }

      // Build file grid items
      let fileItems = '';
      for (const exp of expectedFiles) {
        const section = typeof exp === 'object' ? exp.section : null;
        const part = typeof exp === 'object' ? exp.part : null;
        const moduleId = typeof exp === 'object' ? exp.moduleId : null;
        const displayName = typeof exp === 'object' ? exp.displayName : exp;

        // Check if uploaded
        let key = null;
        if (section && part) {
          key = section + ':' + part;
        } else if (section) {
          key = section;
        } else if (moduleId) {
          key = moduleId;
        }
        const isUploaded = key && matchedKeys.has(key);
        const icon = isUploaded ? '‚úì' : '‚óã';
        const cls = isUploaded ? 'uploaded' : 'pending';

        fileItems += '<div class="file-item ' + cls + '" title="' + escapeHtml(displayName) + '">' +
          '<span class="file-icon">' + icon + '</span>' +
          '<span class="file-name">' + escapeHtml(displayName) + '</span>' +
          '</div>';
      }

      const remaining = progress.expected - progress.uploaded;
      const statusText = progress.complete
        ? '<span class="text-success">‚úì Allar skr√°r</span>'
        : remaining + ' eftir';

      return '<div class="accordion" id="files-accordion">' +
        '<button class="accordion-header" onclick="toggleAccordion(\'files-accordion\')">' +
        '<div class="accordion-header-left">' +
        '<span class="accordion-toggle">‚ñº</span>' +
        '<span>Skr√°r: ' + progress.uploaded + ' hla√∞i√∞ upp, ' + statusText + '</span>' +
        '</div>' +
        '<div class="accordion-progress">' +
        '<div class="progress-linear"><div class="progress-linear-fill" style="width: ' + progressPercent + '%"></div></div>' +
        '<span>' + progressPercent + '%</span>' +
        '</div>' +
        '</button>' +
        '<div class="accordion-body">' +
        '<div class="file-grid">' + fileItems + '</div>' +
        '</div>' +
        '</div>';
    }

    // Build collapsible supplementary files accordion
    function buildMTSupplementaryAccordion(suppFiles, sessionId) {
      if (!suppFiles || suppFiles.length === 0) {
        return '';
      }

      const translatableFiles = suppFiles.filter(f => f.translatableStrings > 0);
      if (translatableFiles.length === 0) {
        return '';
      }

      let fileItems = '';
      for (const sf of suppFiles) {
        if (sf.translatableStrings > 0) {
          fileItems += '<div class="supp-file">' +
            '<span>üìù</span>' +
            '<a href="/api/workflow/' + sessionId + '/supplementary-file/' + encodeURIComponent(sf.filename) + '" ' +
            'download="' + escapeHtml(sf.filename) + '">' + escapeHtml(sf.filename) + '</a>' +
            '<span class="supp-count">' + sf.translatableStrings + ' strengir</span>' +
            '</div>';
        }
      }

      return '<div class="accordion collapsed" id="supp-accordion">' +
        '<button class="accordion-header" onclick="toggleAccordion(\'supp-accordion\')">' +
        '<div class="accordion-header-left">' +
        '<span class="accordion-toggle">‚ñº</span>' +
        '<span>Vi√∞b√≥tarskr√°r (' + translatableFiles.length + ' skr√°r)</span>' +
        '</div>' +
        '</button>' +
        '<div class="accordion-body">' +
        '<div class="supp-grid">' + fileItems + '</div>' +
        '<div style="margin-top: 0.75rem;">' +
        '<a href="/api/workflow/' + sessionId + '/supplementary-files" class="btn btn-secondary btn-small" download>' +
        'S√¶kja allar (ZIP)</a>' +
        '</div>' +
        '</div>' +
        '</div>';
    }

    // Build collapsible instructions accordion
    function buildMTInstructionsAccordion() {
      return '<div class="accordion collapsed" id="instructions-accordion">' +
        '<button class="accordion-header" onclick="toggleAccordion(\'instructions-accordion\')">' +
        '<div class="accordion-header-left">' +
        '<span class="accordion-toggle">‚ñº</span>' +
        '<span>Lei√∞beiningar</span>' +
        '</div>' +
        '</button>' +
        '<div class="accordion-body">' +
        '<div class="instructions-content">' +
        '<ol>' +
        '<li>Far√∞u √° <a href="https://malstadur.is" target="_blank">malstadur.is</a></li>' +
        '<li>Hladdu upp .md skr√°num (ein √≠ einu)</li>' +
        '<li>Veldu enska ‚Üí √≠slenska</li>' +
        '<li>S√¶ktu √æ√Ωddu skr√°rnar</li>' +
        '<li>Hladdu √æeim upp h√©r (drag-and-drop e√∞a veldu skr√°r)</li>' +
        '</ol>' +
        '</div>' +
        '</div>' +
        '</div>';
    }

    // Build issues section (if any)
    function buildMTIssuesSection(sessionIssues, sessionId) {
      if (!sessionIssues || sessionIssues.length === 0) {
        return '';
      }

      const pendingIssues = sessionIssues.filter(i => i.status === 'pending');
      const blockedIssues = pendingIssues.filter(i => i.category === 'BLOCKED');
      const reviewIssues = pendingIssues.filter(i => i.category === 'EDITOR_CONFIRM' || i.category === 'BOARD_REVIEW');
      const autoFixedCount = sessionIssues.filter(i => i.category === 'AUTO_FIX' && i.status === 'resolved').length;

      if (autoFixedCount === 0 && reviewIssues.length === 0 && blockedIssues.length === 0) {
        return '';
      }

      let stats = '';
      if (autoFixedCount > 0) {
        stats += '<span class="issue-stat stat-success">' + autoFixedCount + ' sj√°lfvirkt lagf√¶rt</span>';
      }
      if (reviewIssues.length > 0) {
        stats += '<span class="issue-stat stat-warning">' + reviewIssues.length + ' √æarf yfirlestur</span>';
      }
      if (blockedIssues.length > 0) {
        stats += '<span class="issue-stat stat-error">' + blockedIssues.length + ' vandam√°l</span>';
      }

      return '<div class="issue-summary" style="margin-top: 0.75rem;">' +
        '<div class="issue-stats">' + stats + '</div>' +
        (pendingIssues.length > 0
          ? '<a href="/issues?sessionId=' + sessionId + '" class="btn btn-secondary btn-small" style="margin-top: 0.5rem;">Sko√∞a atri√∞i ‚Üí</a>'
          : '') +
        '</div>';
    }

    // Build step navigation
    function buildMTStepNav(data, progress, blockedIssues) {
      const canProceed = progress.complete || progress.expected === 0;
      const cannotProceedDueToIssues = blockedIssues.length > 0;
      const proceedDisabled = !canProceed || cannotProceedDueToIssues;

      let proceedTitle = '';
      if (cannotProceedDueToIssues) {
        proceedTitle = 'Leystu vandam√°l fyrst';
      } else if (!canProceed) {
        proceedTitle = 'Hladdu upp √∂llum skr√°m fyrst';
      }

      const rollbackHtml = getRollbackButtonHtml(data);
      const gitCommitHtml = getGitCommitButtonHtml(data.sessionId);

      // Add MT publish button if upload is complete and user can publish
      const publishHtml = (canProceed && canPublish())
        ? buildMTPublishAction(data.bookSlug || data.book, data.chapter, true)
        : '';

      return publishHtml +
        '<div class="step-nav">' +
        rollbackHtml +
        gitCommitHtml +
        '<button id="proceed-btn" class="btn btn-primary btn-large"' +
        (proceedDisabled ? ' disabled title="' + proceedTitle + '"' : '') +
        '>Halda √°fram √≠ yfirfer√∞ ‚Üí</button>' +
        '</div>';
    }

    // Toggle accordion open/closed
    function toggleAccordion(accordionId) {
      const accordion = document.getElementById(accordionId);
      if (accordion) {
        accordion.classList.toggle('collapsed');
      }
    }

    // Setup drag-and-drop for the dropzone
    function setupMTDropzone(sessionId, data) {
      const dropzone = document.getElementById('dropzone');
      const dropzoneInput = document.getElementById('dropzone-input');

      if (!dropzone || !dropzoneInput) return;

      // Prevent default drag behaviors on document
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      // Highlight on drag over
      ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.classList.add('drag-over');
        });
      });

      // Remove highlight on drag leave/drop
      ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.classList.remove('drag-over');
        });
      });

      // Handle dropped files
      dropzone.addEventListener('drop', async (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          await handleMTFileUpload(files, sessionId, data);
        }
      });

      // Handle file input change
      dropzoneInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length > 0) {
          await handleMTFileUpload(files, sessionId, data);
        }
      });

      // Make entire dropzone clickable
      dropzone.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
          dropzoneInput.click();
        }
      });
    }

    // Handle file upload from dropzone
    async function handleMTFileUpload(files, sessionId, data) {
      const dropzone = document.getElementById('dropzone');
      const originalText = dropzone.querySelector('.dropzone-text').textContent;

      // Show uploading state
      dropzone.querySelector('.dropzone-text').textContent = 'Hle√∞ur upp ' + files.length + ' skr√°m...';

      let successCount = 0;
      let errorMessages = [];

      for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch('/api/workflow/' + sessionId + '/upload/mt-upload', {
            method: 'POST',
            body: formData
          });
          const result = await res.json();
          if (result.success) {
            successCount++;
          } else {
            errorMessages.push(file.name + ': ' + (result.message || result.error));
          }
        } catch (err) {
          errorMessages.push(file.name + ': ' + err.message);
        }
      }

      // Show result
      if (errorMessages.length > 0) {
        alert('Villur vi√∞ upphle√∞slu:\n' + errorMessages.join('\n'));
      }

      if (successCount > 0) {
        // Reload workflow to show updated state
        loadWorkflow(sessionId);
      } else {
        // Restore original text
        dropzone.querySelector('.dropzone-text').textContent = originalText;
      }
    }

    // Setup proceed button for MT upload step
    function setupMTProceedButton(data, progress) {
      document.getElementById('proceed-btn')?.addEventListener('click', async () => {
        const btn = document.getElementById('proceed-btn');
        if (btn.disabled) {
          alert('Hladdu upp √∂llum √æ√Ωddum skr√°m fyrst (' + progress.uploaded + '/' + progress.expected + ')');
          return;
        }
        try {
          btn.disabled = true;
          btn.textContent = 'Vinnur...';
          // Mark step complete and advance
          const res = await fetch('/api/workflow/' + data.sessionId + '/advance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ markComplete: true })
          });
          const result = await res.json();
          if (result.success || result.complete) {
            loadWorkflow(data.sessionId);
          } else {
            alert('Villa: ' + (result.message || result.error || 'Gat ekki haldi√∞ √°fram'));
            btn.disabled = false;
            btn.textContent = 'Halda √°fram √≠ yfirfer√∞ ‚Üí';
          }
        } catch (e) {
          alert('Villa: ' + e.message);
          btn.disabled = false;
          btn.textContent = 'Halda √°fram √≠ yfirfer√∞ ‚Üí';
        }
      });
    }

    async function showFaithfulEditStep(data, stepIndex) {
      const contentEl = document.getElementById('step-content');
      const sessionIssues = data.session?.issues || [];
      const pendingIssues = sessionIssues.filter(i => i.status === 'pending');
      const rollbackHtml = getRollbackButtonHtml(data);
      const gitCommitHtml = getGitCommitButtonHtml(data.sessionId);

      // Build issues accordion if there are issues
      let issuesAccordion = '';
      if (pendingIssues.length > 0) {
        issuesAccordion = '<div class="accordion" id="issues-accordion">' +
          '<button class="accordion-header" onclick="toggleAccordion(\'issues-accordion\')">' +
          '<div class="accordion-header-left">' +
          '<span class="accordion-toggle">‚ñº</span>' +
          '<span>Atri√∞i til yfirfer√∞ar: <strong>' + pendingIssues.length + '</strong></span>' +
          '</div>' +
          '</button>' +
          '<div class="accordion-body">' +
          '<p>' + pendingIssues.length + ' atri√∞i √æarf a√∞ yfirfara √°√∞ur en haldi√∞ er √°fram.</p>' +
          '<a href="/issues?sessionId=' + data.sessionId + '" class="btn btn-secondary btn-small">Opna atri√∞alista ‚Üí</a>' +
          '</div>' +
          '</div>';
      }

      // Build section publication list (async)
      const sectionPublishHtml = canPublish()
        ? await buildSectionPublishList('faithful', data.bookSlug || data.book, data.chapter)
        : '';

      contentEl.innerHTML = '<div class="step-content-wrapper">' +
        // Step header
        '<div class="step-header">' +
        '<div class="step-header-left">' +
        '<h3><span class="step-num">3</span> 1. yfirfer√∞</h3>' +
        '<p>M√°lfarsyfirfer√∞ √° v√©l√æ√Ω√∞ingu</p>' +
        '</div>' +
        '</div>' +
        // Primary action - Editor link
        '<div class="primary-action">' +
        '<a href="/editor?sessionId=' + data.sessionId + '" class="btn btn-primary btn-large" target="_blank">' +
        'üìù Opna ritstj√≥ra</a>' +
        '<p class="action-hint">Far√∞u yfir √æ√Ωddu skr√°rnar og lei√∞r√©ttu m√°lfarsvillur</p>' +
        '</div>' +
        // Instructions accordion
        '<div class="accordion collapsed" id="instructions-accordion">' +
        '<button class="accordion-header" onclick="toggleAccordion(\'instructions-accordion\')">' +
        '<div class="accordion-header-left">' +
        '<span class="accordion-toggle">‚ñº</span>' +
        '<span>Lei√∞beiningar</span>' +
        '</div>' +
        '</button>' +
        '<div class="accordion-body">' +
        '<div class="instructions-content">' +
        '<ol>' +
        '<li>Far√∞u yfir √æ√Ωddu skr√°rnar √≠ ritstj√≥ranum</li>' +
        '<li>Lei√∞r√©ttu m√°lfarsvillur og samr√¶mdu hugt√∂k vi√∞ <a href="/terminology" target="_blank">or√∞alista</a></li>' +
        '<li>Nota√∞u <strong>Ctrl+S</strong> til a√∞ vista breytingar</li>' +
        '<li>√ûegar b√∫i√∞ er, smelltu √° "Halda √°fram"</li>' +
        '</ol>' +
        '</div>' +
        '</div>' +
        '</div>' +
        // Issues accordion
        issuesAccordion +
        // Section publication (for head editors/admins)
        sectionPublishHtml +
        // Step navigation
        '<div class="step-nav">' +
        rollbackHtml +
        gitCommitHtml +
        '<button id="proceed-btn" class="btn btn-primary btn-large">Halda √°fram ‚Üí</button>' +
        '</div>' +
        '</div>';

      setupProceedButton(data);
      setupRollbackButton(data);
      setupGitCommitButton(data.sessionId);
    }

    function showTMCreationStep(data, stepIndex) {
      const contentEl = document.getElementById('step-content');
      const rollbackHtml = getRollbackButtonHtml(data);
      const gitCommitHtml = getGitCommitButtonHtml(data.sessionId);

      contentEl.innerHTML = '<div class="step-content-wrapper">' +
        // Step header
        '<div class="step-header">' +
        '<div class="step-header-left">' +
        '<h3><span class="step-num">4</span> √û√Ω√∞ingaminni</h3>' +
        '<p>B√∫a til TM me√∞ Matecat Align</p>' +
        '</div>' +
        '</div>' +
        // Primary action - Upload zone
        '<div class="upload-hero">' +
        '<div class="dropzone" id="dropzone">' +
        '<div class="dropzone-icon">üìÅ</div>' +
        '<div class="dropzone-text">Drag√∞u TMX skr√° hinga√∞</div>' +
        '<div class="dropzone-hint">e√∞a</div>' +
        '<form id="upload-form" class="upload-form-inline">' +
        '<input type="file" name="file" id="upload-file" accept=".tmx">' +
        '<button type="submit" class="btn btn-secondary">Velja skr√°</button>' +
        '</form>' +
        '</div>' +
        '</div>' +
        // Instructions accordion
        '<div class="accordion collapsed" id="instructions-accordion">' +
        '<button class="accordion-header" onclick="toggleAccordion(\'instructions-accordion\')">' +
        '<div class="accordion-header-left">' +
        '<span class="accordion-toggle">‚ñº</span>' +
        '<span>Lei√∞beiningar</span>' +
        '</div>' +
        '</button>' +
        '<div class="accordion-body">' +
        '<div class="instructions-content">' +
        '<ol>' +
        '<li>Opna√∞u <a href="https://matecat.com/align" target="_blank">Matecat Align</a></li>' +
        '<li>Hladdu upp ensku og √≠slensku skr√°num</li>' +
        '<li>Samr√¶mdu setningar sem √æarf</li>' +
        '<li>Fluttu √∫t TMX skr√°</li>' +
        '<li>Hladdu TMX skr√°nni upp h√©r</li>' +
        '</ol>' +
        '</div>' +
        '</div>' +
        '</div>' +
        // Info banner
        '<div class="info-banner">' +
        '<span class="info-banner-icon">‚ÑπÔ∏è</span>' +
        '<div class="info-banner-content">' +
        '<strong>Valfrj√°lst skref</strong>' +
        '<p>√û√∫ getur sleppt √æessu skrefi ef √æ√∫ vilt ekki b√∫a til √æ√Ω√∞ingaminni.</p>' +
        '</div>' +
        '</div>' +
        // Step navigation
        '<div class="step-nav">' +
        rollbackHtml +
        gitCommitHtml +
        '<button id="proceed-btn" class="btn btn-primary btn-large">Halda √°fram ‚Üí</button>' +
        '</div>' +
        '</div>';

      setupUploadHandler(data, 'tm-creation');
      setupProceedButton(data);
      setupRollbackButton(data);
      setupGitCommitButton(data.sessionId);
    }

    async function showLocalizationStep(data, stepIndex) {
      const contentEl = document.getElementById('step-content');
      const sessionIssues = data.session?.issues || [];
      const localizationIssues = sessionIssues.filter(i => i.category === 'BOARD_REVIEW' && i.status === 'pending');
      const rollbackHtml = getRollbackButtonHtml(data);
      const gitCommitHtml = getGitCommitButtonHtml(data.sessionId);

      // Build issues accordion if there are localization issues
      let issuesAccordion = '';
      if (localizationIssues.length > 0) {
        issuesAccordion = '<div class="accordion" id="issues-accordion">' +
          '<button class="accordion-header" onclick="toggleAccordion(\'issues-accordion\')">' +
          '<div class="accordion-header-left">' +
          '<span class="accordion-toggle">‚ñº</span>' +
          '<span>Sta√∞f√¶rsluatri√∞i: <strong>' + localizationIssues.length + '</strong></span>' +
          '</div>' +
          '</button>' +
          '<div class="accordion-body">' +
          '<p>' + localizationIssues.length + ' atri√∞i til a√∞ sta√∞f√¶ra (einingar, d√¶mi, o.fl.).</p>' +
          '<a href="/localization-review?sessionId=' + data.sessionId + '" class="btn btn-secondary btn-small">Opna sta√∞f√¶rsluyfirlit ‚Üí</a>' +
          '</div>' +
          '</div>';
      }

      // Build section publication list (async)
      const sectionPublishHtml = canPublish()
        ? await buildSectionPublishList('localized', data.bookSlug || data.book, data.chapter)
        : '';

      contentEl.innerHTML = '<div class="step-content-wrapper">' +
        // Step header
        '<div class="step-header">' +
        '<div class="step-header-left">' +
        '<h3><span class="step-num">5</span> Sta√∞f√¶rsla</h3>' +
        '<p>A√∞laga efni fyrir √≠slenskt samhengi</p>' +
        '</div>' +
        '</div>' +
        // Primary action - Localization review link
        '<div class="primary-action">' +
        '<a href="/localization-review?sessionId=' + data.sessionId + '" class="btn btn-primary btn-large" target="_blank">' +
        'üåç Opna sta√∞f√¶rsluyfirlit</a>' +
        '<p class="action-hint">Umbreyttu einingum og b√¶ttu vi√∞ √≠slenskum d√¶mum</p>' +
        '</div>' +
        // Instructions accordion
        '<div class="accordion collapsed" id="instructions-accordion">' +
        '<button class="accordion-header" onclick="toggleAccordion(\'instructions-accordion\')">' +
        '<div class="accordion-header-left">' +
        '<span class="accordion-toggle">‚ñº</span>' +
        '<span>Lei√∞beiningar</span>' +
        '</div>' +
        '</button>' +
        '<div class="accordion-body">' +
        '<div class="instructions-content">' +
        '<ol>' +
        '<li>Far√∞u yfir sta√∞f√¶rsluatri√∞i</li>' +
        '<li>Umbreyttu einingum (m√≠lu‚Üíkm, Fahrenheit‚ÜíCelsius)</li>' +
        '<li>Settu inn √≠slensk d√¶mi √æar sem vi√∞ √°</li>' +
        '<li>Vista√∞u breytingar</li>' +
        '</ol>' +
        '</div>' +
        '</div>' +
        '</div>' +
        // Issues accordion
        issuesAccordion +
        // Section publication (for head editors/admins)
        sectionPublishHtml +
        // Step navigation
        '<div class="step-nav">' +
        rollbackHtml +
        gitCommitHtml +
        '<button id="proceed-btn" class="btn btn-primary btn-large">Halda √°fram ‚Üí</button>' +
        '</div>' +
        '</div>';

      setupProceedButton(data);
      setupRollbackButton(data);
      setupGitCommitButton(data.sessionId);
    }

    function setupProceedButton(data) {
      document.getElementById('proceed-btn')?.addEventListener('click', async () => {
        const btn = document.getElementById('proceed-btn');
        try {
          btn.disabled = true;
          btn.textContent = 'Vinnur...';
          const res = await fetch('/api/workflow/' + data.sessionId + '/advance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ markComplete: true })
          });
          const result = await res.json();
          if (result.success || result.complete) {
            loadWorkflow(data.sessionId);
          } else {
            alert('Villa: ' + (result.message || result.error || 'Gat ekki haldi√∞ √°fram'));
            btn.disabled = false;
            btn.textContent = 'Halda √°fram √≠ n√¶sta skref ‚Üí';
          }
        } catch (e) {
          alert('Villa: ' + e.message);
          btn.disabled = false;
          btn.textContent = 'Halda √°fram √≠ n√¶sta skref ‚Üí';
        }
      });
    }

    function setupRollbackButton(data) {
      document.getElementById('rollback-btn')?.addEventListener('click', async () => {
        if (!confirm('Ertu viss? √û√∫ fer√∞ til baka √≠ fyrra skref. G√∂gn fr√° n√∫verandi skrefi g√¶tu glatast.')) {
          return;
        }

        const btn = document.getElementById('rollback-btn');
        try {
          btn.disabled = true;
          btn.textContent = 'Vinnur...';
          const res = await fetch('/api/workflow/' + data.sessionId + '/rollback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await res.json();
          if (result.success) {
            loadWorkflow(data.sessionId);
          } else {
            alert('Villa: ' + (result.message || result.error || 'Gat ekki fari√∞ til baka'));
            btn.disabled = false;
            btn.textContent = '‚Üê Til baka';
          }
        } catch (e) {
          alert('Villa: ' + e.message);
          btn.disabled = false;
          btn.textContent = '‚Üê Til baka';
        }
      });
    }

    // Get rollback button HTML based on current step
    function getRollbackButtonHtml(data) {
      // Determine current step index
      let currentStepIndex;
      if (typeof data.currentStep === 'number') {
        currentStepIndex = data.currentStep;
      } else if (data.session && typeof data.session.currentStep === 'number') {
        currentStepIndex = data.session.currentStep;
      } else {
        // Find by step id
        const currentStepObj = typeof data.currentStep === 'object' ? data.currentStep : null;
        if (currentStepObj && data.steps) {
          currentStepIndex = data.steps.findIndex(s => s.id === currentStepObj.id);
        } else {
          currentStepIndex = 0;
        }
      }

      // Only show rollback button if not on first step
      if (currentStepIndex > 0) {
        return '<button id="rollback-btn" class="btn btn-outline-secondary" title="Fara til baka √≠ fyrra skref">‚Üê Til baka</button>';
      }
      return '';
    }

    // Get git commit button HTML (admin only)
    function getGitCommitButtonHtml(sessionId) {
      if (currentUser?.role !== 'admin') {
        return '';
      }
      return '<button id="git-commit-btn" class="btn btn-secondary" title="Vista skr√°r √≠ GitHub">Vista √≠ GitHub</button>';
    }

    // Setup git commit button click handler
    function setupGitCommitButton(sessionId) {
      const btn = document.getElementById('git-commit-btn');
      if (!btn) return;

      btn.addEventListener('click', async () => {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span> Sendi...';

        try {
          const res = await fetch('/api/workflow/' + sessionId + '/git-commit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ push: true })
          });

          const result = await res.json();

          if (result.success) {
            btn.innerHTML = '‚úì Vista√∞';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-secondary');

            // Show success message
            const commitInfo = result.pushed
              ? `${result.filesCommitted} skr√°r vista√∞ar og sendar (${result.sha.substring(0, 7)})`
              : `${result.filesCommitted} skr√°r vista√∞ar (${result.sha.substring(0, 7)})`;

            if (!result.pushed && result.pushError) {
              alert(commitInfo + '\n\nAthugi√∞: Push mist√≥kst. Keyr√∞u git push handvirkt.');
            }
          } else {
            btn.innerHTML = 'Villa';
            btn.classList.add('btn-danger');
            btn.classList.remove('btn-secondary');
            alert('Villa vi√∞ a√∞ vista: ' + (result.error || '√ì√æekkt villa'));
            // Reset button after 3 seconds
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove('btn-danger');
              btn.classList.add('btn-secondary');
              btn.disabled = false;
            }, 3000);
          }
        } catch (err) {
          btn.innerHTML = 'Villa';
          btn.classList.add('btn-danger');
          btn.classList.remove('btn-secondary');
          alert('Villa: ' + err.message);
          // Reset button after 3 seconds
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-secondary');
            btn.disabled = false;
          }, 3000);
        }
      });
    }

    function setupUploadHandler(data, stepId) {
      const uploadFormEl = document.getElementById('upload-form');
      if (uploadFormEl && data.sessionId) {
        uploadFormEl.onsubmit = async (e) => {
          e.preventDefault();
          const files = document.getElementById('upload-file').files;
          if (!files.length) { alert('Veldu skr√°r til a√∞ hla√∞a upp'); return; }

          const btn = uploadFormEl.querySelector('button');
          btn.disabled = true;
          btn.textContent = 'Hle√∞ur upp...';

          let success = true;
          for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);
            try {
              const res = await fetch('/api/workflow/' + data.sessionId + '/upload/' + stepId, {
                method: 'POST',
                body: formData
              });
              const result = await res.json();
              if (!result.success) {
                alert('Villa: ' + (result.message || result.error));
                success = false;
              }
            } catch (err) {
              alert('Villa: ' + err.message);
              success = false;
            }
          }

          if (success) {
            alert(files.length + ' skr√°r hla√∞i√∞ upp!');
            loadWorkflow(data.sessionId);
          } else {
            btn.disabled = false;
            btn.textContent = 'Hla√∞a upp og halda √°fram';
          }
        };
      }
    }

    async function loadWorkflows() {
      try {
        const res = await fetch('/api/workflow/sessions');
        const data = await res.json();
        const el = document.getElementById('active-workflows');

        if (!data.sessions || data.sessions.length === 0) {
          el.innerHTML = '<p class="text-muted">Engin virk verkfl√¶√∞i</p>';
          return;
        }

        el.innerHTML = '<table class="table"><thead><tr><th>B√≥k</th><th>Kafli</th><th>Framvinda</th><th></th></tr></thead><tbody>' +
          data.sessions.map(s => '<tr><td>' + s.book + '</td><td>K. ' + s.chapter + '</td><td><div class="progress-bar"><div class="progress-bar-fill" style="width:' + s.progress + '%"></div></div></td><td><button class="btn btn-secondary" onclick="loadWorkflow(\'' + s.id + '\')">Sko√∞a</button></td></tr>').join('') +
          '</tbody></table>';
      } catch (e) {
        document.getElementById('active-workflows').innerHTML = '<p class="text-error">Villa vi√∞ a√∞ hla√∞a verkfl√¶√∞um</p>';
      }
    }

    async function loadWorkflow(id) {
      currentSessionId = id;  // Track for publication reloads
      const res = await fetch('/api/workflow/' + id);
      const data = await res.json();
      showWorkflow({
        ...data.session,
        sessionId: id,
        downloads: data.downloads,
        uploadProgress: data.uploadProgress,
        session: data.session  // Keep full session for file tracking
      });
    }

    // ==========================================
    // Publication Functions
    // ==========================================

    let pendingPublishAction = null;

    // Check if current user can publish (HEAD_EDITOR or ADMIN)
    function canPublish() {
      return currentUser && ['admin', 'head-editor'].includes(currentUser.role);
    }

    // Show overwrite confirmation modal
    function showOverwriteModal(title, description, preview, onConfirm) {
      const modal = document.getElementById('overwrite-modal');
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-description').textContent = description;

      // Show overwrite list if files will be replaced
      const overwriteContainer = document.getElementById('overwrite-list-container');
      const overwriteList = document.getElementById('overwrite-list');
      if (preview.willOverwrite && preview.willOverwrite.length > 0) {
        overwriteList.innerHTML = preview.willOverwrite.map(f =>
          '<li>' + escapeHtml(f.name) + '</li>'
        ).join('');
        overwriteContainer.style.display = 'block';
      } else {
        overwriteContainer.style.display = 'none';
      }

      // Show create list if new files will be created
      const createContainer = document.getElementById('create-list-container');
      const createList = document.getElementById('create-list');
      if (preview.willCreate && preview.willCreate.length > 0) {
        createList.innerHTML = preview.willCreate.map(f =>
          '<li>' + escapeHtml(f) + '</li>'
        ).join('');
        createContainer.style.display = 'block';
      } else {
        createContainer.style.display = 'none';
      }

      // Show warning if any
      const warningEl = document.getElementById('modal-warning');
      if (preview.warning) {
        warningEl.textContent = '‚ö†Ô∏è ' + preview.warning;
        warningEl.style.display = 'block';
      } else {
        warningEl.style.display = 'none';
      }

      // Store the confirm action
      pendingPublishAction = onConfirm;

      // Show modal
      modal.style.display = 'flex';
    }

    function closeOverwriteModal() {
      document.getElementById('overwrite-modal').style.display = 'none';
      pendingPublishAction = null;
    }

    // Setup confirm button click handler
    document.getElementById('confirm-publish-btn')?.addEventListener('click', async () => {
      if (pendingPublishAction) {
        const btn = document.getElementById('confirm-publish-btn');
        btn.disabled = true;
        btn.textContent = 'Birtir...';
        try {
          await pendingPublishAction();
        } finally {
          btn.disabled = false;
          btn.textContent = 'Birta';
          closeOverwriteModal();
        }
      }
    });

    // Handle publication with confirmation
    async function handlePublish(type, bookSlug, chapter, section = null) {
      if (!canPublish()) {
        alert('A√∞eins ritstj√≥rar og stj√≥rnendur geta birt efni.');
        return;
      }

      // Step 1: Get preview of what will be overwritten
      const previewEndpoint = section
        ? '/api/publication/' + bookSlug + '/' + chapter + '/' + type + '/' + section + '/preview'
        : '/api/publication/' + bookSlug + '/' + chapter + '/' + type + '/preview';

      try {
        const previewRes = await fetch(previewEndpoint);
        if (!previewRes.ok) {
          const err = await previewRes.json();
          alert('Villa: ' + (err.message || err.error || 'Gat ekki s√≥tt forsko√∞un'));
          return;
        }

        const preview = await previewRes.json();

        // Build description
        const typeNames = {
          'mt-preview': 'v√©l√æ√Ω√∞ingu',
          'faithful': 'ritst√Ωr√∞ri √æ√Ω√∞ingu',
          'localized': 'sta√∞f√¶r√∞u efni'
        };
        const typeName = typeNames[type] || type;
        const description = section
          ? 'Birta eining ' + section + ' me√∞ ' + typeName + '.'
          : 'Birta kafla ' + chapter + ' me√∞ ' + typeName + '. ' + preview.totalFiles + ' skr√°r ver√∞a birtar.';

        // Step 2: Show confirmation modal
        const title = preview.willOverwrite.length > 0
          ? 'Yfirskrifa fyrri birtingu?'
          : 'Sta√∞festa birtingu';

        showOverwriteModal(title, description, preview, async () => {
          // Step 3: Actually publish
          const publishEndpoint = section
            ? '/api/publication/' + bookSlug + '/' + chapter + '/' + type + '/' + section
            : '/api/publication/' + bookSlug + '/' + chapter + '/' + type;

          const publishRes = await fetch(publishEndpoint, { method: 'POST' });
          const result = await publishRes.json();

          if (result.success) {
            alert('Birting t√≥kst! ' + result.filesPublished + ' skr√°r birtar.');
            // Reload workflow to reflect new state
            if (currentSessionId) {
              loadWorkflow(currentSessionId);
            }
          } else {
            alert('Villa: ' + (result.message || result.error));
          }
        });

      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    // Build MT Preview publication action box
    function buildMTPublishAction(bookSlug, chapter, isComplete) {
      if (!canPublish() || !isComplete) {
        return '';
      }

      return '<div class="publication-action">' +
        '<h4>üì§ Birta v√©l√æ√Ω√∞ingu</h4>' +
        '<p>Ger√∞u v√©l√æ√Ω√∞inguna a√∞gengilega lesendum strax, me√∞ vi√∞v√∂run um a√∞ h√∫n hafi ekki veri√∞ yfirfarin.</p>' +
        '<button class="btn btn-publish" onclick="handlePublish(\'mt-preview\', \'' + escapeHtml(bookSlug) + '\', ' + chapter + ')">' +
        'Birta v√©l√æ√Ω√∞ingu' +
        '</button>' +
        '</div>';
    }

    // Build section-level publication list for faithful/localized
    async function buildSectionPublishList(type, bookSlug, chapter) {
      if (!canPublish()) {
        return '';
      }

      try {
        const res = await fetch('/api/publication/' + bookSlug + '/' + chapter + '/sections');
        if (!res.ok) {
          return '<p class="text-muted">Gat ekki s√≥tt einingar.</p>';
        }

        const data = await res.json();
        if (!data.sections || data.sections.length === 0) {
          return '<p class="text-muted">Engar einingar skr√°√∞ar.</p>';
        }

        const typeKey = type === 'faithful' ? 'faithful' : 'localized';
        const typeName = type === 'faithful' ? 'Ritst√Ωr√∞ √æ√Ω√∞ing' : 'Sta√∞f√¶r√∞ √∫tg√°fa';

        let html = '<div class="section-publish-list">' +
          '<h4>Birta einingar (' + typeName + ')</h4>';

        for (const section of data.sections) {
          const sectionData = section[typeKey];
          const isApproved = sectionData.approved;
          const isPublished = sectionData.published;

          let statusText = '';
          let btnHtml = '';

          if (isPublished) {
            statusText = '<span class="published-badge">‚úì Birt</span>';
          } else if (isApproved) {
            statusText = '<span class="text-success">‚úì Sam√æykkt</span>';
            btnHtml = '<button class="btn btn-sm btn-publish-section" ' +
              'onclick="handlePublish(\'' + type + '\', \'' + escapeHtml(bookSlug) + '\', ' + chapter + ', \'' + escapeHtml(section.sectionNum) + '\')">' +
              'Birta</button>';
          } else {
            statusText = '<span class="text-muted">‚è≥ B√≠√∞ur</span>';
          }

          html += '<div class="section-row' + (isPublished ? ' published' : '') + '">' +
            '<span class="section-name">' + escapeHtml(section.sectionNum) + ': ' + escapeHtml(section.title) + '</span>' +
            '<span class="section-status">' + statusText + '</span>' +
            btnHtml +
            '</div>';
        }

        html += '</div>';
        return html;

      } catch (err) {
        console.error('Error building section list:', err);
        return '<p class="text-muted">Villa vi√∞ a√∞ s√¶kja einingar.</p>';
      }
    }

    // Track current session ID for reloading
    let currentSessionId = null;

    // Auth check and init
    fetch('/api/auth/me').then(r => r.json()).then(data => {
      const el = document.getElementById('user-info');
      if (data.authenticated) {
        currentUser = data.user;  // Store for role checks
        el.innerHTML = '<img src="' + data.user.avatar + '" alt=""><span>' + data.user.name + '</span>';
        loadBooks();
        loadWorkflows();
        initNotifications(data.user);
      } else {
        el.innerHTML = '<a href="/api/auth/login" class="btn btn-primary">Innskr√°ning</a>';
        // Update form to show login required
        document.getElementById('book-select').innerHTML = '<option value="">Innskr√°ning krafist</option>';
        document.getElementById('book-select').disabled = true;
        document.getElementById('chapter-select').disabled = true;
        document.getElementById('submit-btn').disabled = true;
      }
    });

    // Notification widget functions
    async function initNotifications(user) {
      // Show notification widget
      document.getElementById('notifications-widget').style.display = 'block';

      // Load pending review count for admins/head-editors
      if (['admin', 'head-editor'].includes(user.role)) {
        try {
          const res = await fetch('/api/reviews/count');
          const data = await res.json();
          const badge = document.getElementById('reviews-badge');
          if (data.count > 0) {
            badge.textContent = data.count;
            badge.style.display = 'inline';
          }
        } catch (e) { /* ignore */ }
      }

      // Load notifications
      await loadNotifications();

      // Setup notification button
      document.getElementById('notification-btn').addEventListener('click', toggleNotificationDropdown);
      document.getElementById('mark-all-read').addEventListener('click', markAllNotificationsRead);

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const widget = document.getElementById('notifications-widget');
        if (!widget.contains(e.target)) {
          document.getElementById('notification-dropdown').style.display = 'none';
        }
      });
    }

    async function loadNotifications() {
      try {
        const res = await fetch('/api/notifications?unread=true');
        const data = await res.json();

        // Update count
        const countEl = document.getElementById('notification-count');
        if (data.unreadCount > 0) {
          countEl.textContent = data.unreadCount;
          countEl.style.display = 'inline';
        } else {
          countEl.style.display = 'none';
        }

        // Update list
        const listEl = document.getElementById('notification-list');
        if (data.notifications.length === 0) {
          listEl.innerHTML = '<div class="notification-empty">Engar n√Ωjar tilkynningar</div>';
        } else {
          listEl.innerHTML = data.notifications.map(n => {
            const date = new Date(n.createdAt).toLocaleString('is-IS');
            return '<div class="notification-item' + (n.read ? '' : ' unread') + '" data-id="' + n.id + '">' +
              '<div class="notification-title">' + escapeHtml(n.title) + '</div>' +
              '<div class="notification-message">' + escapeHtml(n.message).substring(0, 100) + '</div>' +
              '<div class="notification-date">' + date + '</div>' +
              (n.link ? '<a href="' + n.link + '" class="notification-link">Sko√∞a</a>' : '') +
              '</div>';
          }).join('');
        }
      } catch (e) {
        console.error('Failed to load notifications:', e);
      }
    }

    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notification-dropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    async function markAllNotificationsRead() {
      try {
        await fetch('/api/notifications/read-all', { method: 'POST' });
        await loadNotifications();
      } catch (e) {
        console.error('Failed to mark notifications as read:', e);
      }
    }
  </script>

  <script src="/js/theme.js"></script>
  <script src="/js/nav.js"></script>

  <style>
    /* Page-specific styles for workflow management */

    .container { max-width: 1000px; }
    .card { padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; }

    .form-select:disabled { background: var(--gray-50); cursor: not-allowed; }

    /* Grid */
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }

    /* Chapter info */
    .chapter-info { background: var(--gray-50); border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem; }
    .chapter-info p { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .module-list { font-size: 0.75rem; color: var(--text-muted); list-style: none; max-height: 150px; overflow-y: auto; }
    .module-list li { padding: 0.25rem 0; }
    .module-list code { background: var(--gray-200); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.7rem; }

    /* Workflow steps */
    .steps { display: flex; gap: 0.5rem; margin-bottom: 2rem; }
    .step { flex: 1; text-align: center; }
    .step-number { width: 2rem; height: 2rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem; background: var(--gray-200); }
    .step.complete .step-number { background: var(--success); color: white; }
    .step.active .step-number { background: var(--primary); color: white; }
    .step-label { font-size: 0.75rem; color: var(--text-muted); }

    /* Table */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }

    /* Actions */
    .actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .action-buttons { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }

    /* Downloads and uploads */
    .downloads { margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .downloads ul { list-style: none; display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .module-status { margin-bottom: 0.5rem; }
    .upload-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    .upload-section h4 { font-size: 0.875rem; margin-bottom: 0.5rem; }
    .upload-form { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .upload-form input[type="file"] { flex: 1; min-width: 200px; }

    /* Step content */
    .step-desc { font-size: 0.875rem; margin: 0.5rem 0; opacity: 0.8; }
    .instructions { margin: 0.75rem 0; line-height: 1.8; }
    .instructions-list { margin: 1rem 0; padding-left: 1.5rem; }
    .instructions-list li { margin: 0.5rem 0; }
    .uploaded-count { color: var(--success); font-weight: 500; margin: 0.5rem 0; }
    .next-action { margin-top: 1rem; padding: 1.5rem; background: var(--bg-card); border-radius: 0.5rem; border: 2px solid var(--primary); text-align: center; }
    .next-action p { margin-bottom: 1rem; }
    .btn-large { padding: 0.75rem 2rem; font-size: 1rem; }

    /* File checklist - responsive layout with full filenames */
    .file-checklist { margin: 1rem 0; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .checklist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0.75rem 1rem;
      background: var(--gray-50);
      border-radius: 0.375rem 0.375rem 0 0;
      user-select: none;
    }
    .checklist-header:hover { background: var(--gray-100); }
    .checklist-header-left { display: flex; align-items: center; gap: 0.5rem; }
    .checklist-header-left strong { font-size: 0.875rem; }
    .checklist-toggle {
      font-size: 0.75rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }
    .file-checklist.collapsed .checklist-toggle { transform: rotate(-90deg); }
    .file-checklist.collapsed .checklist-body { display: none; }
    .checklist-body { padding: 0.75rem 1rem; }
    .checklist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 0.25rem 1rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .checklist {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 0.25rem 1rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.375rem;
      padding: 0.25rem 0;
      font-size: 0.8125rem;
      white-space: normal;
      word-break: break-word;
    }
    .checklist-item.uploaded { color: var(--success); }
    .checklist-item.pending { color: var(--text-muted); }
    .check-icon { width: 1rem; text-align: center; font-weight: bold; flex-shrink: 0; margin-top: 0.1rem; }
    .checklist-item.uploaded .check-icon { color: var(--success); }
    .file-info {
      cursor: help;
    }
    .progress-summary { margin: 0.75rem 0; padding: 0.75rem; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .text-success { color: var(--success); }

    /* Warning alert */
    .alert-warning h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .existing-session-info { margin: 1rem 0; padding: 0.75rem; background: rgba(255,255,255,0.5); border-radius: 0.25rem; }
    .existing-session-info p { margin: 0.25rem 0; font-size: 0.875rem; }
    .dialog-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }

    /* Issue summary */
    .issue-summary { margin: 1rem 0; padding: 1rem; background: var(--bg-card); border-radius: 0.375rem; border: 1px solid var(--border-color); }
    .issue-summary h4 { font-size: 0.875rem; margin-bottom: 0.5rem; color: var(--text-secondary); }
    .issue-stats { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .issue-stat { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .stat-success { background: var(--success-light); color: #166534; }
    .stat-warning { background: var(--warning-light); color: #92400e; }
    .stat-error { background: var(--error-light); color: #991b1b; }
    .btn-small { padding: 0.25rem 0.75rem; font-size: 0.75rem; }

    /* Supplementary files section */
    .supplementary-section {
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: 0.375rem;
      border: 1px solid var(--border-color);
    }
    .supplementary-section h4 {
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }
    .supp-desc {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }
    .supplementary-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .supp-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    .supp-item:last-child {
      border-bottom: none;
    }
    .supp-icon {
      font-size: 1rem;
      flex-shrink: 0;
    }
    .supp-info {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }
    .supp-info a {
      font-weight: 500;
      color: var(--link-color);
      text-decoration: none;
    }
    .supp-info a:hover {
      text-decoration: underline;
    }
    .supp-type {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .supp-item.has-content .supp-type {
      color: var(--success);
    }
    .supp-item.no-content {
      opacity: 0.6;
    }
    .supp-actions {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-color);
    }

    /* Nav badge */
    .nav-badge { background: var(--error); color: white; font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 9999px; font-weight: 600; margin-left: 0.25rem; }

    /* Danger button */
    .btn-danger { background: var(--error); color: white; border: 1px solid var(--error); }
    .btn-danger:hover { background: #b91c1c; border-color: #b91c1c; }

    /* Outline secondary button */
    .btn-outline-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
    .btn-outline-secondary:hover { background: var(--gray-100); border-color: var(--gray-400); }

    /* Step navigation buttons */
    .step-nav-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    .step-nav-buttons .btn-large { margin-left: auto; }

    /* Notification widget */
    .notifications { position: relative; }
    .notification-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; color: var(--text-secondary); position: relative; }
    .notification-btn:hover { background: var(--gray-100); }
    .notification-count { position: absolute; top: 0; right: 0; background: var(--error); color: white; font-size: 0.625rem; min-width: 1rem; height: 1rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
    .notification-dropdown { position: absolute; top: 100%; right: 0; width: 320px; background: var(--bg-card); border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 1000; margin-top: 0.5rem; }
    .dropdown-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); }
    .dropdown-header span { font-weight: 600; font-size: 0.875rem; }
    .mark-all-read { background: none; border: none; color: var(--primary); font-size: 0.75rem; cursor: pointer; }
    .notification-list { max-height: 300px; overflow-y: auto; }
    .notification-item { padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-100); }
    .notification-item.unread { background: var(--primary-light); }
    .notification-item:last-child { border-bottom: none; }
    .notification-title { font-weight: 500; font-size: 0.875rem; margin-bottom: 0.25rem; }
    .notification-message { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .notification-date { font-size: 0.625rem; color: var(--text-muted); }
    .notification-link { font-size: 0.75rem; color: var(--primary); }
    .notification-empty { padding: 2rem; text-align: center; color: var(--text-muted); font-size: 0.875rem; }

    /* Chapter files section */
    .chapter-files {
      background: var(--gray-50);
      border-radius: 0.375rem;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
    }
    .chapter-files h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text-secondary);
    }
    .files-available, .files-missing {
      font-size: 0.875rem;
    }
    .section-list {
      list-style: none;
      margin: 0.5rem 0;
      padding: 0;
      max-height: 120px;
      overflow-y: auto;
      font-size: 0.75rem;
    }
    .section-list li {
      padding: 0.25rem 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .section-list li:last-child {
      border-bottom: none;
    }
    .section-list code {
      background: var(--gray-200);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
    }
    .files-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    /* Import dialog */
    .import-dialog {
      padding: 0.5rem 0;
    }
    .import-dialog h5 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .import-form {
      margin-top: 0.75rem;
    }
    .import-form input[type="file"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px dashed var(--border-color);
      border-radius: 0.375rem;
      background: var(--bg-card);
      margin-bottom: 0.75rem;
    }
    .import-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Workflow progress section */
    .workflow-progress {
      background: var(--bg-card);
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 2px solid var(--border-color);
    }
    .workflow-progress.resumable {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.05);
    }
    .workflow-progress.active-session {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }
    .workflow-progress p {
      margin: 0.25rem 0;
      font-size: 0.875rem;
    }
    .workflow-progress .text-info {
      color: var(--primary);
    }
    .completed-downloads {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
      margin: 0.5rem 0;
    }
    .download-badge {
      background: var(--success-light);
      color: #166534;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.6875rem;
      font-weight: 500;
    }
    .progress-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .notification-dropdown { width: 280px; right: -1rem; }
      .checklist { grid-template-columns: 1fr; }
    }

    /* ==========================================
       MT Upload Step - Progressive Disclosure
       ========================================== */

    /* Step Header with Progress Ring */
    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .step-header-left h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0 0 0.25rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .step-header-left h3 .step-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.75rem;
      height: 1.75rem;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 0.875rem;
    }
    .step-header-left p {
      margin: 0;
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    .step-header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .progress-ring {
      width: 48px;
      height: 48px;
      transform: rotate(-90deg);
    }
    .progress-ring-bg {
      fill: none;
      stroke: var(--gray-200);
      stroke-width: 4;
    }
    .progress-ring-fill {
      fill: none;
      stroke: var(--success);
      stroke-width: 4;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.3s ease;
    }
    .progress-ring-text {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Upload Dropzone (Primary Action) */
    .upload-hero {
      margin-bottom: 1.5rem;
    }
    .dropzone {
      border: 2px dashed var(--border-color);
      border-radius: 0.5rem;
      padding: 2rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-card);
    }
    .dropzone:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.03);
    }
    .dropzone.drag-over {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.08);
      border-style: solid;
    }
    .dropzone-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .dropzone-text {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }
    .dropzone-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .dropzone input[type="file"] {
      display: none;
    }
    .dropzone .btn {
      margin-top: 0.5rem;
    }

    /* Compact Warning Banner (dismissible) */
    .warning-banner {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: 0.375rem;
      margin-bottom: 1rem;
      font-size: 0.8125rem;
    }
    .warning-banner-icon {
      flex-shrink: 0;
      font-size: 1rem;
    }
    .warning-banner-content {
      flex: 1;
    }
    .warning-banner-content strong {
      display: block;
      margin-bottom: 0.125rem;
    }
    .warning-banner-content p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.75rem;
      line-height: 1.4;
    }
    .warning-dismiss {
      flex-shrink: 0;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 1.25rem;
      line-height: 1;
      padding: 0;
      opacity: 0.6;
    }
    .warning-dismiss:hover {
      opacity: 1;
    }

    /* Accordion Component */
    .accordion {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 0.375rem;
      margin-bottom: 0.75rem;
      overflow: hidden;
    }
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--gray-50);
      border: none;
      cursor: pointer;
      text-align: left;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      transition: background 0.15s ease;
    }
    .accordion-header:hover {
      background: var(--gray-100);
    }
    .accordion-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }
    .accordion-toggle {
      font-size: 0.625rem;
      color: var(--text-muted);
      transition: transform 0.2s ease;
    }
    .accordion.collapsed .accordion-toggle {
      transform: rotate(-90deg);
    }
    .accordion.collapsed .accordion-body {
      display: none;
    }
    .accordion-body {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border-color);
    }

    /* Compact File Grid */
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.25rem 1rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .file-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.8125rem;
      padding: 0.125rem 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-item.uploaded {
      color: var(--success);
    }
    .file-item.pending {
      color: var(--text-muted);
    }
    .file-item .file-icon {
      flex-shrink: 0;
      font-size: 0.875rem;
    }
    .file-item .file-name {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Linear Progress Bar */
    .progress-linear {
      height: 0.5rem;
      background: var(--gray-200);
      border-radius: 9999px;
      overflow: hidden;
      flex: 1;
      max-width: 120px;
    }
    .progress-linear-fill {
      height: 100%;
      background: var(--success);
      border-radius: 9999px;
      transition: width 0.3s ease;
    }
    .accordion-progress {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Step Navigation */
    .step-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    .step-nav .btn-primary {
      margin-left: auto;
    }

    /* Instructions accordion content */
    .instructions-content {
      font-size: 0.8125rem;
    }
    .instructions-content ol {
      margin: 0;
      padding-left: 1.25rem;
    }
    .instructions-content li {
      margin: 0.375rem 0;
    }

    /* Supplementary files in accordion */
    .supp-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.5rem;
    }
    .supp-file {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--gray-50);
      border-radius: 0.25rem;
      font-size: 0.8125rem;
    }
    .supp-file a {
      color: var(--link-color);
      text-decoration: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .supp-file a:hover {
      text-decoration: underline;
    }
    .supp-file .supp-count {
      font-size: 0.6875rem;
      color: var(--text-muted);
      margin-left: auto;
      flex-shrink: 0;
    }

    /* Step content wrapper */
    .step-content-wrapper {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Primary action (centered button with hint) */
    .primary-action {
      text-align: center;
      padding: 1.5rem;
      background: var(--bg-card);
      border-radius: 0.5rem;
      border: 2px solid var(--primary);
    }
    .primary-action .btn-large {
      padding: 0.875rem 2rem;
      font-size: 1rem;
    }
    .action-hint {
      margin-top: 0.75rem;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    /* Info banner */
    .info-banner {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(99, 102, 241, 0.08);
      border-radius: 0.375rem;
      border: 1px solid rgba(99, 102, 241, 0.2);
    }
    .info-banner-icon {
      font-size: 1rem;
      flex-shrink: 0;
    }
    .info-banner-content {
      flex: 1;
    }
    .info-banner-content strong {
      font-size: 0.8125rem;
      display: block;
      margin-bottom: 0.125rem;
    }
    .info-banner-content p {
      margin: 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Upload form inline (for TM step) */
    .upload-form-inline {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      margin-top: 0.5rem;
    }
    .upload-form-inline input[type="file"] {
      display: none;
    }

    /* Step action buttons (download + git commit side by side) */
    .step-action-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Git commit button states */
    #git-commit-btn {
      min-width: 120px;
      transition: all 0.2s ease;
    }
    #git-commit-btn.btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    #git-commit-btn.btn-danger {
      background: var(--error);
      color: white;
      border-color: var(--error);
    }

    /* Inline spinner for buttons */
    .spinner {
      display: inline-block;
      width: 0.875rem;
      height: 0.875rem;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      vertical-align: middle;
      margin-right: 0.25rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile: Sticky Nav */
    @media (max-width: 768px) {
      .step-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-card);
        padding: 1rem;
        margin: 0;
        border-top: 1px solid var(--border-color);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }
      .mt-upload-content {
        padding-bottom: 5rem;
      }
      .file-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      .step-header {
        flex-direction: column;
        gap: 1rem;
      }
      .step-header-right {
        align-self: flex-start;
      }
      .step-action-buttons {
        flex-direction: column;
        width: 100%;
      }
      .step-action-buttons .btn {
        width: 100%;
      }
    }

    /* ==========================================
       Publication Modal & Buttons
       ========================================== */

    /* Modal overlay and container */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      position: relative;
      background: var(--bg-card);
      border-radius: 0.5rem;
      padding: 1.5rem;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    .modal-content h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1.125rem;
    }
    .modal-content p {
      margin: 0 0 1rem 0;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    .modal-warning {
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-top: 0.75rem;
      font-size: 0.8125rem;
    }
    .overwrite-list, .create-list {
      list-style: none;
      margin: 0.5rem 0;
      padding: 0;
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.8125rem;
    }
    .overwrite-list li, .create-list li {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      margin: 0.125rem 0;
    }
    .overwrite-list li {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }
    .create-list li {
      background: var(--gray-50);
      color: var(--text-secondary);
    }

    /* Publication action box */
    .publication-action {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: 0.375rem;
      border: 1px solid var(--border-color);
    }
    .publication-action h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin: 0 0 0.5rem 0;
      color: var(--text-secondary);
    }
    .publication-action p {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin: 0 0 0.75rem 0;
    }
    .publication-action .btn-publish {
      background: var(--success);
      color: white;
      border: 1px solid var(--success);
    }
    .publication-action .btn-publish:hover {
      background: #059669;
      border-color: #059669;
    }
    .publication-action .btn-publish:disabled {
      background: var(--gray-300);
      border-color: var(--gray-300);
      cursor: not-allowed;
    }

    /* Section publish list */
    .section-publish-list {
      margin-top: 1rem;
    }
    .section-publish-list h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      color: var(--text-secondary);
    }
    .section-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      background: var(--gray-50);
      margin-bottom: 0.375rem;
    }
    .section-row.published {
      background: rgba(16, 185, 129, 0.08);
    }
    .section-name {
      flex: 1;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .section-status {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .section-row.published .section-status {
      color: var(--success);
    }
    .section-row .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.6875rem;
    }
    .section-row .btn-publish-section {
      background: var(--success);
      color: white;
      border: 1px solid var(--success);
    }
    .section-row .btn-publish-section:hover {
      background: #059669;
    }

    /* Published badge */
    .published-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border-radius: 9999px;
      font-size: 0.6875rem;
      font-weight: 500;
    }
  </style>
</body>
</html>
