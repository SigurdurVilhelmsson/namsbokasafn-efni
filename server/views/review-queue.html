<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yfirfer\u00f0arr\u00f6\u00f0 - N\u00e1msb\u00f3kasafn</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header class="header">
    <h1>Námsbókasafn</h1>
    <nav>
      <a href="/my-work">Mín verkefni</a>
      <a href="/workflow">Verkflæði</a>
      <a href="/status">Framvinda</a>
      <a href="/segment-editor">Ritstjóri</a>
      <a href="/terminology">Orðasafn</a>
      <a href="/review-queue" class="active">Yfirferðarröð</a>
      <span class="nav-separator admin-only"></span>
      <a href="/dashboard" class="admin-only">Stjórnborð</a>
      <a href="/admin" class="admin-only admin-link">Stjórnandi</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" title="Skipta um þema">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Yfirferðarröð</h2>
        <div class="filter-controls">
          <select id="book-filter" class="form-select form-select-small">
            <option value="efnafraedi" selected>Efnafræði</option>
            <option value="liffraedi">Líffræði</option>
          </select>
        </div>
      </div>

      <div id="queue-content">
        <p class="loading"><i class="fas fa-spinner fa-spin"></i> Hleður...</p>
      </div>
    </div>
  </main>

  <script src="/js/htmlUtils.js"></script>
  <script>
    async function init() {
      // Check auth
      const authRes = await fetch('/api/auth/me');
      const authData = await authRes.json();
      const userEl = document.getElementById('user-info');

      if (!authData.authenticated) {
        userEl.innerHTML = '<a href="/api/auth/login?redirect=/review-queue" class="btn btn-primary">Innskráning</a>';
        document.getElementById('queue-content').innerHTML =
          '<div class="empty-state"><p>Skráðu þig inn til að sjá yfirferðarröðina.</p></div>';
        return;
      }

      userEl.innerHTML = '<img src="' + escapeHtml(authData.user.avatar) + '" alt=""><span>' + escapeHtml(authData.user.name) + '</span>';

      // Load queue
      loadQueue();

      // Re-fetch when filter changes
      document.getElementById('book-filter').addEventListener('change', loadQueue);
    }

    async function loadQueue() {
      const container = document.getElementById('queue-content');
      const book = document.getElementById('book-filter').value;

      container.innerHTML = '<p class="loading"><i class="fas fa-spinner fa-spin"></i> Hleður...</p>';

      try {
        const res = await fetch('/api/segment-editor/review-queue?book=' + encodeURIComponent(book));
        if (!res.ok) {
          throw new Error('Þjónn svaraði með stöðu ' + res.status);
        }
        const data = await res.json();

        if (!data.reviews || data.reviews.length === 0) {
          container.innerHTML =
            '<div class="empty-state">' +
              '<i class="fas fa-check-circle"></i>' +
              '<p>Engar yfirferðir í bið</p>' +
            '</div>';
          return;
        }

        renderTable(data.reviews, book);
      } catch (err) {
        container.innerHTML = '<div class="alert alert-error">' + escapeHtml(err.message) + '</div>';
      }
    }

    function renderTable(reviews, book) {
      const container = document.getElementById('queue-content');

      let html = '<table class="table rq-table">' +
        '<thead><tr>' +
          '<th>Kafli</th>' +
          '<th>Eining</th>' +
          '<th>Ritstjóri</th>' +
          '<th>Sent</th>' +
          '<th>Breytingar</th>' +
          '<th>SLA</th>' +
          '<th></th>' +
        '</tr></thead>' +
        '<tbody>';

      for (const r of reviews) {
        const slaClass = slaToClass(r.sla);
        const slaLabel = slaToLabel(r.sla);
        const submittedDate = r.submitted_at ? new Date(r.submitted_at).toLocaleDateString('is-IS') : '-';
        const moduleId = r.module_id || '-';
        const chapter = r.chapter || '-';
        const editor = r.submitted_by_username || '-';

        const pending = r.pending_edits || 0;
        const approved = r.approved_edits || 0;
        const rejected = r.rejected_edits || 0;
        const discuss = r.discuss_edits || 0;

        const editorUrl = '/segment-editor?book=' + encodeURIComponent(book) +
          '&chapter=' + encodeURIComponent(chapter) +
          '&module=' + encodeURIComponent(moduleId) +
          '&reviewId=' + encodeURIComponent(r.id);

        html += '<tr class="' + slaClass + '">' +
          '<td>' + escapeHtml(String(chapter)) + '</td>' +
          '<td><code>' + escapeHtml(String(moduleId)) + '</code></td>' +
          '<td>' + escapeHtml(String(editor)) + '</td>' +
          '<td>' + escapeHtml(submittedDate) + '</td>' +
          '<td class="rq-badges">' +
            (pending > 0 ? '<span class="rq-badge rq-badge-pending">' + pending + ' bid</span>' : '') +
            (approved > 0 ? '<span class="rq-badge rq-badge-approved">' + approved + ' samth.</span>' : '') +
            (rejected > 0 ? '<span class="rq-badge rq-badge-rejected">' + rejected + ' hafn.</span>' : '') +
            (discuss > 0 ? '<span class="rq-badge rq-badge-discuss">' + discuss + ' umr.</span>' : '') +
            ((pending + approved + rejected + discuss === 0) ? '<span class="text-muted">-</span>' : '') +
          '</td>' +
          '<td><span class="rq-sla ' + slaClass + '">' + escapeHtml(slaLabel) + '</span></td>' +
          '<td><a href="' + editorUrl + '" class="btn btn-primary btn-small">Yfirfara</a></td>' +
        '</tr>';
      }

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function slaToClass(sla) {
      if (!sla) return 'sla-on-track';
      const map = {
        'on-track': 'sla-on-track',
        'at-risk': 'sla-at-risk',
        'overdue': 'sla-overdue',
        'critical': 'sla-critical'
      };
      return map[sla] || 'sla-on-track';
    }

    function slaToLabel(sla) {
      if (!sla) return 'Á réttri leið';
      const map = {
        'on-track': 'Á réttri leið',
        'at-risk': 'Á mörkum',
        'overdue': 'Yfir tíma',
        'critical': 'Mjög seint'
      };
      return map[sla] || sla;
    }

    // Initialize
    init();
  </script>

  <style>
    /* Review Queue specific styles */
    .rq-table th { white-space: nowrap; }
    .rq-table code { font-size: 0.8rem; background: var(--gray-100); padding: 0.125rem 0.375rem; border-radius: 0.25rem; }

    .rq-badges { display: flex; gap: 0.375rem; flex-wrap: wrap; }

    .rq-badge {
      display: inline-block;
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      white-space: nowrap;
    }
    .rq-badge-pending { background: #dbeafe; color: #1e40af; }
    .rq-badge-approved { background: #dcfce7; color: #166534; }
    .rq-badge-rejected { background: #fee2e2; color: #991b1b; }
    .rq-badge-discuss { background: #fef3c7; color: #92400e; }

    .rq-sla {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.625rem;
      border-radius: 9999px;
      white-space: nowrap;
    }
    .rq-sla.sla-on-track { background: #dcfce7; color: #166534; }
    .rq-sla.sla-at-risk { background: #fef3c7; color: #92400e; }
    .rq-sla.sla-overdue { background: #fed7aa; color: #9a3412; }
    .rq-sla.sla-critical { background: #fee2e2; color: #991b1b; }

    /* Row highlighting based on SLA */
    tr.sla-critical { background: #fef2f2; }
    tr.sla-critical:hover { background: #fee2e2; }
    tr.sla-overdue { background: #fffbeb; }
    tr.sla-overdue:hover { background: #fef3c7; }
    tr.sla-at-risk { background: #fefce8; }
    tr.sla-at-risk:hover { background: #fef9c3; }

    .empty-state { text-align: center; padding: 3rem; color: var(--gray-500); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; display: block; color: var(--success); }
    .text-muted { color: var(--gray-500); }

    /* Category badges */
    .category-badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-size: 0.7rem;
      background: #f3f4f6;
      color: #6b7280;
    }
    .category-badge.terminology { background: #dbeafe; color: #1e40af; }
    .category-badge.accuracy { background: #fee2e2; color: #991b1b; }
    .category-badge.readability { background: #f0fdf4; color: #166534; }
    .category-badge.style { background: #f3e8ff; color: #7c3aed; }
    .category-badge.omission { background: #fef3c7; color: #92400e; }
  </style>

  <script src="/js/theme.js"></script>
  <script src="/js/nav.js"></script>
</body>
</html>
