<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ritstjóri - Námsbókasafn</title>
  <link rel="stylesheet" href="/css/common.css">
  <style>
    /* ================================================================
       SEGMENT EDITOR — Basalt & Vellum page-specific styles
       ================================================================ */

    /* --- Module selector card --- */
    .selector-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
    }

    .selector-card h2 {
      font-family: var(--font-heading);
      font-size: var(--text-xl);
      margin-bottom: var(--spacing-md);
    }

    .selector-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .selector-grid label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
    }

    .selector-grid select {
      width: 100%;
      padding: var(--spacing-sm) 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      font-family: var(--font-body);
      background: var(--bg-elevated);
      color: var(--text-primary);
      cursor: pointer;
      transition: border-color var(--transition-fast);
    }

    .selector-grid select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(200,121,65,0.15);
    }

    .selector-grid select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- Modules list --- */
    .modules-list h3 {
      font-family: var(--font-heading);
      font-size: var(--text-lg);
      margin-bottom: var(--spacing-sm);
    }

    .module-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.75rem var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .module-card:hover {
      border-color: var(--accent);
      background: var(--accent-subtle);
    }

    .module-card strong {
      font-family: var(--font-mono);
      font-size: var(--text-base);
    }

    .module-card .module-badges {
      display: flex;
      gap: var(--spacing-sm);
    }

    .module-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
    }

    .module-badge.en {
      background: var(--success-subtle);
      color: var(--success);
    }

    .module-badge.mt {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    .module-badge.faithful {
      background: var(--success-subtle);
      color: var(--success);
    }

    /* --- Module header bar --- */
    .module-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .module-header h2 {
      font-family: var(--font-heading);
      font-size: var(--text-lg);
      margin: 0;
    }

    .module-meta {
      color: var(--text-muted);
      font-size: var(--text-sm);
      margin-top: 0.125rem;
    }

    .module-toolbar {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    /* --- Stats bar --- */
    .stats-bar {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .stat-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .stat-chip strong {
      font-weight: 600;
      color: var(--text-primary);
    }

    .stat-chip.has-value strong {
      color: var(--accent);
    }

    .stat-chip.terms {
      background: var(--success-subtle);
      border-color: var(--success);
    }

    .stat-chip.terms strong {
      color: var(--success);
    }

    .stat-chip.term-issues {
      background: var(--warning-subtle);
      border-color: var(--warning);
    }

    .stat-chip.term-issues strong {
      color: var(--warning);
    }

    /* --- Filter bar --- */
    .filter-bar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: var(--spacing-md);
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-bar label {
      font-size: var(--text-sm);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .filter-bar select {
      padding: 0.35rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: var(--font-body);
      background: var(--bg-elevated);
      color: var(--text-primary);
      cursor: pointer;
      transition: border-color var(--transition-fast);
    }

    .filter-bar select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* --- Category legend --- */
    .category-legend {
      margin: 0.25rem 0 var(--spacing-sm);
      font-size: var(--text-sm);
    }

    .category-legend summary {
      cursor: pointer;
      color: var(--text-muted);
      font-size: var(--text-sm);
    }

    .category-legend .legend-items {
      display: flex;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      padding: var(--spacing-sm) 0;
    }

    /* --- Segment table --- */
    .segments-table {
      width: 100%;
      border-collapse: collapse;
    }

    .segments-table th {
      text-align: left;
      padding: 0.625rem 0.75rem;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      border-bottom: 2px solid var(--border-strong);
      white-space: nowrap;
    }

    .segments-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .col-type { width: 6%; }
    .col-en { width: 38%; }
    .col-is { width: 38%; }
    .col-actions { width: 18%; text-align: center; }

    /* --- Segment row states --- */
    .segment-row {
      background: var(--bg-surface);
      transition: background var(--transition-fast);
    }

    .segment-row:hover {
      background: var(--bg-hover);
    }

    .segment-row.has-edit {
      background: var(--accent-subtle);
    }

    .segment-row.approved {
      background: var(--success-subtle);
    }

    .segment-row.rejected {
      background: var(--error-subtle);
    }

    .segment-row.discuss {
      background: var(--warning-subtle);
    }

    .segment-row.no-translation {
      background: var(--warning-subtle);
    }

    .segment-row.no-translation .col-is .segment-content {
      color: var(--warning);
      font-style: italic;
    }

    /* Active editing row — copper left border */
    .segment-row.editing {
      border-left: 4px solid var(--accent);
    }

    /* --- Segment type badge --- */
    .segment-type-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      background: var(--bg-elevated);
      color: var(--text-muted);
    }

    .segment-type-badge.title {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    .segment-type-badge.para {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }

    .segment-type-badge.caption {
      background: var(--warning-subtle);
      color: var(--warning);
    }

    /* --- Segment content --- */
    .segment-content {
      font-size: var(--text-base);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow-y: auto;
    }

    /* --- Diff display --- */
    .diff-hint {
      margin-top: 0.375rem;
      padding: 0.25rem 0.5rem;
      font-size: var(--text-sm);
      background: var(--bg-elevated);
      border-left: 2px solid var(--border);
      border-radius: var(--radius-sm);
      line-height: 1.6;
    }

    .diff-del {
      background: var(--error-subtle);
      color: var(--error);
      text-decoration: line-through;
      border-radius: var(--radius-sm);
      padding: 0 1px;
    }

    .diff-ins {
      background: var(--success-subtle);
      color: var(--success);
      text-decoration: none;
      border-radius: var(--radius-sm);
      padding: 0 1px;
    }

    /* --- Original text hint --- */
    .original-text {
      margin-top: 0.375rem;
      padding: 0.25rem 0.5rem;
      font-size: var(--text-sm);
      color: var(--text-muted);
      background: var(--bg-elevated);
      border-left: 2px solid var(--border);
      border-radius: var(--radius-sm);
      text-decoration: line-through;
      opacity: 0.7;
    }

    /* --- Edit panel (inline) --- */
    .edit-panel {
      display: none;
      margin-top: var(--spacing-sm);
      padding: 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
    }

    .edit-panel.active {
      display: block;
    }

    .edit-panel textarea {
      width: 100%;
      min-height: 80px;
      padding: var(--spacing-sm);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: var(--text-base);
      line-height: 1.6;
      resize: vertical;
      background: var(--bg-base);
      color: var(--text-primary);
      transition: border-color var(--transition-fast);
    }

    .edit-panel textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(200,121,65,0.15);
    }

    .edit-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      margin-top: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .edit-controls select {
      padding: 0.35rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: var(--font-body);
      background: var(--bg-elevated);
      color: var(--text-primary);
      cursor: pointer;
    }

    .edit-controls select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .edit-controls input[type="text"] {
      flex: 1;
      min-width: 150px;
      padding: 0.35rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: var(--font-body);
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .edit-controls input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* --- Action buttons --- */
    .btn-edit {
      font-size: var(--text-sm);
      padding: 0.3rem 0.6rem;
    }

    .btn-approve,
    .btn-reject,
    .btn-discuss {
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: var(--text-sm);
      font-family: var(--font-body);
      color: white;
      transition: filter var(--transition-fast);
    }

    .btn-approve { background: var(--success); }
    .btn-reject { background: var(--error); }
    .btn-discuss { background: var(--warning); }
    .btn-approve:hover { filter: brightness(1.1); }
    .btn-reject:hover { filter: brightness(1.1); }
    .btn-discuss:hover { filter: brightness(1.1); }

    /* --- Edit status badges --- */
    .edit-status {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
    }

    .edit-status.pending {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    .edit-status.approved {
      background: var(--success-subtle);
      color: var(--success);
    }

    .edit-status.rejected {
      background: var(--error-subtle);
      color: var(--error);
    }

    .edit-status.discuss {
      background: var(--warning-subtle);
      color: var(--warning);
    }

    /* --- Category badges --- */
    .category-badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      background: var(--bg-elevated);
      color: var(--text-muted);
    }

    .category-badge.terminology {
      background: var(--accent-subtle);
      color: var(--accent);
    }

    .category-badge.accuracy {
      background: var(--error-subtle);
      color: var(--error);
    }

    .category-badge.readability {
      background: var(--success-subtle);
      color: var(--success);
    }

    .category-badge.style {
      background: var(--info-subtle);
      color: var(--info);
    }

    .category-badge.omission {
      background: var(--warning-subtle);
      color: var(--warning);
    }

    /* --- Review actions --- */
    .review-actions {
      display: flex;
      gap: 0.25rem;
      justify-content: center;
    }

    /* --- Discussion thread --- */
    .discussion-thread {
      margin-top: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }

    .discussion-comment {
      padding: 0.25rem 0;
      border-bottom: 1px solid var(--border);
    }

    .discussion-comment:last-child { border-bottom: none; }
    .discussion-author { font-weight: 600; }
    .discussion-time { color: var(--text-muted); font-size: var(--text-xs); }

    /* --- Math placeholder --- */
    .math-placeholder {
      display: inline;
      padding: 0.1rem 0.3rem;
      background: var(--info-subtle);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: var(--text-sm);
      color: var(--info);
    }

    /* --- Term highlighting --- */
    .term-highlight {
      background: var(--success-subtle);
      border-bottom: 2px solid var(--success);
      cursor: pointer;
      padding: 0 1px;
      border-radius: var(--radius-sm);
      transition: background var(--transition-fast);
    }

    .term-highlight:hover {
      background: rgba(91,154,111,0.25);
    }

    .term-highlight.proposed {
      border-bottom-color: var(--warning);
      background: var(--warning-subtle);
    }

    .term-highlight.proposed:hover {
      background: rgba(196,150,58,0.25);
    }

    /* --- Term issue indicators --- */
    .term-issue {
      display: flex;
      align-items: flex-start;
      gap: 0.4rem;
      padding: 0.3rem 0.5rem;
      margin-top: 0.35rem;
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      line-height: 1.3;
    }

    .term-issue.inconsistent {
      background: var(--warning-subtle);
      border-left: 3px solid var(--warning);
      color: var(--warning);
    }

    .term-issue.missing {
      background: var(--bg-elevated);
      border-left: 3px solid var(--text-muted);
      color: var(--text-muted);
    }

    .term-issue-icon { flex-shrink: 0; }

    /* --- Term popup --- */
    .term-popup {
      display: none;
      position: absolute;
      z-index: 100;
      min-width: 280px;
      max-width: 360px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-modal);
      padding: 0.75rem;
      font-size: var(--text-sm);
    }

    .term-popup.active { display: block; }

    .term-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--border);
    }

    .term-popup-header strong {
      font-size: var(--text-base);
      font-family: var(--font-heading);
    }

    .term-popup-close {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      line-height: 1;
      transition: color var(--transition-fast);
    }

    .term-popup-close:hover { color: var(--text-primary); }

    .term-popup-row {
      display: flex;
      gap: var(--spacing-sm);
      padding: 0.2rem 0;
    }

    .term-popup-label {
      color: var(--text-muted);
      min-width: 70px;
      flex-shrink: 0;
    }

    .term-popup-value { font-weight: 500; }

    /* --- Term lookup --- */
    .term-lookup-container {
      position: relative;
      display: inline-block;
    }

    .term-lookup-input {
      width: 200px;
      padding: 0.35rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: var(--font-body);
      background: var(--bg-elevated);
      color: var(--text-primary);
      transition: border-color var(--transition-fast);
    }

    .term-lookup-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .term-lookup-results {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      box-shadow: var(--shadow-modal);
      z-index: 50;
    }

    .term-lookup-results.active { display: block; }

    .term-lookup-item {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      font-size: var(--text-sm);
      transition: background var(--transition-fast);
    }

    .term-lookup-item:hover { background: var(--bg-hover); }
    .term-lookup-item:last-child { border-bottom: none; }
    .term-lookup-en { font-weight: 600; }
    .term-lookup-is { color: var(--text-muted); }

    /* --- Pipeline panel --- */
    .pipeline-panel {
      margin-top: var(--spacing-md);
      padding: 0.75rem var(--spacing-md);
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
    }

    .pipeline-panel h4 {
      margin: 0 0 var(--spacing-sm) 0;
      font-size: var(--text-base);
      font-family: var(--font-heading);
    }

    .pipeline-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      flex-wrap: wrap;
    }

    .pipeline-controls label {
      font-size: var(--text-sm);
      color: var(--text-muted);
    }

    .pipeline-controls select {
      padding: 0.3rem 0.4rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-family: var(--font-body);
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .pipeline-output {
      display: none;
      margin-top: var(--spacing-sm);
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg-base);
      color: var(--text-secondary);
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      white-space: pre-wrap;
      word-break: break-all;
      border: 1px solid var(--border);
    }

    .pipeline-output.active { display: block; }

    .pipeline-status-badge {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
    }

    .pipeline-status-badge.running {
      background: var(--info-subtle);
      color: var(--info);
    }

    .pipeline-status-badge.completed,
    .pipeline-status-badge.success {
      background: var(--success-subtle);
      color: var(--success);
    }

    .pipeline-status-badge.failed {
      background: var(--error-subtle);
      color: var(--error);
    }

    /* --- Apply panel --- */
    .apply-panel {
      margin-top: 0.75rem;
      padding: 0.75rem var(--spacing-md);
      background: var(--success-subtle);
      border: 1px solid var(--success);
      border-radius: var(--radius-md);
    }

    .apply-panel h4 {
      margin: 0 0 var(--spacing-sm) 0;
      font-size: var(--text-base);
      font-family: var(--font-heading);
      color: var(--success);
    }

    .apply-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-apply {
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: var(--text-sm);
      font-family: var(--font-body);
      padding: 0.3rem 0.6rem;
      transition: filter var(--transition-fast);
    }

    .btn-apply:hover:not(:disabled) { filter: brightness(1.1); }
    .btn-apply:disabled { opacity: 0.5; cursor: not-allowed; }

    .apply-status {
      font-size: var(--text-sm);
      color: var(--text-muted);
    }

    .apply-status strong { color: var(--text-primary); }

    /* --- MT-incomplete warning banner --- */
    .mt-incomplete-banner {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem var(--spacing-md);
      background: var(--warning-subtle);
      border: 1px solid var(--warning);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
      font-size: var(--text-sm);
      color: var(--warning);
      font-weight: 500;
    }

    /* --- Editor container card --- */
    .editor-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
    }

    .editor-card .table-wrap {
      overflow-x: auto;
    }

    /* --- Save status bar --- */
    .save-status-bar {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: var(--radius-md); margin-bottom: var(--spacing-md);
      font-size: var(--text-sm); color: var(--text-secondary);
      transition: background 0.2s, border-color 0.2s;
    }
    .save-status-bar.has-unsaved {
      border-color: var(--warning); background: var(--warning-subtle);
    }
    .save-status-bar.all-saved {
      border-color: var(--success); background: var(--success-subtle);
    }
    .save-status-bar.saving {
      border-color: var(--accent); background: var(--accent-subtle);
    }
    .save-status-dot { font-size: 0.6rem; }
    .save-status-bar.has-unsaved .save-status-dot { color: var(--warning); }
    .save-status-bar.all-saved .save-status-dot { color: var(--success); }
    .save-status-bar.saving .save-status-dot { color: var(--accent); }
    .save-status-time { margin-left: auto; font-size: var(--text-xs); color: var(--text-muted); }

    /* --- Per-segment save indicators --- */
    .seg-save-ind { font-size: var(--text-xs); margin-left: 0.5rem; }
    .seg-save-ind.dirty { color: var(--warning); }
    .seg-save-ind.saving { color: var(--accent); }
    .seg-save-ind.saved { color: var(--success); }
  </style>
</head>
<body>
  <main class="page-content page-wide" id="main-content" data-page="editor" data-title="Ritstjóri">

    <!-- ============================================================
         MODULE SELECTOR
         ============================================================ -->
    <div class="selector-card" id="module-selector">
      <h2>Velja einingu til að ritstýra</h2>
      <div class="selector-grid">
        <div>
          <label for="book-select">Bók</label>
          <select id="book-select">
            <option value="">Veldu bók...</option>
            <option value="efnafraedi">Efnafræði</option>
          </select>
        </div>
        <div>
          <label for="chapter-select">Kafli</label>
          <select id="chapter-select" disabled>
            <option value="">Veldu kafla...</option>
          </select>
        </div>
      </div>
      <div id="modules-list" style="display: none;">
        <h3>Einingar í kafla:</h3>
        <div id="modules-container"></div>
      </div>
    </div>

    <!-- ============================================================
         SEGMENT EDITOR
         ============================================================ -->
    <div id="editor-container" style="display: none;">
      <div class="module-header">
        <div>
          <h2 id="module-title"></h2>
          <div class="module-meta" id="module-meta"></div>
        </div>
        <div class="module-toolbar">
          <button class="btn btn-secondary btn-sm" id="btn-back" title="Til baka">
            &#8592; Til baka
          </button>
          <button class="btn btn-primary btn-sm" id="btn-submit" title="Sendir allar breytingar til yfirferðar hjá aðalritstjóra">
            Senda til yfirlestrar
          </button>
        </div>
      </div>

      <!-- Pipeline Panel (HEAD_EDITOR only) -->
      <div class="pipeline-panel" id="pipeline-panel" style="display: none;">
        <h4 title="Setur þýðingar inn í CNXML skrár (inject) og breytir í HTML (render) til birtingar á vef">Ferill (inject &#8594; render)</h4>
        <div class="pipeline-controls">
          <label>Rás:</label>
          <select id="pipeline-track">
            <option value="faithful">Hrein þýðing (faithful)</option>
            <option value="mt-preview">MT forskoðun</option>
            <option value="localized">Staðfærð (localized)</option>
          </select>
          <button class="btn btn-secondary btn-sm" id="btn-inject" title="Keyra inject">
            Inject
          </button>
          <button class="btn btn-secondary btn-sm" id="btn-render" title="Keyra render">
            Render
          </button>
          <button class="btn btn-primary btn-sm" id="btn-pipeline" title="Keyra inject + render">
            Inject + Render
          </button>
          <span class="pipeline-status-badge" id="pipeline-badge" style="display: none;"></span>
        </div>
        <div class="pipeline-output" id="pipeline-output"></div>
      </div>

      <!-- Apply Panel (HEAD_EDITOR only) -->
      <div class="apply-panel" id="apply-panel" style="display: none;">
        <h4>Vista samþykkt í skrár</h4>
        <div class="apply-controls">
          <span class="apply-status" id="apply-status">Hleður...</span>
          <button class="btn btn-apply" id="btn-apply" disabled title="Vista samþykktar breytingar í 03-faithful-translation/ skrár">
            Vista í skrár
          </button>
          <button class="btn btn-apply" id="btn-apply-render" disabled title="Vista í skrár og keyra inject + render" style="background: var(--accent);">
            Vista + Render
          </button>
          <span class="pipeline-status-badge" id="apply-badge" style="display: none;"></span>
        </div>
      </div>

      <div class="editor-card">
        <div class="save-status-bar" id="save-status-bar" style="display:none">
          <span class="save-status-dot" id="save-status-dot">&#9679;</span>
          <span id="save-status-text">Engar breytingar</span>
          <span class="save-status-time" id="save-status-time"></span>
        </div>
        <div class="stats-bar" id="stats-bar"></div>

        <div class="filter-bar">
          <label>Sýna:</label>
          <select id="filter-type">
            <option value="all">Allir hlutar</option>
            <option value="edited">Með breytingum</option>
            <option value="pending">Bíður yfirlestrar</option>
            <option value="term-issues">Hugtakavandamál</option>
            <option value="title">Titlar</option>
            <option value="para">Málsgreinar</option>
          </select>
          <label>Flokkur:</label>
          <select id="filter-category">
            <option value="all">Allir flokkar</option>
            <option value="terminology">Hugtök</option>
            <option value="accuracy">Nákvæmni</option>
            <option value="readability">Læsileiki</option>
            <option value="style">Stíll</option>
            <option value="omission">Úrfelling</option>
          </select>
          <div style="margin-left: auto;" class="term-lookup-container">
            <input type="text" class="term-lookup-input" id="term-lookup" placeholder="Fletta upp hugtaki..." autocomplete="off">
            <div class="term-lookup-results" id="term-lookup-results"></div>
          </div>
        </div>

        <details class="category-legend">
          <summary>Litaskýring flokka</summary>
          <div class="legend-items">
            <span class="category-badge terminology">Hugtök — fagorð og skilgreiningar</span>
            <span class="category-badge accuracy">Nákvæmni — efnislegir gallar</span>
            <span class="category-badge readability">Læsileiki — málfar og lestur</span>
            <span class="category-badge style">Stíll — tónn og orðalag</span>
            <span class="category-badge omission">Úrfelling — vantar efni</span>
          </div>
        </details>

        <div class="table-wrap">
          <table class="segments-table">
            <thead>
              <tr>
                <th class="col-type">Tegund</th>
                <th class="col-en">Enska (frumtexti)</th>
                <th class="col-is">Íslenska (þýðing)</th>
                <th class="col-actions">Aðgerðir</th>
              </tr>
            </thead>
            <tbody id="segments-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Term Popup (positioned absolutely) -->
    <div class="term-popup" id="term-popup">
      <div class="term-popup-header">
        <strong id="term-popup-en"></strong>
        <button class="term-popup-close" onclick="closeTermPopup()">&times;</button>
      </div>
      <div id="term-popup-body"></div>
    </div>

  </main>

  <script src="/js/layout.js"></script>
  <script src="/js/theme.js"></script>
  <script src="/js/htmlUtils.js"></script>
  <script src="/js/saveRetry.js"></script>
  <script src="/js/tabGuard.js"></script>
  <script>
    // ================================================================
    // STATE
    // ================================================================
    let currentBook = '';
    let currentChapter = 0;
    let currentModuleId = '';
    let moduleData = null;
    let termData = null; // Per-segment term matches and issues
    let userRole = 'viewer';
    let userName = null;
    let termLookupTimer = null;
    const dirtyEdits = new Set(); // Track segment IDs with unsaved textarea edits
    let draftTimer = null;
    let lastServerSaveTime = null;
    const recentlySaved = new Set(); // Track recently saved segment IDs for indicators

    // ================================================================
    // SAVE STATUS BAR
    // ================================================================

    function updateSaveStatusBar() {
      const bar = document.getElementById('save-status-bar');
      if (!bar) return;
      const count = dirtyEdits.size;
      bar.classList.remove('has-unsaved', 'all-saved', 'saving');
      if (count > 0) {
        bar.classList.add('has-unsaved');
        document.getElementById('save-status-text').textContent =
          count === 1 ? '1 óvistuð breyting' : count + ' óvistaðar breytingar';
      } else {
        bar.classList.add('all-saved');
        document.getElementById('save-status-text').textContent = 'Allar breytingar vistaðar';
      }
      document.getElementById('save-status-time').textContent = lastServerSaveTime
        ? 'Síðast vistað: ' + new Date(lastServerSaveTime).toLocaleTimeString('is-IS', { hour: '2-digit', minute: '2-digit' })
        : '';
    }

    // ================================================================
    // DRAFT PERSISTENCE (localStorage)
    // ================================================================

    function draftKey() {
      return 'seg-draft:' + currentBook + '/' + currentChapter + '/' + currentModuleId + ':' + tabGuard.tabId;
    }

    function draftPrefix() {
      return 'seg-draft:' + currentBook + '/' + currentChapter + '/' + currentModuleId + ':';
    }

    function saveDraft() {
      if (!currentModuleId || dirtyEdits.size === 0) {
        if (currentModuleId) localStorage.removeItem(draftKey());
        return;
      }
      const drafts = {};
      for (const segId of dirtyEdits) {
        const ta = document.getElementById('textarea-' + cssId(segId));
        if (ta) drafts[segId] = ta.value;
      }
      try {
        localStorage.setItem(draftKey(), JSON.stringify({ ts: Date.now(), drafts }));
      } catch (e) { /* quota exceeded */ }
    }

    function clearDraft() {
      if (currentModuleId) tabGuard.clearDraftsByPrefix(draftPrefix());
    }

    function startDraftTimer() {
      if (draftTimer) clearInterval(draftTimer);
      draftTimer = setInterval(saveDraft, 5000);
    }

    function restoreDraft() {
      const found = tabGuard.findNewestDraft(draftPrefix());
      if (!found) return;
      try {
        const draft = found.data;
        if (Date.now() - draft.ts > 7 * 24 * 60 * 60 * 1000) {
          tabGuard.clearDraftsByPrefix(draftPrefix());
          return;
        }
        const ids = Object.keys(draft.drafts);
        if (ids.length === 0) return;
        if (!confirm('Fundust ' + ids.length + ' óvistuð drög frá síðustu lotu. Endurheimta?')) {
          tabGuard.clearDraftsByPrefix(draftPrefix());
          return;
        }
        for (const segId of ids) {
          openEditPanel(segId);
          const ta = document.getElementById('textarea-' + cssId(segId));
          if (ta) {
            ta.value = draft.drafts[segId];
            dirtyEdits.add(segId);
          }
        }
        // Clean up all tab-specific drafts after restore
        tabGuard.clearDraftsByPrefix(draftPrefix());
        updateSaveStatusBar();
      } catch (e) {
        tabGuard.clearDraftsByPrefix(draftPrefix());
      }
    }

    /** Get effective role (respects admin role preview override) */
    function getEffectiveRole() {
      if (window.navUtils && typeof window.navUtils.getEffectiveRole === 'function') {
        return window.navUtils.getEffectiveRole(userRole);
      }
      return userRole;
    }

    const API_BASE = '/api/segment-editor';

    // ================================================================
    // AUTH
    // ================================================================
    async function checkAuth() {
      try {
        const data = await fetchJson('/api/auth/me', { credentials: 'include' });
        userRole = data.user?.role || 'viewer';
        userName = data.user?.username || null;
      } catch {
        window.location.href = '/api/auth/login?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
      }
    }

    // ================================================================
    // MODULE SELECTOR
    // ================================================================
    const bookSelect = document.getElementById('book-select');
    const chapterSelect = document.getElementById('chapter-select');

    bookSelect.addEventListener('change', () => {
      currentBook = bookSelect.value;
      chapterSelect.disabled = !currentBook;
      chapterSelect.innerHTML = '<option value="">Veldu kafla...</option>';
      document.getElementById('modules-list').style.display = 'none';

      if (currentBook) {
        // Chemistry has chapters 1-21 + appendices
        for (let i = 1; i <= 21; i++) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `Kafli ${i}`;
          chapterSelect.appendChild(opt);
        }
      }
    });

    chapterSelect.addEventListener('change', async () => {
      currentChapter = parseInt(chapterSelect.value, 10);
      if (!currentChapter) return;

      const container = document.getElementById('modules-container');
      container.innerHTML = '<div class="loading-state"><span class="spinner"></span><span>Hleður...</span></div>';
      document.getElementById('modules-list').style.display = 'block';

      try {
        const data = await fetchJson(`${API_BASE}/${currentBook}/${currentChapter}`, {
          credentials: 'include',
        });

        if (!data.modules || data.modules.length === 0) {
          container.innerHTML = '<p class="text-muted">Engar einingar fundust.</p>';
          return;
        }

        container.innerHTML = data.modules
          .map(
            (m) => `
            <div class="module-card" onclick="loadModule('${m.moduleId}')" title="Smelltu til að opna">
              <strong>${m.moduleId}</strong>
              <div class="module-badges">
                ${m.hasEnSource ? '<span class="module-badge en">EN</span>' : ''}
                ${m.hasMtOutput ? '<span class="module-badge mt">MT</span>' : ''}
                ${m.hasFaithful ? '<span class="module-badge faithful">Ritstýrt</span>' : ''}
              </div>
            </div>
          `
          )
          .join('');
      } catch (err) {
        container.innerHTML = `<p style="color: var(--error);">Villa: ${escapeHtml(err.message)}</p>`;
      }
    });

    // ================================================================
    // LOAD MODULE
    // ================================================================
    async function loadModule(moduleId) {
      currentModuleId = moduleId;

      try {
        moduleData = await fetchJson(`${API_BASE}/${currentBook}/${currentChapter}/${moduleId}`, {
          credentials: 'include',
        });

        // Claim module for cross-tab conflict detection
        tabGuard.claim('seg:' + currentBook + '/' + currentChapter + '/' + moduleId);

        document.getElementById('module-selector').style.display = 'none';
        document.getElementById('editor-container').style.display = 'block';

        renderModule();
        showPipelinePanel();
        showApplyPanel();
        restoreDraft();
        startDraftTimer();

        // Show save status bar and update it
        document.getElementById('save-status-bar').style.display = 'flex';
        updateSaveStatusBar();

        // Load term data in background (non-blocking)
        loadTermData(moduleId);
      } catch (err) {
        alert('Villa við að hlaða einingu: ' + err.message);
      }
    }

    async function loadTermData(moduleId) {
      const requestedModule = currentModuleId; // capture at call time
      try {
        const res = await fetch(
          `${API_BASE}/${currentBook}/${currentChapter}/${moduleId}/terms`,
          { credentials: 'include' }
        );
        if (!res.ok || currentModuleId !== requestedModule) return; // stale
        const data = await res.json();
        if (currentModuleId !== requestedModule) return; // stale after parse
        termData = data.termMatches || {};

        // Re-render to show term highlights and issues
        renderSegments();
        renderStats();
      } catch {
        // Term loading is non-critical, fail silently
        termData = null;
      }
    }

    // ================================================================
    // RENDER MODULE
    // ================================================================
    function renderModule() {
      document.getElementById('module-title').textContent =
        `${moduleData.moduleId} — ${moduleData.title}`;
      const sourceLabels = {
        'mt-output': 'MT — vélþýðing',
        'faithful': 'Ritstýrt — yfirfarin þýðing',
        'localized': 'Staðfærð — aðlöguð að íslensku samhengi',
      };
      const sourceLabel = sourceLabels[moduleData.isSource] || moduleData.isSource || 'engin';
      const metaEl = document.getElementById('module-meta');
      const missing = moduleData.segmentCount - moduleData.translatedCount;
      let metaText =
        `Kafli ${moduleData.chapter} · ${moduleData.segmentCount} bútar · ` +
        `${moduleData.translatedCount} þýddar · Heimild: ${sourceLabel}`;
      if (missing > 0) {
        metaText += ` · ${missing} óþýdd(ar)`;
      }
      metaEl.innerHTML = missing > 0
        ? metaText.replace(`${missing} óþýdd(ar)`, `<span style="color: var(--warning); font-weight: 600;">${missing} óþýdd(ar)</span>`)
        : metaText;
      metaEl.title = 'MT = óyfirfarin vélþýðing · Yfirlesið = mannlegri yfirferð lokið · Staðfærð = aðlöguð að Íslandi';

      // Update topbar breadcrumb
      const topbarTitle = document.getElementById('topbar-title');
      if (topbarTitle) {
        topbarTitle.textContent = `Ritstjóri — ${moduleData.moduleId}`;
      }

      renderStats();
      renderSegments();
    }

    function renderStats() {
      const s = moduleData.stats || {};
      const bar = document.getElementById('stats-bar');

      // Count term matches and issues
      let termMatchCount = 0;
      let termIssueCount = 0;
      if (termData) {
        for (const segId of Object.keys(termData)) {
          termMatchCount += (termData[segId].matches || []).length;
          termIssueCount += (termData[segId].issues || []).length;
        }
      }

      const chipVal = (n) => n > 0 ? ' has-value' : '';

      bar.innerHTML = `
        <div class="stat-chip${chipVal(s.total_edits)}"><strong>${s.total_edits || 0}</strong> breytingar</div>
        <div class="stat-chip${chipVal(s.pending)}"><strong>${s.pending || 0}</strong> bíða</div>
        <div class="stat-chip${chipVal(s.approved)}"><strong>${s.approved || 0}</strong> samþykkt</div>
        <div class="stat-chip${chipVal(s.rejected)}"><strong>${s.rejected || 0}</strong> hafnað</div>
        <div class="stat-chip${chipVal(s.discuss)}"><strong>${s.discuss || 0}</strong> umræða</div>
        ${termData ? `
          <div class="stat-chip terms"><strong>${termMatchCount}</strong> hugtök</div>
          ${termIssueCount > 0 ? `<div class="stat-chip term-issues"><strong>${termIssueCount}</strong> hugtakavandamál</div>` : ''}
        ` : ''}
      `;
    }

    function renderSegments() {
      const tbody = document.getElementById('segments-body');
      const filterType = document.getElementById('filter-type').value;
      const filterCat = document.getElementById('filter-category').value;

      let segments = moduleData.segments;

      // Apply filters
      if (filterType === 'edited') {
        segments = segments.filter((s) => moduleData.edits[s.segmentId]?.length > 0);
      } else if (filterType === 'pending') {
        segments = segments.filter((s) => {
          const edits = moduleData.edits[s.segmentId] || [];
          return edits.some((e) => e.status === 'pending');
        });
      } else if (filterType === 'term-issues') {
        segments = segments.filter((s) => {
          const td = termData?.[s.segmentId];
          return td && td.issues && td.issues.length > 0;
        });
      } else if (filterType !== 'all') {
        segments = segments.filter((s) => s.segmentType === filterType);
      }

      if (filterCat !== 'all') {
        segments = segments.filter((s) => {
          const edits = moduleData.edits[s.segmentId] || [];
          return edits.some((e) => e.category === filterCat);
        });
      }

      tbody.innerHTML = segments.map((seg) => renderSegmentRow(seg)).join('');
    }

    function renderSegmentRow(seg) {
      const edits = moduleData.edits[seg.segmentId] || [];
      const latestEdit = edits[0]; // Most recent
      let rowClass = 'segment-row';
      if (latestEdit) {
        rowClass += ` has-edit ${latestEdit.status}`;
      }
      if (!seg.is && !latestEdit) {
        rowClass += ' no-translation';
      }

      // Determine what IS text to display and what to pre-fill in the editor
      const hasActiveEdit = latestEdit && (latestEdit.status === 'pending' || latestEdit.status === 'approved');
      const displayIs = hasActiveEdit ? latestEdit.edited_content : seg.is;
      const editableText = hasActiveEdit ? latestEdit.edited_content : seg.is;

      let enHtml = highlightMath(escapeHtml(seg.en));
      const isHtml = highlightMath(escapeHtml(displayIs));

      // Show word-level inline diff when an active edit changes the text
      let originalHint = '';
      if (hasActiveEdit && latestEdit.edited_content !== seg.is) {
        const diffHtml = renderInlineDiff(seg.is || '', latestEdit.edited_content || '');
        originalHint = `<div class="diff-hint" title="Breytingar frá upprunalegu">${diffHtml}</div>`;
      }

      // Apply term highlights to EN text
      const segTerms = termData?.[seg.segmentId];
      if (segTerms?.matches?.length > 0) {
        enHtml = highlightTermsInHtml(enHtml, segTerms.matches);
      }

      // Build term issue indicators for IS column
      let termIssuesHtml = '';
      if (segTerms?.issues?.length > 0) {
        termIssuesHtml = segTerms.issues.map(issue => `
          <div class="term-issue ${issue.type}">
            <span class="term-issue-icon">${issue.type === 'inconsistent' ? '&#9888;' : '&#8505;'}</span>
            <span>${escapeHtml(issue.message)}</span>
          </div>
        `).join('');
      }

      const isHeadEditor = ['head-editor', 'admin'].includes(getEffectiveRole());

      // Determine whether editing is allowed:
      // - No edit yet -> can edit
      // - Own pending edit -> can re-edit
      // - Rejected edit -> can try again
      // - Discuss edit -> can re-edit based on feedback
      const canEdit = !latestEdit
        || latestEdit.status === 'rejected'
        || latestEdit.status === 'discuss'
        || (latestEdit.status === 'pending' && latestEdit.editor_username === userName)
        || (latestEdit.status === 'approved' && !latestEdit.applied_at && latestEdit.editor_username === userName);

      let actionsHtml = '';
      if (latestEdit) {
        actionsHtml = `
          <div>
            <span class="edit-status ${latestEdit.status}">${statusLabel(latestEdit.status)}</span>
            ${latestEdit.category ? `<span class="category-badge ${latestEdit.category}">${categoryLabel(latestEdit.category)}</span>` : ''}
          </div>
          ${isHeadEditor && latestEdit.status === 'pending' && latestEdit.editor_username !== userName ? `
            <div class="review-actions" style="margin-top: 0.25rem;">
              <button class="btn btn-sm btn-approve" onclick="reviewEdit(${latestEdit.id}, 'approve')" title="Samþykkja">&#10003;</button>
              <button class="btn btn-sm btn-reject" onclick="reviewEdit(${latestEdit.id}, 'reject')" title="Hafna">&#10007;</button>
              <button class="btn btn-sm btn-discuss" onclick="reviewEdit(${latestEdit.id}, 'discuss')" title="Ræða">&#128172;</button>
            </div>
          ` : ''}
          ${isHeadEditor && latestEdit.status === 'approved' && !latestEdit.applied_at ? `
            <button class="btn btn-sm btn-secondary" onclick="unapproveEdit(${latestEdit.id})" style="margin-top: 0.25rem;" title="Afturkalla samþykki — breytir stöðu í 'bíður'">
              &#8617; Afturkalla
            </button>
          ` : ''}
          ${canEdit ? `
            <button class="btn btn-sm btn-secondary btn-edit" onclick="openEditPanel('${seg.segmentId}')" style="margin-top: 0.25rem;">
              Breyta
            </button>
          ` : ''}
        `;
      } else {
        actionsHtml = `
          <button class="btn btn-sm btn-secondary btn-edit" onclick="openEditPanel('${seg.segmentId}')">
            Breyta
          </button>
        `;
      }

      // Pre-select the category in the dropdown if re-editing
      const selectedCat = latestEdit?.category || '';

      return `
        <tr class="${rowClass}" id="row-${cssId(seg.segmentId)}">
          <td class="col-type">
            <span class="segment-type-badge ${seg.segmentType}">${seg.segmentType}</span>
          </td>
          <td class="col-en">
            <div class="segment-content">${enHtml || '<em class="text-muted">Engin enska</em>'}</div>
          </td>
          <td class="col-is">
            <div class="segment-content" id="is-${cssId(seg.segmentId)}">${isHtml || '<em class="text-muted">Engin þýðing</em>'}</div>
            ${originalHint}
            ${termIssuesHtml}
            <div class="edit-panel" id="edit-${cssId(seg.segmentId)}">
              <textarea id="textarea-${cssId(seg.segmentId)}">${escapeHtml(editableText)}</textarea>
              <div class="edit-controls">
                <select id="cat-${cssId(seg.segmentId)}" title="Veldu flokk breytingar">
                  <option value="">Flokkur...</option>
                  <option value="terminology" title="Fagorð, skilgreiningar, samræmi hugtaka" ${selectedCat === 'terminology' ? 'selected' : ''}>Hugtök</option>
                  <option value="accuracy" title="Efnislegir gallar eða rangar þýðingar" ${selectedCat === 'accuracy' ? 'selected' : ''}>Nákvæmni</option>
                  <option value="readability" title="Málfar, setningaskipan, læsileiki" ${selectedCat === 'readability' ? 'selected' : ''}>Læsileiki</option>
                  <option value="style" title="Tónn, orðalag, stílbrigði" ${selectedCat === 'style' ? 'selected' : ''}>Stíll</option>
                  <option value="omission" title="Vantar efni eða hluta úr upprunalega textanum" ${selectedCat === 'omission' ? 'selected' : ''}>Úrfelling</option>
                </select>
                <input type="text" id="note-${cssId(seg.segmentId)}" placeholder="Athugasemd (valkvætt)" value="${escapeHtml(latestEdit?.editor_note || '')}">
                <button class="btn btn-sm btn-primary" onclick="saveEdit('${seg.segmentId}')">Vista</button>
                <button class="btn btn-sm btn-secondary" onclick="closeEditPanel('${seg.segmentId}')">Hætta við</button>
              </div>
            </div>
          </td>
          <td class="col-actions">${actionsHtml}<span class="seg-save-ind${recentlySaved.has(seg.segmentId) ? ' saved' : ''}" id="seg-ind-${cssId(seg.segmentId)}">${recentlySaved.has(seg.segmentId) ? 'Vistað' : ''}</span></td>
        </tr>
      `;
    }

    // ================================================================
    // EDIT ACTIONS
    // ================================================================
    function openEditPanel(segmentId) {
      const panel = document.getElementById('edit-' + cssId(segmentId));
      if (panel) {
        panel.classList.add('active');
        // Add copper left-border to the row
        const row = document.getElementById('row-' + cssId(segmentId));
        if (row) row.classList.add('editing');
        // Focus the textarea and track dirty state
        const textarea = document.getElementById('textarea-' + cssId(segmentId));
        if (textarea) {
          textarea._segmentId = segmentId;
          textarea.focus();
          textarea.addEventListener('input', function onInput() {
            dirtyEdits.add(segmentId);
            // Update per-segment indicator
            const ind = document.getElementById('seg-ind-' + cssId(segmentId));
            if (ind) { ind.textContent = 'Breytt'; ind.className = 'seg-save-ind dirty'; }
            updateSaveStatusBar();
          }, { once: true });
        }
      }
    }

    function closeEditPanel(segmentId) {
      const panel = document.getElementById('edit-' + cssId(segmentId));
      if (panel) {
        panel.classList.remove('active');
        const row = document.getElementById('row-' + cssId(segmentId));
        if (row) row.classList.remove('editing');
      }
      dirtyEdits.delete(segmentId);
      updateSaveStatusBar();
    }

    async function saveEdit(segmentId) {
      const seg = moduleData.segments.find((s) => s.segmentId === segmentId);
      if (!seg) return;

      const editedContent = document.getElementById('textarea-' + cssId(segmentId)).value;
      const category = document.getElementById('cat-' + cssId(segmentId)).value;
      const editorNote = document.getElementById('note-' + cssId(segmentId)).value;

      // Compare against the file text (seg.is), not any existing edit
      // Even if content matches the original, a category tag is meaningful
      if (editedContent === seg.is && !category && !editorNote) {
        closeEditPanel(segmentId);
        return; // No change from original and no annotation
      }

      const saveUrl = `${API_BASE}/${currentBook}/${currentChapter}/${currentModuleId}/edit`;
      const saveOptions = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          segmentId,
          originalContent: seg.is,
          editedContent,
          category: category || undefined,
          editorNote: editorNote || undefined,
        }),
      };

      // Update per-segment indicator to "saving"
      const savingInd = document.getElementById('seg-ind-' + cssId(segmentId));
      if (savingInd) { savingInd.textContent = 'Vistar...'; savingInd.className = 'seg-save-ind saving'; }

      try {
        await saveRetry.attempt(
          `seg:${currentBook}/${currentChapter}/${currentModuleId}:${segmentId}`,
          saveUrl,
          saveOptions
        );

        dirtyEdits.delete(segmentId);
        lastServerSaveTime = Date.now();
        recentlySaved.add(segmentId);
        setTimeout(() => { recentlySaved.delete(segmentId); }, 4000);
        saveDraft(); // update draft (or clear if empty)
        updateSaveStatusBar();
        // Reload module to refresh edits
        await loadModule(currentModuleId);
      } catch (err) {
        // Revert per-segment indicator on error
        if (savingInd) { savingInd.textContent = 'Breytt'; savingInd.className = 'seg-save-ind dirty'; }
        if (!saveRetry.isRetryable(err)) {
          alert('Villa við að vista: ' + err.message);
        }
      }
    }

    async function reviewEdit(editId, action) {
      const note = action === 'reject' || action === 'discuss'
        ? prompt(action === 'reject' ? 'Ástæða höfnunar:' : 'Umræðuefni:')
        : null;

      if ((action === 'reject' || action === 'discuss') && note === null) return; // Cancelled

      try {
        await fetchJson(`${API_BASE}/edit/${editId}/${action}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ note }),
        });

        await loadModule(currentModuleId);
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    async function unapproveEdit(editId) {
      if (!confirm('Afturkalla samþykki? Breytingin fer til baka í stöðuna „bíður".')) return;

      try {
        await fetchJson(`${API_BASE}/edit/${editId}/unapprove`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
        });

        await loadModule(currentModuleId);
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    }

    // ================================================================
    // SUBMIT FOR REVIEW
    // ================================================================
    document.getElementById('btn-submit').addEventListener('click', async () => {
      const stats = moduleData.stats || {};
      if (!stats.total_edits || stats.total_edits === 0) {
        alert('Engar breytingar til að senda.');
        return;
      }

      if (!confirm(`Senda ${stats.total_edits} breytingar til yfirlestrar?`)) return;

      try {
        await fetchJson(
          `${API_BASE}/${currentBook}/${currentChapter}/${currentModuleId}/submit`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
          }
        );

        alert('Sent til yfirlestrar!');
        await loadModule(currentModuleId);
      } catch (err) {
        alert('Villa: ' + err.message);
      }
    });

    // ================================================================
    // BACK BUTTON
    // ================================================================
    document.getElementById('btn-back').addEventListener('click', () => {
      clearDraft();
      if (draftTimer) clearInterval(draftTimer);
      tabGuard.release();
      document.getElementById('editor-container').style.display = 'none';
      document.getElementById('module-selector').style.display = 'block';
      document.getElementById('save-status-bar').style.display = 'none';
      moduleData = null;
      termData = null;
      lastServerSaveTime = null;
      recentlySaved.clear();
      clearInterval(pipelinePollingTimer);

      // Reset topbar title
      const topbarTitle = document.getElementById('topbar-title');
      if (topbarTitle) {
        topbarTitle.textContent = 'Ritstjóri';
      }
    });

    // ================================================================
    // FILTERS
    // ================================================================
    document.getElementById('filter-type').addEventListener('change', renderSegments);
    document.getElementById('filter-category').addEventListener('change', renderSegments);

    // ================================================================
    // HELPERS
    // ================================================================
    function highlightMath(html) {
      return html.replace(
        /\[\[MATH:(\d+)\]\]/g,
        '<span class="math-placeholder">[[MATH:$1]]</span>'
      );
    }

    function cssId(segmentId) {
      return segmentId.replace(/[^a-zA-Z0-9-]/g, '_');
    }

    // ================================================================
    // WORD-LEVEL INLINE DIFF
    // ================================================================

    /**
     * Tokenize text for diffing. Treats [[MATH:N]] placeholders as single
     * tokens and splits on whitespace boundaries.
     */
    function tokenizeForDiff(text) {
      if (!text) return [];
      const tokens = [];
      const re = /(\[\[MATH:\d+\]\]|\S+|\s+)/g;
      let m;
      while ((m = re.exec(text)) !== null) {
        tokens.push(m[1]);
      }
      return tokens;
    }

    /**
     * LCS-based word diff. Returns array of {type, text} operations.
     * type: 'equal' | 'delete' | 'insert'
     */
    function computeWordDiff(oldText, newText) {
      const oldTokens = tokenizeForDiff(oldText);
      const newTokens = tokenizeForDiff(newText);

      // Build LCS table
      const m = oldTokens.length;
      const n = newTokens.length;
      const dp = Array.from({ length: m + 1 }, () => new Uint16Array(n + 1));
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          if (oldTokens[i - 1] === newTokens[j - 1]) {
            dp[i][j] = dp[i - 1][j - 1] + 1;
          } else {
            dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
          }
        }
      }

      // Backtrack to produce diff ops
      const ops = [];
      let i = m, j = n;
      while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && oldTokens[i - 1] === newTokens[j - 1]) {
          ops.push({ type: 'equal', text: oldTokens[i - 1] });
          i--; j--;
        } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
          ops.push({ type: 'insert', text: newTokens[j - 1] });
          j--;
        } else {
          ops.push({ type: 'delete', text: oldTokens[i - 1] });
          i--;
        }
      }
      ops.reverse();
      return ops;
    }

    /**
     * Render word-level inline diff as HTML with <del> and <ins> tags.
     */
    function renderInlineDiff(oldText, newText) {
      const ops = computeWordDiff(oldText, newText);
      return ops.map(op => {
        const escaped = highlightMath(escapeHtml(op.text));
        switch (op.type) {
          case 'delete': return `<del class="diff-del">${escaped}</del>`;
          case 'insert': return `<ins class="diff-ins">${escaped}</ins>`;
          default: return escaped;
        }
      }).join('');
    }

    function statusLabel(status) {
      const labels = {
        pending: 'Bíður',
        approved: 'Samþykkt',
        rejected: 'Hafnað',
        discuss: 'Umræða',
      };
      return labels[status] || status;
    }

    function categoryLabel(cat) {
      const labels = {
        terminology: 'Hugtök',
        accuracy: 'Nákvæmni',
        readability: 'Læsileiki',
        style: 'Stíll',
        omission: 'Úrfelling',
      };
      return labels[cat] || cat;
    }

    // ================================================================
    // PIPELINE CONTROLS
    // ================================================================

    let pipelinePollingTimer = null;

    function showPipelinePanel() {
      const isHeadEditor = ['head-editor', 'admin'].includes(getEffectiveRole());
      const panel = document.getElementById('pipeline-panel');
      panel.style.display = isHeadEditor ? 'block' : 'none';
    }

    document.getElementById('btn-inject').addEventListener('click', () => {
      runPipelineAction('inject');
    });

    document.getElementById('btn-render').addEventListener('click', () => {
      runPipelineAction('render');
    });

    document.getElementById('btn-pipeline').addEventListener('click', () => {
      runPipelineAction('run');
    });

    async function runPipelineAction(action) {
      const track = document.getElementById('pipeline-track').value;
      const badge = document.getElementById('pipeline-badge');
      const output = document.getElementById('pipeline-output');

      // Disable buttons while running
      setPipelineButtonsDisabled(true);
      badge.textContent = 'Í gangi...';
      badge.className = 'pipeline-status-badge running';
      badge.style.display = 'inline-block';
      output.textContent = `Starting ${action}...\n`;
      output.classList.add('active');

      try {
        const data = await fetchJson(`/api/pipeline/${action}`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            book: currentBook,
            chapter: currentChapter,
            moduleId: currentModuleId !== 'all' ? currentModuleId : undefined,
            track,
          }),
        });

        // Start polling for job status
        pollJobStatus(data.jobId);
      } catch (err) {
        badge.textContent = 'Villa';
        badge.className = 'pipeline-status-badge failed';
        output.textContent += `Error: ${err.message}\n`;
        setPipelineButtonsDisabled(false);
      }
    }

    function pollJobStatus(jobId) {
      clearInterval(pipelinePollingTimer);
      let pollAttempts = 0;
      const MAX_POLL_ATTEMPTS = 40; // ~60 seconds at 1.5s interval

      pipelinePollingTimer = setInterval(async () => {
        pollAttempts++;
        try {
          const { job } = await fetchJson(`/api/pipeline/jobs/${jobId}`, {
            credentials: 'include',
          });
          pollAttempts = 0; // Reset on success

          const badge = document.getElementById('pipeline-badge');
          const output = document.getElementById('pipeline-output');

          // Update output
          output.textContent = job.output.join('\n');
          output.scrollTop = output.scrollHeight;

          if (job.status === 'completed') {
            clearInterval(pipelinePollingTimer);
            badge.textContent = 'Lokið';
            badge.className = 'pipeline-status-badge completed';
            setPipelineButtonsDisabled(false);
          } else if (job.status === 'failed') {
            clearInterval(pipelinePollingTimer);
            badge.textContent = 'Mistókst';
            badge.className = 'pipeline-status-badge failed';
            output.textContent += `\nError: ${job.error || 'Unknown error'}`;
            setPipelineButtonsDisabled(false);
          } else {
            badge.textContent = job.phase ? `Í gangi (${job.phase})...` : 'Í gangi...';
          }
        } catch {
          if (pollAttempts >= MAX_POLL_ATTEMPTS) {
            clearInterval(pipelinePollingTimer);
            const badge = document.getElementById('pipeline-badge');
            badge.textContent = 'Tenging rofnaði';
            badge.className = 'pipeline-status-badge failed';
            document.getElementById('pipeline-output').textContent += '\nGat ekki náð sambandi við þjón.';
            setPipelineButtonsDisabled(false);
          }
        }
      }, 1500);
    }

    function setPipelineButtonsDisabled(disabled) {
      document.getElementById('btn-inject').disabled = disabled;
      document.getElementById('btn-render').disabled = disabled;
      document.getElementById('btn-pipeline').disabled = disabled;
    }

    // ================================================================
    // APPLY CONTROLS (Write approved edits to files)
    // ================================================================

    function showApplyPanel() {
      const isHeadEditor = ['head-editor', 'admin'].includes(getEffectiveRole());
      const panel = document.getElementById('apply-panel');
      panel.style.display = isHeadEditor ? 'block' : 'none';
      if (isHeadEditor) {
        loadApplyStatus();
      }
    }

    // Re-render panels when admin changes role preview
    window.addEventListener('roleVisibilityChanged', function () {
      if (currentModuleId) {
        showPipelinePanel();
        showApplyPanel();
      }
    });

    async function loadApplyStatus() {
      const statusEl = document.getElementById('apply-status');
      const btnApply = document.getElementById('btn-apply');
      const btnApplyRender = document.getElementById('btn-apply-render');
      const badge = document.getElementById('apply-badge');

      statusEl.textContent = 'Hleður...';
      btnApply.disabled = true;
      btnApplyRender.disabled = true;
      badge.style.display = 'none';

      try {
        const data = await fetchJson(
          `${API_BASE}/${currentBook}/${currentChapter}/${currentModuleId}/apply-status`,
          { credentials: 'include' }
        );

        const { unapplied_count, applied_count, total_approved } = data;

        if (unapplied_count > 0) {
          statusEl.textContent = `${unapplied_count} samþykktar breytingar til að vista`;
          btnApply.disabled = false;
          btnApplyRender.disabled = false;
        } else if (total_approved > 0) {
          statusEl.textContent = `Allar ${total_approved} samþykktar breytingar vistaðar`;
        } else {
          statusEl.textContent = 'Engar samþykktar breytingar';
        }
      } catch (err) {
        statusEl.textContent = 'Villa við að sækja stöðu';
        console.error('Apply status error:', err);
      }
    }

    async function applyEdits() {
      const badge = document.getElementById('apply-badge');
      const btnApply = document.getElementById('btn-apply');
      const btnApplyRender = document.getElementById('btn-apply-render');

      btnApply.disabled = true;
      btnApplyRender.disabled = true;
      badge.style.display = 'inline-block';
      badge.textContent = 'Vista...';
      badge.className = 'pipeline-status-badge running';

      try {
        const data = await fetchJson(
          `${API_BASE}/${currentBook}/${currentChapter}/${currentModuleId}/apply`,
          { method: 'POST', credentials: 'include' }
        );
        badge.textContent = `Vistað (${data.appliedCount} breytingar)`;
        badge.className = 'pipeline-status-badge success';
        // Refresh status
        loadApplyStatus();
      } catch (err) {
        badge.textContent = 'Mistókst';
        badge.className = 'pipeline-status-badge failed';
        alert('Villa við að vista: ' + err.message);
        btnApply.disabled = false;
        btnApplyRender.disabled = false;
      }
    }

    async function applyAndRender() {
      const badge = document.getElementById('apply-badge');
      const btnApply = document.getElementById('btn-apply');
      const btnApplyRender = document.getElementById('btn-apply-render');

      btnApply.disabled = true;
      btnApplyRender.disabled = true;
      badge.style.display = 'inline-block';
      badge.textContent = 'Vista + Render...';
      badge.className = 'pipeline-status-badge running';

      try {
        const data = await fetchJson(
          `${API_BASE}/${currentBook}/${currentChapter}/${currentModuleId}/apply-and-render`,
          { method: 'POST', credentials: 'include' }
        );

        badge.textContent = `Vistað (${data.applied.appliedCount}), render í gangi...`;

        // Poll the pipeline job
        if (data.jobId) {
          pollApplyRenderJob(data.jobId);
        } else {
          badge.textContent = 'Vistað, en render startaði ekki';
          badge.className = 'pipeline-status-badge success';
          loadApplyStatus();
        }
      } catch (err) {
        badge.textContent = 'Mistókst';
        badge.className = 'pipeline-status-badge failed';
        alert('Villa: ' + err.message);
        btnApply.disabled = false;
        btnApplyRender.disabled = false;
      }
    }

    function pollApplyRenderJob(jobId) {
      const badge = document.getElementById('apply-badge');
      let pollAttempts = 0;
      const MAX_POLL_ATTEMPTS = 40; // ~60 seconds at 1.5s interval

      const timer = setInterval(async () => {
        pollAttempts++;
        try {
          const job = await fetchJson(`/api/pipeline/status/${jobId}`, {
            credentials: 'include',
          });
          pollAttempts = 0; // Reset on success

          if (job.status === 'completed') {
            clearInterval(timer);
            badge.textContent = 'Vistað + Render lokið!';
            badge.className = 'pipeline-status-badge success';
            loadApplyStatus();
          } else if (job.status === 'failed') {
            clearInterval(timer);
            badge.textContent = 'Render mistókst';
            badge.className = 'pipeline-status-badge failed';
            document.getElementById('btn-apply').disabled = false;
            document.getElementById('btn-apply-render').disabled = false;
          } else {
            badge.textContent = job.phase
              ? `Render (${job.phase})...`
              : 'Render í gangi...';
          }
        } catch {
          if (pollAttempts >= MAX_POLL_ATTEMPTS) {
            clearInterval(timer);
            badge.textContent = 'Tenging rofnaði';
            badge.className = 'pipeline-status-badge failed';
            document.getElementById('btn-apply').disabled = false;
            document.getElementById('btn-apply-render').disabled = false;
          }
        }
      }, 1500);
    }

    document.getElementById('btn-apply').addEventListener('click', applyEdits);
    document.getElementById('btn-apply-render').addEventListener('click', applyAndRender);

    // ================================================================
    // TERM HIGHLIGHTING
    // ================================================================

    /**
     * Highlight matched terms in already-escaped HTML.
     * Works on the escaped text, matching term.english case-insensitively.
     */
    function highlightTermsInHtml(html, matches) {
      // Sort by position descending so replacements don't shift indices
      // But since html is escaped, we match by term text instead
      // Sort longest first so "molar mass" matches before "mass"
      const sorted = [...matches].sort((a, b) => b.english.length - a.english.length);
      const used = new Set();

      for (const m of sorted) {
        const escaped = escapeHtml(m.english);
        const pattern = new RegExp(
          `\\b(${escapeRegexStr(escaped)})\\b`, 'gi'
        );
        // Only highlight first occurrence to keep it clean
        let replaced = false;
        html = html.replace(pattern, (match) => {
          if (replaced || used.has(m.english.toLowerCase())) return match;
          replaced = true;
          used.add(m.english.toLowerCase());
          const cls = m.status === 'approved' ? 'term-highlight' : 'term-highlight proposed';
          return `<span class="${cls}" data-term-id="${m.termId}" onclick="showTermPopup(${m.termId}, this)">${match}</span>`;
        });
      }
      return html;
    }

    function escapeRegexStr(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ================================================================
    // TERM POPUP
    // ================================================================

    function showTermPopup(termId, element) {
      const popup = document.getElementById('term-popup');

      // Find term info from termData
      let termInfo = null;
      if (termData) {
        for (const segId of Object.keys(termData)) {
          const match = termData[segId].matches?.find(m => m.termId === termId);
          if (match) {
            termInfo = match;
            break;
          }
        }
      }

      if (!termInfo) {
        closeTermPopup();
        return;
      }

      document.getElementById('term-popup-en').textContent = termInfo.english;

      const statusBadge = termInfo.status === 'approved'
        ? '<span class="edit-status approved">Samþykkt</span>'
        : '<span class="edit-status pending">Tillaga</span>';

      document.getElementById('term-popup-body').innerHTML = `
        <div class="term-popup-row">
          <span class="term-popup-label">Íslenska:</span>
          <span class="term-popup-value">${escapeHtml(termInfo.icelandic)}</span>
        </div>
        <div class="term-popup-row">
          <span class="term-popup-label">Flokkur:</span>
          <span>${termInfo.category || '—'}</span>
        </div>
        <div class="term-popup-row">
          <span class="term-popup-label">Staða:</span>
          ${statusBadge}
        </div>
        <div style="margin-top: 0.5rem; padding-top: 0.4rem; border-top: 1px solid var(--border);">
          <a href="/terminology" target="_blank" style="font-size: var(--text-xs); color: var(--accent);">
            Opna í orðasafni &#8594;
          </a>
        </div>
      `;

      // Position near the clicked element
      const rect = element.getBoundingClientRect();
      popup.style.top = (rect.bottom + window.scrollY + 4) + 'px';
      popup.style.left = Math.min(rect.left + window.scrollX, window.innerWidth - 380) + 'px';
      popup.classList.add('active');

      // Close on outside click
      setTimeout(() => {
        document.addEventListener('click', closeTermPopupOnOutside);
      }, 0);
    }

    function closeTermPopup() {
      document.getElementById('term-popup').classList.remove('active');
      document.removeEventListener('click', closeTermPopupOnOutside);
    }

    function closeTermPopupOnOutside(e) {
      const popup = document.getElementById('term-popup');
      if (!popup.contains(e.target) && !e.target.classList.contains('term-highlight')) {
        closeTermPopup();
      }
    }

    // ================================================================
    // TERM LOOKUP
    // ================================================================
    const termLookupInput = document.getElementById('term-lookup');
    const termLookupResults = document.getElementById('term-lookup-results');

    termLookupInput.addEventListener('input', () => {
      clearTimeout(termLookupTimer);
      const q = termLookupInput.value.trim();

      if (q.length < 2) {
        termLookupResults.classList.remove('active');
        return;
      }

      termLookupTimer = setTimeout(async () => {
        try {
          const data = await fetchJson(
            `${API_BASE}/terminology/lookup?q=${encodeURIComponent(q)}`,
            { credentials: 'include' }
          );

          if (!data.terms || data.terms.length === 0) {
            termLookupResults.innerHTML = '<div class="term-lookup-item" style="color: var(--text-muted);">Ekkert fannst</div>';
          } else {
            termLookupResults.innerHTML = data.terms.map(t => `
              <div class="term-lookup-item" onclick="insertTermFromLookup('${escapeHtml(t.icelandic)}')">
                <span class="term-lookup-en">${escapeHtml(t.english)}</span>
                &#8594; <span class="term-lookup-is">${escapeHtml(t.icelandic)}</span>
                ${t.status === 'approved' ? ' &#10003;' : ''}
              </div>
            `).join('');
          }
          termLookupResults.classList.add('active');
        } catch {
          termLookupResults.classList.remove('active');
        }
      }, 300);
    });

    termLookupInput.addEventListener('blur', () => {
      // Delay to allow click on results
      setTimeout(() => termLookupResults.classList.remove('active'), 200);
    });

    function insertTermFromLookup(icelandicTerm) {
      // Copy to clipboard for easy pasting
      navigator.clipboard.writeText(icelandicTerm).then(() => {
        termLookupInput.value = '';
        termLookupResults.classList.remove('active');
        // Brief visual feedback
        termLookupInput.placeholder = 'Afritað!';
        setTimeout(() => {
          termLookupInput.placeholder = 'Fletta upp hugtaki...';
        }, 1500);
      }).catch(() => {
        termLookupResults.classList.remove('active');
      });
    }

    // ================================================================
    // KEYBOARD SHORTCUTS
    // ================================================================
    document.addEventListener('keydown', (e) => {
      // Escape to close active edit panel
      if (e.key === 'Escape') {
        const activePanel = document.querySelector('.edit-panel.active');
        if (activePanel) {
          activePanel.classList.remove('active');
          const row = activePanel.closest('tr');
          if (row) row.classList.remove('editing');
          // Clear dirty state — find the segmentId from the textarea data
          const textarea = activePanel.querySelector('textarea');
          if (textarea && textarea._segmentId) {
            dirtyEdits.delete(textarea._segmentId);
            updateSaveStatusBar();
          }
        }
      }

      // Ctrl+Enter to save active edit
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        const focused = document.activeElement;
        if (focused && focused.tagName === 'TEXTAREA' && focused.id.startsWith('textarea-')) {
          const panel = focused.closest('.edit-panel');
          if (panel) {
            const saveBtn = panel.querySelector('.btn-primary');
            if (saveBtn) saveBtn.click();
          }
        }
      }
    });

    // ================================================================
    // WARN BEFORE LEAVING WITH UNSAVED EDITS
    // ================================================================
    window.addEventListener('beforeunload', function (e) {
      if (dirtyEdits.size > 0) {
        saveDraft(); // last-chance save to localStorage
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Save drafts on auth expiry (before 401 redirect)
    window.addEventListener('auth-expired', function () {
      if (dirtyEdits.size > 0) saveDraft();
    });

    // ================================================================
    // INIT
    // ================================================================
    checkAuth();

    // Auto-load from URL params: ?book=...&chapter=...&module=...
    (async function autoLoadFromParams() {
      const params = new URLSearchParams(window.location.search);
      const book = params.get('book');
      const chapter = params.get('chapter');
      const module = params.get('module');
      if (!book || !chapter) return;

      // Set book select and trigger chapter population
      bookSelect.value = book;
      bookSelect.dispatchEvent(new Event('change'));

      // Set chapter select and trigger module list load
      await new Promise(r => setTimeout(r, 50));
      chapterSelect.value = chapter;
      chapterSelect.dispatchEvent(new Event('change'));

      // If module specified, wait for module list then load it
      if (module) {
        await new Promise(r => setTimeout(r, 300));
        loadModule(module);
      }
    })();
  </script>
</body>
</html>
